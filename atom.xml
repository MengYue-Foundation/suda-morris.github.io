<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[WenRis Blog]]></title>
  <link href="http://suda-morris.github.io/atom.xml" rel="self"/>
  <link href="http://suda-morris.github.io/"/>
  <updated>2016-03-24T22:00:52+08:00</updated>
  <id>http://suda-morris.github.io/</id>
  <author>
    <name><![CDATA[suda-morris]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Latex]]></title>
    <link href="http://suda-morris.github.io/blog/2016/03/21/latex/"/>
    <updated>2016-03-21T11:09:15+08:00</updated>
    <id>http://suda-morris.github.io/blog/2016/03/21/latex</id>
    <content type="html"><![CDATA[<h2>LaTeX简介</h2>

<ol>
<li>LaTeX是一种基于TeX的文档排版系统。</li>
<li>LaTeX并不是单独的程序，现在的TEX系统都是复杂的软件包，里面包含各种排版的引擎、编译脚本、格式转换工具、管理界面、配置文件、支持工具、字体以及数以千计的宏包和文档。一个TeX发行版就是把所有这样的部件都集合在一起，打包发布的软件</li>
<li>TeX是由TeX用户组发布的一个发行版，跨平台</li>
<li>LaTeX的命令以反斜线\开头，命令一般用英文单词命名，有的可以带参数。</li>
<li>严格来说，LaTeX并不是标记语言，而是主要基于字符串代换的宏语言
<img src="http://i.imgur.com/b7BVgmf.png" alt="使用各种引擎编译LaTeX文档的简要流程" /></li>
<li>导言区常用命令：

<ol>
<li>声明文章的标题:\title{An Embedded FTP Server Powered by PoE}</li>
<li>声明文章的作者:\author{morris}</li>
<li>声明写作日期:\date{\today}</li>
<li>声明参考文献的格式:\bibliographystyle{plain}</li>
</ol>
</li>
<li>以\begin{document}和\end{document}声明了一个document环境，里面是论文的正文部分，也是直接输出的部分</li>
<li>\maketitle命令实际输出论文标题</li>
<li>\tableofcontents命令输出目录</li>
<li>\section命令开始新的一节</li>
<li>使用空行分段，单个换行并不会使文字另起一段，而只是起到使源代码更易读的作用，空行只起分段作用，使用很多空行并不起任何增大间距的作用</li>
<li>短浅不用打空格，LaTeX会自动完成文字的缩进，即使手工在前面打了空格，LaTeX也会将其忽略</li>
<li>汉字后面的空格会被忽略，其他符号后面的空格则保留。单个的换行就相当于一个空格，因此源代码中大段文字可以安全地分成短行，空格只起分隔单词或符号的作用，使用很多空格并不起到任何增大字词间距的作用</li>
<li>在需要使用注脚的文字后面使用命令:\footnote{注脚内容}</li>
<li>需要强调的内容使用命令:\emph{内容}</li>
<li>命令都以反斜线\开头，后接命令名，命令名或者是一串字母，或是单个符号。命令可以带一些参数，如果命令的参数不止一个字符(不包括空格)，就必须用花括号括起来。可选参数如果出现，则使用方括号括起来。
<img src="http://i.imgur.com/t6MSwSB.png" alt="LaTeX命令的格式" /></li>
<li>引用的内容是在正文中使用quote环境得到,quote环境即以\begin{quote} 和\end{quote} 为起止位置的部分。它将环境中的内容单独分行，增加缩进和上下间距排印，以突出引用的部分。</li>
<li>文章的摘要也是在\maketitle之后用abstract环境生成的
<img src="http://i.imgur.com/eQWRnSC.png" alt="LaTeX环境的一般格式" /></li>
<li>最简单的输入公式的办法是把公式用一对美元符号$$括起来，如使用$a+b$就得到漂亮的a+b，这种夹在行文中的公式称为正文公式或行内公式。对比较长或比较重要的公式，一般则单独居中写在一行；为了方便引用，经常还给公式编号。这种公式被称为显示公式或列表公式，使用equation环境就可以方便的输入这种公式。</li>
<li>键盘上没有的符号，就需要使用一个命令来输入。例如表示角的符号就可以用\angle输入。命令的名字通常也就是符号的名字，圆周率的符号用\pi来表示</li>
<li>符号^用来引入一个上标，而_则引入一个下标，它们用起来差不多等同于一个带一个参数的命令，因此多个字符的上下标需要使用花括号分组，如$2^{10}=1024$</li>
<li>怎么输入90°，LaTeX默认的数学字体中，并没有一个专门用于表示角度的符号，自然也没有这么命令，角度的符号°是通过上标输入的：$^\circ$</li>
<li>插图功能不是由LaTeX的内核直接提供的，而是由graphicx宏包提供的。要使用graphicx宏包的插图功能，需要在源文件的导言区使用\usepackage命令引入宏包</li>
<li>引入graphicx宏包后就可以使用\includegraphics命令插图了，比如：\includegraphics[scale=0.4]{DC-DC.jpg}。插入的图形就是一个有内容的矩形盒子，在正文中和一个很大的字符没有多少区别。支持的图形格式包括PDF、PNG、JPG、EPS 等。</li>
<li>除了一些很小的标志图形，我们很少把插图直接夹在文字之中，而是使用单独的环境列出。而且很大的图形如果固定位置，会给分页造成困难。因此，通常把图形放在一个可以变动的相对位置的环境中，称为<strong>浮动体</strong>。在浮动体中还可以给图形加入说明性的标题。例如：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>\begin{figure}[ht]
</span><span class='line'>\centering
</span><span class='line'>\includegraphics[scale=0.6]{xiantu.pdf}
</span><span class='line'>\caption{宋赵爽在《周髀算经》注中作的弦图（仿制），该图给出了勾股定
</span><span class='line'>理的一个极具对称美的证明。}
</span><span class='line'>\label{fig:xiantu}
</span><span class='line'>\end{figure}</span></code></pre></td></tr></table></div></figure>


<ol>
<li>在上面的代码中，figure环境有可选参数[ht]，表示浮动体可以出现在环境周围的文本所在处(here)和一页的顶部(top)，figure环境内部相当于普通的段落（默认没有缩进）；使用声明\centering表示后面的内容居中；使用caption命令给插图加上自动编号和标题</li>
<li>制作表格需要确定的是表格的行、列对齐模式和表格线，这是由tabular环境完成的：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>\begin{table}[H]
</span><span class='line'>\begin{tabular}{|rrr|}
</span><span class='line'>\hline
</span><span class='line'>直角边$a$ & 直角边$b$ & 斜边$c$ \\
</span><span class='line'>\hline
</span><span class='line'>3 & 4 & 5 \\
</span><span class='line'>5 & 12 & 13 \\
</span><span class='line'>\hline
</span><span class='line'>\end{tabular}%
</span><span class='line'>\qquad
</span><span class='line'>($a^2 + b^2 = c^2$)
</span><span class='line'>\end{table}</span></code></pre></td></tr></table></div></figure>


<ol>
<li>tabular环境中有一个参数，里面声明了表格中列的模式，在前面的表格中，|rrr|表示表格有3列，都是右对齐，在第一列和第三列后面各有一条垂直的表格线。在tabular环境内部，行与行之间用命令\隔开，每行内部的表项则用符号&amp;隔开。表格中的横线则是用命令\hline产生的。表格与插图一样，都是一个比较大的盒子，一般也放在浮动环境中，即table环境</li>
<li>使用\bibliographystyle{plain}声明了参考文献的格式，用\bibliography{math}命令打印参考文献列表。实际上这只是BibTeX处理文献的一个空架子，还需要定义“参考文献数据库”。BibTeX使用的参考文献数据库其实就是个后缀为.bib的文件。BibTeX数据库经常不需要我们自己录入，而可以从相关学科的网站直接下载或是从其他类型的文献数据库转换得到。定义好参考数据库后在正文中使用\cite命令选择需要LaTeX列出的文献。</li>
<li>引用不仅限于参考文献，图表、公式的编号，只要事先设定了标签，同样可以通过辅助文件为中介引用。基本的交叉引用命令是\ref，它以标签为参数，得到被引用的编号。数学宏包amsmath就定义了\eqref命令，专门用于公式的引用，并能产生括号</li>
<li>设计页面尺寸可以使用geometry宏包：\geometry{a6paper,centering,scale=0.8}，表示页面使用A6纸大小，版心居中，长宽占页面的0.8</li>
<li>改变图标标题格式可以使用caption宏包：\usepackage[format=hang,font=small,textfont=it]{caption}表示设置图表所有标题使用悬挂对齐方式，整体用小字号，而标题文本使用斜体（对汉字来说就是楷体）</li>
<li>增加目录的项目则可以用tocbibnd宏包：\usepackage[nottoc]{tocbibind}，宏包默认会在目录中加入目录项本身、参考文献、索引等项目，这里使用nottoc选项取消了在目录中显示目录本身</li>
<li>自定义环境命令,\newenvironment有3个参数，第一个参数是环境的名字，后两个参数分别是在环境开始和末尾处的代码</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>\newenvironment{myquote}
</span><span class='line'>{\begin{quote}\kaishu\zihao{-5}}
</span><span class='line'>{\end{quote}}</span></code></pre></td></tr></table></div></figure>


<ol>
<li>自定义新的命令：\newcommand\degree{^\circ}</li>
<li>LaTeX是一种结构化的排版语言，在填写便准格式的模板时可以忽略编号、格式等许多具体细节。在文档排版中应主动追求内容与格式的分离，在document环境之内避免直接使用诸如字体字号、对齐缩进的格式控制命令，而代之以有具体意义的环境和命令，让文档变得清晰</li>
</ol>


<h2>文字与符号</h2>

<ol>
<li>LaTeX中的特殊字母
<img src="http://i.imgur.com/lWzOtlB.png" alt="LaTeX中的特殊字母及命令" /></li>
<li>LaTeX提供了babel宏包，可以方便同时访问多种语言的字母表，babel宏包可带有一个或多个语言的可选参数，支持不同的语言，如:\usepackage[greek,english]{babel},将使用英语和希腊语，其中最后一个参数的英语是默认语言，此时希腊语就可以用ASCII字符代替：\textgreek{abcd}</li>
<li>LaTeX在盘拌种会将单词中的一些字母连写为一个符号，即连字，连字的有无和多少一般是由使用的字体决定的，比如fi和fl连在了一起，有时候为了美观考虑取消连字，可以使用空的分组，比如：f{}ind</li>
<li>在每个标点之后应该加上空格，以保证正确的距离和换行</li>
<li>LaTeX中遇到单引号和双引号连续出现的情形，则在双引号和单引号之间用\隔开</li>
<li>除了在数学模式中表示减号，符号-在LaTeX正文中也有多种用途：单独使用时它是连字符，两个连用时en dash，用来表示数字范围；三个连用是em dash，即破折号</li>
<li>圣罗浩使用\ldots或者\dots命令产生，相比直接输入三个句号，它所略微拉开的间距要合理的多</li>
<li>标准键盘上不能直接录入的标点符号
<img src="http://i.imgur.com/FT4ZOtP.png" alt="标准键盘不能直接录入的标点符号" /></li>
<li>文本中的空格起分隔单词的作用，任意多个空格与一个空格的功能相同；只有字符后面的空格使有效的，每行最前面的空格会被忽略。单个换行也被看做是一个空格</li>
<li>有一种不可打断的空格，在TeX中被称为带子，用~表示，TeX禁止在这种空格之间分行，因为可以用来表示一些不宜分开的情况
<img src="http://i.imgur.com/qKvkp9w.png" alt="带子的使用" /></li>
<li>西文的逗号、句号、分号等标点后面应该加空格，这不仅能保证正确的间距，也能保证正确的换行。这是因为，标点后如果没有空格，就不能换行。</li>
<li>空行，即用连续两个换行表示分段，段与段之间会自动得到合适的缩进，任意多个空行与一个空行的效果相同</li>
<li>除了分段，也可以让LaTeX直接另起一行，并不分段。\命令直接另起一行，上一行保持原来的样子，\命令可以带一个可选的长度参数，表示换行后增加的额外垂直间距，例如\[2cm]。\linebreak则指定一行的断点，上一行仍按完整一行散开对齐</li>
<li>特殊符号
<img src="http://i.imgur.com/T5X1sug.png" alt="正文中常用的特殊符号" /></li>
<li>LaTeX的基本工具宏包textcomp就定义了大量用于文本的符号，例如欧元符号\texteuro，千分符\textperthousand等。tipa宏包提供了国际音标字体的访问</li>
<li>预定义命令的字体族有3种：罗马字体族、无衬底字体族和打字机字体族，其命令为：
<img src="http://i.imgur.com/uiy67RS.png" alt="预定义命令的字体族" /></li>
<li>预定义命令的字体形状有4种：直立形状、意大利形状、倾斜形状、小型大写形状，其命令为：
<img src="http://i.imgur.com/NPpS0NK.png" alt="预定义命令的字体形状" /></li>
<li>预定义命令的字体系列有中等和加宽加粗两类
<img src="http://i.imgur.com/kIXpFT7.png" alt="预定义命令的字体系列" /></li>
<li>对于中文字体，一般只是用不同字体族进行区分。xeCJK和CJK宏包机制下，中文字体的选择命令和西文字体是分离，选择中文字体族使用\CJKfamily</li>
<li>中文的字体族，根据不同的系统和使用方式有不同，在ctex宏包及文档下有一些预定义
<img src="http://i.imgur.com/eBwRbYt.png" alt="ctex宏包提供的简化中文字体命令" /></li>
<li>字体命令：

<ol>
<li>\emph表示强调，用于把直立体改为意大利体，把意大利体改为直立体</li>
<li>\underline可以给文字或公式加下划线</li>
</ol>
</li>
<li>基本的LaTeX提供了10个简单的生命是命令调整文字的大小
<img src="http://i.imgur.com/QXMMMsV.png" alt="声明式命令调整文字大小" /></li>
<li>中文字号可以使用ctex宏包或者ctexart等文档类提供的\zihao命令设置
<img src="http://i.imgur.com/H0dDab2.png" alt="中文字号" /></li>
<li>LaTeX中的行距是与字号直接相关的，在设置字号的时候，同时也就设置了基本行距为文字大小的1.2倍</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[FieldBus]]></title>
    <link href="http://suda-morris.github.io/blog/2016/03/09/fieldbus/"/>
    <updated>2016-03-09T11:46:13+08:00</updated>
    <id>http://suda-morris.github.io/blog/2016/03/09/fieldbus</id>
    <content type="html"><![CDATA[<h2>485总线</h2>

<ol>
<li>485，一般称作RS485/EIA-485，是隶属于OSI模型物理层的电气特性规定为2线，半双工，多点通信的标准。它的电气特性和RS-232不一样，用缆线两端的电压差值来表示传递信号。</li>
<li>RS485仅仅规定了接收端和发送端的电气特性，没有规定或推荐任何数据协议，常用的协议是ModBus</li>
<li>RS485的特点：

<ol>
<li>接口电平低，不易损坏芯片。RS485的电气特性：逻辑“1”以两线间的电压差为+(2~6)V表示；逻辑“0”以两线间的电压差为-(2~6)V表示。接口信号电平比RS232降低了，不易损坏接口电路的芯片，且该电平与TTL电平兼容，可方便与TTL电路连接</li>
<li>传输速率高。10米时，RS485的数据最高传输速率可达35Mbps，在1200时传输速率可达100Kbps</li>
<li>抗干扰能力强。RS485接口是采用平衡驱动器和差分接收器的组合，抗共模干扰能力增强，即抗噪声干扰性好</li>
<li>传输距离远，支持节点多。RS485总线最长可以传输1200m以上(速率≤100Kbps)，一般足底啊支持32个节点，如果使用特制的485芯片，可以达到128个或者256个节点，足底啊可以支持到400个节点</li>
</ol>
</li>
<li>RS485推荐使用在点对点网络中，线型，总线型，不能是星型，环形网络。理想情况下RS485需要2个终端匹配电阻，其阻止要求等于传输电缆的特性阻抗，一般为200Ω。没有特性阻抗的话，当左右的设备都静止或者没有能量的时候就会产生噪声，而且线移需要双端的电压差。没有终接电阻的话，会使得较快速的发送端产生多个数据信号的边缘，导致数据传输出错。</li>
<li>推荐的连接方式如下，如果需要添加匹配电阻，一般在总线的起止端加入，也就是主机和设备4上面各加要给120Ω的匹配电阻
<img src="http://i.imgur.com/RlEPFc5.png" alt="RS485连接" /></li>
<li></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[altium_designer]]></title>
    <link href="http://suda-morris.github.io/blog/2016/02/19/altium-designer/"/>
    <updated>2016-02-19T15:12:32+08:00</updated>
    <id>http://suda-morris.github.io/blog/2016/02/19/altium-designer</id>
    <content type="html"><![CDATA[<h2>软件汉化</h2>

<ol>
<li>DXP->Preferences</li>
<li>在System->General中选择Use localized resources复选框</li>
<li>重启软件</li>
</ol>


<h2>恢复桌面布局</h2>

<p>当文件桌面发生混乱时，可通过View->Desktop Layout->Default命令来恢复默认的桌面布局</p>

<h2>公制与英制</h2>

<p>1mil = 1/1000inch = 0.0254mm</p>

<h2>设置图纸格点</h2>

<p>图纸格点设置包括两个方面，一个是图纸的Snap捕捉格点，一个是可视格点，还有一个是电栅格（电气格点）。
1. snap捕捉格点：表示放置线时可以捕捉到放置端点位置的点。
2. 可视格点：表示可见到的网格大小
3. 电栅格：绘制原理图的导线时系统会以电栅格大小为半径，以光标所在位置为中心进行查找电气节点，如果在此范围内有电气节点则光标会自动移动到此电气节点上</p>

<h2>视图的刷新</h2>

<p>绘制原理图时，在完成滚动画面、移动元件等操作后，又会出现画面显示残留的斑点、线段或图形变性等问题。虽然这些内容不会影响电路的正确性，但是为了美观，通过View->Refresh命令可以使显示恢复</p>

<h2>选择一个连接上的所有导线</h2>

<p>选择Edit->Select->Connection命令，将鼠标指针移动到某个连接的导线上，单击，则该连接上的所有导线都被选中，并高亮地显示出来，元器件也被特殊标示出来</p>

<h2>绘制椭圆曲线</h2>

<p>在绘图工具栏中选择绘制椭圆，按Tab键，输入相应的配置参数后在不移动鼠标的情况下连续单击5次</p>

<h2>使用Ultra Librarian软件自动生成原理图库和封装库</h2>

<ol>
<li><a href="http://webench.ti.com/cad/ULib.zip">下载ULib</a>，解压缩后安装</li>
<li>打开软件，Load Data导入bxl文件(芯片厂商提供)</li>
<li>选择输出格式为Altium Designer，然后Export，导出的文件一般放在软件目录的Exported下，比如D:\UltraLibrarian\Library\Exported
<img src="http://i.imgur.com/H9HAk1N.png" alt="数据文件导入" /></li>
<li>进入导出后的文件夹，用altium软件打开PrjScr工程文件</li>
<li>在打开的软件中双击打开UL_Form.pas文件，并运行</li>
<li>紧接着弹出的对话框中，选择导出文件夹下的【日期.txt]格式的文件</li>
<li>完成后会在相同的目录下生成需要的库文件
<img src="http://i.imgur.com/l3Mzy9u.png" alt="使用Altium软件完成余下工作" /></li>
</ol>


<h2>测量距离</h2>

<p>快捷键：Ctrl+M</p>

<h2>Mechanical13和Mechanical15</h2>

<ol>
<li>Mechanical13用于代表元件封装本体外形</li>
<li>Mechanical15用于表示囊括元件外形（包括管脚）所需的最小矩形</li>
</ol>


<h2>从PCB文件生成封装库文件</h2>

<ol>
<li>Altium提供了一个从PCB文件生成封装库文件的功能，该功能自动创建一个封装库并将PCB文件中所有用到的元件封装导入该封装库</li>
<li>方法：在PCB编辑器中单击：Design->Make PCB Library</li>
</ol>


<h2>敷铜</h2>

<ol>
<li>印刷线路板上大面积的敷铜通常有两种，一种用作散热，一种用作屏蔽来减小干扰</li>
<li>大面积敷铜上一般要开窗口（网状），这是由于印刷线路板板材的基板与铜箔之间的粘合剂在浸焊或长时间受热（如波峰焊），会产生挥发性气体无法排出，热量不易散发，以致产生铜箔膨胀、脱落现象。</li>
<li>每个板卡都包含了大量敷铜多边形，在设计时一个方便的管理方法就是把他们堆放在一起，即所谓敷铜搁置，也称敷铜堆放。堆放敷铜多边形不会将他们删除，而是把它们放进PCB文件中保留其完整的定义，但在设计窗口中他们将不再出现。</li>
<li>敷铜管理器：Tool->Polygon Pours->Polygon Manager</li>
</ol>


<h2>PCB的组成部分</h2>

<ol>
<li>元件：用于完成电路功能的各种器件</li>
<li>铜箔：铜箔在电路板上可以表现为导线、焊盘、过孔和敷铜等</li>
<li>丝印层：印刷电路板的顶层，采用绝缘材料制成。在丝印层上可以标注文字，注释电路板上的元件和整个电路板。丝印层还能起到保护顶层导线的功能</li>
<li>印制材料：采用绝缘材料制成，用于支撑整个电路板</li>
</ol>


<h2>PCB的板层</h2>

<ol>
<li>Altium Designer提供堆栈管理器对各层属性进行管理，在堆栈管理器中可以定义层的结构，看到堆栈层的立体效果。选择：Design->Layer Stack Manager</li>
<li>PCB工作层面可以分成以下几种类型：

<ol>
<li>信号层：即为用于建立电气连接的铜箔层</li>
<li>内平面：是专门用于建立电源网络的铜箔，可以算作信号层的一种</li>
<li>机械层：是用于支持电路板的印制材料层</li>
<li>掩膜层：为了方便焊接而设立的

<ol>
<li>Top/Bottom Solder，阻焊层，是指印刷电路板要上绿油的部分。实际上这阻焊层使用的是负片输出，所以在阻焊层的形状映射到板子上以后，并不是上了绿油阻焊，反而是露出了铜皮。所以阻焊层的意思是在整片阻焊的绿油上开窗，目的是允许焊接，默认情况下，没有阻焊层的区域都要上绿油</li>
<li>Top/Bottom Paste，锡膏防护层，这一层只要露出所有需要焊接的焊盘</li>
</ol>
</li>
<li>丝印层：即电路板的说明文字层</li>
<li>其余层

<ol>
<li>Drill Guide和Drill Drawing：用于描述钻孔图及钻孔位置</li>
<li>Keep-out Layer：禁止布线层</li>
<li>Multi-Layer：设置更多层面</li>
</ol>
</li>
</ol>
</li>
</ol>


<h2>电路板物理与电气边界</h2>

<ol>
<li>电路板的物理边界由机械层1来定义</li>
<li>电路板的电气边界由Keep-out层来定义</li>
<li>一般物理边界与电气边界间距50mil即可。比如电路板大小为5000milX4000mil，那么电气边界大小为4900milX3900mil</li>
</ol>


<h2>PCB设计规则(执行菜单命令：Design->Rules)</h2>

<ol>
<li>一般每个特定的网络布线宽度规则需要添加一个规则名称，以便与其他网络区分</li>
<li>通常为了降低布线间的耦合面积，减小干扰，不同层的布线需要设置成不同的走向。如双层板，默认状态下顶层为垂直走向，底层为水平走向。</li>
<li>表贴式焊盘的引出导线一般都是引出一段长度后才开始拐弯，这样就不会出现和相邻焊盘太近的情况</li>
<li>阻焊层扩展

<ol>
<li>通常阻焊层除焊盘或过孔外，整面都铺满阻焊剂。阻焊层的作用就是防止不该被焊上的部分被焊锡连接，回流焊就是靠阻焊层实现的。板子整面经过高温的锡水，没有阻焊层的裸露电路板就被粘锡焊接了，而有阻焊层的部分则不会粘锡。阻焊层的另一个作用是起到提高布线的绝缘性，防氧化和美观</li>
<li>阻焊剂印制到电路板上时，焊盘或过孔被空出，空出的面积要比焊盘或过孔大一些，这就是阻焊层扩展</li>
</ol>
</li>
<li>锡膏防护层扩展

<ol>
<li>表贴式组件在焊接前，先对焊盘涂一层锡膏，然后将组件粘在焊盘上，再用回流焊机焊接。通常在大规模生产时，标贴式焊盘的涂膏是通过一个钢模完成的。钢模上对应焊盘的位置按焊盘形状镂空，涂膏时将钢模覆盖在电路板上，将锡膏放在钢模上，用括板来回括，锡膏通过镂空的部位涂到焊盘上。PCB设计软件的锡膏层或锡膏防护层的数据就是用来制作钢模的，钢模上镂空的面积要比设计焊盘的面积小，这个差值便是锡膏防护层扩展，默认是0mil</li>
</ol>
</li>
<li>在数字电路中，是否为高频电路取决于信号的上升沿和下降沿，而不是信号的频率</li>
<li>当系统工作在50MHz时，将产生传输线效应和信号完整性问题。当系统时钟达到120MHz时，除非使用高速电路设计知识，否则基于传统方法设计的PCB将无法工作。</li>
<li>通常约定如果线传播延时大于数字信号驱动端的上升时间，则认为此类信号是高速信号并产生传输线效应</li>
<li>PCB上每英寸/单位的延时时间为0.167ns，但是如果过孔多，器件引脚多，布线上设置的约束多，延时将增大</li>
<li>如果采用CMOS或TTL电路进行设计，工作频率小于10MHz时，布线长度应不大于7in。工作频率在50MHz以上时，布线长度应不大于1.5in。如果工作频率达到或超过75MHz时，布线长度应在1in。对于GaAs芯片最大的布线长度应为0.3in。</li>
<li>解决传输线效应的另一个方法是选择正确的布线路径和终端拓扑结构。走线的拓扑结构是指一根网线的布线顺序以及布线结构。当使用告诉逻辑器件的时候，除非走线分支长度保持很短，否则边沿快速变化的信号将被信号主干走线上的分支走线所扭曲。通常情形下，PCB走线采用两种基本拓扑结构，即<strong>菊花形</strong>布线和<strong>星形</strong>布线。</li>
<li>对于菊花形布线，布线从驱动端开始，一次到达各接收端。如果使用串联电阻来改变信号特性，串联电阻的位置应该紧靠驱动端。在控制走线的高次谐波干扰方面，菊花链走线效果最好。</li>
<li>星形拓扑结构可以有效避免时钟信号的不同步问题，但在密度很高的PCB上手工完成布线十分困难。采用自动布线器是完成星形布线的最好方法。每条分支上都需要终端电阻。终端电阻的阻值应和连线的特征阻抗相匹配。</li>
<li>等长网络布线规则也称为匹配网络长度规则，用于设置指定网络等长布线规则。该规则以规定范围中的最长布线为基准，使其他网络通过匹配调整操作，以增长布线的形式在设定的公差范围内与之等长。增长的布线按设定的迂回模式（折现模式）进行布线。</li>
<li>在高速PCB设计时，设计者总是希望过孔越小越好，这样板上就可以有更多的布线空间。此外，过孔越小，其自身的寄生电容也越小，更适合用于高速电路。但孔尺寸的减小同时带来了成本的增加。当孔的深度超过钻孔直径的6倍时，就无法保证孔壁能均匀镀铜。随着激光钻孔技术的发展，钻孔的尺寸越来越小，一般直径小于等于6mil的过孔称为微孔。</li>
<li>过孔在传输线上表现为阻抗不连续的断点，会造成信号的反射。一般过孔的等效阻抗比传输线低12%左右。但过孔因为阻抗不连续而造成的反射其实是微乎其微的，其反射系数仅为0.06，过孔产生的问题更多的集中在寄生电容和电感的影响。过孔的寄生电容会给电路造成的主要影响是延长了信号的上升时间，降低了电路的速度。</li>
<li>在实际设计中可以通过增大过孔和敷铜区的距离或者减小焊盘的直径来减小寄生电容</li>
<li>在高速数字电路的设计中，过孔的寄生电感带来的危害往往大于寄生电容的影响。它的寄生串联电感会削弱旁路电容的贡献，减弱整个电源系统的滤波效用。</li>
<li>如果要在PCB文件中有几个电源和地线，则需要建立布线类规则来增加电源和地线的宽度</li>
</ol>


<h2>添加泪滴及敷铜</h2>

<ol>
<li>添加泪滴是指在导线与焊盘/过孔的链接处添加一段过渡铜箔，过渡铜箔呈现泪滴状。泪滴的作用是增加焊盘/过孔的机械强度，避免应力集中在导线与焊盘/过孔的连接处，而使连接处断裂或焊盘/过孔脱落。单击Tools->Teardrops</li>
<li>网格状填充区又称敷铜，敷铜就是将电路板中空白的地方铺满铜箔，添加敷铜不仅仅是为了好看，最主要的目的是提高电路板的抗干扰能力，起到屏蔽外界干扰的效果，通常将敷铜接地，这样电路板中空白的地方就铺满了接地的铜箔。</li>
</ol>


<h2>修改PCB的形状大小</h2>

<ol>
<li>在PCB页面用Keep-Out Layer画出所需板子的大小形状，必须是封闭的形状</li>
<li>选中画出的这些封闭的框框</li>
<li>Design->Board Shape->Define from selected objects</li>
</ol>


<h2>PCB Logo制作</h2>

<ol>
<li>DXP->Run Script</li>
<li>选择PCB Logo Creator下的工程文件
<img src="http://i.imgur.com/1NjlZbw.png" alt="PCB Logo Creator脚本工程" /></li>
<li>选择RunConverterScript，点击OK
<img src="http://i.imgur.com/BXtrhYj.png" alt="选择bmp图片开始转换" /></li>
<li>点击Load选择需要使用的bmp位图</li>
<li>选择好丝印层，点击Convert，等待转换结束</li>
</ol>


<h2>硬件构件化电路原理图绘制的规则</h2>

<ol>
<li>硬件构建分类

<ol>
<li>核心构件：只提供接口，没有需求接口，比如芯片的硬件最小系统</li>
<li>中间构件：既有需求接口，又有提供接口，比如232电平转换构件</li>
<li>终端构件：只有需求接口，比如LCD构件</li>
</ol>
</li>
<li>通用规则

<ol>
<li>元器件命名格式

<ol>
<li>核心构件：其元器件直接编号命名，同种类型的元件命名时冠以相同的字母前缀，如R1，R2</li>
<li>中间构件和终端构件：元器件命名格式采用“构件名-标志字符？”，例如LCD构件中所有的电阻名称统一为“LCD-R”</li>
</ol>
</li>
<li>为硬件构件添加详细的文字描述</li>
<li>将前两歩产生的内容封装在一个虚线框内，组成硬件构件的内部实体</li>
<li>为该硬件构件添加与其他构件交互的输入、输出接口标识。接口标识有两种

<ol>
<li>接口注释：位于虚线框内，是为构件接口所作的解释性文字，采用斜体</li>
<li>接口网标：位于虚线框外，具有电气特性</li>
</ol>
</li>
</ol>
</li>
<li>核心构件设计规则

<ol>
<li>核心构件的接口标识均为网标，若同意引脚具有不同功能，则接口网标依据第一功能选项命名</li>
</ol>
</li>
<li>中间构件设计规则

<ol>
<li>描述需求接口采用接口注释，描述提供接口采用接口网标</li>
<li>直观起见，将构件的需求接口放置在构件实体的左侧，提供接口放置在右侧</li>
<li>接口网标的命名规则是：构件名称-引脚信号/功能名称</li>
<li>接口注释名称前的构件名称可有可无</li>
</ol>
</li>
<li>终端构件设计规则

<ol>
<li>接口标识均为斜体标注的接口注释</li>
</ol>
</li>
</ol>


<h2>布线总结</h2>

<ol>
<li>按小键盘的*键或大键盘的数字2键添加一个过孔</li>
<li>按L键可以切换布线层</li>
<li>按数字3可设定最小线宽、典型线宽、最大线宽的值进行切换</li>
<li>差分布线

<ol>
<li>差分网络是两条存在耦合的传输线，一天携带信号，另一条则携带它的互补信号。使用差分对布线前要对设定差分对网络进行设置。设置可以在原理图中设置，也可以在PCB中进行设置</li>
<li>原理图中添加差分对规则:在命名差分对网络时，必须保证网络名的前缀是一样的，后缀中用下划线带一个N和一个P字母即可。命名好之后，点击菜单Place->Directives->DifferentialPair命令，在差分对上放置两个差分图标</li>
</ol>
</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android]]></title>
    <link href="http://suda-morris.github.io/blog/2016/01/20/android/"/>
    <updated>2016-01-20T18:01:40+08:00</updated>
    <id>http://suda-morris.github.io/blog/2016/01/20/android</id>
    <content type="html"><![CDATA[<h2>Android系统架构图</h2>

<p><img src="http://i.imgur.com/fNWm4KQ.png" alt="Android系统架构" /></p>

<ol>
<li>应用程序框架

<ol>
<li>Activity Manager：管理各个应用程序生命周期以及通常的导航回退功能</li>
<li>Window Manager：管理所有的窗口程序</li>
<li>Content Provider：使得不同应用程序之间存取或者分享数据</li>
<li>View System：构建应用程序的基本组件</li>
<li>NotificationManager：使得应用程序可以在状态栏中显示自定义的提示信息</li>
<li>Package Manager：Android系统内的程序管理</li>
<li>TelephonyManager：管理所有的移动设备功能</li>
<li>Resource Manager：提供应用程序使用的各种非代码资源，如本地化字符串、图片、布局文件、颜色文件等</li>
<li>LocationManager：提供位置服务</li>
<li>XMPP Service：提供GoogleTalk服务</li>
</ol>
</li>
<li>系统运行库分成两个部分，分别是系统库和Android运行时。

<ol>
<li>系统库是应用程序框架的支撑，是连接应用程序框架层与Linux内核层的重要纽带。

<ol>
<li>Surface Manager：执行多个应用程序的时候，负责管理显示与存取操作间的互动，另外也负责2D绘图与3D绘图进行显示合成</li>
<li>Media Framework：多媒体库，基于PacketVideo OpenCore；支持多种常用的音频、视频格式录制和回放，编码格式包络MPEG4、MP3、H.264、AAC、ARM</li>
<li>SQLite：小型的关系型数据库引擎</li>
<li>OpenGL|ES：根据OpenGLES1.0API标准实现的3D绘图函数库</li>
<li>FreeType：提供点阵字与向量字的描绘与显示</li>
<li>WebKit：一套网页浏览器的软件引擎</li>
<li>SGL：底层的2D图形渲染引擎</li>
<li>SSL:在Android上通信过程中实现握手</li>
<li>Libc：从BSD继承来的标准C系统函数库，专门为基于embedded linux的设备定制</li>
</ol>
</li>
<li>Android运行时，程序在Android运行时中执行，其运行分为核心库和Dalvik虚拟机两部分

<ol>
<li>核心库：核心库提供了Java语言API中的大多数功能，同时也包含了Android的一些核心API，如android.os、android.net、android.media等等</li>
<li>Dalvik虚拟机：Android程序不同于J2ME程序，每个Android应用程序都有一个专有的进程，并且不是多个程序运行在一个虚拟机中，而是每个Android程序都有一个Dalvik虚拟机的实例，并在该实例中执行。Dalvik虚拟机是一种基于寄存爱的Java虚拟机，而不是传统的基于栈的虚拟机，并进行了内存资源使用的优化，以及支持多个虚拟机的特点。需要注意，不同于J2ME，Android程序在虚拟机中执行的并非编译后的字节码，而是通过转换工具dx将java字节码转换成dex格式的中间码</li>
</ol>
</li>
</ol>
</li>
</ol>


<h2>Adnroid UI基础</h2>

<ol>
<li>Android UI由View和ViewGroup组成，ViewGroup是不可见的，用于组织和排版View和ViewGroup。View显示用户内容，以及相应用户的操作。Android UI可以在code中生产，不过更加方便的方式是在Android的XML文件中定义UI</li>
<li>可以通过2种方式定义界面结构，一种是在XML中定义视图结构，另一种是在运行时动态创建视图结构，

<ol>
<li>通过XML定义视图结构，可以有效做到代码与界面的分离，并且提高界面的可读性。XML的文件西部包含一个root，可以是View或者ViewGroup。在节点下面增加子界面的方式来构造界面结构</li>
<li>在编译阶段，所有的XML layout文件都会编译到一个统一的View资源里面，在需要使用layout资源的时候，需要将资源加载到程序中，一般做法是在Activity.onCreate()中做加载的资源操作</li>
</ol>
</li>
<li>每一个View或者ViewGroup都有一个ID属性，该属性由class View定义。其定义语法为：android:id=&ldquo;@+id/my_button"。

<ol>
<li>@的意思是指示XML parser解析并且展开后面的内容，将其作为一个ID的资源</li>
<li>+的意思是指示这是一个新的ID，需要将其加到资源定义文件R.java中去。有一些系统自定的ID，如果引用这些系统自定的ID，则不需要加+号，但是要加上包的命名空间，其定义非语法为：android：id=“@android：id/empty”</li>
</ol>
</li>
<li>在XML文件中，通常使用layout_something来定义View在ViewGroup中的位置。ViewGroup类会实现一个嵌套类来扩展ViewGroup.LayoutParms。这个内嵌的子类会定义类型来指定字View的位置和大小。每个view group一般都会包含width和height参数，因此每个在其内部的view都需要定义这两个属性。一般不会将其指定为某一个宽度或者高度，一般写为相对的，这样可以保证适用于多种屏幕大小的设备。其中，wrap_content会根据内容的大小来调节大小。fill_parent，最大化达到父几点所允许的，在API level8后名字改为match_parent</li>
<li>View作为一个几何图形，具有4个属性对应于它所属的容器，分别是left，top，width和height，每个属性的单位是pixel。参考API文档，可以很多函数获取位置以及View的大小信息。getLeft()，getTop(),getRight(),getBottom()。获取的值一本都是相对应与父节点的位置和大小信息。Padding是内容与View空间直接的间隔。View并未提供Margin属性，该属性一般由ViewGroup设置</li>
<li>如果需要在界面上显示的内容是动态获取的话，可以使用Adapter和继承AdapterView的View来动态显示。Adapter是数据源和AdapterView之间的桥梁，由它从数据源获取数据，然后转换为一组实体，填充到View</li>
<li>可以简单的使用继承自AdapterView的View来绑定Adapter，来获取外部数据源的数据。Android也提供了一些继承自Adapter的子类用于处理不同的数据形式来建立View，下面是三种比较常见的Adapter：

<ol>
<li>ArrayAdapter，当数据源是一个数组的时候，可以使用这个Adapter，默认，ArrayAdapter在调用toString()后会为每个Item创建一个TextView</li>
<li>SimpleCursorAdapter，如果数据源是来自于游标的时候，使用这个Adapter。使用这个Adapter的时候，需要指定Cursor的哪个行，哪个列插入Layout的View</li>
</ol>
</li>
<li>可以通过实现AdapterView.OnItemClickListener接口来让AdapterView响应点击事件</li>
</ol>


<h2>Android开发中高效的数据结构</h2>

<ol>
<li>SimpleArrayMap与ArrayMap

<ol>
<li>实质上ArrayMap继承自SimpleArrayMap，主要是为了实现像HashMap一样的api方法，让习惯使用HashMap的开发者感觉不到差异，本质上是SimpleArrayMap+Map的再封装。一般来说使用这两个类来代替HashMap，因为它们比HashMap更加高效，也对内存进行了优化</li>
</ol>
</li>
<li>SparseArray与SparseArrayCompat和LongSparseArray

<ol>
<li>这3个类中，前2个基本上是同一类，只不过第二个类有removeAt方法，第三个是Long类型的。这3个类也是用来代替HashMap，只不过它们的键的类型是整形Integer或者Long类型，在实际开发中，如月份缩写的映射，或者进行文件缓存映射，viewHolder都特别适用</li>
</ol>
</li>
<li>AtomicFile

<ol>
<li>AtomicFile首先不是用来代替File的，而是作为File的辅助类存在，AtomicFile的作用是实现事务性原子操作，即文件读写必须完整，适合多线程中的文件读写操作</li>
</ol>
</li>
</ol>


<h2>Intent</h2>

<ol>
<li>Intent是不同组件中提供运行时绑定的对象。Intent代表一个应用“想去做什么事情”，你可以用它做各种各样的任务，不过大部分的时候他们被用来启动另一个Activity。</li>
<li>在Activity之间传递数据包Bundle</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">//发送端</span>
</span><span class='line'><span class="n">Bundle</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Bundle</span><span class="o">();</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span><span class="s">&quot;morris&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="s">&quot;age&quot;</span><span class="o">,</span><span class="mi">20</span><span class="o">);</span>
</span><span class='line'><span class="n">intent</span><span class="o">.</span><span class="na">putExtras</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'><span class="c1">//接收端</span>
</span><span class='line'><span class="n">Bundle</span> <span class="n">data</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getExtras</span><span class="o">();</span>
</span><span class='line'><span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">);</span>
</span><span class='line'><span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;age&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>在Activity之间传递值对象</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/*方法1，使用Java的序列化，效率比较低*/</span>
</span><span class='line'><span class="c1">//前提要求User类实现Serializable接口</span>
</span><span class='line'><span class="c1">//发送端</span>
</span><span class='line'><span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span><span class="k">new</span> <span class="nf">User</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span><span class="mi">20</span><span class="o">));</span>
</span><span class='line'><span class="c1">//接收端</span>
</span><span class='line'><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span><span class="n">intent</span><span class="o">.</span><span class="na">getSerializableExtra</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*方法2，使用Android的Parcelable，效率比较高*/</span>
</span><span class='line'><span class="c1">//前提要求User类实现了Parcelable接口,并且重写了writeToParcel方法来手动实现序列化</span>
</span><span class='line'><span class="c1">//在User类中实现方法</span>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeToParcel</span><span class="o">(</span><span class="n">Parcel</span> <span class="n">dest</span><span class="o">,</span><span class="kt">int</span> <span class="n">flags</span><span class="o">){</span>
</span><span class='line'>  <span class="n">dest</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">getName</span><span class="o">());</span>
</span><span class='line'>  <span class="n">dest</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">getAge</span><span class="o">());</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c1">//在User类中实现常量对象CREATOR</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Creator</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">CREATOR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CREATOR</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(){</span>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">User</span> <span class="nf">createFromParcel</span><span class="o">(</span><span class="n">Parcel</span> <span class="n">source</span><span class="o">){</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">User</span><span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">readString</span><span class="o">(),</span><span class="n">source</span><span class="o">.</span><span class="na">readInt</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">User</span><span class="o">[]</span> <span class="nf">newArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">){</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="n">User</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c1">//发送端</span>
</span><span class='line'><span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span><span class="k">new</span> <span class="nf">User</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span><span class="mi">20</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//接收端</span>
</span><span class='line'><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>获取Activity的返回参数</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">//发送端</span>
</span><span class='line'><span class="n">startActivityForResult</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span><span class="n">requestCode</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onActivityResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span><span class="n">Intent</span> <span class="n">data</span><span class="o">){</span>
</span><span class='line'>  <span class="kd">super</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span><span class="n">resultCode</span><span class="o">,</span><span class="n">data</span><span class="o">);</span>
</span><span class='line'>  <span class="c1">//ToDo</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c1">//接收端</span>
</span><span class='line'><span class="n">setResult</span><span class="o">(</span><span class="n">resultCode</span><span class="o">,</span><span class="n">intent</span><span class="o">);</span>
</span><span class='line'><span class="n">finish</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>隐式Intent

<ol>
<li>在AndroidManifest文件中，为activity添加<intent-filter>标签，并为其指名category和action</li>
</ol>
</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;</span><span class="n">category</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.intent.category.DEFAULT&quot;</span><span class="o">/&gt;</span> <span class="c1">//表示该intent-filter的行为方式是activity</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">action</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;字符串A&quot;</span><span class="o">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>2. 然后在创建Intent实例的时候把“字符串A”传入构造函数
3. 一般来说，字符串A约定的格式为：包名.intent.action.类名
4. 通过这种方式能够访问其他应用中的activity，但是如果在activity的标签中指名`android:exported="false"`的话，别的应用便无法访问该activity
</code></pre>

<h2>Activity的启动模式</h2>

<ol>
<li>在AndroidManifest文件中，为activity添加参数：android:lanuchMode=&ldquo;standard"。在standard启动模式中，所有实例放入同一个任务栈，因此支持后退键导航</li>
<li>在AndroidManifest文件中，为activity添加参数：android:lanuchMode=&ldquo;singleTop"。singleTop模式和standard模式都会将intent发送给新的实例，不过，singleTop要求如果创建intent的时候栈顶已经有了要创建的Activity的实例，则将intent发送给该实例，而不创建新的实例。singleTop模式，可用来解决栈顶多个重复相同的Activity的问题。如果是A activity跳转到B activity，在跳转到A activity，行为就和standard模式一样了，会在B activity跳转到A activity的时候创建A activity的新实例，因为当时的栈顶不是A activity实例。</li>
<li>在AndroidManifest文件中，为activity添加参数：android:lanuchMode=&ldquo;singleTask"。当intent到来，需要穿件singleTask模式Activity的时候，系统会检查任务栈里面是否已经有该Activity的实例，如果有直接将intent发送给它。</li>
<li>在AndroidManifest文件中，为activity添加参数：android:lanuchMode=&ldquo;singleInstance"。<strong>一个任务栈只包括一个activity</strong>。比如有A，B，C三个Activity，其中B为sigleInstance模式，他们之间的跳转关系是A->B->C，现在在C中按下返回键，由于B位于独立的task中，它不属于C的上下文activity，所以此时直接返回到A中。</li>
</ol>


<h2>Get a string resource from you app&rsquo;s Resources</h2>

<blockquote><p>String hello = getResources().getString(R.string.hello_world);</p></blockquote>

<h2>Toast使用方法</h2>

<blockquote><p>Toast.makeText(activity对象，“显示内容”，Toast.LENGTH_SHORT).show();</p></blockquote>

<h2>适配不同的屏幕</h2>

<ol>
<li>安卓设备的屏幕的分类指标：大小(size)和分辨率(density)</li>
<li>有四种size：small，normal，large，xlarge</li>
<li>有四种density：low（ldpi），medium（mdpi），high（hdpi），extra high（xhdpi）</li>
<li>每份图片需要四种分辨率的备份，比如，如果你为xhdpi设备生成一张200X200的照片，同样，你需要为hdpi设备生成150X150的照片，为mdpi设备生成100X100的照片，为ldpi设备生成75X75的照片

<ol>
<li>xhdpi：2.0</li>
<li>hdpi：1.5</li>
<li>mdpi：1.0（baseline）</li>
<li>ldpi：0.75</li>
</ol>
</li>
<li>一般来说，ldpi的素材是可以不需要的，因为如果你提供了hdpi的素材，系统会自动将它缩小一半来适应ldpi的设备</li>
</ol>


<h2>Activity的生命周期</h2>

<p><img src="http://i.imgur.com/gzlBPwv.png" alt="Activity生命周期" /></p>

<ol>
<li>onPause主要完成的工作（为了快速切换到下一个Activity，这个函数里面的操作内容应该尽量简单些）

<ol>
<li>停止动画或者其他正在消耗CPU的动作</li>
<li>提交未保存的变化，比如草稿邮件</li>
<li>释放系统资源，包括broadcast receiver，传感器句柄等</li>
</ol>
</li>
<li>onStop函数用来执行占用CPU大的shut-down操作，比如往数据库中写入数据</li>
</ol>


<h2>Context</h2>

<ol>
<li>它是用来访问全局信息（比如，应用程序的资源）的接口，一些常用的资源都会实现Context，这样就可以方便访问资源</li>
<li>System.out.println(R.string.hello_world)等同于System.out.println(getContext().getResources().getText(R.string.hello_world));</li>
</ol>


<h2>Application</h2>

<ol>
<li>安装一个app应用后可以在桌面上显示多个应用图标(即同一个应用程序有多个主Activity)，那是因为在Manifest文件中设置了多个activity的category为android.intent.category.LAUNCHER，action为android.intent.category.LAUNCHER。但是这几个应用同属于一个Application，表现为在Manifest文件中，这些activity在同一个application标签下。</li>
<li>在Manifest文件中，为application标签设置属性name,其值为一个继承自Application的某个自定义类，这样在任意一个activity中可以通过getApplicationContext来获取该自定义Application类的实例。从某种意义上来说，该自定义Appliacation类中的资源可以更加方便的为全局共享，里面可以存放一些全局的逻辑资源（区别于UI的资源）</li>
<li>Application的生命周期相关的方法

<ol>
<li>onCreate，创建Application的时候调用，先于activity的onCreate</li>
<li>onTerminate，结束后调用</li>
<li>onLowMemory，低内存时候调用</li>
<li>onTrimMemory，操作系统内存整理的时候调用</li>
<li>onConfigurationChanged，配置改变的时候调用</li>
</ol>
</li>
</ol>


<h2>Service</h2>

<ol>
<li>启动服务：startService，service内部会执行onStartCommand</li>
<li>停止服务：stopService</li>
<li>绑定服务：bindService</li>
<li>解绑服务：unbindService</li>
<li>当activity与service绑定后，如果activity退出，响应的service也会停止。即service的生命周期伴随着activity的存在于消亡。若是是使用startService来启动service的话，service的生命将会独立于activity，只有通过调用stopService才能将其停止。当startService与bindService都调用了的话，若想退出服务，unbindService与stopService都必须执行</li>
<li>同一个service只会创建1次</li>
</ol>


<h2>普通辅线程不允许修改UI线程中的资源！</h2>

<h2>AIDL(Android Interface Definition Language)</h2>

<ol>
<li></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jetbrains]]></title>
    <link href="http://suda-morris.github.io/blog/2016/01/20/jetbrains/"/>
    <updated>2016-01-20T11:27:47+08:00</updated>
    <id>http://suda-morris.github.io/blog/2016/01/20/jetbrains</id>
    <content type="html"><![CDATA[<h2>如何破解DataGrid</h2>

<blockquote><p>启动，在要求输出注册码的界面选<code>License server</code>输入<code>http://idea.lanyus.com/</code>，点击OK，快速激活</p></blockquote>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android_Studio]]></title>
    <link href="http://suda-morris.github.io/blog/2016/01/19/android-studio/"/>
    <updated>2016-01-19T10:06:41+08:00</updated>
    <id>http://suda-morris.github.io/blog/2016/01/19/android-studio</id>
    <content type="html"><![CDATA[<h2>最新安装的Android Studio打开软件特别慢，总是卡在“Fetching Android SDK component information”，如何解决？</h2>

<ol>
<li>进入Android Studio的安装目录下的bin目录，找到idea.properties文件，用文本编辑器打开</li>
<li>在idea.properties文件末尾天剑一行：disable.android.first.run=true,然后保存文件</li>
<li>关闭Android Studio后重新启动</li>
</ol>


<h2>给Android Studio安装Genymotion插件</h2>

<ol>
<li>File->Settings</li>
<li>找到plugins设置项，点击Browser，输入：genymotion关键字，安装相应插件</li>
<li>重启android studio后，点击Genymotion插件的图标，设置Genymotion在本地的路径，完成后就告成</li>
</ol>


<h2>设置自动导入依赖包</h2>

<ol>
<li>File->Settings->Editor</li>
<li>找到Auto Import选项，使能：show import popup，Optimize imports on the fly，Add unambiguous imports on the fly</li>
</ol>


<h2>常用功能</h2>

<ol>
<li>Gradle同步，在项目运行或者更改Gradle配置的时候都要点击下这个按钮，会下载相应的依赖</li>
<li>AVD Manager，模拟器管理</li>
<li>SDK Manager，管理SDK版本</li>
<li>DDMS即Dalvik Debug Monitor Service，Dalvik调试监控服务</li>
</ol>


<h2>Gradle</h2>

<ol>
<li>Gradle是一种依赖管理工具，基于Groovy语言，面向Java应用为主，它抛弃了基于XML的各种繁琐配置，而取而代之的是一种基于Groovy的内部领域特定（DSL）语言</li>
<li>Android Studio中新建项目成功后会自动下载Gradle，Windows下回安装到：C:\Documents and Settings\&lt;用户名>.gradle\wrapper\dists 目录</li>
<li>命令行Gradle编译过程

<ol>
<li>切换到项目根目录，执行./gradlew -v来查看项目所用的Gradle版本，如果是第一次执行，将会去下载Gradle</li>
<li>接着执行./gradlew clean，清除项目根目录/app目录下的build文件夹</li>
<li>最后执行./gradlew build,检查依赖，直接编译生成相应的apk文件。接着在项目根目录/app/build/outputs/apk目录下会看到类似于app-debug-unaligned.apk，app-release-unsigned.apk等，unaligned代表没有进行zip优化的，unsigned代表没有签名的。</li>
<li>gradlew build命令吧debug、release环境的包都打出来，如果正式发布只需要打Release的包，就需要这样使用：

<ol>
<li>./gradlew assembleDebug编译并打Debug包</li>
<li>./gradlew assembleRelease编译并打Release包</li>
</ol>
</li>
<li>除此以外，assemble除了能和BuildType结合外还能和ProductFlavor结合，实质上，assemble是和Build Variants一起结合使用的，而Build Variants=Build Type + Product Flavor，例如如果想打包豌豆荚渠道的release版本，执行如下命令：<code>./gradle assembleWandoujiaRelease</code>,如果只打豌豆荚渠道的版本，则：<code>./gradle assembleWandoujia</code></li>
</ol>
</li>
<li>与Gradle相关的几个文件

<ol>
<li>项目根目录/app/build.gradle,这个文件是app文件下下这个Module的gradle配置文件，在里面会指明要编译成安卓的应用程序（com.android.application）还是库（com.android.library）；指明编译SDK的版本，build tools的版本（根据实际开发者已经下载好的版本来修改），指明应用的包名，支持的最小的SDK版本，目标SDK版本，要编译在lib目录下的哪些jar包。</li>
<li>项目根目录/build.gradle，这个文件是整个项目的基础配置文件，内容主要包括两个方面，一个是声明仓库的源，一般是jcenter，jcenter可以理解成是一个新的中央远程仓库，兼容maven中心仓库，而且性能更优。另一个是声明了android gradle plugin的版本</li>
<li>项目根目录/settings.gradle，这个文件是全局的项目配置文件，里面主要声明一些需要加入gradle的module，例如：<code>include ':app', ':extras:ShimmerAndroid'</code>,文件中的app，extra：ShimmerAndroid都是module，如果还有其他module都需要按照如上格式加进去</li>
</ol>
</li>
<li>完整的gradle脚本</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">apply</span> <span class="nl">plugin</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="n">android</span><span class="p">.</span><span class="n">application</span><span class="err">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">def</span> <span class="n">releaseTime</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">new</span> <span class="n">Date</span><span class="p">().</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;yyyy-MM-dd&quot;</span><span class="p">,</span> <span class="n">TimeZone</span><span class="p">.</span><span class="n">getTimeZone</span><span class="p">(</span><span class="s">&quot;UTC&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">android</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">compileSdkVersion</span> <span class="mi">21</span>
</span><span class='line'>    <span class="n">buildToolsVersion</span> <span class="err">&#39;</span><span class="mf">21.1.2</span><span class="err">&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">defaultConfig</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">applicationId</span> <span class="s">&quot;com.boohee.*&quot;</span>
</span><span class='line'>        <span class="n">minSdkVersion</span> <span class="mi">14</span>
</span><span class='line'>        <span class="n">targetSdkVersion</span> <span class="mi">21</span>
</span><span class='line'>        <span class="n">versionCode</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">versionName</span> <span class="s">&quot;1.0&quot;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// dex突破65535的限制</span>
</span><span class='line'>        <span class="n">multiDexEnabled</span> <span class="nb">true</span>
</span><span class='line'>        <span class="c1">// 默认是umeng的渠道</span>
</span><span class='line'>        <span class="n">manifestPlaceholders</span> <span class="o">=</span> <span class="p">[</span><span class="nl">UMENG_CHANNEL_VALUE</span><span class="p">:</span> <span class="s">&quot;umeng&quot;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">lintOptions</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">abortOnError</span> <span class="nb">false</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">signingConfigs</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// No debug config</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">release</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">storeFile</span> <span class="n">file</span><span class="p">(</span><span class="s">&quot;../yourapp.keystore&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="n">storePassword</span> <span class="s">&quot;your password&quot;</span>
</span><span class='line'>            <span class="n">keyAlias</span> <span class="s">&quot;your alias&quot;</span>
</span><span class='line'>            <span class="n">keyPassword</span> <span class="s">&quot;your password&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">buildTypes</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 显示Log</span>
</span><span class='line'>            <span class="n">buildConfigField</span> <span class="s">&quot;boolean&quot;</span><span class="p">,</span> <span class="s">&quot;LOG_DEBUG&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">versionNameSuffix</span> <span class="s">&quot;-debug&quot;</span>
</span><span class='line'>            <span class="n">minifyEnabled</span> <span class="nb">false</span>
</span><span class='line'>            <span class="n">zipAlignEnabled</span> <span class="nb">false</span>
</span><span class='line'>            <span class="n">shrinkResources</span> <span class="nb">false</span>
</span><span class='line'>            <span class="n">signingConfig</span> <span class="n">signingConfigs</span><span class="p">.</span><span class="n">debug</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">release</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 不显示Log</span>
</span><span class='line'>            <span class="n">buildConfigField</span> <span class="s">&quot;boolean&quot;</span><span class="p">,</span> <span class="s">&quot;LOG_DEBUG&quot;</span><span class="p">,</span> <span class="s">&quot;false&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">minifyEnabled</span> <span class="nb">true</span>
</span><span class='line'>            <span class="n">zipAlignEnabled</span> <span class="nb">true</span>
</span><span class='line'>            <span class="c1">// 移除无用的resource文件</span>
</span><span class='line'>            <span class="n">shrinkResources</span> <span class="nb">true</span>
</span><span class='line'>            <span class="n">proguardFiles</span> <span class="n">getDefaultProguardFile</span><span class="p">(</span><span class="err">&#39;</span><span class="n">proguard</span><span class="o">-</span><span class="n">android</span><span class="p">.</span><span class="n">txt</span><span class="err">&#39;</span><span class="p">),</span> <span class="err">&#39;</span><span class="n">proguard</span><span class="o">-</span><span class="n">rules</span><span class="p">.</span><span class="n">pro</span><span class="err">&#39;</span>
</span><span class='line'>            <span class="n">signingConfig</span> <span class="n">signingConfigs</span><span class="p">.</span><span class="n">release</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">applicationVariants</span><span class="p">.</span><span class="n">all</span> <span class="p">{</span> <span class="n">variant</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="n">variant</span><span class="p">.</span><span class="n">outputs</span><span class="p">.</span><span class="n">each</span> <span class="p">{</span> <span class="n">output</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="n">def</span> <span class="n">outputFile</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">outputFile</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="n">outputFile</span> <span class="o">!=</span> <span class="n">null</span> <span class="o">&amp;&amp;</span> <span class="n">outputFile</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">endsWith</span><span class="p">(</span><span class="err">&#39;</span><span class="p">.</span><span class="n">apk</span><span class="err">&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                        <span class="c1">// 输出apk名称为boohee_v1.0_2015-01-15_wandoujia.apk</span>
</span><span class='line'>                        <span class="n">def</span> <span class="n">fileName</span> <span class="o">=</span> <span class="s">&quot;boohee_v${defaultConfig.versionName}_${releaseTime()}_${variant.productFlavors[0].name}.apk&quot;</span>
</span><span class='line'>                        <span class="n">output</span><span class="p">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">new</span> <span class="n">File</span><span class="p">(</span><span class="n">outputFile</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 友盟多渠道打包</span>
</span><span class='line'>    <span class="n">productFlavors</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">wandoujia</span> <span class="p">{}</span>
</span><span class='line'>        <span class="n">_360</span> <span class="p">{}</span>
</span><span class='line'>        <span class="n">baidu</span> <span class="p">{}</span>
</span><span class='line'>        <span class="n">xiaomi</span> <span class="p">{}</span>
</span><span class='line'>        <span class="n">tencent</span> <span class="p">{}</span>
</span><span class='line'>        <span class="n">taobao</span> <span class="p">{}</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">productFlavors</span><span class="p">.</span><span class="n">all</span> <span class="p">{</span> <span class="n">flavor</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="n">flavor</span><span class="p">.</span><span class="n">manifestPlaceholders</span> <span class="o">=</span> <span class="p">[</span><span class="nl">UMENG_CHANNEL_VALUE</span><span class="p">:</span> <span class="n">name</span><span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">dependencies</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">compile</span> <span class="n">fileTree</span><span class="p">(</span><span class="nl">dir</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">libs</span><span class="err">&#39;</span><span class="p">,</span> <span class="nl">include</span><span class="p">:</span> <span class="p">[</span><span class="err">&#39;</span><span class="o">*</span><span class="p">.</span><span class="n">jar</span><span class="err">&#39;</span><span class="p">])</span>
</span><span class='line'>    <span class="n">compile</span> <span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="n">android</span><span class="p">.</span><span class="nl">support</span><span class="p">:</span><span class="n">support</span><span class="o">-</span><span class="nl">v4</span><span class="p">:</span><span class="mf">21.0.3</span><span class="err">&#39;</span>
</span><span class='line'>    <span class="n">compile</span> <span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="nl">jakewharton</span><span class="p">:</span><span class="nl">butterknife</span><span class="p">:</span><span class="mf">6.0.0</span><span class="err">&#39;</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[nRF51822]]></title>
    <link href="http://suda-morris.github.io/blog/2016/01/11/nrf51822/"/>
    <updated>2016-01-11T11:41:13+08:00</updated>
    <id>http://suda-morris.github.io/blog/2016/01/11/nrf51822</id>
    <content type="html"><![CDATA[<h2>nRF51822介绍</h2>

<p><img src="http://i.imgur.com/W7Ksvm4.jpg" alt="nRF51822引脚图" /></p>

<ol>
<li>通信距离30m（条件:空旷区域/1M速率）</li>
<li>工作频段：2.4GHz</li>
<li>工作电压：2.0V~3.6V</li>
<li>nRF51822整合了Nordic一流的无线传送器，同时支持BLE和专用的2.4GHz蓝牙协议栈</li>
<li>基本情况：

<ol>
<li>2.4GHz多协议无线射频</li>
<li>32位ARM CortexM0 处理器</li>
<li>128位AES硬件加密处理器</li>
<li>256KB Flash，32KB RAM(最新的QF AC版本)</li>
<li>可编程外设接口PPI</li>
<li>全功能数字接口：SPI、I2C、UART</li>
<li>10位ADC</li>
<li>可编程的输出功率+4dBm到-20dBm</li>
<li>应用开发和协议栈完全独立</li>
<li>固定的系统时钟：16MHz</li>
</ol>
</li>
<li>参考资料：

<ol>
<li><a href="http://infocenter.nordicsemi.com/index.jsp">参考文档</a></li>
<li><a href="https://devzone.nordicsemi.com/questions/">官方论坛</a></li>
<li><a href="http://www.qfv8.com/forum.php">青风电子社区</a></li>
</ol>
</li>
<li>与新版芯片的各种版本搭配：

<ol>
<li>QFN48封装</li>
<li>HWID=0084</li>
<li>Rev：3</li>
<li>nRF51 SDK:10.0.0</li>
<li>software device:S130-1.0.0</li>
<li>software device specification:S130-1.0</li>
<li>Qualified Design ID（QD ID）=68915（for S130 v1.0.0）</li>
</ol>
</li>
</ol>


<h2>工程配置</h2>

<p><img src="http://i.imgur.com/tVItFZn.png" alt="工程配置-Target" />
<img src="http://i.imgur.com/MTbnCdA.png" alt="工程配置-Linker" />
<img src="http://i.imgur.com/HtCEJLi.png" alt="工程配置-Debug" />
<img src="http://i.imgur.com/WPiTpWa.png" alt="工程配置-Download" /></p>

<h2>Bluetooth</h2>

<ol>
<li>蓝牙4.0提出了“低功耗蓝牙”、“经典蓝牙”和“高速蓝牙”三种模式。其中，高速蓝牙主攻数据交换与传输；经典蓝牙则以信息沟通、设备连接为重点；蓝牙低功耗以不需占用太多带宽的设备连接为主。</li>
<li>Bluetooth SmartReady与Bluetooth Smart

<ol>
<li>Bluetooth SmartReady设备包括智能电话、平板电脑、PC、智能电视这些在用户周边设备中充当中心并且要求Bluetooth v4.0 dual-mode通讯的智能设备</li>
<li>Bluetooth Smart设备时传感器类型的设备，比如心率计、电子计步器这种以电池并用来收集特定信息的设备，通常他们只需要single-mode low energy Bluetooth v4.0通讯
<img src="http://i.imgur.com/P9w7f76.png" alt="Bluetooth设备分类" /></li>
</ol>
</li>
<li>Bluetooth4.0低功耗模式由双模和单模两种应用。双模应用中，蓝牙低功耗功能集成在现有的经典蓝牙控制器中，或在现有经典蓝牙技术的芯片上增加低功耗堆栈，整体架构基本不变，因此成本增加有限。单模应用面向高度集成、紧凑的设备，具备轻量级链路层，支持超低功耗的待机模式操作、简单设备恢复、可靠的点对点数据传输、安全的加密连接等；而链路层则适用于网络互连传感器，并确保在无线传输中，皆能通过蓝牙低功耗传输。单模式蓝牙低功耗设备与现有蓝牙设备不能兼容，无法向下兼容，仅能支持BLE技术；而双模式芯片可同时支持蓝牙低功耗和传统蓝牙技术。一般而言，手机和个人电脑等设备将会安装双模式芯片，以便于蓝牙低功耗设备已传统蓝牙进行互操作。</li>
</ol>


<h2>SoftDevice</h2>

<ol>
<li>S110和S120由于协议栈大小有区别，因此在内部ROM和RAM分配的空间是有区别的。如下图：
<img src="http://i.imgur.com/JUv2wQy.png" alt="芯片内部资源分配" /></li>
<li>应用程序的向量表地址，取决于芯片是否已下载了SoftDevice，SoftDevice的下载地址从0x0开始，应用程序的向量表必须紧跟在SoftDevice之后，应用程序可以使用除去SoftDevice空间之外的Flash空间。相应的，SoftDevice数据区从最低的RAM地址开始，应用程序的数据区要跟在SoftDevice的数据区域后面布置</li>
<li>如果芯片烧写了SoftDevice，那么用户应用程序和SoftDevice共享同一个call stack（堆栈），应用程序必须保证call stack有足够的空间给自己和SoftDevice，SoftDevice的call stack空间需求跟不同的设备和不同的协议版本都有关系。用户应用程序应该把call stack的大小设置为它本身的需求加上SoftDevice的需求，然后设置堆栈指针（stack pointer）到应用程序的复位向量（Reset Vector）的首地址。</li>
<li>为了保证SoftDevice的正确性，微处理器包含了一个MPU（Memory Protection Unit），它可以防止对特定区域的访问，debugger读取这些区域将会返回0x0000。被SoftDevice占用的空间将禁止write和erase，使能SoftDevice后，MPU将会对协议栈进行写保护。为了避免单步调式保护区域，请在SVC calls后面设置断点，然后直接运行到该断点，也可以使用“step over”方法跳过SVC calls。</li>
</ol>


<h2>GPIO</h2>

<ol>
<li>在使用GPIO的input功能之前，需要将input buffer连接上，不使用的时候可以断开，这样可以一定程度上省电</li>
<li>GPIO pin的上下拉电阻使用标准的13KΩ的内部电阻</li>
<li>GPIO pin的驱动强度，标准情况下是0.5mA，高驱动能力下为5mA</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cm">/*****************************************************/</span>
</span><span class='line'><span class="cp">#define LED_PORT     NRF_GPIO_PORT_SELECT_PORT2</span>
</span><span class='line'><span class="cp">#define LED_NUMBER       5</span>
</span><span class='line'><span class="cp">#define LED_OFFSET       2</span>
</span><span class='line'><span class="cp">#define LED_START        18</span>
</span><span class='line'><span class="cp">#define LED0         18</span>
</span><span class='line'><span class="cp">#define LED1         19</span>
</span><span class='line'><span class="cp">#define LED2         20</span>
</span><span class='line'><span class="cp">#define LED3         21</span>
</span><span class='line'><span class="cp">#define LED4         22</span>
</span><span class='line'><span class="cp">#define LED_END          22</span>
</span><span class='line'><span class="k">extern</span> <span class="kt">void</span> <span class="nf">platform_led_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'><span class="cm">/****************************************************/</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">platform_led_init</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">nrf_gpio_range_cfg_output</span><span class="p">(</span><span class="n">LED_START</span><span class="p">,</span><span class="n">LED_END</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cm">/****************************************************/</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">SEGGER_RTT_printf</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;***Welcome to nRF51822***</span><span class="se">\r\n</span><span class="s">***System Clock=%dHz***</span><span class="se">\r\n</span><span class="s">Press </span><span class="se">\&#39;</span><span class="s">y</span><span class="se">\&#39;</span><span class="s"> to begin</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">SystemCoreClock</span><span class="p">);</span>
</span><span class='line'>  <span class="k">while</span><span class="p">(</span><span class="sc">&#39;y&#39;</span> <span class="o">!=</span> <span class="n">SEGGER_RTT_WaitKey</span><span class="p">());</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">platform_led_init</span><span class="p">();</span>
</span><span class='line'>  <span class="kt">uint8_t</span> <span class="n">led_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span><span class='line'>      <span class="n">nrf_gpio_port_write</span><span class="p">(</span><span class="n">LED_PORT</span><span class="p">,</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">led_status</span><span class="o">+</span><span class="n">LED_OFFSET</span><span class="p">));</span>
</span><span class='line'>      <span class="n">led_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">led_status</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">LED_NUMBER</span><span class="p">;</span>
</span><span class='line'>      <span class="n">nrf_delay_ms</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Power</h2>

<ol>
<li>实际中如果供电电压在1.75-1.95的时候，可以旁路内部的DC/DC转换器，直接使用内部的LDO，此时电源电压不高，在LDO上产生的功耗比较小，不会对整机功耗产生多达影响。当实际产品的供电电压高于1.95V，需要使能DC/DC转换器，以期将电源的效率提高。DC/DC转换器工作的时候会消耗300uA的电流。DC/DC转换器工作与否通过配置寄存器DCDCEN来实现。</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Free-RTOS]]></title>
    <link href="http://suda-morris.github.io/blog/2016/01/05/free-rtos/"/>
    <updated>2016-01-05T20:58:43+08:00</updated>
    <id>http://suda-morris.github.io/blog/2016/01/05/free-rtos</id>
    <content type="html"><![CDATA[<h2>如何在FreeRTOS下实现低功耗</h2>

<ol>
<li>可以在空任务或者空任务钩子函数中进入低功耗模式，在系统滴答时钟中断服务函数中重新回到正常工作模式，</li>
<li>多数操作系统都包含一个空任务，空任务优先级最低且一直保持就绪状态，空任务可以用于统计CPU的使用率，或者让MCU进入低功耗状态。如果不想修改空任务，还可以通过空任务的钩子函数插入实现低功耗的代码。</li>
<li>在FreeRTOS中，若需打开空任务钩子函数，需要在FreeRTOSConfig.h中定义#define configUSE_IDLE_HOOK 1</li>
<li>然后在钩子函数中实现低功耗的代码，比如430中：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void vApplicationIdleHook( void )
</span><span class='line'>{
</span><span class='line'>    /* Called on each iteration of the idle task.  In this case the idle task
</span><span class='line'>    just enters a low power mode. */
</span><span class='line'>    __bis_SR_register( LPM3_bits + GIE );
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ol>
<li>在大多数嵌入式操作系统中可以在系统滴答中断函数中退出低功耗模式</li>
</ol>


<h2>任务间使用队列同步数据</h2>

<ol>
<li>在嵌入式操作系统中，队列是人物间数据交换的常用手段，队列是生产者消费之模型的重要组成部分。</li>
<li>xQueueHandle MsgQueue;声明一个队列句柄，队列句柄可以理解成一个队列的标记，不同的队列具有不同的标记。</li>
<li>MsgQueue = xQueueCreate( 5 , sizeof( int16_t ) );创建队列，即在内存中开辟固定大小的区域。FreeRTOS中需要指定队列的深度和每个元素的字节长度</li>
<li>xQueueSend( MsgQueue, ( void* )&amp;SendNum, 0 );向队列中填充内容，第二参数需要取出地址并进行类型转换，第三参数设置等待时间，在队列满的情况下再往队列中填充内容会阻塞任务，知道等待时间溢出；若此处填充的内容为0的话，则立即返回插入队列结果</li>
<li>xQueueReceive( MsgQueue, &amp;ReceiveNum, 100/portTICK_RATE_MS )；从队列中取出内容，第二参数需要取出地址，第三参数为等待最大时间，若在等待的时间内队列中没有数据则返回阻塞任务。</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Makefile]]></title>
    <link href="http://suda-morris.github.io/blog/2015/12/24/makefile/"/>
    <updated>2015-12-24T23:31:10+08:00</updated>
    <id>http://suda-morris.github.io/blog/2015/12/24/makefile</id>
    <content type="html"><![CDATA[<h2>wildcard(扩展通配符)用法</h2>

<h2>patsubst(替换通配符)用法</h2>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[eclipse+cygwin]]></title>
    <link href="http://suda-morris.github.io/blog/2015/12/10/eclipse-plus-cygwin/"/>
    <updated>2015-12-10T13:21:49+08:00</updated>
    <id>http://suda-morris.github.io/blog/2015/12/10/eclipse-plus-cygwin</id>
    <content type="html"><![CDATA[<h2>eclipse+cdt+cygwin配置c/c++开发环境</h2>

<ol>
<li><a href="https://cygwin.com/mirrors.html">下载cygwin</a>,默认情况下Cygwin没有选择C++开发所需要的包，在安装时需要选中：

<ul>
<li>gcc,gcc-core,gcc-g++,gcc-mingw-core,gcc-mingw-g++,make,gdb,bunutils</li>
</ul>
</li>
<li>安装好后，需要把Cygwin加入到Windows环境变量</li>
<li>下载安装CDT插件，或者直接下载安装带有CDT插件的eclipse软件</li>
<li>配置路径映射，eclipse中调试时，由于GDB使用的是unix格式的路径，而eclipse使用的是windows路径，导致找不到匹配的代码，需要手工设置：

<ol>
<li>进入eclipse的preference，搜索“lookup path”</li>
<li>进入后添加新的“Path Mapping”</li>
<li>把linux的路径映射到windows的路径，比如/cygdrive/c 映射成C:/</li>
</ol>
</li>
</ol>


<h2>cygwin技巧</h2>

<ol>
<li>清屏：ctrl+l</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Spansion-FM4]]></title>
    <link href="http://suda-morris.github.io/blog/2015/12/09/spansion-fm4/"/>
    <updated>2015-12-09T12:53:06+08:00</updated>
    <id>http://suda-morris.github.io/blog/2015/12/09/spansion-fm4</id>
    <content type="html"><![CDATA[
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ESP8266使用]]></title>
    <link href="http://suda-morris.github.io/blog/2015/12/06/esp8266/"/>
    <updated>2015-12-06T18:06:10+08:00</updated>
    <id>http://suda-morris.github.io/blog/2015/12/06/esp8266</id>
    <content type="html"><![CDATA[<h2>NodeMCU-V1.0</h2>

<ol>
<li>核心板型号：ESP-12-E,4Mbytes（32Mbits）的flash</li>
<li><a href="https://github.com/nodemcu/nodemcu-firmware">开源官网</a></li>
<li>官网烧录工具使用：

<ol>
<li>SPI模式选择：DIO</li>
<li>FLASH SIZE选择：32Mbit</li>
<li>将最新的固件烧写到0x00000处</li>
<li>在烧写之前，需要按住FLASH按键不动然后按下RST按键一次</li>
</ol>
</li>
<li>nodemcu专用烧录工具：只需连接USB串口，选择好烧录文件，单击Flash即可完成烧写</li>
<li>Pin map
<img src="http://i.imgur.com/PoUJ0sw.png" alt="Node MCU Pin Map" />

<ul>
<li>其中D0（GPIO16）只能被用作gpio read/write，不支持中断，不支持pwm、i2c、onewire</li>
</ul>
</li>
<li>Lua core based on eLua project</li>
<li>cjson based on lua-cjson</li>
<li>File system based on spiffs</li>
<li>事件驱动的编程模型</li>
<li>内建的模块：node,json,file,timer,pwm,i2c,spi,onewire,net,mqtt,coap,gpio,wifi,adc,uart,bit,u8g,ucg,ws2801,ws2812,crypto,dht,rtc,sntp,bmp085,tls2561,hx711,system</li>
<li><a href="https://github.com/nodemcu/nodemcu-firmware/wiki/nodemcu_api_cn#noderestart">Node MCU API</a></li>
</ol>


<h2>ESP8266介绍</h2>

<p><img src="http://i.imgur.com/OC5vpzm.png" alt="ESP8266结构图" />
1. 内核架构：XtensaLX106（32位），由Tensilica公司开发，是个可配置软核CPU，指令集可扩展，扩展的指令集通过硬件实现。通常扩展指令集有几种方式：
    1. fusion，就是将多条指令合并为一条指令，从而缩短程序所需要的cycle数
    2. SIMD，就是单指令多数据
2. 默认串口波特率9600。当工作在AP模式时，默认的ip地址为192.168.4.1
3. CPU主频支持80MHz和160MHz，支持RTOS。内部三条总线：iBus访问内部，外部存储器；dBus访问数据RAM；AHB访问内部寄存器
4. 支持的无线网络类型：STA/AP/STA+AP
5. 安全机制：WEP/WPA-PSK/WPA2-PSK
6. 加密类型：WEP64/WEP128/TKIP/AES
7. 固件升级：本地串口，OTA云端升级
8. 网络协议：IPv4，TCP/UDP/FTP/HTTP
9. 支持的硬件接口：UART，I2C，PWM，GPIO，ADC（10位，ADC的范围在0~1V）
10. 串口数据传输最大传输速率为460800bps
11. 系统上电会运行厂商芯片内部的Boot loader，而在bootloader中串口波特率被设置为了<strong>74880</strong>
12. ESP8266的PWM频率100~500Hz
13. GPIO输出电压为VDD_IO（比如3.3V），输出电流应该不超过20mA
14. ESP8266有两个uart，其中uart0有Tx、Rx，可做数据传输，uart1仅有Tx，可做串口调试信息打印
15. ESP8266有两套MAC，因此可以支持softAP+station共存的模式
16. ESP8266 softAP可连接4个station
17. ESP8266低功耗只针对station模式，对于softAP则没有低功耗模式
18. ESP8266的TCP连接最多可以建立5个，UDP连接最多可以建立5个，可同时建立5个TCP连接和5个UDP连接
19. ESP8266片上没有ROM，用户程序存放在外部SPI Flash中。最大支持16MByte的容量。支持的SPI模式：Standard SPI，Dual SPI，DIO SPI，QIO SPI以及Quad SPI。注意，在下载固件时需要在下载工具选择对应模式，否则下载后程序将无法得到正确的运行
20. ESP8266芯片定义了1个SDIO Slave接口，SDIO由硬件实现，支持4位25MHz SDIOv1.1和4位50MHz SDIO v2.0</p>

<h2>最小系统</h2>

<p><img src="http://i.imgur.com/6Hsgedk.png" alt="ESP8266最下系统" />
1. Pin11和Pin17两个数字电源管脚，数字电源无需在电路中增加滤波电容。数字电源工作电压范围1.8v~3.3V
2. 在模拟电源部分，要注意当ESP8266工作在TX时候，瞬间电流会加大，往往会引起电源的轨道塌陷，所以在设计时在模拟电源电路上增加一个0603或者0805封装的10uF电容，此电容可与0402封装的0.1uF电容搭配
3. 在PIN21 SD_CLK管脚上串联一个0402封装的电阻连接到Flash CLK管脚上。此电阻的作用主要为：降低驱动电流，减小串扰和外部干扰，调节时序等。串联电阻大小为200ohm
4. RES12K（Pin31）需外接12K对地电阻，该电阻作为芯片bias控制电流的电阻，对精度要求比较高，建议采用12K±1%精度的电阻
5. ESP8266模组
    1. Layout：
        1. 第一层Top层主要用于走信号线和摆件
        2. 第二层为GND层，不走信号线，保证一个完整的GND平面
        3. 第三层为POWER层，尽量走电源线
        4. 第四层为Bottom层，建议Bottom层不摆件，只走信号线
    2. 3.3V电源线线宽必须＞15mil，走线尽量走第三层（POWER层），到达芯片管脚处时打过孔到达TOP层连接芯片管脚。在过孔处理上，VIA的直径需要大于电源走线的宽度，而且drill应始终，略大于VIA的半径即可
    3. 晶振位置尽量靠近芯片的XTAL Pins，走线不要太长，同时晶振走线必须用地包起来良好屏蔽；晶振的输入输出走线不能打孔走线，即不能跨层。金正的输入输出走线不能交叉，跨层较差也不行。晶振的输入输出的bypass电容要靠近芯片左右侧摆放，尽量不要放在走线上；晶振下方4层都不能走高频数字信号，最佳情况是晶振下方不走任何信号线，晶振TOP面的铺铜区域越大越好。晶振为敏感器件，晶振周围不能有磁感应器件，比如大电感。
    4. RF走线必须控制特性阻抗为50Ω，保证第二层完整地平面，周围地孔屏蔽，走线长度尽量短。RF走线尽量保持在10mil以上；RF走线需预留一个π型匹配网络，且π性匹配电路靠近芯片RF Pin脚摆放。芯片到天线的RF走线不能有过孔，即不能跨层走线。RF走线不能走直角或者45°角，如果有需要则使用圆弧走线。RF走线附近不能有高频信号线。RF上的天线必须远离所有传输高频信号的器件，比如<strong>晶振</strong>，DDR，一些高频时钟</p>

<h2>编译</h2>

<p><img src="http://i.imgur.com/ORglsN7.png" alt="编译参数" />
1. esp_iot_sdk_v0.9.5及之后版本的软件简化了编译脚本，编译指令：./gen_misc.sh，根据提示按要求输入编译参数
    1. boot_v1.1与boot_v1.2+：boot_v1.2相对编译时将程序排列的更紧凑，省flash空间；boot_v1.3主要支持增强启动模式可用于产测
    2. 不支持云端升级：flash.bin+iromtext.bin，支持云端升级：boot.bin+user1.bin
    3. 注意编译不同大小的bin时，其烧录地址不同
2. bin目录存放需要下载到Flash的bin文件
    1. at文件夹：Espressif提供的支持AT指令的bin文件
    2. upgrade文件夹，编译生成的支持云端升级的bin文件（user1.bin或user2.bin）
    3. bin文件下根目录，编译生成的不支持云端升级的bin文件，和其他Espressif提供的bin文件
3. 编译生成user1.bin后，先运行make clean清除上次编译生成的临时文件后，再编译生成user2.bin
4. 每个bin编译成功后，会提示该bin的烧录位置,典型烧写位置：
<img src="http://i.imgur.com/pO5yrDq.png" alt="烧写" />
5. 编译esp_iot_sdk_v0.9.4及之前版本软件
    1. 指令：./gen_misc.sh
    2. 支持云端升级（FOTA）的编译步骤如下：
        1. 运行./gen_misc_plus.sh 1，在esp_iot_sdk/bin/upgrade路径下生成user1.bin
        2. 运行make clean，清除之前的编译信息
        3. 运行./gen_misc_plus.sh 2，在esp_iot_sdk/bin/upgrade路径下生成user2.bin
6. 针对编译时STEP1和STEP5的选择不同，对应的flash size和flash map不同。
    1. 系统参数区（system param）始终为flash的最后16KB
    2. 用户参数区（User param）指Espressif提供的示例软件（IOT_Demo或AT）中设定的用户参数区。如果用户自行实现应用程序，则可以将用户参数存放在flash任意空闲区域
    3. 用户数据区（UserData），可能空闲，当程序区域未占满flash空间时，剩余空间可供用户存储数据
7. none boot-不支持云端升级。编译时Step1选择2，编译生成eagle.flash.bin（简称flash.bin）和eagle.irom0text.bin（简称irom0text.bin），不支持云端升级，则STEP5时选择不同flash size对应的布局如下：
    1. 512KB flash
<img src="http://i.imgur.com/I6YK0Jx.png" alt="none-boot-512KB" />
<img src="http://i.imgur.com/n9onmx8.png" alt="none-boot-512KB-ld文件" />
    2. 1024KB flash
<img src="http://i.imgur.com/1tluP12.png" alt="none-boot-1024KB" /></p>

<ul>
<li><p>\esp_iot_sdk\ld 路径的“eagle.app.v6.ld”文件，其中irom0_0_seg的len即设置irom0text.bin的上限值。对于1024KB flash，此len最大可修改为0xBC000，irom0text.bin 最大支持到752KB</p>

<ol>
<li>2048KB flash
<img src="http://i.imgur.com/x7x40sM.png" alt="none-boot-2048KB" /></li>
</ol>
</li>
<li><p>\esp_iot_sdk\ld 路径的“eagle.app.v6.ld”文件，其中irom0_0_seg的len即设置irom0text.bin的上限值。对于2048KB flash，此len最大可修改为0xC0000，irom0text.bin 最大支持到768KB（因为ESP8266目前程序区最大支持1024KB，1024-256=768）</p>

<ol>
<li>4096KB flash
<img src="http://i.imgur.com/yRtUCDG.png" alt="none-boot-4096KB" /></li>
</ol>
</li>
<li><p>\esp_iot_sdk\ld 路径的“eagle.app.v6.ld”文件，其中irom0_0_seg的len即设置irom0text.bin的上限值。对于2048KB flash，此len最大可修改为0xC0000，irom0text.bin 最大支持到768KB（因为ESP8266目前程序区最大支持1024KB，1024-256=768）</p></li>
<li>with boot-支持云端升级。编译时STEP1选择1，便一两次，分别生成user1.bin和user2.bin，支持云端升级功能。STEP5时选择不同的flash size对应的布局：
<img src="http://i.imgur.com/rlr2rLh.png" alt="with-boot-512KB" />
<img src="http://i.imgur.com/ciZmOP4.png" alt="with-boot-1024KB" />
<img src="http://i.imgur.com/7y3TiXf.png" alt="with-boot-2048KB" />
<img src="http://i.imgur.com/dyOkeMh.png" alt="with-boot-4096KB" /></li>
</ul>


<h2>烧录</h2>

<ol>
<li>系统参数区固定为flash的最后四个扇区，每个扇区4KBytes，即flash最后16KB</li>
<li>master_device_key.bin是ESP8266设备享受Espressif云端服务的身份证明，如果不使用Espressif Cloud可以不少路，否则仅烧录一次。烧录地址在IOT_Demo中设置为用户参数区的第三个扇区</li>
<li>blank.bin初始化系统参数，烧录地址为flash的倒数第二个扇区</li>
<li>esp_init_data_default.bin初始化射频相关参数，烧录地址为flash的倒数第四个扇区</li>
<li>不支持云端升级
<img src="http://i.imgur.com/Bf5iLCd.png" alt="不支持云端程序的烧录地址" /></li>
<li>支持云端升级（FOTA）。支持云端升级的软件无需烧录user2.bin，可以通过网络升级下载user2.bin到Flash并重启运行。
<img src="http://i.imgur.com/AKXb5Vn.png" alt="支持云端程序的烧录地址" /></li>
<li>从esp_iot_sdk_v1.4.0版本起，开发者可以通过设置esp_init_data_default.bin（0~128byte）的114byte控制上电时的RF初始化的行为。
<img src="http://i.imgur.com/8qvF0y6.png" alt="改变RF初始化行为" /></li>
</ol>


<h2>SDK二次开发</h2>

<ol>
<li>如果函数添加了ICACHE_FLASH_ATTR,该函数会被放在irom中，CPU仅在调用到他们的时候，将他们读到cache中运行；没有条件ICACHE_FLASH_ATTR宏的函数，将在一开始上电运行时，就加载到iram中运行。由于空间有限，我们无法将所有代码都一次性加载到iram中运行，因此在大部分函数前添加ICACHE_FLASH_ATTR宏。注意，不能在GPIO或UART中断处理函数中调用带有“ICACHE_FLASH_ATTR”宏的函数，否则将引起异常。</li>
<li>wifi_set_ip_info、wifi_set_macaddr仅在user_init中调用才生效</li>
<li>system_timer_reinit建议在user_init中调用，否则调用后，需要重新arm所有timer</li>
<li>wifi_station_set_config如果在user_init中调用，底层会自动连接对应的路由，不需要再调用wifi_station_connect来进行连接，否则需要。</li>
<li>使能us级定时器

<ol>
<li>在user_config.h中#define USE_US_TIMER，并在user_init中调用system_timer_reinit(),此时可以同时使用os_timer_arm_us和os_timer_arm</li>
<li>未定义USE_US_TIMER时，os_timer_arm（）的时间参数范围0~6871947ms，os_timer_arm_us不可用</li>
<li>定义了USE_US_TIMER时，os_timer_arm（）的时间参数范围0~429496ms，os_timer_arm_us的时间参数范围是0~429496729us</li>
</ol>
</li>
<li>blank.bin，有Espressif提供，烧录到0x7E000地址。不是每次都要烧录，仅当sdk升级版本或需要擦除WIFI配置参数时进行烧录</li>
<li>eagle.app.v6.flash.bin,用户编译生成，烧录到0x0000地址</li>
<li>master_device_key.bin，向Espressif服务器申请，烧录到0x3E000地址</li>
<li>eagle.app.v6.irom0text.bin，用户编译生成，烧录到0x40000地址</li>
<li>esp_init_data_default.bin有Espressif提供，烧录到0x7c000地址</li>
<li>system_restore将wifi相关参数复位，即擦出了路由器信息以及恢复了softAP默认名称</li>
<li>固件云端升级成功后，需要调用system_upgrade_reboot，否则不切换</li>
<li>system_timer_reinit需要放在程序最开始，usr_init第一句</li>
</ol>


<h2>重要API介绍</h2>

<ol>
<li>bool wifi_station_scan (struct scan_config *config, scan_done_cb_t cb);功能：获取AP的信息。注意：不能在user_init中调用此接口，该接口必须在系统初始化完成后，并且ESP8266 station接口使能的情况下调用</li>
<li>bool wifi_station_set_config (struct station_config *config)；功能：设置WiFi station接口的配置参数，并保存到flash。注意：如果wifi_station_set_config在user_init中调用，则ESP8266 station接口在系统初始化完成后，自动连接AP（路由），无需再调用wifi_station_connect；否则，需要调用wifi_station_connect连接AP（路由）。station_config.bssid_set一般设置为0，仅当需要检查AP的MAC地址时（用于有重名AP的情况下）设置为1、本设置如果与原设置不同，会更新保存到flash系统参数区</li>
</ol>


<h2>降低功耗的方法</h2>

<ol>
<li>Modem-Sleep：CPU一直工作，在保持wifi连接，如果没有数据传输则关闭WiFi Modem电路来省电</li>
<li>Light-Sleep：CPU暂停工作，保持Wifi连接</li>
<li>Deep-Sleep：WiFi不需要一直保持连接时采用该模式</li>
</ol>


<h2>ADC应用场景</h2>

<ol>
<li>测量VDD3P3管脚3和4的电源电压

<ol>
<li>TOUT必须悬空</li>
<li>RF_init参数：esp_init_data_default.bin（0~127byte）中的低107byte为“vdd33_const”，必须设为0xFF，即255</li>
<li>RF Calibration工作过程：自测VDD3P3管脚3和管脚4上的电源电压，根据测量结果优化RF电路工作状态</li>
<li>用户软件：可使用system_get_vdd33，不可使用system_adc_read</li>
</ol>
</li>
<li>测量TOUT管脚6的输入电压

<ol>
<li>TOUT管脚接外部电路，输入电压范围限定为0-1.0V</li>
<li>RF_init参数：esp_init_data_default.bin（0~127byte）中的第107byte为“vdd33_const”，必须设为真实的VDD3P3管脚3和管脚4上的电源电压，ESP8266的工作电压范围1.8V-3.6V，“vdd33_const”单位0.1V，因此“vdd33_const”有效取值18~36.若电源电压不稳定，会动态变化，“vdd33_const”应输入为电源电压变化的最小值0x10.</li>
<li>RF Calibration工作过程：根据RF_init第107byte“vdd33_const”的值来优化RF电路工作状态，容许误差约为±0.2V</li>
<li>用户软件：不可使用system_get_vdd33；可使用system_adc_read</li>
</ol>
</li>
</ol>


<h2>电源管理</h2>

<ol>
<li>关闭（OFF）：CHIP_PD管脚处于低功耗状态。RTC失效，所有寄存器被清空</li>
<li>深度睡眠（DEEP_SLEEP）：RTC开着，芯片的其他部分都是关着的。RTC内部recovery memory可保存基本的WiFi连接信息</li>
<li>睡眠（SLEEP）：只有RTC在运行。晶体振荡器停止工作。任何部位唤醒（MAC、主机、RTC计时器、外部中断）将唤醒整个芯片</li>
<li>环形（WAKEUP）：在这种状态下，系统从睡眠状态下转为启动（PWR）状态。晶体振荡器和PLL均转化为使能状态</li>
<li>开启状态（CPU ON）：告诉时钟可以运行，并发送至各个被时钟控制寄存器使能的模块。各个模块，包括CPU在内，执行较低电平的时钟门控。系统运作时，可以通过WAITI指令关闭CPU内部时钟</li>
<li>工作状态（RF WORK）：在开启状态的基础上打开WiFi功能</li>
</ol>


<h2>2.4GHz接收器</h2>

<p>2.4GHz接收器把RF信号降频，编程正交基带信号，用2个高分辨率的高速ADC将后者转为数字信号。为了适应不同的信号频道，无线电接收器集成了RF滤波器、自动增益控制AGC、DC偏移补偿电路和基带滤波器</p>

<h2>2.4GHz发射器</h2>

<p>2.4GHz发射器将正交基带信号升频到2.4GHz，使用大功率CMOS功率放大器驱动天线。数字校准的使用进一步改善了功率放大器的线性，从而在802.11b传输中达到+17dBm的平均功率，在802.11n中达到了13dBm的平均功率。为了抵消无线电接收器的瑕疵，还另增了校准措施：
    1. 载波泄露
    2. I/Q相位匹配
    3. 基带非线性</p>

<h2>SDK_IOT_Demo使用方法</h2>

<ol>
<li>ESP8266物联网平台的所有网络功能均在库中实现，对用户不透明。用户应用的初始化功能可以在user_main.c中实现。</li>
<li>void user_init(void)是上层程序的入口函数，给用户提供一个初始化接口，用户可在该函数内增加硬件初始化、网络参数配置、定时器初始化等功能。</li>
<li>SDK中提供了对json包的处理API，用户也可以采用自定义数据包格式，自行对数据进行处理</li>
<li>user_config.h,该头文件中可以选择具体的应用示例，仅支持每次打开一个宏定义，使能一个设备，具体支持：

<ol>
<li>PLUG_DEVICE（只能插座）</li>
<li>LIGHT_DEVICE（灯）</li>
<li>SENSOR_DEVICE（传感器）

<ol>
<li>HUMITURE_SUB_DEVICE（温湿度传感器）</li>
<li>FLAMMABLE_GAS_SUB_DEVICE（可燃气体检测）</li>
</ol>
</li>
</ol>
</li>
<li>需要注意，以下头文件中的宏定义只是用户参数区，用户需要根据编译时的flash map自行调整

<ol>
<li>user_esp_platform.h中的#define ESP_PARAM_START_SEC 0x3D //or 0x7D, or 0xFD</li>
<li>user_light.h中的#define PRIV_PARAM_START_SEC   0x3C //or ox7C, or 0xFC</li>
<li>user_plug.h中的#define PRIV_PARAM_START_SEC 0x3C // or 0x7C, or 0xFC</li>
</ol>
</li>
</ol>


<h2>SDK编程指南</h2>

<ol>
<li>SDK_v1.1.0及之后版本，请在user_main.c增加void user_rf_pre_init(void)，可参考IOT_Demo的user_main.c。用户可在user_rf_pre_init中配置RF初始化，相关RF设置接口为system_phy_set_rfoption，或者在deep-sleep前调用system_deep_sleep_set_option。如果设置为RF不打开，则ESP8266 station及soft-AP均无法使用</li>
<li>非OS SDK中，由于是单线程，任何task都不能长期占用CPU

<ol>
<li>如果一个task占用CPU不退出，将导致看门狗的喂狗函数无法执行，系统重启</li>
<li>如果关闭中断，请勿占用CPU超过10微妙；如果不关闭中断，建议不超过500毫秒</li>
</ol>
</li>
<li>建议使用定时器实现周期性的查询功能，如需在定时器的执行函数中调用os_delay_us或者while、for等函数进行延时或者循环操作，占用时间请勿超过15毫秒</li>
<li>非OS SDK在终端处理函数中，请勿使用任何ICACHE_FLASH_ATTR定义的函数</li>
<li>内存必须4字节对齐进行读写，请勿直接进行指针转换。例如语句：float temp=<em>（（float</em>）data）；可能引起异常，建议使用os_memcpy</li>
<li>如需在中断处理函数中打印，请使用os_printf_plus，且不能加入太多打印信息，尤其是频繁的中断，中断占用时间过长可能引起底层异常</li>
</ol>


<h2>应用程序接口（APIs）</h2>

<ol>
<li><p>软件定时器（/esp_iot_sdk/include/osapi.h）</p>

<ol>
<li>该定时器由软件实现，定时器的函数在任务中被执行，因为任务可能被中断，或者被其他高优先级的任务延迟，因此以下os_timer系列的接口并不能保证定时器精确执行</li>
<li>如果需要精确的定时，请使用硬件中断定时器，硬件定时器的执行函数在中断里被执行</li>
<li>对于同一个timer，os_timer_arm或os_timer_arm_us不能重复调用，必须先os_timer_disarm</li>
<li>os_timer_setfn必须在timer未使能的情况下调用，在os_timer_arm或os_timer_arm_us之前或者os_timer_disarm之后
<img src="http://i.imgur.com/ut3L04J.png" alt="os_timer_arm" />
<img src="http://i.imgur.com/g4r2Hqy.png" alt="os_timer_disarm" />
<img src="http://i.imgur.com/NJSnALl.png" alt="os_timer_setfn" />
<img src="http://i.imgur.com/rjtHFxg.png" alt="system_timer_reinit" />
<img src="http://i.imgur.com/YGqHnPH.png" alt="os_timer_arm_us" /></li>
</ol>
</li>
<li><p>硬件中断定时器（esp_iot_sdk/example/driver_lib/hw_timer.c）</p>

<ol>
<li>如果使用NMI中断源，且为自动填装的定时器，调用hw_timer_arm时参数val必须大于100</li>
<li>如果使用NMI中断源，那么该定时器将为最高优先级，可打断其他ISR</li>
<li>如果使用FRC1中断源，那么该定时器无法打断其他ISR</li>
<li>hw_timer.c的接口不能跟PWM驱动函数同时使用，因为两者共用了同一个硬件定时器
<img src="http://i.imgur.com/4IYnD4u.png" alt="hw_timer_init" />
<img src="http://i.imgur.com/HJSwcP1.png" alt="hw_timer_arm" />
<img src="http://i.imgur.com/AdwUQnK.png" alt="hw_timer_set_func" /></li>
</ol>
</li>
<li><p>系统接口
<img src="http://i.imgur.com/wwOKGue.png" alt="system_get_sdk_version" />
<img src="http://i.imgur.com/FhDEzk9.png" alt="system_restore" />
<img src="http://i.imgur.com/KebuEg2.png" alt="system_restart" />
<img src="http://i.imgur.com/gd7wPOu.png" alt="system_init_done_cb" />
<img src="http://i.imgur.com/1kbe7QR.png" alt="system_get_chip_id" />
<img src="http://i.imgur.com/VYY0bm0.png" alt="system_get_vdd33" />
<img src="http://i.imgur.com/qcos9q2.png" alt="system_adc_read" />
<img src="http://i.imgur.com/BvIJ9j3.png" alt="system_deep_sleep" />
<img src="http://i.imgur.com/7GyREOv.png" alt="system_deep_sleep_set_option" />
<img src="http://i.imgur.com/iN58kRk.png" alt="system_phy_set_rfoption" />
<img src="http://i.imgur.com/q9kfPIR.png" alt="system_phy_set_powerup_option" />
<img src="http://i.imgur.com/xpDL6g5.png" alt="system_phy_set_max_tpw" />
<img src="http://i.imgur.com/WmKLDfl.png" alt="system_phy_set_tpw_via_vdd33" />
<img src="http://i.imgur.com/sBL3Dxe.png" alt="system_set_os_print" />
<img src="http://i.imgur.com/b65IXuv.png" alt="system_print_meminfo" />
<img src="http://i.imgur.com/PR7wSZc.png" alt="system_get_free_heap_size" />
<img src="http://i.imgur.com/VdxyQlN.png" alt="system_os_task" />
<img src="http://i.imgur.com/zdplehL.png" alt="system_os_post" />
<img src="http://i.imgur.com/NyzEjjf.png" alt="system_get_time" />
<img src="http://i.imgur.com/mKDWnWa.png" alt="system_get_rtc_time" />
<img src="http://i.imgur.com/LygTWoX.png" alt="system_rtc_clock_cali_proc" />
<img src="http://i.imgur.com/A72POUy.png" alt="system_rtc_mem_read" />
<img src="http://i.imgur.com/TFeTFTD.png" alt="system_uart_swap" />
<img src="http://i.imgur.com/qvrBExO.png" alt="system_uart_de_swap" />
<img src="http://i.imgur.com/Kgy6Klz.png" alt="system_get_boot_version" />
<img src="http://i.imgur.com/fTlFRgx.png" alt="system_get_userbin_addr" />
<img src="http://i.imgur.com/TsZutcF.png" alt="system_get_boot_mode" />
<img src="http://i.imgur.com/Hz979AN.png" alt="system_restart_enhance" />
<img src="http://i.imgur.com/XSo84Zh.png" alt="system_update_cpu_freq" />
<img src="http://i.imgur.com/vvaN0rO.png" alt="system_get_cpu_freq" />
<img src="http://i.imgur.com/VvcFGtr.png" alt="system_get_flash_size_map" />
<img src="http://i.imgur.com/qS1DJbK.png" alt="system_get_rst_info" />
<img src="http://i.imgur.com/L4Val81.png" alt="system_soft_wdt_stop" />
<img src="http://i.imgur.com/a84yBT6.png" alt="system_soft_wdt_restart" />
<img src="http://i.imgur.com/ae9oSIE.png" alt="system_soft_wdt_feed" />
<img src="http://i.imgur.com/a1phXi6.png" alt="system_show_malloc" />
<img src="http://i.imgur.com/ih4sEt8.png" alt="os_memcpy" />
<img src="http://i.imgur.com/Z3lIfXz.png" alt="os_strlen" />
<img src="http://i.imgur.com/TAVUB3x.png" alt="os_printf" />
<img src="http://i.imgur.com/PJJjvLk.png" alt="os_bzero" />
<img src="http://i.imgur.com/7B4XZ86.png" alt="os_delay_us" />
<img src="http://i.imgur.com/D3sMS0i.png" alt="os_install_putc1" /></p></li>
<li><p>SPI Flash接口
<img src="http://i.imgur.com/XmmnjBi.png" alt="spi_flash_get_id" />
<img src="http://i.imgur.com/2ovYNiF.png" alt="spi_flash_erase_sector" />
<img src="http://i.imgur.com/iIj5npZ.png" alt="spi_flash_write" />
<img src="http://i.imgur.com/boQJjil.png" alt="spi_flash_read" />
<img src="http://i.imgur.com/IcZDndm.png" alt="system_param_save_with_protect" />
<img src="http://i.imgur.com/O97tZqz.png" alt="system_param_load" />
<img src="http://i.imgur.com/SmENox2.png" alt="spi_flash_set_read_func" /></p></li>
<li><p>Wi-Fi接口</p>

<ol>
<li>wifi_station系列接口以及ESP8266 station相关的设置、查询接口，请在ESP8266 station使能的情况下调用</li>
<li>wifi_softap系列接口以及ESP8266 soft-AP相关的设置、查询接口，请在ESP8266 soft-AP使能的情况下调用</li>
<li>后文的“flash系统参数区”位于flash的最后16KB
<img src="http://i.imgur.com/RlFFDxJ.png" alt="wifi_get_opmode" />
<img src="http://i.imgur.com/XaW34cD.png" alt="wifi_get_opmode_default" />
<img src="http://i.imgur.com/QGHqO0N.png" alt="wifi_set_opmode" />
<img src="http://i.imgur.com/Q4lSIWk.png" alt="wifi_set_opmode_current" />
<img src="http://i.imgur.com/wqkMEDJ.png" alt="wifi_station_get_config" />
<img src="http://i.imgur.com/k9VPDzA.png" alt="wifi_station_get_config_default" />
<img src="http://i.imgur.com/61GE3Ib.png" alt="wifi_station_set_config" />
<img src="http://i.imgur.com/qdYW054.png" alt="wifi_station_set_config_current" />
<img src="http://i.imgur.com/03hCjeQ.png" alt="wifi_station_set_cert_key" />
<img src="http://i.imgur.com/QPXjpWE.png" alt="wifi_station_clear_cert_key" />
<img src="http://i.imgur.com/Yh1PrWq.png" alt="wifi_station_connect" />
<img src="http://i.imgur.com/DZl8NZr.png" alt="wifi_station_disconnect" />
<img src="http://i.imgur.com/kApSlV0.png" alt="wifi_station_get_connect_status" />
<img src="http://i.imgur.com/Ts9TcYG.png" alt="wifi_station_scan" />
<img src="http://i.imgur.com/tmSeQd4.png" alt="scan_done_cb_t" />
<img src="http://i.imgur.com/3qUP8bn.png" alt="wifi_station_ap_number_set" />
<img src="http://i.imgur.com/KIVrSGI.png" alt="wifi_station_get_ap_info" />
<img src="http://i.imgur.com/TwvND65.png" alt="wifi_station_ap_change" />
<img src="http://i.imgur.com/5lvsPLw.png" alt="wifi_station_get_current_ap_id" />
<img src="http://i.imgur.com/4Kfn8ab.png" alt="wifi_station_get_auto_connect" />
<img src="http://i.imgur.com/oi0cgPi.png" alt="wifi_station_set_auto_connect" />
<img src="http://i.imgur.com/EWEmI4Z.png" alt="wifi_station_dhcpc_start" />
<img src="http://i.imgur.com/m82n4Zm.png" alt="wifi_station_dhcpc_stop" />
<img src="http://i.imgur.com/zaJSEFV.png" alt="wifi_station_dhcpc_status" />
<img src="http://i.imgur.com/SOkwKH3.png" alt="wifi_station_dhcpc_set_maxtry" />
<img src="http://i.imgur.com/E4qQCrP.png" alt="wifi_station_set_reconnect_policy" />
<img src="http://i.imgur.com/9rt7lqT.png" alt="wifi_station_get_rssi" />
<img src="http://i.imgur.com/ghg2o8V.png" alt="wifi_station_set_hostname" />
<img src="http://i.imgur.com/FAlGs8p.png" alt="wifi_station_get_hostname" />
<img src="http://i.imgur.com/5Pdrcxh.png" alt="wifi_softap_get_config" />
<img src="http://i.imgur.com/CZQUF2Q.png" alt="wifi_softap_get_config_default" />
<img src="http://i.imgur.com/UDNTbY5.png" alt="wifi_softap_set_config" />
<img src="http://i.imgur.com/ZDcmXW0.png" alt="wifi_softap_set_config_current" />
<img src="http://i.imgur.com/P9tlgeM.png" alt="wifi_softap_get_station_num" />
<img src="http://i.imgur.com/yHVy86S.png" alt="wifi_softap_get_station_info" />
<img src="http://i.imgur.com/x5ngKIb.png" alt="wifi_softap_free_station_info" />
<img src="http://i.imgur.com/78K07qB.png" alt="wifi_softap_dhcps_start" />
<img src="http://i.imgur.com/1qfrMUV.png" alt="wifi_softap_dhcps_stop" />
<img src="http://i.imgur.com/HxrV1vR.png" alt="wifi_softap_set_dhcps_lease" />
<img src="http://i.imgur.com/0E9KVU1.png" alt="wifi_softap_get_dhcps_lease" />
<img src="http://i.imgur.com/SRSOODU.png" alt="wifi_softap_set_dhcps_lease_time" />
<img src="http://i.imgur.com/Hx99GO2.png" alt="wifi_soft_dhcps_status" />
<img src="http://i.imgur.com/l97H0jZ.png" alt="wifi_softap_set_dhcps_offer_option" />
<img src="http://i.imgur.com/XcDbqxT.png" alt="wifi_set_phy_mode" />
<img src="http://i.imgur.com/GUa5O5O.png" alt="wifi_get_phy_mode" />
<img src="http://i.imgur.com/xyPVuhn.png" alt="wifi_get_ip_info" />
<img src="http://i.imgur.com/Zr9vWoq.png" alt="wifi_set_ip_info" />
<img src="http://i.imgur.com/Z9LwYlW.png" alt="wifi_set_macaddr" />
<img src="http://i.imgur.com/kTZanO6.png" alt="wifi_get_macaddr" />
<img src="http://i.imgur.com/uDAgvRn.png" alt="wifi_set_sleep_type" />
<img src="http://i.imgur.com/rYM4D3u.png" alt="wifi_get_sleep_type" />
<img src="http://i.imgur.com/lSCPGbX.png" alt="wifi_status_led_install" />
<img src="http://i.imgur.com/ggsdLte.png" alt="wifi_status_led_uninstall" />
<img src="http://i.imgur.com/ZjWAM9E.png" alt="wifi_set_broadcase_if" />
<img src="http://i.imgur.com/j7IEi5C.png" alt="wifi_get_broadcast_if" />
<img src="http://i.imgur.com/SDZx9vy.png" alt="wifi_set_event_handler_cb" />
<img src="http://i.imgur.com/WOrpmmZ.png" alt="wifi_wps_enable" />
<img src="http://i.imgur.com/nIabYMP.png" alt="wifi_wps_disable" />
<img src="http://i.imgur.com/mbemUfV.png" alt="wifi_wps_start" />
<img src="http://i.imgur.com/UjUURzV.png" alt="wifi_set_wps_cb" />
<img src="http://i.imgur.com/Fc9Vy7R.png" alt="wifi_register_send_pkt_freedom_cb" />
<img src="http://i.imgur.com/82xDFc1.png" alt="wifi_send_pkt_freedom" />
<img src="http://i.imgur.com/2KAsPlg.png" alt="wifi_rfid_locp_recv_open" />
<img src="http://i.imgur.com/gIVEqHb.png" alt="wifi_rfid_locp_recv_close" />
<img src="http://i.imgur.com/atfre24.png" alt="wifi_register_rfid_locp_recv_cb" />
<img src="http://i.imgur.com/ySvAcKR.png" alt="wifi_unregister_rfid_locp_recv_cb" /></li>
</ol>
</li>
<li><p>Rate Control 接口
<img src="http://i.imgur.com/hsHHgyu.png" alt="wifi_set_user_fixed_rate" />
<img src="http://i.imgur.com/mbJAoHb.png" alt="wifi_get_user_fixed_rate" />
<img src="http://i.imgur.com/qb8MnZh.png" alt="wifi_set_user_sup_rate" />
<img src="http://i.imgur.com/X0Upq9z.png" alt="wifi_set_user_rate_limit" />
<img src="http://i.imgur.com/asqAVuW.png" alt="wifi_set_user_limit_rate_mask" />
<img src="http://i.imgur.com/iqOBgeg.png" alt="wifi_get_user_limit_rate_mask" /></p></li>
<li><p>强制休眠接口
使用强制休眠功能，必须先设置WiFi工作模式位NULL_MODE，从强制休眠中唤醒ESP8266，或者休眠时间到，进入唤醒回调（wifi_fpm_set_wakeup_cb注册）后，先关闭强制休眠功能，才能再设置WiFi工作模式为station、soft-AP或sta+AP的正常工作模式。
<img src="http://i.imgur.com/LMJT80U.png" alt="wifi_fpm_open" />
<img src="http://i.imgur.com/H0ajlD1.png" alt="wifi_fpm_close" />
<img src="http://i.imgur.com/aFSgMZu.png" alt="wifi_fpm_do_wakeup" />
<img src="http://i.imgur.com/nSg5lrr.png" alt="wifi_fpm_set_wakeup_cb" />
<img src="http://i.imgur.com/XVbopKI.png" alt="wifi_fpm_do_sleep" />
<img src="http://i.imgur.com/RJFmtGe.png" alt="wifi_fpm_set_sleep_type" />
<img src="http://i.imgur.com/hbiNG8u.png" alt="wifi_fpm_get_sleep_type" />
示例
<img src="http://i.imgur.com/mQaZk2x.png" alt="示例代码" /></p></li>
<li><p>ESP-NOW
ESP-NOW软件接口使用时注意：</p>

<ol>
<li>ESP-NOW目前不支持广播包和组播包</li>
<li>ESP-NOW现阶段主要为智能灯项目，建议slave角色对应ESP8266 soft-AP模式或者soft-AP+station共存模式；controller角色对应station模式</li>
<li>当ESP8266处于soft-AP+station共存模式时，若作为slave角色，将从soft-AP接口通信；若作为controller角色，将从station接口通信</li>
<li>ESP-NOW不实现休眠环形功能，因此如果通信对方的ESP8266 station正处于休眠状态，ESP-NOW发包将会失败</li>
<li>ESP8266 station模式下，最多可设置10个加密的ESP-NOW peer，加上不加密的设备，综述不超过20个</li>
<li>ESP8266 soft-AP模式或者soft-AP+station模式下，最多设置6个加密的ESP-NOW peer，加上不加密的设备，总数不超过20个
<img src="http://i.imgur.com/ZqxmdUT.png" alt="esp_now_init" />
<img src="http://i.imgur.com/jnoadVK.png" alt="esp_now_deinit" />
<img src="http://i.imgur.com/hVQrHz9.png" alt="esp_now_register_recv_cb" />
<img src="http://i.imgur.com/KCRctG7.png" alt="esp_now_unregister_recv_cb" />
<img src="http://i.imgur.com/kqTxtwA.png" alt="esp_now_register_send_cb" />
<img src="http://i.imgur.com/6eVV4AH.png" alt="esp_now_unregister_send_cb" />
<img src="http://i.imgur.com/45s7eeI.png" alt="esp_now_send" />
<img src="http://i.imgur.com/500z8ub.png" alt="esp_now_add_peer" />
<img src="http://i.imgur.com/2S8zfbW.png" alt="esp_now_del_peer" />
<img src="http://i.imgur.com/JlYx4aq.png" alt="esp_now_set_self_role" />
<img src="http://i.imgur.com/Guzjbw0.png" alt="esp_now_get_self_role" />
<img src="http://i.imgur.com/osSgTqs.png" alt="esp_now_set_peer_role" />
<img src="http://i.imgur.com/0GiHi1M.png" alt="esp_now_get_peer_role" />
<img src="http://i.imgur.com/hIq3URt.png" alt="esp_now_set_peer_key" />
<img src="http://i.imgur.com/q945HqV.png" alt="esp_now_get_peer_key" />
<img src="http://i.imgur.com/ZL6L5o7.png" alt="esp_now_set_peer_channel" />
<img src="http://i.imgur.com/eOa2xH8.png" alt="esp_now_get_peer_channel" />
<img src="http://i.imgur.com/H3U5eoY.png" alt="esp_now_is_peer_exist" />
<img src="http://i.imgur.com/3bUBgdm.png" alt="esp_now_fetch_peer" />
<img src="http://i.imgur.com/0vxZrA2.png" alt="esp_now_get_cnt_info" />
<img src="http://i.imgur.com/diYBk7z.png" alt="esp_now_set_tok" /></li>
</ol>
</li>
<li><p>云端升级（FOTA）
<img src="http://i.imgur.com/vI1fgnj.png" alt="system_upgrade_userbin_check" />
<img src="http://i.imgur.com/5drhXqB.png" alt="system_upgrade_flag_set" />
<img src="http://i.imgur.com/RJoi4Ax.png" alt="system_upgrade_flag_check" />
<img src="http://i.imgur.com/yAC2blM.png" alt="system_upgrade_start" />
<img src="http://i.imgur.com/1YM4Vqy.png" alt="system_upgrade_reboot" /></p></li>
<li><p>Sniffer接口
<img src="http://i.imgur.com/hp8xnhl.png" alt="wifi_promiscuous_enable" />
<img src="http://i.imgur.com/IG127Hv.png" alt="wifi_promiscuous_set_mac" />
<img src="http://i.imgur.com/a83zveF.png" alt="wifi_set_promiscuous_rx_cb" />
<img src="http://i.imgur.com/Mv6Iz1J.png" alt="wifi_get_channel" />
<img src="http://i.imgur.com/ubo9cpS.png" alt="wifi_set_channel" /></p></li>
<li><p>smart config
开启smart config功能前，先要确保AP已经开启
<img src="http://i.imgur.com/LnOwF3z.png" alt="smartconfig_start" />
<img src="http://i.imgur.com/X8GqB53.png" alt="smartconfig_stop" />
<img src="http://i.imgur.com/KVw3EWh.png" alt="smartconfig_set_type" /></p></li>
<li><p>SNTP
<img src="http://i.imgur.com/JidngYO.png" alt="sntp_setserver" />
<img src="http://i.imgur.com/LoF3zE2.png" alt="sntp_getserver" />
<img src="http://i.imgur.com/Aa5MuMU.png" alt="sntp_setservername" />
<img src="http://i.imgur.com/TsNRL1v.png" alt="sntp_getservername" />
<img src="http://i.imgur.com/xdbOU1A.png" alt="sntp_init" />
<img src="http://i.imgur.com/edA5UWl.png" alt="sntp_stop" />
<img src="http://i.imgur.com/mjPbh2d.png" alt="sntp_get_current_timestamp" />
<img src="http://i.imgur.com/4LFCzuZ.png" alt="sntp_get_real_time" />
<img src="http://i.imgur.com/bhKWquX.png" alt="sntp_set_timezone" />
<img src="http://i.imgur.com/xLD8Muv.png" alt="sntp_get_timezone" />
<img src="http://i.imgur.com/d16kfdb.png" alt="sntp实例" /></p></li>
<li><p>TCP/UDP接口</p>

<ol>
<li>通用接口
<img src="http://i.imgur.com/b7JpuSF.png" alt="espconn_delete" />
<img src="http://i.imgur.com/oYeFFV5.png" alt="espconn_gethostbyname" />
<img src="http://i.imgur.com/byn3M8b.png" alt="espconn_port" />
<img src="http://i.imgur.com/RWTvtPX.png" alt="espconn_regist_sentcb" />
<img src="http://i.imgur.com/kyjCZLo.png" alt="espconn_regist_recvcb" />
<img src="http://i.imgur.com/9TiclzH.png" alt="espconn_sent_callback" />
<img src="http://i.imgur.com/EGx24RQ.png" alt="espconn_recv_callback" />
<img src="http://i.imgur.com/ZMdDW5D.png" alt="espconn_send" /></li>
<li>TCP APIs
<img src="http://i.imgur.com/tvFIHXv.png" alt="espconn_accept" />
<img src="http://i.imgur.com/MQDJ2dm.png" alt="espconn_regist_time" />
<img src="http://i.imgur.com/JHhTCX8.png" alt="espconn_get_connection_info" />
<img src="http://i.imgur.com/qnPMqHW.png" alt="espconn_connect" />
<img src="http://i.imgur.com/AXFBUEl.png" alt="espconn_regist_connectcb" />
<img src="http://i.imgur.com/PapbezX.png" alt="espconn_connect_callback" />
<img src="http://i.imgur.com/qDyblQ6.png" alt="espconn_set_opt" />
<img src="http://i.imgur.com/SGEKnoP.png" alt="espconn_clear_opt" />
<img src="http://i.imgur.com/p0qCJtW.png" alt="espconn_set_keepalive" />
<img src="http://i.imgur.com/zBb9208.png" alt="espconn_get_keepalive" />
<img src="http://i.imgur.com/vG8gNaV.png" alt="espconn_reconnect_callback" />
<img src="http://i.imgur.com/bsyzRMX.png" alt="espconn_regist_reconcb" />
<img src="http://i.imgur.com/D0ksaOd.png" alt="espconn_disconnect" />
<img src="http://i.imgur.com/5HlP8kD.png" alt="espconn_regist_disconcb" />
<img src="http://i.imgur.com/87L2XO8.png" alt="espconn_abort" />
<img src="http://i.imgur.com/g9FFQ2T.png" alt="espconn_regist_write_finish" />
<img src="http://i.imgur.com/4iDHlaW.png" alt="espconn_tcp_get_max_con" />
<img src="http://i.imgur.com/7zcoIEJ.png" alt="espconn_tcp_set_max_con" />
<img src="http://i.imgur.com/tj1A4IN.png" alt="espconn_tcp_get_max_con_allow" />
<img src="http://i.imgur.com/YnFUF40.png" alt="espconn_tcp_set_max_con_allow" />
<img src="http://i.imgur.com/Di7fpNE.png" alt="espconn_recv_hold" />
<img src="http://i.imgur.com/p9Wh4ar.png" alt="espconn_recv_unhold" />
<img src="http://i.imgur.com/x77iFAZ.png" alt="espconn_secure_accept" />
<img src="http://i.imgur.com/yf0nu6u.png" alt="espconn_secure_delete" />
<img src="http://i.imgur.com/aJTmXp1.png" alt="espconn_secure_set_size" />
<img src="http://i.imgur.com/LYSOddi.png" alt="espconn_secure_get_size" />
<img src="http://i.imgur.com/vWyey95.png" alt="espconn_secure_connect" />
<img src="http://i.imgur.com/MjT9kZI.png" alt="espconn_secure_send" />
<img src="http://i.imgur.com/Q8Pc8mB.png" alt="espconn_secure_disconnect" />
<img src="http://i.imgur.com/KbuaGLw.png" alt="espconn_secure_ca_disable" />
<img src="http://i.imgur.com/EjurJ9N.png" alt="espconn_secure_ca_enable" />
<img src="http://i.imgur.com/mLQrUcq.png" alt="espconn_secure_cert_req_enable" />
<img src="http://i.imgur.com/ssMcZnw.png" alt="espconn_secure_cert_req_disable" />
<img src="http://i.imgur.com/NOkGIJa.png" alt="espconn_secure_set_default_certificate" />
<img src="http://i.imgur.com/vSJnk8r.png" alt="espconn_secure_set_default_private_key" /></li>
<li>UDP APIs
<img src="http://i.imgur.com/b4U0hIS.png" alt="espconn_crerat" />
<img src="http://i.imgur.com/qJXFCtQ.png" alt="espconn_sendto" />
<img src="http://i.imgur.com/hnz1IKo.png" alt="espconn_igmp_join" />
<img src="http://i.imgur.com/IaZYyTV.png" alt="espconn_igmp_leave" />
<img src="http://i.imgur.com/3LSmGln.png" alt="espconn_dns_setserver" /></li>
<li>mDNS APIs
<img src="http://i.imgur.com/6ZtF0Cx.png" alt="espconn_mdns_init" />
<img src="http://i.imgur.com/4diP7CK.png" alt="espconn_mdns_close" />
<img src="http://i.imgur.com/JHgRWYC.png" alt="espconn_mdns_server_register" />
<img src="http://i.imgur.com/uWcpQwi.png" alt="espconn_mdns_server_unregister" />
<img src="http://i.imgur.com/WGx1eCJ.png" alt="espconn_mdns_get_servername" />
<img src="http://i.imgur.com/fQ1FfCr.png" alt="espconn_mdns_set_servername" />
<img src="http://i.imgur.com/5fmYZOd.png" alt="espconn_mdns_set_hostname" />
<img src="http://i.imgur.com/JztcNEV.png" alt="espconn_mdns_get_hostname" />
<img src="http://i.imgur.com/JWvn7uS.png" alt="espconn_mdns_disable" />
<img src="http://i.imgur.com/iyADme0.png" alt="espconn_mdns_enable" />
<img src="http://i.imgur.com/MlaoB7u.png" alt="nDNS示例" /></li>
</ol>
</li>
<li><p>MESH接口
<img src="http://i.imgur.com/IBvybY2.png" alt="espconn_mesh_enable" />
<img src="http://i.imgur.com/OAC3v1k.png" alt="espconn_mesh_disable" />
<img src="http://i.imgur.com/4VE4LfU.png" alt="espconn_mesh_get_status" />
<img src="http://i.imgur.com/nL1ApJU.png" alt="espconn_mesh_connect" />
<img src="http://i.imgur.com/HW2jL3C.png" alt="espconn_mesh_disconnect" />
<img src="http://i.imgur.com/bDVScnj.png" alt="espconn_mesh_sent" />
<img src="http://i.imgur.com/SWhdlPv.png" alt="espconn_mesh_set_max_hop" />
<img src="http://i.imgur.com/7XQeKKP.png" alt="espconn_mesh_get_max_hop" />
<img src="http://i.imgur.com/iPK4CLN.png" alt="espconn_mesh_get_node_info" />
<img src="http://i.imgur.com/9lqq5x0.png" alt="espconn_mesh_local_addr" />
<img src="http://i.imgur.com/hxtkS50.png" alt="espconn_mesh_server_init" />
<img src="http://i.imgur.com/kk27vxO.png" alt="espconn_mesh_get_router" />
<img src="http://i.imgur.com/8MO0BNo.png" alt="espconn_mesh_set_router" />
<img src="http://i.imgur.com/OYFa67D.png" alt="espconn_mesh_encrypt_init" />
<img src="http://i.imgur.com/UUmQjpb.png" alt="espconn_mesh_set_ssid_prefix" />
<img src="http://i.imgur.com/wsGGmGK.png" alt="espconn_mesh_group_id_init" />
<img src="http://i.imgur.com/ciwvwV1.png" alt="espconn_mesh_set_dev_type" />
<img src="http://i.imgur.com/crA8NVu.png" alt="espconn_mesh_get_dev_type" />
<img src="http://i.imgur.com/MddfA9d.png" alt="espconn_mesh_print_ver" />
<img src="http://i.imgur.com/oTx1V3H.png" alt="espconn_mesh_scan" /></p></li>
<li><p>AT接口
<img src="http://i.imgur.com/uBBcloa.png" alt="at_response_ok" />
<img src="http://i.imgur.com/Hl7Wxrw.png" alt="at_response_error" />
<img src="http://i.imgur.com/wMckYre.png" alt="at_cmd_array_regist" />
<img src="http://i.imgur.com/4bqK9gn.png" alt="at_get_next_int_dec" />
<img src="http://i.imgur.com/c0oafeU.png" alt="at_data_str_copy" />
<img src="http://i.imgur.com/UdkkoRg.png" alt="at_init" />
<img src="http://i.imgur.com/bRMNu26.png" alt="at_port_print" />
<img src="http://i.imgur.com/Qh4Egbh.png" alt="at_set_custom_info" />
<img src="http://i.imgur.com/ojVLj93.png" alt="at_enter_special_state" />
<img src="http://i.imgur.com/7893WIC.png" alt="at_leave_special_state" />
<img src="http://i.imgur.com/Ntv3tdk.png" alt="at_get_version" />
<img src="http://i.imgur.com/9DJBqHV.png" alt="at_register_uart_rx_intr" />
<img src="http://i.imgur.com/BX32Nhi.png" alt="at_response" />
<img src="http://i.imgur.com/JTr50kC.png" alt="at_register_response_func" /></p></li>
<li><p>JSON接口
<img src="http://i.imgur.com/ON88llK.png" alt="jsonparse_setup" />
<img src="http://i.imgur.com/QiEDpFB.png" alt="jsonparse_next" />
<img src="http://i.imgur.com/SCa6Qd3.png" alt="jsonparse_copy_value" />
<img src="http://i.imgur.com/brv0X37.png" alt="jsonparse_get_value_as_int" />
<img src="http://i.imgur.com/d5RR8Wt.png" alt="jsonparse_get_value_as_long" />
<img src="http://i.imgur.com/WVOl4Ue.png" alt="jsonparse_get_value_len" />
<img src="http://i.imgur.com/HOFZdUg.png" alt="jsonparse_get_value_as_type" />
<img src="http://i.imgur.com/37m1XVv.png" alt="jsonparse_strcmp_value" />
<img src="http://i.imgur.com/ACKNxRZ.png" alt="jsontree_set_up" />
<img src="http://i.imgur.com/MxdDQEF.png" alt="jsontree_reset" />
<img src="http://i.imgur.com/YKXsm2O.png" alt="jsontree_path_name" />
<img src="http://i.imgur.com/tpRuPOI.png" alt="jsontree_write_int" />
<img src="http://i.imgur.com/0dfzHBw.png" alt="jsontree_write_int_array" />
<img src="http://i.imgur.com/JMdzDbN.png" alt="jsontree_write_string" />
<img src="http://i.imgur.com/kTFiCg8.png" alt="jsontree_print_next" />
<img src="http://i.imgur.com/YPZRVqT.png" alt="jsontree_find_next" /></p></li>
<li><p>GPIO接口
<img src="http://i.imgur.com/l4cAWaW.png" alt="PIN相关宏定义" />
<img src="http://i.imgur.com/0dYog5W.png" alt="gpio_output_set" />
<img src="http://i.imgur.com/LMjDjU1.png" alt="GPIO输入输出相关宏" />
<img src="http://i.imgur.com/xh7jhE8.png" alt="GPIO中断" />
<img src="http://i.imgur.com/HBeRCSR.png" alt="gpio_pin_intr_state_set" />
<img src="http://i.imgur.com/myjm32J.png" alt="GPIO中断处理函数" /></p></li>
<li><p>UART接口
默认情况下，UART0作为系统的打印信息输出接口，当配置为双UART时，UART0作为数据收发接口，UART1作为打印信息输出接口
<img src="http://i.imgur.com/SG8nMkv.png" alt="uart_init" />
<img src="http://i.imgur.com/7xpciAa.png" alt="uart0_tx_buffer" />
<img src="http://i.imgur.com/yPCsPRq.png" alt="uart0_rx_intr_handler" /></p></li>
<li><p>I2C Master接口
ESP8266不能作为I2C从设备，但可以作为I2C主设备，对其他I2C从设备进行控制和读写。每个GPIO管脚内部都可以配置为开漏模式，从而可以灵活地将GPIO口用作I2C data或者clock功能。同时芯片内部提供上拉电阻，以节省外部的上拉电阻
<img src="http://i.imgur.com/cFCO4NY.png" alt="i2c_master_gpio_init" />
<img src="http://i.imgur.com/9dEjKkE.png" alt="i2c_master_init" />
<img src="http://i.imgur.com/lj8qJuy.png" alt="i2c_master_start" />
<img src="http://i.imgur.com/dKOHZpG.png" alt="i2c_master_stop" />
<img src="http://i.imgur.com/UTNUycs.png" alt="i2c_master_send_ack" />
<img src="http://i.imgur.com/3UGpatY.png" alt="i2c_master_send_nack" />
<img src="http://i.imgur.com/UU2TSbP.png" alt="i2c_master_checkAck" />
<img src="http://i.imgur.com/gjxuJFt.png" alt="i2c_master_readByte" />
<img src="http://i.imgur.com/xOwdzPq.png" alt="i2c_master_writeByte" /></p></li>
<li><p>PWM接口
PWM驱动接口不能跟hw_timer的接口同时使用，因为二者共用了同一个硬件定时器
<img src="http://i.imgur.com/Xtahx9b.png" alt="pwm_init" />
<img src="http://i.imgur.com/XIbDsa7.png" alt="pwm_start" />
<img src="http://i.imgur.com/iKhLfuh.png" alt="pwm_set_duty" />
<img src="http://i.imgur.com/sJ3mGcB.png" alt="pwm_get_duty" />
<img src="http://i.imgur.com/Ixgd7Kz.png" alt="pwm_set_period" />
<img src="http://i.imgur.com/7PB2YeI.png" alt="pwm_get_period" />
<img src="http://i.imgur.com/jxVThkr.png" alt="pwm_get_version" /></p></li>
</ol>


<h2>参数结构和宏定义</h2>

<ol>
<li>定时器
<img src="http://i.imgur.com/SWbnx7J.png" alt="ETSTimer" /></li>
<li>WiFi参数
<img src="http://i.imgur.com/dA8A124.png" alt="station参数" />
<img src="http://i.imgur.com/QNMFXtn.png" alt="soft-AP参数" />
<img src="http://i.imgur.com/E7jjlFd.png" alt="scan参数" />
<img src="http://i.imgur.com/Uw9zTI9.png" alt="WiFi event结构体" />
<img src="http://i.imgur.com/ZP29Rew.png" alt="smart config结构体" /></li>
<li>json相关结构体
<img src="http://i.imgur.com/wnY8lSb.png" alt="json结构体" />
<img src="http://i.imgur.com/amJ4Pbv.png" alt="json宏定义" /></li>
<li>espconn参数
<img src="http://i.imgur.com/YCKqSWm.png" alt="回调函数" />
<img src="http://i.imgur.com/glbsJWw.png" alt="espconn" /></li>
<li>中断相关宏定义
<img src="http://i.imgur.com/i8UAMcA.png" alt="中断宏定义" /></li>
</ol>


<h2>ESPCONN编程</h2>

<ol>
<li>TCP client模式，步骤：

<ol>
<li>依据工作协议初始化espconn参数</li>
<li>注册连接成功的回调函数和连接失败重连的回调函数</li>
<li>调用espconn_connect建立与TCP Secver的连接</li>
<li>TCP连接建立成功后，在连接成功的回调函数(espconn_connect_callback)中，注册接收数据的回调函数，发送数据成功的回调函数和断开连接的回调函数</li>
<li>在接收数据的回调函数，或者发送数据成功的回调函数中，执行断开连接操作时，建议适当延时一定时间，确保底层函数执行结束</li>
</ol>
</li>
<li>TCP Server模式，步骤

<ol>
<li>依据工作协议初始化espconn参数</li>
<li>注册连接成功的回调函数和连接失败重连的回调函数</li>
<li>调用espconn_accept侦听TCP连接</li>
<li>TCP连接建立成功后，在连接成功的回调函数中，注册接收数据的回调函数，发送数据成功的回调函数和断开连接的回调函数</li>
</ol>
</li>
<li>espconn callback
<img src="http://i.imgur.com/X0xci3I.png" alt="espconn callback" />

<ul>
<li>注意：回调函数中传入的指针arg，对应网络连接的结构体espconn指针。该指针为SDK内部维护的指针，不同回调传入的指针地址可能不一样，请勿依此判断网络连接。可根据espconn结构体中的remote_ip，remote_port判断多连接中的不同网络传输</li>
<li>如果espconn_connect（或者espconn_secure_connect）失败，返回非零值，连接未建立，不会进入任何espconn callback</li>
<li>请勿在espconn热河回调中调用espconn_disconnect（或者espconn_secure_disconnect）断开连接。如果有需要，可以在espconn回调中使用触发任务的方式（system_os_task和system_os_post）调用espconn_disconnect（或者espconn_secure_disconnect）断开连接</li>
</ul>
</li>
</ol>


<h2>RTC使用实例</h2>

<p>以下测试示例，可以验证RTC时间和系统时间，在system_restart时的变化，以及读写RTC memory
<img src="http://i.imgur.com/SqM8KtO.png" alt="RTC示例" /></p>

<h2>Sniffer结构体说明</h2>

<ol>
<li>ESP8266可以进入混杂模式，接收空气中的IEEE802.11包，可支持如下HT20的包：

<ol>
<li>802.11b</li>
<li>802.11g</li>
<li>802.11n（MCS0到MCS7）</li>
<li>AMPDU</li>
</ol>
</li>
<li>尽管有些类型的IEEE802.11包是ESP8266不能完全接收的，但ESP8266可以获得它们的包长。因此，sniffer模式下，ESP8266或者可以接收完整的包，或者可以获得包的长度</li>
<li>ESP8266可完全接收的包，包含：

<ol>
<li>一定长度的MAC头信息（包含了收发双发的MAC地址和加密方式）</li>
<li>整个包的长度</li>
</ol>
</li>
<li>ESP8266不可完全接收的包，它包含：

<ol>
<li>整个包的长度</li>
</ol>
</li>
<li>结构体RxControl和sniffer_buf分别用于via哦是这两种类型的包。其中结构体sniffer_buf包含结构体RxControl。
<img src="http://i.imgur.com/WiqsD0p.png" alt="sniffer结构体" />
回调函数wifi_promiscuous_rx含两个参数（buf和len）。len表示buf的长度，分为三种情况：len=128，len为10的整数倍，len=12；

<ol>
<li>LEN==128的情况

<ul>
<li>buf的数据是结构体sniffer_buf2，该结构体对应的数据包是管理包，含有112字节的数据</li>
<li>sniffer_buf2.cnt为1</li>
<li>sniffer_buf2.len为管理包的长度</li>
</ul>
</li>
<li>LEN为10的整数倍的情况

<ul>
<li>buf的数据是结构体sniffer_buf，该结构体是比较可信的，它对应的数据包是通过CRC校验正确的</li>
<li>sniffer_buf.cnt表示了该buf包含的包的个数，len的值由sniffer_buf.cnt决定</li>
<li>sniffer_buf.cnt==0表示此buf无效；否则len=5=+cnt*10</li>
<li>sniffer_buf.buf表示IEEE802.11包的前36字节。从成员sniffer_buf.lenseq[0]开始，每一个lenseq结构体表示一个包长信息</li>
<li>当sniffer_buf.cnt>1，由于该包是一个AMPDU，认为每个MPDU的包头基本是相同的，因此没有给出所有的MPDU包头，只给出了每个包的长度（从MAC包头开始到FCS）</li>
<li>该结构体中较为游泳的信息有：包长、包的发送者和接收者、包头长度</li>
</ul>
</li>
<li>LEN==12的情况

<ul>
<li>buf的数据是一个结构体RxControl，该结构体是不太可信的，它无法表示包所属的发送和接收者，也无法判断该报的包头长度</li>
<li>对于AMPDU包，也无法判断子包的个数和每个子包的长度</li>
<li>该结构体中较为有用的信息有：包长，rssi和FEC_CODING</li>
<li>RSSI和FEC_CODING可以用于评估是否是同一个设备所发</li>
</ul>
</li>
</ol>
</li>
</ol>


<h2>ESP8266信道的定义</h2>

<ol>
<li>虽然ESP8266支持soft-AP和station共存模式，但是ESP8266实际只有一个硬件通道。因此在soft-AP+station模式时，ESP8266 soft-AP会动态调整信道值与ESP8266 station一致
<img src="http://i.imgur.com/0l6M5tU.png" alt="ESP8266 soft-AP+station模式注意事项" /></li>
</ol>


<h2>AT 官方指令</h2>

<ol>
<li>如果开发板Flash为4Mbit，则无法使用固件升级功能（对应指令AT+CIUPDATE），只能采用non-boot的烧录方式。固件升级功能要求Flash容量为8Mbit或以上，采用boot mode的烧录方式</li>
<li>AT底层已经占用system_os_task优先级0和1，因此用户如基于AT开发，仅支持建立一个优先级为2的任务</li>
<li>波特率为115200</li>
<li>AT指令必须大写，以回车换行符结尾“\r\n”</li>
<li>AT Demo仅在ESP8266作为TCP client单连接或者UDP传输时，支持透传</li>
<li>目前AT Demo ESP8266仅支持一个TCP服务器，且必须使能多连接，即可连接多个TCP client
<img src="http://i.imgur.com/ZHMdvIV.png" alt="基础AT指令" />
<img src="http://i.imgur.com/KWLgQRV.png" alt="WiFi功能AT指令" />
<img src="http://i.imgur.com/qftT477.png" alt="TCP/IP相关AT指令" />
<img src="http://i.imgur.com/iY82gSq.png" alt="保存设置到Flash的AT指令" /></li>
</ol>


<h2>GPIO</h2>

<p><img src="http://i.imgur.com/DtNrGiF.png" alt="ESP8266-GPIO" /></p>

<ol>
<li>ESP8266共有16个通用IO，管脚的位置和管脚的名称分别为：</li>
<li>在四线（QUAD）模式flash下，有6个IO用于flash通讯；在两线（DUAL）模式flash下，有四个IO用于与flash通讯</li>
<li>与其他IO口不同，GPIO16不属于通用GPIO模块，它属于RTC模块，可以用来在深度睡眠时候唤醒整个芯片，可以配置为输入或者输出模式，但是无法触发IO中断

<ol>
<li>将GPIO16配置为输出模式：gpio16_output_conf(void)</li>
<li>从GPIO16输出高/低电平，需要先配置为输出模式：gpio16_output_set(uint8 value)</li>
<li>将GPIO16配置为输入模式:gpio16_input_conf(void)</li>
<li>读取GPIO16的输入电平状态，需要先配置为输入模式:gpio16_input_get(void)</li>
</ol>
</li>
</ol>


<h2>Free-RTOS</h2>

<ol>
<li>编程注意事项：

<ol>
<li>建议使用定时器实现长时间的查询功能，可将定时器设置为循环调用,注意：

<ol>
<li>定时器（freeRTOS timer或os_timer）执行函数内部请勿使用while（1）或其他能阻塞线程的方式延时，例如，不能在定时器回调中进行socket send操作，因为send函数会阻塞线程</li>
<li>定时器回调执行请勿超过15毫秒</li>
<li>os_timer_t建立的变量不能为局部变量，必须为全局变量、静态变量或os_malloc分配的指针</li>
</ol>
</li>
<li>从esp_iot_rtos_sdk_v1.2.0起，无需添加宏ICACHE_FLASH_ATTR，函数默认存放在CACHE区，中断函数也可以存放在CACHE区；如需将部分频繁调用的函数定义在RAM中，请在函数前面添加宏IRAM_ATTR</li>
<li>网络编程使用通用的socket编程，网络通信时，socket请勿绑定在同一个端口</li>
<li>RTOS SDK的系统任务最高优先级为14，创建任务的接口xTaskCreate为freeRTOS自带接口，使用下TaskCreate创建任务时，任务堆栈甚至范围为【176，512】

<ol>
<li>在任务内部如需使用长度超过60的大数组，建议使用os_malloc和os_free的方式操作，否则，大数组将占用任务的堆空间</li>
<li>SDK底层已占用部分优先级：watchdog task优先级14，pp task优先级13，高精度timer(ms)线程优先级12，TCP/IP task优先级10，freeRTOS timer优先级2，idle task优先级为0，pm task优先级1</li>
<li>可供用户线程使用的优先级为1~9</li>
<li>请勿修改FreeRTOSConfig.h，此处修改头文件并不能生效，设置由SDK库文件决定</li>
</ol>
</li>
</ol>
</li>
<li>esp_iot_rtos_sdk默认使用UART0打印调试信息，默认波特率为74880</li>
<li>esp_iot_rtos_sdk支持多线程，可以建立多个任务。创建任务的接口xTaskCreate为freeRTOS自带接口，使用xTaskCreate创建任务时，任务堆栈设置范围为[176,512]</li>
<li>RTC使用
<img src="http://i.imgur.com/qBVkRA7.png" alt="复位对RTC的影响" /></li>
</ol>


<h2>非OS SDK与RTOS SDK创建任务的方式对比</h2>

<figure class='code'><figcaption><span>非OS SDK创建任务</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#define Q_NUM （10）</span>
</span><span class='line'><span class="n">ETSEvent</span> <span class="n">test_q</span><span class="p">[</span><span class="n">Q_NUM</span><span class="p">];</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">test_task</span><span class="p">(</span><span class="n">ETSEvent</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">switch</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>      <span class="n">func1</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>      <span class="n">func2</span><span class="p">();</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>      <span class="n">func3</span><span class="p">();</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">default</span><span class="o">:</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">func_send_Sig</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">ETSSignal</span> <span class="n">sig</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>  <span class="n">system_os_post</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">task_ini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">system_os_task</span><span class="p">(</span><span class="n">test_task</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">test_q</span><span class="err">，</span><span class="n">Q_NUM</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">// test_q is the corresponding array of test_task.</span>
</span><span class='line'>  <span class="c1">// (2) is the priority of test_task.</span>
</span><span class='line'>  <span class="c1">// Q_NUM is the queue length of test_task.</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>RTOS SDK创建任务</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#define Q_NUM （10）</span>
</span><span class='line'><span class="n">xQueueHandle</span> <span class="n">test_q</span><span class="p">;</span>
</span><span class='line'><span class="n">xTaskHandle</span> <span class="n">test_task_hdl</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">test_task</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pvParameters</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">sig</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(;;){</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">pdTRUE</span> <span class="o">==</span> <span class="n">xQueueReceive</span><span class="p">(</span><span class="n">test_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="p">(</span><span class="n">portTickType</span><span class="p">)</span><span class="n">portMAX_DELAY</span><span class="p">)</span> <span class="p">){</span>
</span><span class='line'>          <span class="n">vTaskSuspendAll</span><span class="p">();</span>
</span><span class='line'>          <span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">sig</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>              <span class="n">func1</span><span class="p">();</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>              <span class="n">func2</span><span class="p">();</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">default</span><span class="o">:</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="n">free</span><span class="p">(</span><span class="n">sig</span><span class="p">);</span>
</span><span class='line'>          <span class="n">xTaskResumeAll</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">func_send_Sig</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">evt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">sizeif</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span><span class='line'>  <span class="o">*</span><span class="n">evt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">xQueueSend</span><span class="p">(</span><span class="n">test_q</span><span class="p">,</span><span class="o">&amp;</span><span class="n">evt</span><span class="p">,</span><span class="mi">10</span><span class="o">/</span><span class="n">portTick_RATE_MS</span><span class="p">)</span><span class="o">!=</span><span class="n">pdTRUE</span><span class="p">){</span>
</span><span class='line'>      <span class="n">os_printf</span><span class="p">(</span><span class="s">&quot;test_q is full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// It is the address of parameter that stored in test_q, so int *evt and int</span>
</span><span class='line'>  <span class="o">*</span><span class="n">sig</span> <span class="n">can</span> <span class="n">be</span> <span class="n">other</span> <span class="n">types</span><span class="p">.</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">task_ini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">test_q</span> <span class="o">=</span> <span class="n">xQueueCreate</span><span class="p">(</span><span class="n">Q_NUM</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
</span><span class='line'>  <span class="n">xTaskCreate</span><span class="p">(</span><span class="n">test_task</span><span class="p">,(</span><span class="kt">signed</span> <span class="n">portCHAR</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;test_task&quot;</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span><span class='line'>              <span class="o">&amp;</span><span class="n">test_task_hdl</span> <span class="p">);</span>
</span><span class='line'>  <span class="c1">// 512 means the heap size of this task, 512 * 4 byte.</span>
</span><span class='line'>  <span class="c1">// NULL is a pointer of parameter to test_task.</span>
</span><span class='line'>  <span class="c1">// (1) is the priority of test_task.</span>
</span><span class='line'>  <span class="c1">// test_task_hdl is the pointer of the task of test_task.</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>强制系统休眠</h2>

<ol>
<li>强制休眠接口调用后，并不会立即休眠，而是等到系统idle task执行时才进入休眠</li>
<li>Modem-sleep</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#define FPM_SLEEP_MAX_TIME 0xFFFFFFF</span>
</span><span class='line'><span class="n">wifi_station_disconnect</span><span class="p">();</span>
</span><span class='line'><span class="n">wifi_set_opmode</span><span class="p">(</span><span class="n">NULL_MODE</span><span class="p">);</span> <span class="c1">// set WiFi mode to null mode</span>
</span><span class='line'><span class="n">wifi_fpm_set_sleep_type</span><span class="p">(</span><span class="n">MODEM_SLEEP_T</span><span class="p">);</span> <span class="c1">// set modem sleep</span>
</span><span class='line'><span class="n">wifi_fpm_open</span><span class="p">();</span> <span class="c1">// enable force sleep</span>
</span><span class='line'><span class="n">wifi_fpm_do_sleep</span><span class="p">(</span><span class="n">FPM_SLEEP_MAX_TIME</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="n">wifi_fpm_do_wakeup</span><span class="p">();</span> <span class="c1">// wake up to use WiFi again</span>
</span><span class='line'><span class="n">wifi_fpm_close</span><span class="p">();</span> <span class="c1">// disable force sleep</span>
</span><span class='line'><span class="n">wifi_set_opmode</span><span class="p">(</span><span class="n">STATION_MODE</span><span class="p">);</span> <span class="c1">//set station mode</span>
</span><span class='line'><span class="n">wifi_station_connect</span><span class="p">();</span> <span class="c1">//connect to AP</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Light-sleep</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="kt">void</span> <span class="nf">fpm_wakup_cb_func1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="n">wifi_fpm_close</span><span class="p">();</span> <span class="c1">// disable force sleep function</span>
</span><span class='line'><span class="n">wifi_set_opmode</span><span class="p">(</span><span class="n">STATION_MODE</span><span class="p">);</span> <span class="c1">// set station mode</span>
</span><span class='line'><span class="n">wifi_station_connect</span><span class="p">();</span> <span class="c1">// connect to AP</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">user_func</span><span class="p">(...)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="n">wifi_station_disconnect</span><span class="p">();</span>
</span><span class='line'><span class="n">wifi_set_opmode</span><span class="p">(</span><span class="n">NULL_MODE</span><span class="p">);</span> <span class="c1">// set WiFi mode to null mode.</span>
</span><span class='line'><span class="n">wifi_fpm_set_sleep_type</span><span class="p">(</span><span class="n">LIGHT_SLEEP_T</span><span class="p">);</span> <span class="c1">// light sleep</span>
</span><span class='line'><span class="n">wifi_fpm_open</span><span class="p">();</span> <span class="c1">// enable force sleep</span>
</span><span class='line'><span class="n">wifi_fpm_set_wakeup_cb</span><span class="p">(</span><span class="n">fpm_wakup_cb_func1</span><span class="p">)</span><span class="err">；</span> <span class="c1">// Set wakeup callback</span>
</span><span class='line'><span class="n">wifi_fpm_do_sleep</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>spiffs文件系统应用</h2>

<h2>Windows下网络防火墙对TCP Server的屏蔽</h2>

<ol>
<li>Win+R，输入wf.msc,进入高级安全Windows防火墙</li>
<li>在<strong>入站规则</strong>右击新建规则</li>
<li>在<strong>规则类型</strong>对话框中选择“程序”</li>
<li>指名程序的路径</li>
<li>允许连接</li>
</ol>


<h2>PWM接口</h2>

<ol>
<li>ESP8266系统的PWM由<strong>FRC1</strong>在软件上实现，可实现同频率、不同占空比的多路PWM，可用来控制彩灯、蜂鸣器和电机等设备</li>
<li>FRC1是一个23bit的硬件定时器</li>
<li>使用NMI中断，更加精确</li>
<li>可扩展最多8路PWM信号</li>
<li>大于14bit的分辨率，最小分辨率45ns</li>
<li>PWM的时钟源由高速系统时钟提供，其频率高达80MHz。PWM通过预分频器将时钟源16分频，其输入时钟频率为5MHz。PWM通过FRC1来产生粗调定时，结合高速系统时钟的微调，可将分辨率提高到45ns</li>
<li>PWM时钟周期：100Hz~1KHz</li>
</ol>


<h2>UART接口</h2>

<ol>
<li>UART0默认情况下会在上电booting期间输出一些打印，此期间打印内容的波特率与所用的外部晶振频率有关。使用40M晶振时，该段打印波特率为115200。使用26M晶振时，该段打印波特率为74880</li>
<li>UART0和UART1各有一个长度为128Byte的硬件FIFO，读写FIFO都在同一个地址操作</li>
<li>如何屏蔽上电打印：使用uart的内部引脚交换功能，在初始化的时候，将U0TXD、U0RXD分别与U0RTS、U0CTS交换</li>
</ol>


<h2>Sleep接口</h2>

<p><img src="http://i.imgur.com/5VMutHe.png" alt="三种sleep模式的区别" />
1. 对于Modem-sleep和Light-sleep模式，SDK提供接口来使能睡眠模式，并由系统底层决定何时进入睡眠。在deep-sleep模式下，何时进入睡眠由用户控制，调用接口函数就可立即进入deep-sleep模式，
2. Modem-sleep仅工作在Station模式下，连接路由器后生效，ESP8266通过Wi-Fi的DTIM（Delivery Traffic Indication Message）Beacon机制与路由器保持连接。一般路由器的DTIM Beacon间隔为100ms~1000ms。在Modem-sleep模式下，ESP8266会在两次DTIM Beacon间隔时间内，关闭Wi-Fi模块电路，达到省电效果，在下次Beacon到来前自动唤醒。睡眠时间由路由器的DTIM Beacon时间决定。睡眠同时可以保持与路由器的Wi-Fi连接，并通过路由器接受来自手机或者服务器的交互信息。
3. 在Modem-sleep模式下，系统可以自动被唤醒，无需配置接口。Modem-sleep一般用于必须打开CPU的应用场景，例如PWM彩灯，需要CPU实时控制
4. Light-sleep的工作模式与Modem-sleep相似，不同的是，除了关闭Wi-Fi模块电路以为，在Light-sleep模式下，还会关闭时钟并暂停内部的CPU。在Wi-Fi连接后，并且CPU处于空闲状态时，会自动进入Light-sleep状态
5. 在Light-sleep模式下，CPU在暂停状态下不会响应来自外围硬件接口的信号与终端，因此需要配置通过外部GPIO信号将ESP8266唤醒，唤醒过程小于3ms。通过GPIO唤醒只能配置为<strong>电平触发模式</strong>。接口如下：<strong>void gpio_pin_wakeup_enable(uint32 i, GPIO_INT_TYPE intr_state);</strong>，其中i为唤醒功能的IO序号，intr_state为唤醒的触发模式，只能是GPIO_PIN_INTR_LOLEVEL或者GPIO_PIN_INTR_HILEVEL。
6. Light-sleep模式可用于需要保持与路由器的链接，可以实时响应路由器发来的数据的场合。并且在未收到命令时，CPU可以处于空闲状态。比如Wi-Fi开关的应用，大部分时间CPU都是空闲的，知道收到控制命令，CPU才需要进行GPIO的操作。若系统应用中有小于DTIM Beacon间隔时间的循环定时，系统将不能进入Light-sleep模式。
7. Deep-sleep由用户控制，调用接口函数就可立即进入Deep-sleep模式，在该模式下，芯片会断开所有的Wi-Fi连接与数据连接，进入睡眠模式，只有RTC模块仍然工作，负责芯片的定时唤醒。使用Deep-sleep必须将GPIO16与芯片EXT_RSTB管脚连接。
8. 配置Deep-sleep
<img src="http://i.imgur.com/4kuXKWI.png" alt="配置Deep-sleep" />
9. 在Deep-sleep状态下，可以通过外部IO在芯片EXT_RSTB管脚上产生一个低电平脉冲，芯片即可被唤醒并启动
10. Deep-sleep可以用于低功耗的传感器应用，或者大部分时间都不需要进行数据传输的情况。设备可以每隔一段时间从Deep-sleep状态醒来测量数据并上传，之后继续进入Deep-sleep。也可以将多个数据存储于RTC memory（RTC memory在Deep-sleep模式下任然可以保存数据），然后一次发送出去</p>

<h2>I2C接口</h2>

<ol>
<li>每个GPIO管脚内部都可以配置为开漏模式，从而可以灵活地将GPIO口用作I2C data或clock功能，同时芯片内部提供上拉电阻，以节省外部的上拉电阻。ESP8266作为I2C主机的SDA与SCL线波形由GPIO模拟产生，在SCL的上升沿之后SDA读取数据。SCL高低电平各保持5us，因此I2C时钟频率约为100KHz</li>
</ol>


<h2>OTA升级</h2>

<ol>
<li>在支持云端升级的软件中，boot.bin用于选择运行user1还是user2，而主程序由原本的eagle.flash.bin和eagle.iromtext.bin合并为user1.bin或user2.bin</li>
<li>system param区存了一个flag，标识启动时应当运行user1还是user2</li>
<li>启动时先运行boot，boot读取system param区中的flag，判断运行user1还是user2，然后到SPI Flash的对应位置去取</li>
<li>上传时，将新版本的 user1.bin 和 user2.bin 均上传⾄至服务器，由设备⾃自⾏行判断应该下载user1.bin 还是 user2.bin</li>
<li>user1.bin 和 user2.bin 是同样的可执⾏行软件，差别仅在于 flash 的存放位置不同</li>
<li><a href="http://iot.espressif.cn/#/">固件升级服务器网址</a></li>
<li>软件接口
<img src="http://i.imgur.com/M0E9B5D.png" alt="struct upgrade_server_info" />
<img src="http://i.imgur.com/CqL3FLL.png" alt="FOTA升级" /></li>
<li>上传服务器的固件版本命名形如：[v|b]Num1.Num2.Num3.tPTYPE([o|l|a|n])

<ol>
<li>v：表示发布版本，b：表示测试版本</li>
<li>版本值为：Num1<em>1000</em>1000 + Num2*1000 + Num3</li>
<li>Light ptype = 45772</li>
<li>Switch ptype = 23701</li>
<li>general ptype = 27388</li>
<li>o表示支持在线升级</li>
<li>l表示支持本地升级</li>
<li>a表示既支持在线升级，也支持本地升级</li>
<li>n表示不支持升级</li>
</ol>
</li>
</ol>


<h2>红外遥控</h2>

<ol>
<li>用于发送的载波可以采用以下几种方式：

<ol>
<li>I2S的BCK</li>
<li>WS脚产生38KHz载波</li>
<li>由GPIO中的sigma-delta功能在任意GPIO口产生载波，但sigma-delta产生的载波占空比约为20%，推荐使用MTMS脚（GPIO14），可产生准确的38KHz且占空比为50%的标准方波</li>
<li>通过系统FRC2的DSR TIMER接口，产生发送序列并驱动红外发送状态机。由于发送NEC红外码需要精确到us级的定时，所以在IR TX初始化时候，会先调用system_timer_reinit来提高FRC2 timer的精度。</li>
</ol>
</li>
<li>红外接收功能主要通过GPIO的边沿中断完成。读取系统时间，将两次时间相减可以得到波形持续时间。由软件状态机ir_intr_handler进行处理</li>
<li>红外接收通过GPIO中断实现，而同时，系统只能注册一个IO中断处理程序，如果有其他IO口也需要中断的话，请将这些中断在同一个处理程序中处理（判断中断源并相应处理）</li>
<li>在非OS版本的SDK中，进入中断处理（GPIO、UART、FRC等）直到退出中断的整个过程中，不可调用带ICACHE_FLASH_ATTR属性的函数，包括打印函数os_printf</li>
<li>硬件电路图</li>
</ol>


<p><img src="http://i.imgur.com/z3EJhmR.png" alt="硬件电路图" /></p>

<h2>SSL/TLS加密</h2>

<p><img src="http://i.imgur.com/YJZiqwC.png" alt="SSL协议报文" /></p>

<ol>
<li>SSL运行在TCP/IP层之上、应用层之下，为应用程序提供加密数据通道，它采用了RC4、MD5以及RSA等加密算法，使用40位的密钥。</li>
<li>HTTPS实际上就是HTTP over SSL，它使用默认端口443，而不是像HTTP那样使用端口80。</li>
<li>HTTPS协议使用SSL在发送方把原始数据进行加密，然后在接收方进行解密，加密和解密需要发送方和接收方通过交换公知的密钥来实现，因此，所传送的数据不容易被网络何可截获和解密
<img src="http://i.imgur.com/rahzPAL.png" alt="SSL通信过程" /></li>
<li>工作流程

<ol>
<li>建立安全能力。SSL捂手的第一阶段启动逻辑连接，建立这个连接的安全能力。首先客户机向服务器发出client hello消息并等待服务器响应，随后服务器向客户机返回server hello消息，对client hello消息中的信息进行确认。

<ol>
<li>Client hello消息包括：

<ol>
<li>客户端可以支持的SSL最高版本号</li>
<li>一个客户端生成的随机数，稍后用于生成“对话密钥”</li>
<li>一个确定会话的会话ID</li>
<li>一个客户端可以支持的密码套件列表，每个套件都以SSL开头，紧跟着的是密钥交换算法，用with这个词把密钥交换算法、机密算法、散列算法分开。例如：SSL_DHE_RSA_WITH_DES_CBC_SHA, 表示把DHE_RSA(带有RSA数字签名的暂时Diffie-HellMan)定义为密钥交换算法；把DES_CBC定义为加密算法；把SHA定义为散列算法。</li>
<li>一个客户端可以支持的压缩算法列表</li>
</ol>
</li>
<li>Server Hello消息包括

<ol>
<li>一个SSL版本号。去客户端支持的最高版本号和服务端支持的最高笨笨好中的较低者</li>
<li>一个服务器生成的随机数，稍后用于生成“对话密钥”</li>
<li>会话ID</li>
<li>从客户端的密码条件列表中选择的一个密码套件</li>
<li>从客户端的压缩方法的列表中选择的压缩方法</li>
</ol>
</li>
<li>这个阶段之后，客户端服务端知道了下列内容：

<ol>
<li>SSL版本</li>
<li>密钥交换、信息验证和加密算法</li>
<li>压缩方法</li>
<li>有关密钥生成的两个随机数</li>
</ol>
</li>
</ol>
</li>
<li>服务器鉴别与密钥交换。服务器启动SSL握手第二阶段，是本阶段所有消息的唯一发送方，客户机是所有消息的唯一接收方。该阶段分为4步

<ol>
<li>证书：服务器将数字证书和到根CA整个链发给客户端，使客户端能用服务器证书中的服务器公钥认证服务器</li>
<li>服务器密钥交换：这里视密钥交换算法而定</li>
<li>证书请求：服务端可能会要求客户自身进行验证</li>
<li>服务器握手完成</li>
</ol>
</li>
<li>客户机鉴别与密钥交换。客户机启动SSL握手第三阶段，是本阶段所有消息的唯一发送方，服务器是所有消息的唯一接收方。该阶段分为3歩：

<ol>
<li>证书：为了对服务器证明自身，客户要发送一个整数信息，这是可选的</li>
<li>客户机密钥交换：这里客户端将预备主密钥发送给服务端，注意这里会使用服务端的公钥进行加密</li>
<li>证书验证：对预备密钥和随机数进行签名</li>
</ol>
</li>
<li>完成，客户机启动SSL握手的第四阶段，是服务器结束。该阶段分成4歩</li>
</ol>
</li>
<li>SSL协议可分为两层：

<ol>
<li>SSL记录协议：它建立在可靠的传输协议之上，为高层协议提供数据封装、压缩、加密等基本功能的支持</li>
<li>SSL握手协议：它建立在SSL记录协议之上，用于在实际数据传输开始前，通讯双方进行身份认证、协商加密算法、交换密钥等</li>
</ol>
</li>
<li>ESP8266作为SSL server时，提供加密证书的制作脚本，生成SSL加密所需的头文件cert.h和private_key.h。CA认证功能默认关闭，用户可调用接口espconn_secure_ca_enable使能CA认证

<ol>
<li>证书制作：tool文件夹下，修改makefile.sh文件里面的IP地址为实际SSL 服务器的IP地址；然后./makefile.sh</li>
<li>开发者必须调用espconn_secure_set_default_certificate和espconn_secure_set_default_private_key传入证书和密钥</li>
<li>证书制作脚本makefile.sh生成默认SSL server证书由Espressif System颁发，并非由CA颁发。如果用户需要CA认证，请将运行脚本Makefile.sh生成的TLS.ca_x509.cer导入SSL client，并使用脚本make_cacert.py将CA文件生成eap_ca_cert.bin烧写到Flash对应的地址</li>
</ol>
</li>
<li>ESP8266作为SSL client时，可支持双向认证。CA认证功能默认关闭，用户可调用接口espconn_secure_ca_enable使能CA认证</li>
<li>ESP8266作为SSL client时支持证书认证功能，但此功能默认关闭，开发者可以调用接口espconn_secure_cert_req_enable使能证书认证，证书制作：

<ol>
<li>修改脚本makefile.sh，制作开发者自行签发的CA证书，例如，证书实例中的TLS.ca_x509.cer</li>
<li>使用签发的CA制作供SSL client使用的证书，例如，证书示例中的TLS.x509_1024.cer</li>
<li>去除制作SSL client使用的证书时所用的密钥，例如证书示例中的TLS.key_1024</li>
<li>将证书合成脚本make_cacert.py与CA文件放在同一目录下</li>
<li>运行脚本“make_cacert.py”将合成同一目录下的CA文件生成sap_ca_cert.bin，esp_ca_cert.bin的烧录位置由接口espconn_secure_ca_enable设置，用户可以自行定义</li>
<li>重命名证书名称（例如TLS.x509_1024.cer）；重命名密钥名称，改为private_key.key_1024。</li>
<li>将重命名后的文件，与脚本make_cert.py拷贝到同一目下下</li>
<li>运行脚本make_cert.py生成esp_cert_private_key.bin，esp_cert_private_key.bin的烧录位置由接口espconn_secure_cert_enable设置，用户可自行定义</li>
</ol>
</li>
<li>软件接口

<ol>
<li>SSL系列软件接口与普通TCP软件接口，在SDK底层是两套不同的处理流程，因此不能混用两种软件接口。SSL连接时，仅支持使用：

<ol>
<li>espconn_secure_XXX系列接口</li>
<li>espconn_regist_XXX系列注册回调的接口</li>
<li>espconn_port获得一个空闲的端口</li>
</ol>
</li>
</ol>
</li>
<li>在SSL中会使用密钥交换算法交换密钥；使用密钥对数据进行加密；使用散列算法对数据的完整性进行验证，使用数字证书证明自己的身份</li>
<li>SSL/TLS协议的基本思路是采用<strong>公钥加密法</strong>，也就是说，客户端先向服务器所要公钥，然后用公钥加密信息，服务器收到密文后，用自己的私钥解密。

<ol>
<li>如何保证公钥不被篡改？

<ul>
<li>将公钥放在数字证书中。只要证书时可信的，公钥就是可信的</li>
</ul>
</li>
<li>公钥加密计算量太大，如何减少耗用的时间？

<ul>
<li>每一次对话（session），客户端和服务器都生成一个“对话密钥”，用它来加密信息。由于“对话密钥”是对称加密，所以运算速度非常快，而服务器公钥只用于加密“对话密钥”本身，这样就减少了加密运算的消耗时间</li>
</ul>
</li>
<li>SSL/TLS协议的基本过程是这样的：

<ol>
<li>客户端向服务端索要并验证公钥</li>
<li>双方协商生成“对话密钥”</li>
<li>双方采用“对话密钥”进行加密通信</li>
</ol>
</li>
<li>为什么要用三个随机数来生成“会话密钥”？

<ul>
<li>不管是客户端还是服务器，都需要随机数，这样生成的密钥才不会每次都一样。由于SSL协议中证书是静态的，因此十分有必要引入一种随机因素来保证协商出来的密钥的随机性。对于RSA密钥交换算法来说，pre-master-key本身就是一个随机数，再加上hello消息中的随机，三个随机数通过一个密钥导出器最终导出一个对称密钥。pre master的存在在于SSL协议不信任每个主机都能产生完全随机的随机数，如果随机数不随机，那么pre master secret就有可能被猜出来，那么仅适用pre master secret作为密钥就不合适了，因此必须引入新的随机因素，那么客户端和服务器加上pre master secret三个随机数一同生成的密钥就不容易被猜出了，一个伪随机可能完全不随机，可是是三个伪随机就十分接近随机了，每增加一个自由度，随机性增加的可不是一。</li>
</ul>
</li>
</ol>
</li>
</ol>


<h2>Flash接口</h2>

<ol>
<li>一个扇区为4KB，从扇区0开始计数，以下接口可以读写整个Flash的任意区域

<ol>
<li>SpiFlashOpResult spi_flash_erase_sector (uint16 sec)：擦除Flash的某个扇区</li>
<li>SpiFlashOpResult spi_flash_write (uint32 des_addr,uint32 *src_addr, uint32 size)：将数据写入Flash</li>
<li>SpiFlashOpResult spi_flash_read(uint32 src_addr,uint32 * des_addr, uint32 size)：读取Flash中的数据</li>
</ol>
</li>
<li>在IoT_Demo中，将应用级数据存储在了0x3C000开始的4X4KB区域。例如，master_device_key.bin(用户参数，仅在需使用Espressif Cloud的情况需烧录)烧录在0x3E000地址</li>
<li>Flash擦除的最小单元为一个扇区，当存储在某个扇区的数据需要改写时，流程是先擦掉整个扇区，再将该扇区的数据写回去</li>
<li>读写保护的方法：

<ul>
<li>使用三个扇区，提供4KB的可靠存储空间

<ol>
<li>将sector1和sector2作为数据sector，轮流读写，时钟分别存放“本次”数据和“前一次”数据，确保了至少有一份数据存储安全；sector3作为flag sector，标志最新的数据存储sector。</li>
<li>初次上电时，数据存储在sector2中，从sector2中将数据读到RAM</li>
<li>第一次写数据时，将数据写入sector1.此时若突然掉电，sector1写入失败，sector2&amp;3数据未改变；重新上电时，仍是从sector2中读取数据，不影响使用。</li>
<li>改写sector3，将标志置为0，表示数据存于sector1.此时若突然掉电，sector3写入失败，sector1&amp;2均存有一份完整的数据，重新上电时，因为sector3无效，默认从sector2中读取数据，则仍能正常使用，只是未能包含掉电前对sector1写入的数据</li>
<li>再一次写数据时，先从sector3读取flag，若flag为0，则上次数据存于sector1，此次应将数据写入sector2；若flag为非0，则认为上次数据存于sector2，此时应将数据写入sector1.</li>
<li>写入sector1或者sector2完成后才会写sector3，重置flag</li>
</ol>
</li>
</ul>
</li>
</ol>


<h2>cJSON使用</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">cJSON</span> <span class="p">{</span>
</span><span class='line'> <span class="k">struct</span> <span class="n">cJSON</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span><span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span><span class='line'> <span class="k">struct</span> <span class="n">cJSON</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
</span><span class='line'> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'> <span class="kt">char</span> <span class="o">*</span><span class="n">valuestring</span><span class="p">;</span>
</span><span class='line'> <span class="kt">int</span> <span class="n">valueint</span><span class="p">;</span>
</span><span class='line'> <span class="kt">double</span> <span class="n">valuedouble</span><span class="p">;</span>
</span><span class='line'> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">cJSON</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>cJSON结构体为一个双向链表，并可通过child指针访问下一层</li>
<li>type变量决定数据类型，数据项可以是字符串可以是整形，也可以是浮点型。如果是整形的话可以从valueint取出，如果是浮点型的话可以从valuedouble取出，以此类推</li>
<li>主要函数说明

<ol>
<li>解析

<ol>
<li>cJSON_Parse函数负责解析JSON数据包，并按照cJSON结构体的结构序列化整个数据包。使用该函数会通过malloc函数在内存中开辟一个空间，使用完成需要手动释放</li>
<li>cJSON_GetObjectItem函数可以从cJSON结构体中查找某个子节点名称，如果查找成功，可把该子节点序列化到cJSON结构体中</li>
<li>如果需要使用cJSON结构体中的内容，可通过cJSON结构体中的valueint和valuestring取出有价值的内容</li>
<li>通过cJSON_Delete释放内存空间</li>
</ol>
</li>
<li>组装

<ol>
<li>cJSON_CreateObject函数可创建一个根数据项，之后便可向该根数据项中添加string或int等内容</li>
<li>cJSON_AddNumberToObject向节点中添加子节点</li>
<li>cJSON_Print函数可以打印跟数据项</li>
</ol>
</li>
</ol>
</li>
<li>使用例子：</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'> <span class="n">cJSON</span><span class="o">*</span> <span class="n">pRoot</span> <span class="o">=</span> <span class="n">cJSON_CreateObject</span><span class="p">();</span>
</span><span class='line'> <span class="n">cJSON</span><span class="o">*</span> <span class="n">pArray</span> <span class="o">=</span> <span class="n">cJSON_CreateArray</span><span class="p">();</span>
</span><span class='line'> <span class="n">cJSON_AddItemToObject</span><span class="p">(</span><span class="n">pRoot</span><span class="p">,</span> <span class="s">&quot;students_info&quot;</span><span class="p">,</span> <span class="n">pArray</span><span class="p">);</span>
</span><span class='line'> <span class="kt">char</span><span class="o">*</span> <span class="n">szOut</span> <span class="o">=</span> <span class="n">cJSON_Print</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="n">cJSON</span><span class="o">*</span> <span class="n">pItem</span> <span class="o">=</span> <span class="n">cJSON_CreateObject</span><span class="p">();</span>
</span><span class='line'> <span class="n">cJSON_AddStringToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;chenzhongjing&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddStringToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;sex&quot;</span><span class="p">,</span> <span class="s">&quot;male&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddNumberToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="mi">28</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddItemToArray</span><span class="p">(</span><span class="n">pArray</span><span class="p">,</span> <span class="n">pItem</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="n">pItem</span> <span class="o">=</span> <span class="n">cJSON_CreateObject</span><span class="p">();</span>
</span><span class='line'> <span class="n">cJSON_AddStringToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;fengxuan&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddStringToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;sex&quot;</span><span class="p">,</span> <span class="s">&quot;male&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddNumberToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddItemToArray</span><span class="p">(</span><span class="n">pArray</span><span class="p">,</span> <span class="n">pItem</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="n">pItem</span> <span class="o">=</span> <span class="n">cJSON_CreateObject</span><span class="p">();</span>
</span><span class='line'> <span class="n">cJSON_AddStringToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;tuhui&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddStringToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;sex&quot;</span><span class="p">,</span> <span class="s">&quot;male&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddNumberToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddItemToArray</span><span class="p">(</span><span class="n">pArray</span><span class="p">,</span> <span class="n">pItem</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="kt">char</span><span class="o">*</span> <span class="n">szJSON</span> <span class="o">=</span> <span class="n">cJSON_Print</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_Delete</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span><span class='line'> <span class="c1">//free(szJSON);</span>
</span><span class='line'>
</span><span class='line'> <span class="n">pRoot</span> <span class="o">=</span> <span class="n">cJSON_Parse</span><span class="p">(</span><span class="n">szJSON</span><span class="p">);</span>
</span><span class='line'> <span class="n">pArray</span> <span class="o">=</span> <span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">pRoot</span><span class="p">,</span> <span class="s">&quot;students_info&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pArray</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>     <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kt">int</span> <span class="n">iCount</span> <span class="o">=</span> <span class="n">cJSON_GetArraySize</span><span class="p">(</span><span class="n">pArray</span><span class="p">);</span>
</span><span class='line'> <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iCount</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>     <span class="n">cJSON</span><span class="o">*</span> <span class="n">pItem</span> <span class="o">=</span> <span class="n">cJSON_GetArrayItem</span><span class="p">(</span><span class="n">pArray</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>     <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pItem</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>         <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">string</span> <span class="n">strName</span> <span class="o">=</span> <span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">;</span>
</span><span class='line'>     <span class="n">string</span> <span class="n">strSex</span> <span class="o">=</span> <span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;sex&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">;</span>
</span><span class='line'>     <span class="kt">int</span> <span class="n">iAge</span> <span class="o">=</span> <span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">valueint</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="n">cJSON_Delete</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span><span class='line'> <span class="n">free</span><span class="p">(</span><span class="n">szJSON</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Verilog基础知识]]></title>
    <link href="http://suda-morris.github.io/blog/2015/11/22/verilog/"/>
    <updated>2015-11-22T19:53:49+08:00</updated>
    <id>http://suda-morris.github.io/blog/2015/11/22/verilog</id>
    <content type="html"><![CDATA[<h2>我的FPGA</h2>

<ol>
<li>FPGA芯片：EP4CE6F22C8N，逻辑资源6272LEs，乘法器15，RAM资源270Kbits</li>
<li>SDRAM芯片：K4S561632J，256Mbit</li>
<li>串行FLASH：EPCS4，4Mbit</li>
<li>有源晶振：48MHz</li>
<li>SPI Flash：Winbond 25Q128</li>
</ol>


<h2>FPGA入门知识</h2>

<ol>
<li>FPGA的仿真分为：行为仿真、门级仿真和布局布线后仿真，或者叫做前仿真、后仿真（包含门级仿真和布局布线后仿真）。</li>
<li>一个标称450MHz的FPGA仅仅值内部的寄存器或者乘法器、RAM等单个资源的时钟频率能够达到。实际上使用这些器件搭建一个运行在200-300MHz之间的设计已经非常理想。因为级联门延时、线延时都是非常大的除了优化算法结构外，为了达到更高的速率插入同步寄存器，增加流水级数必不可少，这样才能用资源换来速度的提升。对同功能的设计，速度和资源永远成反比</li>
<li>建立就是CLK到来前DATA稳定时间，保持就是时钟到来后数据的保持时间</li>
<li>现在的很多PCB工具和FPGA开发软件都有附带的接口，可以相互转换。将PCB设计软件中的管脚转换成FPGA的约束文件（TCL或者CSV格式），或者在FPGA调整之后再次导入PCB</li>
<li>真的时钟是不能赋值给线网或者寄存器的。由于FPGA里时钟属于单独的时钟树，CLK是无法直接赋值给一个寄存器变量的，因为他们只能从时钟树分配到寄存器的CLK端。因为时钟树总是和寄存器的clk端相连，他们和触发器的D端实际是不连接的，需要通过特殊处理。</li>
<li>在基本组成元素中非时序组合逻辑在FPGA内部使用查找表资源实现（LUT）。而时序则由寄存器实现。</li>
</ol>


<h2>将POF文件转换成固化到FPGA Flash的文件</h2>

<p><img src="http://i.imgur.com/u2iVkzg.png" alt="使用JTAG烧写Flash文件（非AS模式）" /></p>

<ol>
<li>选择File->Convert Programming Files</li>
<li>选择Programming file type为：JTAG Indirect Configuration(.jic),选择相应的串行配置Flash型号，点击Flash Loader，添加Flash器件，然后导入之前生成的pof文件</li>
</ol>


<h2>使用TCL文件来分配器件与管脚</h2>

<p><img src="http://i.imgur.com/oEYr6m0.png" alt="一个tcl文件的例子" /></p>

<h2>Verilog的模块</h2>

<ol>
<li>模块是Verilog语言的基本单元，其基本语法如下：</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='Verilog'><span class='line'><span class="k">module</span> <span class="o">&lt;</span><span class="err">模块名</span><span class="o">&gt;</span><span class="err">（</span><span class="o">&lt;</span><span class="err">端口列表</span><span class="o">&gt;</span><span class="err">）</span>
</span><span class='line'>  <span class="err">端口说明（</span><span class="k">input</span><span class="err">，</span><span class="k">output</span><span class="err">，</span><span class="k">inout</span><span class="err">）</span>
</span><span class='line'>  <span class="err">参数定义</span>
</span><span class='line'>  <span class="err">数据类型定义：指定模块内用到的数据对象为寄存器型、存储器型还是连续型</span>
</span><span class='line'>  <span class="err">连续赋值语句（</span><span class="k">assign</span><span class="err">）</span>
</span><span class='line'>  <span class="err">过程块（</span><span class="k">initial</span><span class="err">和</span><span class="k">always</span><span class="err">）</span>
</span><span class='line'>      <span class="o">-</span><span class="err">行为描述语句</span>
</span><span class='line'>  <span class="err">底层模块实例</span>
</span><span class='line'>  <span class="err">任务和函数</span>
</span><span class='line'>  <span class="err">延时说明块：对模块各个输入和输出端口之间的路径延时进行说明</span>
</span><span class='line'><span class="k">endmodule</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>模块的描述方式

<ol>
<li>模块的描述方式又称建模方式。verilog既是一门行为化又是一门结构化的HDL语言，根据设计的需要，每个模块的内部可以分为四种抽象级别来进行描述。模块在外部环境中的表现都是同等的，而与其内部具体描述的抽象级别无关。因此模块的内部具体描述相对于外部环境来说是隐藏的，该表一个模块内部描述的抽象级别，可以不用对其外部环境做任何的改动。</li>
<li>模块的4类抽象级别的描述

<ol>
<li>行为级建模：这是Verilog最高抽象级别的描述方式。一个模块可以按照要求的设计算法来实现，而不用关心具体硬件实现的细节。行为描述通过行为语句来实现，行为功能可使用下述过程语句结构描述

<ul>
<li>initial语句，此语句只执行一次</li>
<li>always语句，此语句循环执行</li>
</ul>
</li>
<li>数据流描述方式（数据流级建模）

<ol>
<li>数据流描述方式也称RTL（寄存器传输级）描述方式。在这种描述方式下，设计者需要知道数据是如何在寄存器之间传输的以及将被如何处理。数据流描述防护四类似于布尔方程，它能够比较直观地表达底层逻辑行为。在Verilog中数据流描述方式主要用来描述组合逻辑，具体由连续赋值语句“assign”来实现。</li>
</ol>
</li>
<li>门级描述方式

<ol>
<li>在这种描述方式下，模块是按照逻辑门和他们之间的互连线来实现的，在这种抽象级别下的设计与按照门级逻辑图来描述一个设计类似。门级描述就是指调用Verilog内建的基本门级元件来对硬件电路进行结构设计。这些基本的门级元件是一类特殊的模块，共有14种，分成4类，他们分别由Verilog语言自身提供。</li>
</ol>
</li>
<li>开关级描述方式

<ol>
<li>开关级描述方式也称晶体管级描述方式，是Verilog最低级别的描述方式。在这种描述方式下，模块是按照开关级元件和存储节点以及它们之间的互连来实现的。具体来说是指调用Verilog内建的基本开关级原价来对硬件电路进行结构设计。与门级元件类似，这些基本的开关级元件也是一类特殊的模块，共有12种，由Verilog语言自身提供</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>模块调用</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Verilog'><span class='line'><span class="o">&lt;</span><span class="err">模块名</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="err">参数值列表</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="err">实例名</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="err">端口连接表</span><span class="o">&gt;</span><span class="p">)</span><span class="err">；</span>
</span></code></pre></td></tr></table></div></figure>


<h2>语法基础</h2>

<ol>
<li>注释：<code>/*多行注释*/</code>和<code>//单行注释</code></li>
<li>数值可取下面的4类值：

<ol>
<li>0：逻辑0或者假状态</li>
<li>1：逻辑1或者真状态</li>
<li>x(X)：未知状态</li>
<li>z(Z)：高阻状态</li>
</ol>
</li>
<li>整数型常量

<ol>
<li>简单的十进制格式。由0~9的数字串组成的十进制数，可以在数值前面加上符号“+”或“-”来表示数的正负</li>
<li>指定位宽的基数格式，由三部分组成：<size>&lt;&lsquo;base_format><number>

<ol>
<li>size指定数的二进制位宽，是一个非零的无符号十进制常量，size若省略默认32位</li>
<li>&lsquo;base_format:单引号'是指定位宽格式表示法的固有字符，不能省略。base_format指定数的基数格式，用一个字母表示，对大小写不敏感。在base_format之前，单引号之后可以加上字母s(S)表示该数为有符号数。合法的技术格式字符串字母有d(D)-十进制；h(H)-十六进制；o(O)-八进制；b(B)-二进制。number是一个无符号的数，由相应基数格式的数字串组成。十六进制数字a~f对大小写也是不敏感的。可以在size之前加上“+”或“-”表示数的正或负，但是不能再base_format和number之间加“+”或“-”，因为这违背了Verilog的语法规则</li>
</ol>
</li>
<li>下划线符号“_”除了不能放在数值的首位外，可以放在整数型和实数型内任何地方。它们对数值没有任何影响，在编译时会被忽略，只是为了将长的数值分段，提高可读性</li>
<li>数值常量中的？表示高阻状态</li>
</ol>
</li>
<li>实数型常量

<ol>
<li>实数型常量可以通过对小数的四舍五入，转换为最靠近的整数型常量，而不是直接将小数舍弃，从而得到整数。当一个实数常量被赋给一个整数变量时，一种隐式的转换就发生了。例如实数-1.5转换为整数-2，实数35.2转换为整数得到35</li>
<li>实数既可以使用小数也可以使用科学计数法的方式来表达</li>
</ol>
</li>
<li>字符串：用双引号“”括起来的字符序列，必须包含在一行内，不能分成多行书写

<ol>
<li>字符串变量是寄存器类型的变量，该字符串变量的位数要大于等于字符串的最大长度</li>
<li>存储一个12字符的字符串“Hello world！”需要一个8*12=96位的寄存器变量。

<ul>
<li><code>reg [8*12:1] stringvar;</code></li>
<li><code>stringvar = "Hello world";</code></li>
</ul>
</li>
<li>如果声明的字符串变量位数大于字符串实际长度，则在赋值操作后，字符串变量的左端（即高位）补0.如果声明的字符串变量位数小于字符串实际长度，那么字符串的左端被截取，这些高位字符就丢失了</li>
</ol>
</li>
<li>标识符分为简单标识符、转义标识符、生成标识符、关键字

<ol>
<li>简单标识符是由字母、数字、美元符号、下划线构成的任意序列。简单标识符的第一个符号不能是数字或者美元符号$</li>
<li>关键字都用小写字母定义</li>
<li>标识符的第一个字符不能够是“$”，因为在Verilog中，“$”专门用来代表系统命令</li>
<li>Verilog中9个关键字：always,endmodule,reg,and,assign,begin,for,case,or,function,output,parameter,wait,if,else,input,while,end</li>
</ol>
</li>
<li>系统任务和函数

<ol>
<li>为了便于设计者对仿真过程进行控制，以及对仿真结果进行分析，Verilog提供了大量的系统功能调用，大致分为：

<ol>
<li>任务型的功能调用，称为系统任务</li>
<li>函数型的功能调用，称为系统函数</li>
</ol>
</li>
<li>Verilog的系统任务和系统函数是以字符$开头的标识符，他们的主要区别是

<ol>
<li>系统任务可以没有返回值或者有多个返回值，而系统函数只有一个返回值</li>
<li>系统任务可以带有延迟，而系统函数不允许延迟，在0时刻执行</li>
</ol>
</li>
<li>用户可以根据需要基于Verilog仿真系统提供的PLI编程接口，编制特殊的系统任务和系统函数，根据系统任务和系统函数实现的功能不同，可将其分成以下几类：

<ol>
<li>标准输出任务

<ol>
<li>$display:将特定信息输出到标准输出设备时，具有自动换行的功能</li>
<li>$write：不带有行结束符</li>
<li>$displayb和writeb（输出二进制）</li>
<li>$displayo和writeo（输出八进制）</li>
<li>$displayh和writeh（输出十六进制）</li>
<li>格式说明符：

<ol>
<li>%h或%H：以十六进制数的形式输出</li>
<li>%d或%D：以十进制数的形式输出</li>
<li>%o或%O：以八进制的形式输出</li>
<li>%b或%B：以二进制的形式输出</li>
<li>%c或%C：以ASCII码字符的形式输出</li>
<li>%s或%S：以字符串的形式输出</li>
<li>%v或%V：输出线型数据的驱动强度</li>
<li>%m或%M：输出模块的名称</li>
</ol>
</li>
</ol>
</li>
<li>文件管理任务

<ol>
<li><file_handle>=$fopen(&ldquo;<file_name>&rdquo;);如果文件名<file_name>正确，则返回一个32位的句柄描述符<file_handle>，且其中只有一位为高电平</li>
<li>Verilog中用来将信息输出到文件的系统任务有$fdisplay,$fwrite,$fmonitor:<task_name>(<file_handles>,<format_specifiers>);其中<task_name>是上述三种系统任务中的一种。<file_handles>是文件句柄描述符，与打开文件所不同的是，可以对句柄进行多位设置。<format_specifiers>用来指定输出格式</li>
<li>$fclose(<file_handle>);关闭文件</li>
<li>Verilog中有两个系统任务$readmemb和$readmemh,它们能够把一个数据文件中的数据内容读入到一个指定的存储器中。这两个系统任务的区别在于，前者要求以二进制数据格式存放数据文件，而后者要求以十六进制数据格式存放数据文件。他们具有相同的语法格式：<task_name>(<file_name>,<register_array>,<start>,<end>);其中<task_name>用来指定系统任务，可取上述任务中的一个。<file_name>是读出数据的文件名。<register_array>为要读入数据的存储器。<start>和<end>分别为存储器的起始地址和结束地址。

<ul>
<li>系统任务$readmem中，被读取的数据文件内容只能够包含空白符、注释行、二进制或十六进制的数字，同样也可以存在不定态X、高阻态Z和下划线_。</li>
<li>数据文件中地址的表示格式为：“@”后面加上十六进制数字。同一个数据文件中可以出现多个地址。当系统任务遇到一个地址时，立刻将该地址后面的数据存放到存储器中相应的地址单元中</li>
</ul>
</li>
</ol>
</li>
<li>仿真控制任务

<ol>
<li>Verilog中有三种仿真监控任务：$monitor,$monitoron,$monitoroff</li>
<li>$monitor(<format_specifiers>,signal,signal,&hellip;);该任务可用来连续监控指定的信号参数，如果发现其中的任一信号发生变化，则系统按照调用$monitor时规定的格式，在时间歩结束时显示整个信号表。</li>
<li>$finish和$stop这两个系统任务可以用来结束仿真。$finish用来终止仿真器的运行，结束仿真过程返回到操作系统。$stop暂时挂起仿真器，进入Verilog界面，可以通过输入相应命令使仿真继续进行</li>
</ol>
</li>
<li>时间函数

<ol>
<li>$timeformat(<unit>,<precision>,<suffix>,<min_field_width>)其中<unit>用于指定时间单位，取值范围是0~-15。<precision>指定所要显示时间信息的精度，<suffix>是诸如“ms”，“ns”之类的字符，<min_field_width>说明时间信息的最小字符数</li>
<li><code>$timeformat(-9,2,"ns",10)</code></li>
<li>时间显示函数

<ol>
<li>$time，返回64位整数，指定当前的仿真时间</li>
<li>$stime，返回32位的仿真时间</li>
<li>$realtime，以实数形式范湖当前的仿真时间</li>
</ol>
</li>
</ol>
</li>
<li>其他

<ol>
<li>随机函数

<ol>
<li>$random%<number>,其中<number>用来指定所产生的随机数的范围，即-<number>+1到<number>-1</li>
</ol>
</li>
<li>转换函数

<ol>
<li>有时需要将整数转换成实数，或将实数转换成整数，或者用向量形式来表示实数等。Verilog提供了许多转换函数可以方便实现上述功能。</li>
<li>$rtio：通过截断小数部分，将实数转换成整数</li>
<li>$itor:将整数转换成实数</li>
<li>$realtobits:将实数转换成64位的实数向量表示</li>
<li>$bitstoreal:将位模式转换为实数</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>相等（==）与全等（===）运算符

<ol>
<li>相等运算中，如果任何一个操作数中存在不定态或者高阻态，将得到一个不定态的结果；而在全等运算中，则是将不定态和高阻态看作是逻辑状态的一种，同样参与比较，当这两个操作数的相应位都是X或者Z时，认为全等关系成立，否则运算结果为0。所以，全等是比较是否完全匹配，只有0和1两个状态，相等则会出现不定态。</li>
</ol>
</li>
<li>缩位运算符&amp;，~&amp;，|，~|，^,~^

<ol>
<li>缩位运算符是对单个操作数进行与或非等操作，与逻辑运算符的区别是最终结果和操作的位数无关，一定是1位的逻辑值。如果a为[3:0]，&amp;a等效于a[0]&amp;a[1]&amp;a[2]&amp;a[3],~|a等效于~(a[0]|a[1]|a[2]|a[3])</li>
</ol>
</li>
<li>Verilog中的数据类型是指在硬件数字电路中数据进行存储和传输的方式。按照物理数据类型分类，Verilog中变量分为<strong>线型</strong>和<strong>寄存器</strong>型两种，两者在驱动方式、保持方式和对应的硬件实现都不同。这两种变量在定义时要设置位宽，缺省值为1位。变量的每一位可以是0，1，x或者z，其中x代表一个未被预置初始状态的变量，或者是由于两个或更多个驱动装置试图将之设定为不同的值而引起的冲突型变量。z代表高阻状态或悬空状态。

<ol>
<li>参数(parameters)

<ol>
<li>参数是常量的一种，经常用来定义延时、线宽、寄存器位数等物理量，可以增加代码的可读性和可维护性</li>
<li>参数的定义格式：parameter 参数名1=表达式1，参数名2=表达式2，参数名3=表达式3，……</li>
<li>对含有参数的模块通常称为参数化模块</li>
</ol>
</li>
<li>线型变量（Nets）

<ol>
<li>线型变量表示硬件电路中元器件之间的物理连接。它的值由驱动元件的值决定，并具有实时更新性</li>
<li>线型变量不具备电荷保持作用（trireg型除外），因此没有存储数据的能力，其逻辑值由驱动源提供和保持。各种线型变量在没有驱动源的情况下呈现高阻态（trireg保持不定态）</li>
<li>wire,tri表示标准连线</li>
<li>wor，trior，多重驱动时，具有线或特性的连线</li>
<li>wand，triand，多重驱动时，具有线与特性的连线</li>
<li>tri1，tri0，上拉电阻，下拉电阻</li>
<li>supply1，supply0，电源线，地线</li>
<li>trireg，具有点和保持特性的连线</li>
<li>线型变量主要通过assign语句赋值。对于综合而言，wire型变量的取值可以是0，1，X与Z</li>
</ol>
</li>
<li>寄存器型变量（Register），<strong>寄存器型变量对应的硬件电路并不一定是寄存器</strong>

<ol>
<li>寄存器型变量表示一个抽象的数据存储单元，它并不是指寄存器，而是所有具有存储能力的硬件电路的通称，如触发器、锁存器等。此外，寄存器型变量还包括测试文件中的<strong>激励信号</strong>。虽然这些激励信号并不是电路元件，仅是虚拟驱动源，但由于保持数值的特性，任然属于寄存器变量。</li>
<li>寄存器类型只能在always语句和initial语句中被赋值，并且它的值从一个赋值到另一个赋值被保存下来。寄存器型变量的缺省值是不定态X</li>
<li>寄存器型变量与线型变量的显著区别是寄存器型数据在接受下一次赋值之前，始终保持原值不变，而线型变量需要有持续的驱动</li>
<li>reg，表示常用的寄存器型变量</li>
<li>integer，表示32位带符号整数型变量</li>
<li>real，便是64位带符号整数型变量</li>
<li>time，无符号时间变量</li>
</ol>
</li>
<li>存储器（Memories）

<ol>
<li>设计中，经常有存储指令或者存储数据等操作</li>
<li>存储器定义格式：reg[wordsize-1:0] memory_name[memorysize-1:0]</li>
<li>存储器可以看成是寄存器组成的数组</li>
</ol>
</li>
</ol>
</li>
<li>编译向导

<ol>
<li>类似于C语言中的编译预处理的功能，在编译时首先对这些编译向导进行预处理，然后保持其结果，将其与源代码一起进行编译</li>
<li>编译向导的标志是在某些标识符前面添加反引号“`”</li>
<li>`define &lt;宏名> &lt;宏定义的文本内容>。用于文本定义，和C语言#define类似，即在编译时通知编译器，用宏定义中的文本直接替换代码中出现的宏名。宏定义语句可以用于模块的任意位置，通常写在模块的外面，建议使用大写字母表示宏名，便于与变量名相区别。在调用宏定义的时候，也需要撇号作为开头</li>
<li>`timescale &lt;时间单位>/&lt;时间精度>。时间单位和时间精度都是由整数和计时单位组成的。合法的整数有1，10，100；合法的计时单位为s,ms,us,ns,ps和fs。在仿真时间尺度中，时间单位用来定义模块内部仿真时间和延迟时间的基准单位；时间精度用来声明该模块仿真时间的精确程度。时间精度和时间单位的差别最好不要太大，因为在仿真过程中，仿真时间是以时间精度累计的，两者差异越大，仿真花费的时间就越长。另外，时间精度值至少要和时间单位一样精确，时间精度值不能大于时间单位值。如果一个设计中存在多个timescale，则采用最小的时间单位。如果不指定timescale，则系统默认执行时间单位为1ns，时间精度为1ns的timescale</li>
<li>`include “文件名”。文件名中可以指定包含文件的路径，既可以是相对路径，也可以是完整的路径名。每条文件包含语句只能够用于一个文件的包含，但是，包含文件允许嵌套，即包含的文件中允许再去包含另外的一个文件</li>
</ol>
</li>
<li>Verilog HDL中，所有的描述都是通过下面四种结构中的一种实现的，在一个模块内部可以由任意多个initial语句和always语句，两者都是从仿真的起始时刻开始执行的，但是initial语句后面的块语句只执行一次，而always语句则循环地重复执行后面的块语句，直到仿真结束。task任务和function函数可以在模块内部从一处或多处被调用

<ol>
<li>initial语句</li>
</ol>
</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='Verilog'><span class='line'><span class="k">initial</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>      <span class="err">语句</span><span class="mh">1</span><span class="p">;</span>
</span><span class='line'>      <span class="err">语句</span><span class="mh">2</span><span class="p">;</span>
</span><span class='line'>      <span class="err">语句</span><span class="mh">3</span><span class="p">;</span>
</span><span class='line'>      <span class="p">...</span>
</span><span class='line'>      <span class="err">语句</span><span class="n">n</span><span class="p">;</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>2. always语句,多个敏感信号表达式之间用or或者逗号隔开
</code></pre>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Verilog'><span class='line'><span class="k">always</span> <span class="p">@</span> <span class="err">（敏感信号表达式）</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'><span class="p">......</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>3. task任务
    1. 任务可以在源代码的不同位置执行共同的代码段，这些代码段已经用任务定义编写成任务，因此能够从源代码的不同位置调用任务。
    2. 任务的定义与引用都在一份模块内部完成，任务内部可以包含时序控制，即时延控制，并且任务也能够调用任何任务（包括本身）和函数
    3. 定义任务与调用任务必须在同一个模块内，任务调用语句应该在always块或者task-endtask块中
    4. 定义任务时，没有端口名称表，但要进行端口与数据类型的声明
    5. 调用任务时，与调用模块一样，要列出端口名称表，但是顺序要与定义中的排序完全一致
    6. 任务中可以调用其他的任务或者函数，且调用的个数不受限制
    7. 定义格式：
</code></pre>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Verilog'><span class='line'><span class="k">task</span> <span class="o">&lt;</span><span class="err">任务名</span><span class="o">&gt;</span><span class="err">；</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">端口及数据类型定义语句</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">语句</span><span class="mh">1</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">语句</span><span class="mh">2</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">语句</span><span class="n">n</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">endtask</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>4. function函数
    1. 函数与task一样，也可以在模块中的不同位置执行同一段代码，不同之处是函数只能返回一个值，它不能包含任何时间控制语句。函数可以调用其他函数，但是不能调用任务。此外，函数必须至少带有一个输入端口，在函数中允许没有输出或输入输出说明
    2. 函数的定义蕴含声明了一个与函数同名的，函数的内部寄存器，并作为函数的返回值传出函数
    3. 定义格式：
</code></pre>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Verilog'><span class='line'><span class="k">function</span> <span class="o">&lt;</span><span class="err">位宽说明</span><span class="o">&gt;</span> <span class="err">函数名；</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">输入端口和类型说明</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">局部变量说明</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">语句</span><span class="mh">1</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">语句</span><span class="mh">2</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">语句</span><span class="n">n</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">endfunction</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>赋值语句Assignments，是Verilog中对线型和寄存器型变量赋值的主要方式，根据赋值对象的不同分为连续赋值语句（针对线型变量）和过程赋值语句（针对寄存器型变量）

<ol>
<li>线型变量一旦被连续赋值语句赋值后，赋值语句右端表达式中的信号有任何变化，都将实时反映到左端的线型变量中；</li>
<li>过程赋值语句只有在语句被执行到时，赋值过程才能够进行一次，而且赋值过程的具体执行时间还受到各种因素的影响</li>
<li>连续赋值语句不能出现在任何一个过程块中；过程赋值语句只能够出现在过程块中</li>
<li>连续赋值语句以关键词assign为先导。过程赋值语句不需要任何先导的关键词，但是语句的赋值分为阻塞性和非阻塞型</li>
<li>连续赋值语句

<ol>
<li>assign #[delay] &lt;线型变量>=&lt;表达式></li>
</ol>
</li>
<li>过程赋值语句

<ol>
<li>&lt;寄存器型变量> = &lt;表达式>，阻塞型过程赋值</li>
<li>&lt;寄存器型变量> &lt;= &lt;表达式>，非阻塞型过程赋值</li>
<li>阻塞型赋值语句的执行受到前后顺序的而影响，只有在第一条语句执行完之后才可以执行第二条语句，而在非阻塞型赋值语句中，则是某一规定时刻同时完成，不受先后顺序的影响。从某种角度来说，非阻塞型赋值语句的执行顺序与并行块的执行十分相像。</li>
<li>总结：阻塞赋值按顺序执行，非阻塞赋值，块结束后并行执行</li>
</ol>
</li>
</ol>
</li>
<li>块语句

<ol>
<li>串行块（begin-end）

<ol>
<li>串行块中的每条语句都是依据块中的排列次序顺序执行</li>
<li>串行块中每条语句的延时都是相对于前一条语句执行结束的相对时间</li>
<li>串行块的起始执行时间是块中第一条语句开始执行的时间，结束时间是最后一条语句执行结束的时间</li>
</ol>
</li>
<li>并行快（fork-join）

<ol>
<li>并行块中的每条语句都是同时并行执行的，与排列次序无关</li>
<li>并行块中每条语句的延时都是相对于整个并行块开始执行的绝对时间</li>
<li>并行块的起始时间是流程控制转入并行块的时间，结束时间是并行块中按执行时间排序，最后执行的那条语句结束的时间</li>
</ol>
</li>
</ol>
</li>
<li>case语句

<ol>
<li>case语句要求敏感表达式的值与给定的值1、值2……或值n中的一个全等时，执行后面相应的块语句，如果均不相等，执行default语句</li>
<li>casez语句认为，如果给定的值中有一位或几位是高阻态z，则认为该位为“真”，敏感表达式与其比较时不予判断，只需比较其他几位</li>
<li>casex语句扩充为，如果给定的值中有一位或某几位是高阻态或者不定态，同样认为其为“真”，不予判断</li>
</ol>
</li>
<li>Verilog中存在4中类型的循环语句，可以控制语句的执行次数。这四种语句分别是for语句，repeat语句，while语句和forever语句

<ol>
<li>for(循环变量赋初值；循环结束条件；循环变量增值) 块语句；</li>
<li>repeat(循环次数表达式) 块语句；</li>
<li>while(循环执行条件表达式) 块语句；</li>
<li>forever 块语句；多用在initial块中，生成周期性输入波形，通常为不可综合语句</li>
</ol>
</li>
<li>任务与函数的区别

<ol>
<li>函数需要在一个仿真时间单位内完成，而任务定义中可以包含任意类型的定时控制部分及weit语句等</li>
<li>函数不能调用任务，而任务可以调用任何任务和函数</li>
<li>函数只允许有输入变量且至少有一个，不能够有输出端口输入输出端口；任务可以没有任何端口，也可以包括各种类型的端口</li>
<li>函数通过函数名返回一个值；任务则不需要</li>
</ol>
</li>
</ol>


<h2>减小NIOS程序的代码量</h2>

<ol>
<li>采用alt_main()作为程序入口</li>
<li>打开编译器优化选项，-O3</li>
<li>使用小封装的驱动库与C语言库

<ol>
<li>HAL为处理器的外设提供了两种驱动库：一种是执行速度快，但是代码量大的版本；另一种是小封装的版本。默认情况下，HAL系统使用的是代码量大的版本。可以选择Reduced device drivers选项来选择小封装版本，从而减小代码量</li>
<li>完整的ANSI C标准库通常不适用于嵌入式系统，HAL提供了一系列经过剪裁的新的ANSI C标准库，占用非常小的代码量。可以选择Small C library选项来选择新的ANSI C标准库</li>
</ol>
</li>
<li>去掉不使用的驱动库

<ol>
<li>当用户的程序没有使用到NIOS系统中某些设备时，应该在系统中将这些设备完全移出</li>
</ol>
</li>
</ol>


<h2>流水灯</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='Verilog'><span class='line'> <span class="k">module</span> <span class="n">led_module</span><span class="p">(</span>
</span><span class='line'>  <span class="k">input</span> <span class="no">EN</span><span class="p">,</span>
</span><span class='line'>  <span class="k">input</span> <span class="no">CLK</span><span class="p">,</span>
</span><span class='line'>  <span class="k">output</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">leds</span>
</span><span class='line'> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="kt">reg</span> <span class="n">clk_hz</span><span class="p">;</span>
</span><span class='line'> <span class="k">initial</span> <span class="n">clk_hz</span><span class="o">=</span> <span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="c1">//初始化只对仿真有效，综合器会自动无视</span>
</span><span class='line'> <span class="kt">reg</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'> <span class="k">initial</span> <span class="n">count</span> <span class="o">=</span> <span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
</span><span class='line'> <span class="kt">reg</span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">led_reg</span><span class="p">;</span>
</span><span class='line'> <span class="k">initial</span> <span class="n">led_reg</span> <span class="o">=</span> <span class="mh">4</span><span class="mb">&#39;b1111</span><span class="p">;</span>
</span><span class='line'> <span class="k">parameter</span> <span class="no">SEC_TIME</span> <span class="o">=</span> <span class="mh">32</span><span class="mi">&#39;d48</span><span class="n">_000_000</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="k">always</span><span class="p">@(</span><span class="k">posedge</span> <span class="no">CLK</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="no">SEC_TIME</span><span class="o">&gt;&gt;</span><span class="mh">1</span><span class="p">)</span>
</span><span class='line'>      <span class="k">begin</span>
</span><span class='line'>          <span class="n">count</span> <span class="o">&lt;=</span> <span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
</span><span class='line'>          <span class="n">clk_hz</span> <span class="o">=</span> <span class="o">!</span><span class="n">clk_hz</span><span class="p">;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">count</span><span class="o">+</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
</span><span class='line'>      
</span><span class='line'>
</span><span class='line'> <span class="k">always</span><span class="p">@(</span><span class="k">posedge</span> <span class="n">clk_hz</span><span class="p">)</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">led_reg</span> <span class="o">==</span> <span class="mh">4</span><span class="mb">&#39;b1111</span><span class="p">)</span>
</span><span class='line'>          <span class="n">led_reg</span> <span class="o">&lt;=</span> <span class="mh">4</span><span class="mb">&#39;b1110</span><span class="p">;</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">led_reg</span> <span class="o">==</span> <span class="mh">4</span><span class="mb">&#39;b1110</span><span class="p">)</span>
</span><span class='line'>          <span class="n">led_reg</span> <span class="o">&lt;=</span> <span class="mh">4</span><span class="mb">&#39;b1101</span><span class="p">;</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">led_reg</span> <span class="o">==</span> <span class="mh">4</span><span class="mb">&#39;b1101</span><span class="p">)</span>
</span><span class='line'>          <span class="n">led_reg</span> <span class="o">&lt;=</span> <span class="mh">4</span><span class="mb">&#39;b1011</span><span class="p">;</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">led_reg</span> <span class="o">==</span> <span class="mh">4</span><span class="mb">&#39;b1011</span><span class="p">)</span>
</span><span class='line'>          <span class="n">led_reg</span> <span class="o">&lt;=</span> <span class="mh">4</span><span class="mb">&#39;b0111</span><span class="p">;</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">led_reg</span> <span class="o">==</span> <span class="mh">4</span><span class="mb">&#39;b0111</span><span class="p">)</span>
</span><span class='line'>          <span class="n">led_reg</span> <span class="o">&lt;=</span> <span class="mh">4</span><span class="mb">&#39;b1110</span><span class="p">;</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">led_reg</span> <span class="o">&lt;=</span> <span class="mh">4</span><span class="mb">&#39;b1111</span><span class="p">;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'> <span class="k">assign</span> <span class="n">leds</span> <span class="o">=</span> <span class="no">EN</span> <span class="o">?</span> <span class="n">led_reg</span> <span class="o">:</span> <span class="mh">4</span><span class="p">&#39;</span><span class="n">bzzzz</span><span class="p">;</span>
</span><span class='line'> <span class="k">endmodule</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h2>蜂鸣器</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='Verilog'><span class='line'> <span class="k">module</span> <span class="n">beep_module</span><span class="p">(</span>
</span><span class='line'> <span class="k">input</span> <span class="no">EN</span><span class="p">,</span>
</span><span class='line'> <span class="k">input</span> <span class="no">CLK</span><span class="p">,</span>
</span><span class='line'> <span class="k">output</span> <span class="no">BP</span>
</span><span class='line'> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="kt">reg</span> <span class="n">clk_hz</span><span class="p">;</span>
</span><span class='line'> <span class="k">initial</span> <span class="n">clk_hz</span><span class="o">=</span> <span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="c1">//初始化只对仿真有效，综合器会自动无视</span>
</span><span class='line'> <span class="kt">reg</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'> <span class="k">initial</span> <span class="n">count</span> <span class="o">=</span> <span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="k">parameter</span> <span class="no">SEC_TIME</span> <span class="o">=</span> <span class="mh">32</span><span class="mi">&#39;d48</span><span class="n">_000_000</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="k">always</span><span class="p">@(</span><span class="k">posedge</span> <span class="no">CLK</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="no">SEC_TIME</span><span class="o">&gt;&gt;</span><span class="mh">1</span><span class="p">)</span>
</span><span class='line'>      <span class="k">begin</span>
</span><span class='line'>          <span class="n">count</span> <span class="o">&lt;=</span> <span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
</span><span class='line'>          <span class="n">clk_hz</span> <span class="o">=</span> <span class="o">!</span><span class="n">clk_hz</span><span class="p">;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">count</span><span class="o">+</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
</span><span class='line'>      
</span><span class='line'> <span class="k">assign</span> <span class="no">BP</span> <span class="o">=</span> <span class="no">EN</span> <span class="o">?</span> <span class="n">clk_hz</span> <span class="o">:</span> <span class="mh">1</span><span class="p">&#39;</span><span class="n">bz</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="k">endmodule</span>
</span></code></pre></td></tr></table></div></figure>


<h2>共阴数码管</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
</pre></td><td class='code'><pre><code class='Verilog'><span class='line'><span class="k">module</span> <span class="n">dt_module</span><span class="p">(</span>
</span><span class='line'>  <span class="k">input</span> <span class="n">clk</span><span class="p">,</span>
</span><span class='line'>  <span class="k">input</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">num1</span><span class="p">,</span>
</span><span class='line'>  <span class="k">input</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">num2</span><span class="p">,</span>
</span><span class='line'>  <span class="k">input</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">num3</span><span class="p">,</span>
</span><span class='line'>  <span class="k">input</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">num4</span><span class="p">,</span>
</span><span class='line'>  <span class="k">output</span> <span class="kt">reg</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">ds_en</span><span class="p">,</span>
</span><span class='line'>  <span class="k">output</span> <span class="kt">reg</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">ds_reg</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_0</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b0111111</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_1</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b0000110</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_2</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b1011011</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_3</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b1001111</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_4</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b1100110</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_5</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b1101101</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_6</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b1111101</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_7</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b0000111</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_8</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b1111111</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_9</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b1101111</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_A</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b1110111</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_B</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b1111100</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_C</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b1011000</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_D</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b1011110</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_E</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b1111001</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_F</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b1110001</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">NUM_BLK</span><span class="o">=</span><span class="mh">7</span><span class="mb">&#39;b0000000</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">EN_1</span><span class="o">=</span><span class="mh">4</span><span class="mb">&#39;b1110</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">EN_2</span><span class="o">=</span><span class="mh">4</span><span class="mb">&#39;b1101</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">EN_3</span><span class="o">=</span><span class="mh">4</span><span class="mb">&#39;b1011</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">EN_4</span><span class="o">=</span><span class="mh">4</span><span class="mb">&#39;b0111</span><span class="p">;</span>
</span><span class='line'><span class="k">parameter</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="no">EN_A</span><span class="o">=</span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">cnt</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>      <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span><span class='line'><span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">cnt</span><span class="p">[</span><span class="mh">16</span><span class="o">:</span><span class="mh">15</span><span class="p">]</span> <span class="o">==</span> <span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">)</span>
</span><span class='line'>          <span class="k">case</span> <span class="p">(</span><span class="n">num1</span><span class="p">)</span>
</span><span class='line'>          <span class="mh">4&#39;h0</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_0</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h1</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_1</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h2</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_2</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h3</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_3</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h4</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_4</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h5</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_5</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h6</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_6</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h7</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_7</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h8</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_8</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h9</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_9</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;ha</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_A</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hb</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_B</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hc</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_C</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hd</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_D</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;he</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_E</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hf</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_F</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="k">default</span><span class="o">:</span>  <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_BLK</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_1</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="k">endcase</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">cnt</span><span class="p">[</span><span class="mh">16</span><span class="o">:</span><span class="mh">15</span><span class="p">]</span> <span class="o">==</span> <span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">)</span>
</span><span class='line'>          <span class="k">case</span> <span class="p">(</span><span class="n">num2</span><span class="p">)</span>
</span><span class='line'>          <span class="mh">4&#39;h0</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_0</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h1</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_1</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h2</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_2</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h3</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_3</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h4</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_4</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h5</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_5</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h6</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_6</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h7</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_7</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h8</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_8</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h9</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_9</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;ha</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_A</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hb</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_B</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hc</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_C</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hd</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_D</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;he</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_E</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hf</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_F</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="k">default</span><span class="o">:</span>  <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_BLK</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_2</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="k">endcase</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">cnt</span><span class="p">[</span><span class="mh">16</span><span class="o">:</span><span class="mh">15</span><span class="p">]</span> <span class="o">==</span> <span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">)</span>
</span><span class='line'>          <span class="k">case</span> <span class="p">(</span><span class="n">num3</span><span class="p">)</span>
</span><span class='line'>          <span class="mh">4&#39;h0</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_0</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h1</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_1</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h2</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_2</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h3</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_3</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h4</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_4</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h5</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_5</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h6</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_6</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h7</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_7</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h8</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_8</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h9</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_9</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;ha</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_A</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hb</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_B</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hc</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_C</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hd</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_D</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;he</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_E</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hf</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_F</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="k">default</span><span class="o">:</span>  <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_BLK</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_3</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="k">endcase</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">cnt</span><span class="p">[</span><span class="mh">16</span><span class="o">:</span><span class="mh">15</span><span class="p">]</span> <span class="o">==</span> <span class="mh">2</span><span class="mb">&#39;b11</span><span class="p">)</span>
</span><span class='line'>          <span class="k">case</span> <span class="p">(</span><span class="n">num4</span><span class="p">)</span>
</span><span class='line'>          <span class="mh">4&#39;h0</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_0</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h1</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_1</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h2</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_2</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h3</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_3</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h4</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_4</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h5</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_5</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h6</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_6</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h7</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_7</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h8</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_8</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;h9</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_9</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;ha</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_A</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hb</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_B</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hc</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_C</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hd</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_D</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;he</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_E</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="mh">4&#39;hf</span><span class="o">:</span> <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_F</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="k">default</span><span class="o">:</span>  <span class="k">begin</span> <span class="n">ds_reg</span> <span class="o">=</span> <span class="no">NUM_BLK</span><span class="p">;</span> <span class="n">ds_en</span> <span class="o">=</span> <span class="no">EN_4</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>          <span class="k">endcase</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span><span class='line'><span class="k">endmodule</span>
</span></code></pre></td></tr></table></div></figure>


<h2>按键</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='Verilog'><span class='line'> <span class="k">module</span> <span class="n">key_module</span><span class="p">(</span>
</span><span class='line'>  <span class="k">input</span> <span class="n">clk</span><span class="p">,</span>
</span><span class='line'>  <span class="k">input</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">key</span><span class="p">,</span>
</span><span class='line'>  <span class="k">output</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">key_flag</span>
</span><span class='line'> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="k">parameter</span> <span class="no">DIV_FACTOR</span> <span class="o">=</span> <span class="mh">32</span><span class="mi">&#39;d48</span><span class="n">_000</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">cnt</span><span class="p">;</span>
</span><span class='line'> <span class="kt">reg</span> <span class="n">clk_khz</span><span class="p">;</span>
</span><span class='line'> <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="no">DIV_FACTOR</span><span class="o">/</span><span class="mh">2</span><span class="p">)</span>
</span><span class='line'>          <span class="k">begin</span>
</span><span class='line'>              <span class="n">cnt</span> <span class="o">&lt;=</span> <span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
</span><span class='line'>              <span class="n">clk_khz</span> <span class="o">=</span> <span class="o">!</span><span class="n">clk_khz</span><span class="p">;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">else</span> 
</span><span class='line'>          <span class="n">cnt</span> <span class="o">&lt;=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
</span><span class='line'>          
</span><span class='line'> <span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">key_reg0</span><span class="p">;</span>
</span><span class='line'> <span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">key_reg1</span><span class="p">;</span>
</span><span class='line'> <span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">key_reg2</span><span class="p">;</span>
</span><span class='line'> <span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">key_reg3</span><span class="p">;</span>
</span><span class='line'> <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk_khz</span><span class="p">)</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>      <span class="n">key_reg0</span> <span class="o">&lt;=</span> <span class="p">{</span><span class="n">key_reg0</span><span class="p">[</span><span class="mh">30</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="o">!</span><span class="n">key</span><span class="p">[</span><span class="mh">0</span><span class="p">]};</span>
</span><span class='line'>      <span class="n">key_reg1</span> <span class="o">&lt;=</span> <span class="p">{</span><span class="n">key_reg1</span><span class="p">[</span><span class="mh">30</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="o">!</span><span class="n">key</span><span class="p">[</span><span class="mh">1</span><span class="p">]};</span>
</span><span class='line'>      <span class="n">key_reg2</span> <span class="o">&lt;=</span> <span class="p">{</span><span class="n">key_reg2</span><span class="p">[</span><span class="mh">30</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="o">!</span><span class="n">key</span><span class="p">[</span><span class="mh">2</span><span class="p">]};</span>
</span><span class='line'>      <span class="n">key_reg3</span> <span class="o">&lt;=</span> <span class="p">{</span><span class="n">key_reg3</span><span class="p">[</span><span class="mh">30</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="o">!</span><span class="n">key</span><span class="p">[</span><span class="mh">3</span><span class="p">]};</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span><span class='line'> <span class="k">assign</span> <span class="n">key_flag</span><span class="p">[</span><span class="mh">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_reg0</span> <span class="o">==</span> <span class="mh">32&#39;hffffffff</span><span class="p">);</span>
</span><span class='line'> <span class="k">assign</span> <span class="n">key_flag</span><span class="p">[</span><span class="mh">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_reg1</span> <span class="o">==</span> <span class="mh">32&#39;hffffffff</span><span class="p">);</span>
</span><span class='line'> <span class="k">assign</span> <span class="n">key_flag</span><span class="p">[</span><span class="mh">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_reg2</span> <span class="o">==</span> <span class="mh">32&#39;hffffffff</span><span class="p">);</span>
</span><span class='line'> <span class="k">assign</span> <span class="n">key_flag</span><span class="p">[</span><span class="mh">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_reg3</span> <span class="o">==</span> <span class="mh">32&#39;hffffffff</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="k">endmodule</span>
</span></code></pre></td></tr></table></div></figure>


<h2>VGA</h2>

<ol>
<li>VGA全称Video Graphic Array，也叫显示绘图阵列，是逐行扫描的显示制式，其支持的分辨率为640X480，对更高分辨率800X600称为SVGA模式；1024X768称为XVGA</li>
<li>VGA时序分行时序和帧时序，两者都包含同步脉冲（Sync a），显示后延（Back porch b），显示时序段（Display interval c）和显示前沿（Front porch d）四个部分
<img src="http://i.imgur.com/xTENNYJ.png" alt="VGA时序" /></li>
<li>各种分辨率的行场同步时序如图
<img src="http://i.imgur.com/VTCZg6j.png" alt="VGA参考时序数据表" /></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[TinyHttpd]]></title>
    <link href="http://suda-morris.github.io/blog/2015/11/22/tinyhttpd/"/>
    <updated>2015-11-22T15:56:10+08:00</updated>
    <id>http://suda-morris.github.io/blog/2015/11/22/tinyhttpd</id>
    <content type="html"><![CDATA[<h2>简介</h2>

<ol>
<li>tinyhttpd是一个不到500行的超轻量型Http Server</li>
</ol>


<h2>函数介绍</h2>

<ol>
<li>void accept_request(int);

<ul>
<li>处理从套接字上监听到的一个HTTP请求，在这里可以很大一部分体现服务器处理请求流程</li>
</ul>
</li>
<li>void bad_request(int);

<ul>
<li>返回给客户端这是一个错误请求，HTTP状态码400 BAD REQUEST</li>
</ul>
</li>
<li>void cat(int, FILE *);

<ul>
<li>读取服务器上某个文件写到socket套接字</li>
</ul>
</li>
<li>void cannot_execute(int);

<ul>
<li>主要处理发生在执行cgi程序时出现的错误</li>
</ul>
</li>
<li>void error_die(const char *);

<ul>
<li>将错误信息写到perror并退出</li>
</ul>
</li>
<li>void execute_cgi(int, const char <em>, const char </em>, const char *);

<ul>
<li>运行cgi程序的处理</li>
</ul>
</li>
<li>int get_line(int, char *, int);

<ul>
<li>读取套接字的一行，把回车换行等情况都统一为换行结束符</li>
</ul>
</li>
<li>void headers(int, const char *);

<ul>
<li>把HTTP响应的头部写到套接字</li>
</ul>
</li>
<li>void not_found(int);

<ul>
<li>主要处理找不到请求的文件时的情况</li>
</ul>
</li>
<li>void serve_file(int, const char *);

<ul>
<li>调用cat把服务器文件返回给浏览器</li>
</ul>
</li>
<li>int startup(u_short *);

<ul>
<li>初始化httpd服务，包括建立套接字，绑定端口，进行监听等</li>
</ul>
</li>
<li>void unimplemented(int);

<ul>
<li>返回给浏览器表明收到的HTTP请求所用的method不被支持</li>
</ul>
</li>
</ol>


<h2>源码详解</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
<span class='line-number'>457</span>
<span class='line-number'>458</span>
<span class='line-number'>459</span>
<span class='line-number'>460</span>
<span class='line-number'>461</span>
<span class='line-number'>462</span>
<span class='line-number'>463</span>
<span class='line-number'>464</span>
<span class='line-number'>465</span>
<span class='line-number'>466</span>
<span class='line-number'>467</span>
<span class='line-number'>468</span>
<span class='line-number'>469</span>
<span class='line-number'>470</span>
<span class='line-number'>471</span>
<span class='line-number'>472</span>
<span class='line-number'>473</span>
<span class='line-number'>474</span>
<span class='line-number'>475</span>
<span class='line-number'>476</span>
<span class='line-number'>477</span>
<span class='line-number'>478</span>
<span class='line-number'>479</span>
<span class='line-number'>480</span>
<span class='line-number'>481</span>
<span class='line-number'>482</span>
<span class='line-number'>483</span>
<span class='line-number'>484</span>
<span class='line-number'>485</span>
<span class='line-number'>486</span>
<span class='line-number'>487</span>
<span class='line-number'>488</span>
<span class='line-number'>489</span>
<span class='line-number'>490</span>
<span class='line-number'>491</span>
<span class='line-number'>492</span>
<span class='line-number'>493</span>
<span class='line-number'>494</span>
<span class='line-number'>495</span>
<span class='line-number'>496</span>
<span class='line-number'>497</span>
<span class='line-number'>498</span>
<span class='line-number'>499</span>
<span class='line-number'>500</span>
<span class='line-number'>501</span>
<span class='line-number'>502</span>
<span class='line-number'>503</span>
<span class='line-number'>504</span>
<span class='line-number'>505</span>
<span class='line-number'>506</span>
<span class='line-number'>507</span>
<span class='line-number'>508</span>
<span class='line-number'>509</span>
<span class='line-number'>510</span>
<span class='line-number'>511</span>
<span class='line-number'>512</span>
<span class='line-number'>513</span>
<span class='line-number'>514</span>
<span class='line-number'>515</span>
<span class='line-number'>516</span>
<span class='line-number'>517</span>
<span class='line-number'>518</span>
<span class='line-number'>519</span>
<span class='line-number'>520</span>
<span class='line-number'>521</span>
<span class='line-number'>522</span>
<span class='line-number'>523</span>
<span class='line-number'>524</span>
<span class='line-number'>525</span>
<span class='line-number'>526</span>
<span class='line-number'>527</span>
<span class='line-number'>528</span>
<span class='line-number'>529</span>
<span class='line-number'>530</span>
<span class='line-number'>531</span>
<span class='line-number'>532</span>
<span class='line-number'>533</span>
<span class='line-number'>534</span>
<span class='line-number'>535</span>
<span class='line-number'>536</span>
<span class='line-number'>537</span>
<span class='line-number'>538</span>
<span class='line-number'>539</span>
<span class='line-number'>540</span>
<span class='line-number'>541</span>
<span class='line-number'>542</span>
<span class='line-number'>543</span>
<span class='line-number'>544</span>
<span class='line-number'>545</span>
<span class='line-number'>546</span>
<span class='line-number'>547</span>
<span class='line-number'>548</span>
<span class='line-number'>549</span>
<span class='line-number'>550</span>
<span class='line-number'>551</span>
<span class='line-number'>552</span>
<span class='line-number'>553</span>
<span class='line-number'>554</span>
<span class='line-number'>555</span>
<span class='line-number'>556</span>
<span class='line-number'>557</span>
<span class='line-number'>558</span>
<span class='line-number'>559</span>
<span class='line-number'>560</span>
<span class='line-number'>561</span>
<span class='line-number'>562</span>
<span class='line-number'>563</span>
<span class='line-number'>564</span>
<span class='line-number'>565</span>
<span class='line-number'>566</span>
<span class='line-number'>567</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cm">/* J. David&#39;s webserver */</span>
</span><span class='line'><span class="cm">/* This is a simple webserver. </span>
</span><span class='line'><span class="cm"> * Created November 1999 by J. David Blackstone. </span>
</span><span class='line'><span class="cm"> * CSE 4344 (Network concepts), Prof. Zeigler </span>
</span><span class='line'><span class="cm"> * University of Texas at Arlington </span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="cm">/* This program compiles for Sparc Solaris 2.6. </span>
</span><span class='line'><span class="cm"> * To compile for Linux: </span>
</span><span class='line'><span class="cm"> *  1) Comment out the #include &lt;pthread.h&gt; line. </span>
</span><span class='line'><span class="cm"> *  2) Comment out the line that defines the variable newthread. </span>
</span><span class='line'><span class="cm"> *  3) Comment out the two lines that run pthread_create(). </span>
</span><span class='line'><span class="cm"> *  4) Uncomment the line that runs accept_request(). </span>
</span><span class='line'><span class="cm"> *  5) Remove -lsocket from the Makefile. </span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;  </span>
</span><span class='line'><span class="cp">#include &lt;sys/socket.h&gt;  </span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;  </span>
</span><span class='line'><span class="cp">#include &lt;netinet/in.h&gt;  </span>
</span><span class='line'><span class="cp">#include &lt;arpa/inet.h&gt;  </span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;  </span>
</span><span class='line'><span class="cp">#include &lt;ctype.h&gt;  </span>
</span><span class='line'><span class="cp">#include &lt;strings.h&gt;  </span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;  </span>
</span><span class='line'><span class="cp">#include &lt;sys/stat.h&gt;  </span>
</span><span class='line'><span class="cp">#include &lt;pthread.h&gt;  </span>
</span><span class='line'><span class="cp">#include &lt;sys/wait.h&gt;  </span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;  </span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define ISspace(x) isspace((int)(x))  </span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define SERVER_STRING &quot;Server: jdbhttpd/0.1.0\r\n&quot;  </span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">accept_request</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">bad_request</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">cat</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">cannot_execute</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">error_die</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">execute_cgi</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">get_line</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">headers</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">not_found</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">serve_file</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">startup</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">unimplemented</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="cm">/* A request has caused a call to accept() on the server port to </span>
</span><span class='line'><span class="cm"> * return.  Process the request appropriately. </span>
</span><span class='line'><span class="cm"> * Parameters: the socket connected to the client */</span>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">accept_request</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">numchars</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">method</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">url</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">cgi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="cm">/* becomes true if server decides this is a CGI program */</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">query_string</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*得到请求的第一行*/</span>
</span><span class='line'>    <span class="n">numchars</span> <span class="o">=</span> <span class="n">get_line</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span class='line'>    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/*把客户端的请求方法存到 method 数组*/</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ISspace</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">method</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span><span class='line'>        <span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">method</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*如果既不是 GET 又不是 POST 则无法处理 */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">&quot;GET&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">strcasecmp</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">unimplemented</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* POST 的时候开启 cgi */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">cgi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*读取 url 地址*/</span>
</span><span class='line'>    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">ISspace</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)))</span>
</span><span class='line'>        <span class="n">j</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ISspace</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="cm">/*存下 url */</span>
</span><span class='line'>        <span class="n">url</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span><span class='line'>        <span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">url</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*处理 GET 方法*/</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">&quot;GET&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* 待处理请求为 url */</span>
</span><span class='line'>        <span class="n">query_string</span> <span class="o">=</span> <span class="n">url</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">query_string</span> <span class="o">!=</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">query_string</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">))</span>
</span><span class='line'>            <span class="n">query_string</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="cm">/* GET 方法特点，? 后面为参数*/</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">query_string</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="cm">/*开启 cgi */</span>
</span><span class='line'>            <span class="n">cgi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>            <span class="o">*</span><span class="n">query_string</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="n">query_string</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*格式化 url 到 path 数组，html 文件都在 htdocs 中*/</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;htdocs%s&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/*默认情况为 index.html */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">strcat</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;index.html&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/*根据路径找到对应文件 */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/*把所有 headers 的信息都丢弃*/</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">((</span><span class="n">numchars</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>  <span class="cm">/* read &amp; discard headers */</span>
</span><span class='line'>            <span class="n">numchars</span> <span class="o">=</span> <span class="n">get_line</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span class='line'>        <span class="cm">/*回应客户端找不到*/</span>
</span><span class='line'>        <span class="n">not_found</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="cm">/*如果是个目录，则默认使用该目录下 index.html 文件*/</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">((</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IFMT</span><span class="p">)</span> <span class="o">==</span> <span class="n">S_IFDIR</span><span class="p">)</span>
</span><span class='line'>            <span class="n">strcat</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;/index.html&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">((</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IXUSR</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IXGRP</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IXOTH</span><span class="p">)</span>    <span class="p">)</span>
</span><span class='line'>          <span class="n">cgi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="cm">/*不是 cgi,直接把服务器文件返回，否则执行 cgi */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cgi</span><span class="p">)</span>
</span><span class='line'>          <span class="n">serve_file</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">execute_cgi</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">query_string</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*断开与客户端的连接（HTTP 特点：无连接）*/</span>
</span><span class='line'>    <span class="n">close</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="cm">/* Inform the client that a request it has made has a problem. </span>
</span><span class='line'><span class="cm"> * Parameters: client socket */</span>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">bad_request</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*回应客户端错误的 HTTP 请求 */</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;HTTP/1.0 400 BAD REQUEST</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Content-type: text/html</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;&lt;P&gt;Your browser sent a bad request, &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;such as a POST without a Content-Length.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="cm">/* Put the entire contents of a file out on a socket.  This function </span>
</span><span class='line'><span class="cm"> * is named after the UNIX &quot;cat&quot; command, because it might have been </span>
</span><span class='line'><span class="cm"> * easier just to do something like pipe, fork, and exec(&quot;cat&quot;). </span>
</span><span class='line'><span class="cm"> * Parameters: the client socket descriptor </span>
</span><span class='line'><span class="cm"> *             FILE pointer for the file to cat */</span>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">cat</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">resource</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*读取文件中的所有数据写到 socket */</span>
</span><span class='line'>    <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">resource</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">resource</span><span class="p">))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">resource</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="cm">/* Inform the client that a CGI script could not be executed. </span>
</span><span class='line'><span class="cm"> * Parameter: the client socket descriptor. */</span>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">cannot_execute</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* 回应客户端 cgi 无法执行*/</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;HTTP/1.0 500 Internal Server Error</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Content-type: text/html</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;&lt;P&gt;Error prohibited CGI execution.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="cm">/* Print out an error message with perror() (for system errors; based </span>
</span><span class='line'><span class="cm"> * on value of errno, which indicates system call errors) and exit the </span>
</span><span class='line'><span class="cm"> * program indicating an error. */</span>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">error_die</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/*出错信息处理 */</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
</span><span class='line'>    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="cm">/* Execute a CGI script.  Will need to set environment variables as </span>
</span><span class='line'><span class="cm"> * appropriate. </span>
</span><span class='line'><span class="cm"> * Parameters: client socket descriptor </span>
</span><span class='line'><span class="cm"> *             path to the CGI script */</span>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">execute_cgi</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">query_string</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">cgi_output</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">cgi_input</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">numchars</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">content_length</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">&quot;GET&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="cm">/*把所有的 HTTP header 读取并丢弃*/</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">((</span><span class="n">numchars</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>  <span class="cm">/* read &amp; discard headers */</span>
</span><span class='line'>            <span class="n">numchars</span> <span class="o">=</span> <span class="n">get_line</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span class='line'>    <span class="k">else</span>    <span class="cm">/* POST */</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* 对 POST 的 HTTP 请求中找出 content_length */</span>
</span><span class='line'>        <span class="n">numchars</span> <span class="o">=</span> <span class="n">get_line</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">((</span><span class="n">numchars</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="cm">/*利用 \0 进行分隔 */</span>
</span><span class='line'>            <span class="n">buf</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="cm">/* HTTP 请求的特点*/</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Content-Length:&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                <span class="n">content_length</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">]));</span>
</span><span class='line'>            <span class="n">numchars</span> <span class="o">=</span> <span class="n">get_line</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="cm">/*没有找到 content_length */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">content_length</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="cm">/*错误请求*/</span>
</span><span class='line'>            <span class="n">bad_request</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* 正确，HTTP 状态码 200 */</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;HTTP/1.0 200 OK</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* 建立管道*/</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">cgi_output</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/*错误处理*/</span>
</span><span class='line'>        <span class="n">cannot_execute</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="cm">/*建立管道*/</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">cgi_input</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/*错误处理*/</span>
</span><span class='line'>        <span class="n">cannot_execute</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/*错误处理*/</span>
</span><span class='line'>        <span class="n">cannot_execute</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="cm">/* child: CGI script */</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">char</span> <span class="n">meth_env</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">char</span> <span class="n">query_env</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">char</span> <span class="n">length_env</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* 把 STDOUT 重定向到 cgi_output 的写入端 */</span>
</span><span class='line'>        <span class="n">dup2</span><span class="p">(</span><span class="n">cgi_output</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="cm">/* 把 STDIN 重定向到 cgi_input 的读取端 */</span>
</span><span class='line'>        <span class="n">dup2</span><span class="p">(</span><span class="n">cgi_input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="cm">/* 关闭 cgi_input 的写入端 和 cgi_output 的读取端 */</span>
</span><span class='line'>        <span class="n">close</span><span class="p">(</span><span class="n">cgi_output</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">close</span><span class="p">(</span><span class="n">cgi_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>        <span class="cm">/*设置 request_method 的环境变量*/</span>
</span><span class='line'>        <span class="n">sprintf</span><span class="p">(</span><span class="n">meth_env</span><span class="p">,</span> <span class="s">&quot;REQUEST_METHOD=%s&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">);</span>
</span><span class='line'>        <span class="n">putenv</span><span class="p">(</span><span class="n">meth_env</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">&quot;GET&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="cm">/*设置 query_string 的环境变量*/</span>
</span><span class='line'>            <span class="n">sprintf</span><span class="p">(</span><span class="n">query_env</span><span class="p">,</span> <span class="s">&quot;QUERY_STRING=%s&quot;</span><span class="p">,</span> <span class="n">query_string</span><span class="p">);</span>
</span><span class='line'>            <span class="n">putenv</span><span class="p">(</span><span class="n">query_env</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">{</span>   <span class="cm">/* POST */</span>
</span><span class='line'>            <span class="cm">/*设置 content_length 的环境变量*/</span>
</span><span class='line'>            <span class="n">sprintf</span><span class="p">(</span><span class="n">length_env</span><span class="p">,</span> <span class="s">&quot;CONTENT_LENGTH=%d&quot;</span><span class="p">,</span> <span class="n">content_length</span><span class="p">);</span>
</span><span class='line'>            <span class="n">putenv</span><span class="p">(</span><span class="n">length_env</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="cm">/*用 execl 运行 cgi 程序*/</span>
</span><span class='line'>        <span class="n">execl</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>    <span class="cm">/* parent */</span>
</span><span class='line'>        <span class="cm">/* 关闭 cgi_input 的读取端 和 cgi_output 的写入端 */</span>
</span><span class='line'>        <span class="n">close</span><span class="p">(</span><span class="n">cgi_output</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">close</span><span class="p">(</span><span class="n">cgi_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="cm">/*接收 POST 过来的数据*/</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">content_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">recv</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>                <span class="cm">/*把 POST 数据写入 cgi_input，现在重定向到 STDIN */</span>
</span><span class='line'>                <span class="n">write</span><span class="p">(</span><span class="n">cgi_input</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="cm">/*读取 cgi_output 的管道输出到客户端，该管道输入是 STDOUT */</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">cgi_output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*关闭管道*/</span>
</span><span class='line'>        <span class="n">close</span><span class="p">(</span><span class="n">cgi_output</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">close</span><span class="p">(</span><span class="n">cgi_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>        <span class="cm">/*等待子进程*/</span>
</span><span class='line'>        <span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="cm">/* Get a line from a socket, whether the line ends in a newline, </span>
</span><span class='line'><span class="cm"> * carriage return, or a CRLF combination.  Terminates the string read </span>
</span><span class='line'><span class="cm"> * with a null character.  If no newline indicator is found before the </span>
</span><span class='line'><span class="cm"> * end of the buffer, the string is terminated with a null.  If any of </span>
</span><span class='line'><span class="cm"> * the above three line terminators is read, the last character of the </span>
</span><span class='line'><span class="cm"> * string will be a linefeed and the string will be terminated with a </span>
</span><span class='line'><span class="cm"> * null character. </span>
</span><span class='line'><span class="cm"> * Parameters: the socket descriptor </span>
</span><span class='line'><span class="cm"> *             the buffer to save the data in </span>
</span><span class='line'><span class="cm"> *             the size of the buffer </span>
</span><span class='line'><span class="cm"> * Returns: the number of bytes stored (excluding null) */</span>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">get_line</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*把终止条件统一为 \n 换行符，标准化 buf 数组*/</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="cm">/*一次仅接收一个字节*/</span>
</span><span class='line'>        <span class="n">n</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="cm">/* DEBUG printf(&quot;%02X\n&quot;, c); */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="cm">/*收到 \r 则继续接收下个字节，因为换行符可能是 \r\n */</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="cm">/*使用 MSG_PEEK 标志使下一次读取依然可以得到这次读取的内容，可认为接收窗口不滑动*/</span>
</span><span class='line'>                <span class="n">n</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MSG_PEEK</span><span class="p">);</span>
</span><span class='line'>                <span class="cm">/* DEBUG printf(&quot;%02X\n&quot;, c); */</span>
</span><span class='line'>                <span class="cm">/*但如果是换行符则把它吸收掉*/</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">recv</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'>                    <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="cm">/*存到缓冲区*/</span>
</span><span class='line'>            <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'>            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*返回 buf 数组大小*/</span>
</span><span class='line'>    <span class="k">return</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="cm">/* Return the informational HTTP headers about a file. */</span>
</span><span class='line'><span class="cm">/* Parameters: the socket to print the headers on </span>
</span><span class='line'><span class="cm"> *             the name of the file */</span>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">headers</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">filename</span><span class="p">;</span>  <span class="cm">/* could use filename to determine file type */</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*正常的 HTTP header */</span>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;HTTP/1.0 200 OK</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/*服务器信息*/</span>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">SERVER_STRING</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Content-Type: text/html</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="cm">/* Give a client a 404 not found status message. */</span>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">not_found</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* 404 页面 */</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;HTTP/1.0 404 NOT FOUND</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/*服务器信息*/</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">SERVER_STRING</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Content-Type: text/html</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;&lt;HTML&gt;&lt;TITLE&gt;Not Found&lt;/TITLE&gt;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;&lt;BODY&gt;&lt;P&gt;The server could not fulfill</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;your request because the resource specified</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;is unavailable or nonexistent.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;&lt;/BODY&gt;&lt;/HTML&gt;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="cm">/* Send a regular file to the client.  Use headers, and report </span>
</span><span class='line'><span class="cm"> * errors to client if they occur. </span>
</span><span class='line'><span class="cm"> * Parameters: a pointer to a file structure produced from the socket </span>
</span><span class='line'><span class="cm"> *              file descriptor </span>
</span><span class='line'><span class="cm"> *             the name of the file to serve */</span>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">serve_file</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">FILE</span> <span class="o">*</span><span class="n">resource</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">numchars</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*读取并丢弃 header */</span>
</span><span class='line'>    <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">((</span><span class="n">numchars</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>  <span class="cm">/* read &amp; discard headers */</span>
</span><span class='line'>        <span class="n">numchars</span> <span class="o">=</span> <span class="n">get_line</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*打开 sever 的文件*/</span>
</span><span class='line'>    <span class="n">resource</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">resource</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="n">not_found</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="cm">/*写 HTTP header */</span>
</span><span class='line'>        <span class="n">headers</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
</span><span class='line'>        <span class="cm">/*复制文件*/</span>
</span><span class='line'>        <span class="n">cat</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">resource</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">fclose</span><span class="p">(</span><span class="n">resource</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="cm">/* This function starts the process of listening for web connections </span>
</span><span class='line'><span class="cm"> * on a specified port.  If the port is 0, then dynamically allocate a </span>
</span><span class='line'><span class="cm"> * port and modify the original port variable to reflect the actual </span>
</span><span class='line'><span class="cm"> * port. </span>
</span><span class='line'><span class="cm"> * Parameters: pointer to variable containing the port to connect on </span>
</span><span class='line'><span class="cm"> * Returns: the socket */</span>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">startup</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">httpd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">name</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*建立 socket */</span>
</span><span class='line'>    <span class="n">httpd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">httpd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="n">error_die</span><span class="p">(</span><span class="s">&quot;socket&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
</span><span class='line'>    <span class="n">name</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'>    <span class="n">name</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="p">);</span>
</span><span class='line'>    <span class="n">name</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">httpd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">error_die</span><span class="p">(</span><span class="s">&quot;bind&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/*如果当前指定端口是 0，则动态随机分配一个端口*/</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="cm">/* if dynamically allocating a port */</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">getsockname</span><span class="p">(</span><span class="n">httpd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">namelen</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>            <span class="n">error_die</span><span class="p">(</span><span class="s">&quot;getsockname&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">sin_port</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="cm">/*开始监听*/</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">httpd</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">error_die</span><span class="p">(</span><span class="s">&quot;listen&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/*返回 socket id */</span>
</span><span class='line'>    <span class="k">return</span><span class="p">(</span><span class="n">httpd</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="cm">/* Inform the client that the requested web method has not been </span>
</span><span class='line'><span class="cm"> * implemented. </span>
</span><span class='line'><span class="cm"> * Parameter: the client socket */</span>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">unimplemented</span><span class="p">(</span><span class="kt">int</span> <span class="n">client</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* HTTP method 不被支持*/</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;HTTP/1.0 501 Method Not Implemented</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/*服务器信息*/</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">SERVER_STRING</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Content-Type: text/html</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Method Not Implemented</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;&lt;/TITLE&gt;&lt;/HEAD&gt;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;&lt;BODY&gt;&lt;P&gt;HTTP request method not supported.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;&lt;/BODY&gt;&lt;/HTML&gt;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**********************************************************************/</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">server_sock</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">u_short</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">client_sock</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">client_name</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">client_name_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_name</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">pthread_t</span> <span class="n">newthread</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*在对应端口建立 httpd 服务*/</span>
</span><span class='line'>    <span class="n">server_sock</span> <span class="o">=</span> <span class="n">startup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;httpd running on port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="cm">/*套接字收到客户端连接请求*/</span>
</span><span class='line'>        <span class="n">client_sock</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">server_sock</span><span class="p">,(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_name</span><span class="p">,</span><span class="o">&amp;</span><span class="n">client_name_len</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">client_sock</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>            <span class="n">error_die</span><span class="p">(</span><span class="s">&quot;accept&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="cm">/*派生新线程用 accept_request 函数处理新请求*/</span>
</span><span class='line'>        <span class="cm">/* accept_request(client_sock); */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newthread</span> <span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">accept_request</span><span class="p">,</span> <span class="n">client_sock</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="n">perror</span><span class="p">(</span><span class="s">&quot;pthread_create&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">close</span><span class="p">(</span><span class="n">server_sock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[i.MX280]]></title>
    <link href="http://suda-morris.github.io/blog/2015/11/12/i-dot-mx280/"/>
    <updated>2015-11-12T15:40:17+08:00</updated>
    <id>http://suda-morris.github.io/blog/2015/11/12/i-dot-mx280</id>
    <content type="html"><![CDATA[<h2>Linux内核组成部分</h2>

<ol>
<li>内存管理

<ol>
<li>进程管理负责控制进程对CPU的访问，如任务的创建、调度和终止等。任务调度是进程管理最核心的工作，由Linux内核调度器来完成。Linux内核调度器根据一定算法来选择最值得运行的进程</li>
<li>运行态：已经获得了资源，并且进程正在被CPU执行进程既可以运行在内核态，也可运行在用户态

<ol>
<li>内核态：内核和驱动所运行时的状态，程序处于特权阶级，能够访问系统的任何资源</li>
<li>用户态：用户程序运行的状态，处于非特权阶级，不能随意访问系统资源，必须通过驱动程序方可访问，用户态程序运行的状态，处于非特权阶级，不能随意访问系统资源，必须通过驱动程序方可访问，用户态程序可通过系统调用进入内核态。</li>
</ol>
</li>
<li>就绪态：当系统资源已经可用，但由于前一个进程还没有执行完而释放CPU，准备进入运行状态</li>
<li>可中断睡眠状态：当进程处于可中断等待状态时，系统不会调度改程序执行。当系统产生一个中断或者释放了进程正在等待的资源，或者进程收到一个信号，都可以被唤醒进入就绪状态或者运行态</li>
<li>不可中断睡眠状态：处于中断等待状态，但是该进程只能被使用wake_up（）函数明确唤醒的时候才可进入就绪状态。</li>
<li>暂停状态：当进程收到SIGSTOP、SIGSTP、SIGTTIN或者SIGTTOU就会进入暂停状态，收到SIGCONT信号即可进入运行态</li>
<li>僵死态：进程已经被停止运行，但是其父进程还没有询问其状态
<img src="http://i.imgur.com/bBBsOdX.png" alt="Linux进程状态和转换" /></li>
</ol>
</li>
<li>内存管理

<ul>
<li>内存管理的主要作用是控制和管理多个进程，使之能够安全的共享主内存区域。当CPU提供内存管理单元MMU时，内存管理为各进程实现虚拟地址到内存物理地址的转换。在32位系统上，Linux内核将4G空间分为1G内核空间（3~4G）和3G（0~3G）用户控件，通过内存管理，每个进程都可以使用3G的用户空间</li>
</ul>
</li>
<li>文件系统

<ul>
<li>Linux内核支持众多的逻辑文件系统，如Ext2、Ext3、Ext4、btrfs、NFS、VFAT等。VFS则是Linux基于各种逻辑文件系统抽象出的一种内存中的文件系统，隐藏了各种硬件设备的细节，为用户提供了同意的操作接口，是用户访问各种不同文件系统和设备时，不用区分具体的逻辑文件系统。</li>
</ul>
</li>
<li>网络接口

<ul>
<li>Linux对网络支持相当完善，网络接口提供了对各种网络标准的存取和各种网络硬件的支持，接口可分为网络协议和网络驱动程序。网络协议部分负责实现每一种可能的网络传输协议。网络设备驱动程序负责与硬件设备通讯，每一种可能的硬件设备都有相应的设备驱动程序</li>
</ul>
</li>
<li>进程间通信

<ul>
<li>支持进程间各种通信机制，如管道、命令管道、信号、消息队列、内存共享、信号量和套接字等。

<ol>
<li>管道通常用于具有亲缘关系的父子进程或者兄弟进程间通信，是半双工的，数据只能往一个方向流动，先入先出，与自来水管很相似。如果双方胡同时，需要建立两个管道</li>
<li>命名管道突破了进程间的亲缘关系限制，即非父子、兄弟进程之间也可以相互通信</li>
<li>信号是软件中断，用于在多个进程之间传递一步信号。</li>
<li>信号能传递的信息很有限，而消息队列正好弥补了这点。</li>
<li>共享内存常用于不同进程间进行大量数据传递。Linux下每个进程都有自己的独立空间，各自都不能直接访问其他进程的空间。</li>
<li>信号量用于进程同步。只有获得了信号量的进程才可以运行，没有获得信号量的进程则只能等待。</li>
<li>套接字起源于BSD，也常称“BSD套接字”，用于多个进程间通信，可以基于文件，也可以基于网络。
<img src="http://i.imgur.com/fk3Ryjy.png" alt="Linux操作系统基本体系结构" /></li>
</ol>
</li>
</ul>
</li>
</ol>


<h2>设置主板支持虚拟化</h2>

<ol>
<li>进入BIOS（F2或者F10等等）</li>
<li>找到Intel Virtualization Technology选项，设置为Enable</li>
<li>设置好后重启电脑</li>
</ol>


<h2>虚拟网卡有三种模式</h2>

<ol>
<li>桥接模式

<ol>
<li>这种情况下，虚拟机虚拟出来的操作系统就像是局域网中的一台独立的主机，它可以访问网内任何一台主机。在桥接模式下，虚拟系统和宿主机的关系就像连接在同一个Hub上的两台电脑。用户需要手工为虚拟系统配置IP地址、子网掩码，而且还要和宿主机器处于同一网段，这样虚拟系统才能和宿主机器进行通信。同时，由于这个虚拟系统是局域网中的而一个独立的主机系统，那么就可以手工配置它的TCP/IP配置信息，以实现通过局域网的网关或罗尤其访问互联网。在进行嵌入式Linux开发，要目标板通过NFS挂载虚拟机的NFS共享目录的话，必须将虚拟王珂配置为桥接模式</li>
</ol>
</li>
<li>NAT模式

<ol>
<li>使用NAT模式，就是让虚拟机系统借助NAT（网络地址转化）功能，通过宿主机器在的网络来访问公网。也就是说，使用NAT模式可以实现在虚拟系统里访问互联网。NAT模式下的虚拟系统的TCP/IP配置信息是由VMnet8（NAT）虚拟网络的DHCP服务器提供的，虚拟机无法正常对主机锁链网络中的其他主机提供普通的而络服务，如TFTP、NFS和FTP等。采用NAT模式最大的优势是虚拟系统接入互联网非常简单，用户不需要进行任何其他的配置，只需要宿主机器能访问互联网即可</li>
</ol>
</li>
<li>Host-Only模式

<ol>
<li>在某些特殊的网络调试环境中，要求将真实环境和虚拟环境隔开，这是用户就可采用仅主机（Host-Only）模式。在Host-Only模式中，所有的虚拟系统是可以相互通信的，但虚拟系统和真实的网络是被隔离开的。</li>
</ol>
</li>
</ol>


<h2>简单的Shell</h2>

<ol>
<li>cd -:切换至之前的工作目录</li>
<li>ls -lash:查看当前目录文件信息</li>
<li>pwd：查看当前路径</li>
<li>mkdir -p：创建多级目录</li>
<li>rmdir：删除空目录</li>
<li>alias rm=&ldquo;rm -vi"：为rm -vi取别名</li>
<li>rm -rf:强制删除某些文件或者目录</li>
<li>touch a：创建a文件，文件大小为0</li>
<li>file a：读取a文件的文件头并识别文件类型。a文件必须具有可读属性</li>
<li>more/less：两个命令都能用来浏览文本文件，可以分页查看文件内容，空格翻页。文件浏览完毕，按键盘q退出。相比来说，less命令更加灵活，支持键盘Page Up和Page Down键，可任意向前后翻页浏览，并且还支持文本搜索。使用less打开文件后，输入/abc可在文本中搜索字符串abc</li>
<li>head/tail：这两个命令可分别查看文件头部和文件尾部，一般用于查看ASCII文件。默认显示10行，加上参数-n【数字】可以指定显示行数或者加上参数-c【数字】指定显示的字节数</li>
<li>cat：cat命令可以将一个或者多个文件输出到标准输出上，可以用于文件查看</li>
<li>文件合并：cat [选项] 文件1 文件2 &hellip; [>文件3]

<ol>
<li>选项

<ul>
<li>-n ：从1开始对输出进行编号</li>
<li>-b：类似于-n，从1开始编号，但是忽略空白行</li>
<li>-s：遇到连续两行或者以上的空白行，就替换为一行空白行</li>
</ul>
</li>
</ol>
</li>
<li>文件压缩/解压：tar [选项] 文件

<ol>
<li>tar是UNIX系统的一个文件打包工具，只是连续首位相连的将文件堆放起来，并不具备压缩功能，但是加上选项，tar可以调用其它压缩/解压工具，能够实现文件的压缩和解压</li>
<li>选项

<ul>
<li>-c：创建存档文件，与-x相斥</li>
<li>-t：列出档案文件的文件列表</li>
<li>-x：解包存档文件，与-c相斥</li>
<li>-A：合并存档文件</li>
<li>-d：比较存档文件与源文件</li>
<li>-r：追加文件到存档文件末尾</li>
<li>-u：更新存档文件</li>
<li>-f：指定存档文件，与其他选项同时使用时，必须在最后，如tar -xjvf a.tar.bz2</li>
<li>-v:显示详细处理信息</li>
<li>-C：转到指定目录，常用于解开存档文件</li>
<li>-j：调用bzip2程序</li>
<li>-z：调用gzip程序</li>
<li>-Z：调用compress程序</li>
<li>&ndash;exclude=PATH：排除指定文件或者目录，常用于打包文件</li>
</ul>
</li>
</ol>
</li>
<li>文件复制：cp [选项] 源文件/目录 目的文件/目录

<ol>
<li>选项：

<ul>
<li>-a：保留链接，文件属性并递归复制，等同于-dpR组合，常用于复制目录</li>
<li>-d：复制时保留链接</li>
<li>-f：若目标文件已经存在，则直接删除而不提示</li>
<li>-i：若目标文件已经存在，需要用户确认操作，与-f相反</li>
<li>-p：除复制文件内容外，把访问权限和修改时间也复制到新文件中</li>
<li>-f：递归复制，递归复制指定目录下的文件和目录</li>
<li>-v：显示文件复制过程</li>
</ul>
</li>
</ol>
</li>
<li>创建链接：ln [选项] 源文件/目录 目标文件

<ol>
<li>硬链接通过索引节点进行链接，相当于源文件的镜像，占用源文件一样大小的空间，修改其中任何一个，另外一个都会进行同样的改动。给一个文件创建硬链接后，文件属性的硬连接数会增加。硬链接不能跨越文件系统，只能在同一个文件系统内进行链接，且不能对目录文件建立硬链接，给目录文件建立硬链接会出错</li>
<li>软连接和硬链接不同，软连接是产生一个新文件，这个文件指向另一个文件的位置，类似于Windows下的快捷方式。软连接可以跨越文件系统，且用于任何文件，包括目录文件</li>
</ol>
</li>
<li>网卡配置：ifconfig 网络接口 [选项] 地址/参数

<ol>
<li>选项：

<ul>
<li>-a：查看系统拥有的全部网络接口</li>
<li>网络接口如eth0：指定操作某个网口</li>
<li>broadcast：设置网口的广播地址</li>
<li>netmask：设置网口的子网掩码</li>
<li>hw ether：设置网卡物理地址（如果驱动不支持则无效）</li>
<li>up：激活指定网卡</li>
<li>down：关闭指定网卡</li>
</ul>
</li>
</ol>
</li>
<li>安装和卸载文件系统

<ol>
<li>linux允许多个文件系统存在于同一个系统中，也允许用户在系统运行中安装内核所支持的文件系统。例如，讲一个FAT格式的U盘插入到linux系统中。</li>
<li>linux安装文件系统：mount [参数] [设备名] [挂载点]

<ol>
<li>参数：

<ul>
<li>-a：挂载/etc/fstab文件中列出的所有文件系统</li>
<li>-r：以只读的方式挂载</li>
<li>-w：以可写的方式挂载（默认）</li>
<li>-v：显示详细安装信息</li>
<li>-t&lt;文件系统类型>：指定文件系统类型，常见的有：

<ul>
<li>ext/ext2/ext3/ext4:Linux常用文件系统</li>
<li>msdos：MS-DOS的FAT，即FAT16</li>
<li>vfat：Windows系统的FAT，FAT32</li>
<li>nfs：网络文件系统</li>
<li>ntfs：Windows2000/NT/XP的ntfs文件系统</li>
<li>auto：自动检测文件系统</li>
</ul>
</li>
<li>-o&lt;选项>：指定挂载时的一些选项，常用有：

<ul>
<li>defaults：使用默认值（auto，nouser，rw，suid）</li>
<li>suid/nosuid：确认/不确认suid和sgid位</li>
<li>user/nouser：允许/不允许一般用户挂载</li>
<li>codepage=XXX：指定codepage</li>
<li>iocharset=XXX：指定字符集</li>
<li>ro：以只读方式挂载</li>
<li>rw：以读写方式挂载</li>
<li>remount：重新安装已经安装了的文件系统</li>
<li>loop：挂载loopback设备以及ISO文件</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
<li>挂载点必须是一个已经存在的目录</li>
<li>一个挂载点可以被多个设备/文件重复挂载，只是后一次挂载将覆盖前一次内容，卸载后可用</li>
<li>使用多个-o参数的时候，-o只用一次，参数之间用半角逗号隔开</li>
<li>例如，挂载FAT格式的U盘：

<ol>
<li>mount -t vfat /dev/sda1 /mnt</li>
</ol>
</li>
<li>nfs挂载，将远程主机主机Linux的某个共享目录挂载到嵌入式系统本地，当成本地设备进行操作：

<ol>
<li>mount -t nfs 192.168.1.138:/home/morris/lpc/mnt -o nolock</li>
<li>nolock表示禁用文件锁，当连接到一个旧版本的NFS服务器时常加该选项</li>
</ol>
</li>
<li>此外，嵌入式开发中常用的文件系统还有cramfs，jffs2，yaffs2以及ubifs等，特别是用于NOR Flash的jffs2和用于NAND Flash的yaffs/yaffs2,ubifs等，在进行系统操作中通常需要对各设备进行挂载或者卸载，需要在挂载的时候指定正确的文件系统类型。

<ul>
<li>挂载yaffs2分区的命令示例：mount -t yaffs2 /dev/mtdblock2 /mnt</li>
<li>挂载ubifs分区的命令示例：mount -t ubifs ubi0:rootfs /mnt</li>
</ul>
</li>
<li>文件系统卸载：umount 挂载点</li>
</ol>
</li>
<li>使用sudo命令需要管理员将用户添加到sudoer组中，一般在/etc/sudoer文件中修改</li>
<li>linux中，对文件的操作都是先保存在缓存中，并没有立即写入磁盘，经系统调度后方可写入磁盘。如果修改了缓存，还没来得及写到磁盘就断电，自然就会造成文件改变丢失。要避免这种情况，就是修改文件后，立即强制进行一次文件同步操作，将缓存的内容写入磁盘，确保文件系统的完整性。能完成这样功能的命令是sync。只需要在关闭文本编辑器后再shell输入sync即可</li>
<li>文件搜索，find 路径 选项 其他

<ol>
<li>最常用的就是根据文件名来查找，加上-name就可以了，还可以支持通配符，进行模糊搜索。例如：find arch/arm/ -name mux*.c</li>
</ol>
</li>
<li>字符串搜索： grep 选项

<ol>
<li>例如：grep &ldquo;pcf8563&rdquo; -R arch/arm</li>
<li>关键字最好加上双引号，特别是包含空格的关键字。</li>
<li>-R表示递归查找</li>
</ol>
</li>
<li>执行Shell脚本有多种方式：

<ol>
<li>点+斜线+文件名，这种方式要求文件必须具有可执行权限</li>
<li>点+空格+文件名，这种方式不要求文件一定具有可执行权限</li>
<li>sh+空格+文件名，这种方式不要求文件一定具有可执行权限</li>
<li>source+空格+文件名，这种方式不要求文件一定具有可执行权限</li>
</ol>
</li>
</ol>


<h2>重定向</h2>

<ol>
<li>Linux Shell终端启动的时候会打开3个标准文件：标准输入（stdin）、标准输出（stdout）和标准错误（stderr）。shell从标准输入（通常是键盘）接收命令，命令执行结果信息打印到标准输出（通常是终端屏幕）上，如有错误信息，则打印到标准错误（通常是终端屏幕）上。</li>
<li>Shell允许用户对输入输出进行重定向。输出重定向允许将输出信息从标准输出重定向到其他文件上，也可以重定向到某个设备如打印机上。</li>
<li>重定向在Linux下用“>”和“>>”表示，“>”表示输出到一个新文件中，而“>>”则表示输出到现有文件的末尾。如果文件已经存在，直接操作文件，否则将创建新文件。</li>
<li>echo命令将内容回显到标准输出上，使用echo命令加上重定向可以创建一个带内容的非空文件。</li>
<li>回显内容如果不加引号，则用单空格替代多个连续空格，如果加了引号，则原封不动回显</li>
</ol>


<h2>使用内核模块和驱动</h2>

<ol>
<li>加载（插入）模块

<ol>
<li>linux能够动态加载和卸载模块。如果某些功能平时用不到，可以不编译进内核，而采取模块方式编译，在需要的时候再插入内核，不再需要的时候卸载。linux中最常见的模块是内核驱动</li>
<li>insmod [选项] 模块 [符号名称=值]，常用选项

<ol>
<li>-f：强制将模块载入，不检查目前kernel版本与模块编译时的kernel是否一致</li>
<li>-k：将模块设置为自动卸载</li>
<li>-p：测试模块是否能正确插入</li>
<li>-x：不导出模块符号</li>
<li>-X：导出模块所有外部符号（默认）</li>
<li>-v：显示执行过程</li>
</ol>
</li>
</ol>
</li>
<li>查看系统已经加载的模块：lsmod，其实际上就是列出/proc/modules的内容</li>
<li>卸载驱动模块：rm [选项] 模块，常用选项

<ol>
<li>-f：强制卸载正在被使用的模块，非常危险。需要内核支持CONFIG_MODULE_FORCE_UNLOAD使能，否则无效</li>
<li>-w：通常情况下不能卸载正在被使用的模块，加上-w选项，指定模块将会被孤立，直到不再被使用</li>
<li>-s：将错误信息写入syslog，而不是标准错误</li>
<li>-v：显示执行过程</li>
</ol>
</li>
<li>自动处理可加载模块：insmod/rmmod分别用于加载和卸载模块，但是每次只能加载/卸载一个模块，如果一个模块依赖于多个模块，则需要进行多次操作，比较繁琐。modprobe命令集加载/卸载功能于一身，并且可以自动解决模块的依赖关系。modprobe [选项] 模块[符号=值]，常用选项：

<ol>
<li>-C&lt;文件>：不使用默认配置文件，使用指定文件作为配置文件</li>
<li>-i：忽略配置文件中的加载和卸载命令</li>
<li>-r：卸载指定模块，包括依赖模块</li>
<li>-f：强制安装</li>
<li>-l：显示所有匹配模块</li>
<li>-a：安装所有匹配的模块</li>
<li>&ndash;show-depends：显示模块的依赖关系</li>
<li>-v：显示执行过程</li>
<li>-q：不显示任何信息</li>
<li>-V：显示版本信息</li>
</ol>
</li>
<li>modprob处理模块时忽略模块的路径，这要求系统模块和驱动是按照make modules_install方式安装的，即模块必须放在/lib/modules/$(uname -r)目录下，并且有正确的/lib/modules/$(uname -r)/modules.dep文件，modprobe根据该文件来寻找和解决依赖关系</li>
<li>如果系统不能自动创建设备节点，加载驱动后，则需要为驱动建立对应的设备节点，否则无法通过驱动来操作设备。mknod 设备名 设备类型 主设备号 次设备号</li>
</ol>


<h2>环境变量</h2>

<ol>
<li>Linux是一个多用户操作系统，每个用户都有自己专有的运行环境，用户所使用的环境由一系列变量所定义，这些变量被称为环境变量，系统环境变量一般都是大写</li>
<li>常见的环境变量：

<ol>
<li>PATH：决定了Shell将到哪些目录中寻找命令或程序，这个变量是在日常使用中经常需要修改的变量</li>
<li>TERM：指定系统终端</li>
<li>SHELL：当前用户shell类型</li>
<li>HOME：当前用户主目录</li>
<li>LOGNAME：当前用户的登录名</li>
<li>USER：当前用户名</li>
<li>HISTSIZE：历史命令记录数</li>
<li>HOSTNAME：主机名</li>
<li>LANGUGE：语言相关的环境变量，多语言可以修改此环境变量</li>
<li>MAIL：当前用户的邮件存放目录</li>
<li>PS1：基本提示符，对于root用户是#，对于普通用户是$</li>
<li>PS2：附属提示符，默认是“>”</li>
<li>LS_COLORS:ls命令结果颜色显示</li>
</ol>
</li>
<li>在shell下通过$符号来引用环境变量，使用echo可以查看某个具体环境变量的值</li>
<li>使用env或者printenv命令可以查看系统全部的环境变量设置</li>
<li>修改系统配置文件以达到修改环境变量的目的

<ol>
<li>修改/etc/profile文件会影响使用本机的全部用户</li>
<li>修改~/.bashrc则仅仅影响当前用户</li>
</ol>
</li>
</ol>


<h2>Linux目录树标准与文件系统</h2>

<ol>
<li>文件层次标准（FHS）对Linux根文件系统的基本目录结构做了比较详细的规定

<ol>
<li>bin：基本命令的程序文件，里面不能再包含目录</li>
<li>boot：Bootloader静态文件</li>
<li>dev：设备文件</li>
<li>etc：系统配置文件，配置文件必须是静态文件，不能是二进制文件</li>
<li>home：存放各用户的个人数据</li>
<li>lib：基本的共享库和内核模块</li>
<li>media：可移动介质的挂载点</li>
<li>mnt：临时的文件系统挂载点</li>
<li>opt：附件的应用程序软件包</li>
<li>root：root用户目录</li>
<li>sbin：基本的系统命令二进制文件</li>
<li>srv：系统服务的一些数据</li>
<li>tmp：临时文件</li>
<li>usr

<ol>
<li>/usr/bin:众多的应用程序</li>
<li>/usr/sbin:超级用户的一些管理程序</li>
<li>/usr/doc:linux文档</li>
<li>/usr/lib:常用的动态链接库和软件包的配置文件</li>
<li>/usr/man:帮助文档</li>
<li>/usr/src:源代码</li>
<li>/usr/local/bin:本地增加的命令</li>
<li>/usr/local/lib:本地增加的库</li>
</ol>
</li>
<li>var：可变数据</li>
</ol>
</li>
<li>Linux下所有文件的描述结构都是相同的，包含索引节点和数据

<ol>
<li>索引节点：又称I节点，是Linux文件系统用来记录文件信息的一种数据结构，信息包括文件名、文件长度、文件权限、存放位置、所属关系、创建和修改时间。文件系统维护了一个索引节点的数组，每个文件都与索引节点数组中的唯一元素对应，索引节点在数组中的索引号称为索引节点号。每个文件都有一个索引号与之对应，而一个索引节点号可以对应多个文件。</li>
<li>数据：文件的实际内容，可以是空的，也可以非常大，并且拥有自己的结构</li>
</ol>
</li>
<li>Linux系统中，文件名以点号（.）开始的文件是隐藏文件，用ls命令不加-a将看不到这类文件</li>
<li>设备文件

<ol>
<li>设备是一种特殊的的文件，除了存放在文件I节点中的信息外，它们不包含任何数据，有效的设备文件与相应的设备对应，通过设备文件，可以操作与之对应的硬件设备</li>
<li>设备文件包括字符设备和块设备文件。字符设备按照字符操作设备，如键盘、中断等；块设备文件以块为单位操作设备，如磁盘、光盘等。Linux系统的设备文件都放在/dev目录下，用ls -la命令可以查看各设备的属性</li>
</ol>
</li>
<li>Linux支持多种文件系统，且同时存在于一个一个运行的系统中，查看/proc/filesystems文件，可以看到系统支持的全部文件系统</li>
<li>proc文件系统

<ol>
<li>proc是Linux系统中的一种特殊的文件系统，是内核和内核模块用来向进程发送消息的机制，只存在于内存中，实际上是一个伪文件系统。用户和应用程序可通过/proc获得系统的信息，还可以改变内核的某些参数。</li>
<li>/proc/cpuinfo：CPU信息</li>
<li>/proc/meminfo：物理内存，交换空间信息</li>
<li>/proc/mounts：已加载的文件系统列表</li>
<li>/proc/devices：可用设备的列表</li>
<li>/proc/filesystems：被支持的文件系统</li>
<li>/proc/modules：已加载的模块</li>
<li>/proc/version：内核版本</li>
<li>/proc/cmdline：系统启动时输入的内核命令行参数</li>
</ol>
</li>
<li>sysfs文件系统

<ol>
<li>sysfs是Linux2.6引入的新型文件系统是一个基于内存的文件系统，它的作用是将内核的信息以文件的方式提供给用户程序使用。该文件系统的目录层次结构严格按照内核的数据结构组织，除了二进制文件外，sysfs文件内容均以ASCII格式保存，且一个文件只保存一个数据，另外，一个文件不可大于一个内存页（通常为4096字节）</li>
<li>sysfs提供一种机制，使得可以显式地描述内核对象，对象属性及对象间关系。sysfs有两组接口，一组针对内核，用于将设备映射到文件系统中，另一组针对用户程序，用于读取或操作这些设备
<img src="http://i.imgur.com/yE7Xrtx.png" alt="sysfs内部结构与外部表现" /></li>
<li>sysfs产生了一个包含所有系统硬件的层次视图，把连接在系统上的设备和总线组织成为一个分级的文件，向用户空间导出内核数据结构和以及它们的属性。sysfs清晰地展示了设备驱动模型中各组件的关系，顶层目录包括block、device、bus、drivers、class、power和firmware等。各目录和所包含的内容如下
<img src="http://i.imgur.com/JjRYVxz.png" alt="sysfs目录结构" /></li>
</ol>
</li>
</ol>


<h2>vi的使用</h2>

<ol>
<li>从命令模式进入编辑模式：插入（i或者I），附件（a或者A），打开（o或者O）</li>
<li>光标移动：命令模式下，h（左），j（下），k（上），l（右）</li>
<li>快速光标定位：

<ol>
<li>命令G：将光标定位到最后一行</li>
<li>命令nG：将光标定位到第n行</li>
<li>命令gg：将光标定位到第1行</li>
<li>命令ngg：将光标定位到第n行</li>
<li>命令:n将光标定位到第n行</li>
</ol>
</li>
<li>文本块选定

<ol>
<li>将光标移动到将要选定的文本块开始处，按esc进入命令模式，再按v，进入可视状态，然后移动光标至文本块结尾，被选定的文本块高亮显示。连按两次esc可以取消所选定的文本块</li>
</ol>
</li>
<li>复制和粘贴

<ol>
<li>如果已经选定文本块，按y即可将所选定文本复制到缓冲区，将光标移到将要粘贴的地方，按p，就可完成文本粘贴</li>
<li>在命令模式下，连按yy，即可复制光标所在的行的内容，连按yny即可复制从光标所在行开始的n行</li>
</ol>
</li>
<li>剪切和删除

<ol>
<li>最后一次剪切和删除的内容都可以被粘贴到其他位置</li>
<li>x或nx：剪切从光标所在位置开始的一个或者n个字符</li>
<li>X或nX：剪切光标前的一个或n个字符</li>
<li>dd：删除光标所在行</li>
<li>D：删除光标位置开始至行尾</li>
<li>dw：删除从光标位置至该词末尾的所有字符</li>
<li>d0：删除从光标位置开始至行首</li>
<li>dnd：删除光标所在行开始的n行</li>
<li>dnG：将光标所在行至第n行删除</li>
</ol>
</li>
<li>文本查找

<ol>
<li>在命令模式下，输入“/字符串”即可从光标位置开始向下查找字符串。输入“？字符串”则从光标位置开始向上查找字符串。无论向上还是向下查找，查找下一个，按键盘n键即可</li>
<li>全局匹配搜索：先将光标移动到字符串abc，然后按下“SHIFT+*”，完成搜索。</li>
</ol>
</li>
<li>文本替换

<ol>
<li>在命令模式下，输入：%s /old/new/gc，能够将文本内全部的字符串old替换为new，为了安全起见，可以在替换命令尾部加上c，这样每次替换前都需要确认一下</li>
</ol>
</li>
<li>撤销和回复

<ol>
<li>在命令模式下输入u，可以撤销所做的更改，回复编辑前的状态，这里的编辑以保存命令为界。不小心多按了u时可以用Ctrl+R来恢复</li>
</ol>
</li>
<li>Vi的配置文件

<ol>
<li>在vi内执行的配置命令的效果是临时IDE，关闭vi，再次打开vi，需要重新配置。vi有自己的配置文件，可以是"/etc/vim/vimrc"或者"~/.vimrc"。两者的区别是前者是全局的，影响登陆本机的全部用户，后者仅仅对当前用户有效</li>
</ol>
</li>
<li>文本对比

<ol>
<li>Vim提供了文本对比工具vimdiff</li>
<li>用法：vimdiff file1 file2 file3</li>
<li>vimdiff可以同时进行2个以上文件的对比</li>
</ol>
</li>
</ol>


<h2>如何使全局环境变量生效</h2>

<ol>
<li>添加在/etc/profile中的全局变量生效的方法：. /etc/profile（点+空格+文件名）</li>
</ol>


<h2>MCIMX28x处理器（i.MX28X）</h2>

<ol>
<li>基于ARM926EJ-S内核，主频454MHz</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Matlab基础知识]]></title>
    <link href="http://suda-morris.github.io/blog/2015/11/11/matlab/"/>
    <updated>2015-11-11T22:45:49+08:00</updated>
    <id>http://suda-morris.github.io/blog/2015/11/11/matlab</id>
    <content type="html"><![CDATA[<h2>几个常用命令</h2>

<ol>
<li>help：查看某个命令的帮助文档</li>
<li>version：获得当前Matlab的版本</li>
<li>pwd：给出当前的工作目录名</li>
<li>dir：ls或dir列出当前目录下的所有文件名清单</li>
<li>cd：改变目录</li>
<li>what：列出当前工作目录下所有的M文件、MAT文件和MEX文件</li>
<li>who：列出当前工作空间里的变量名</li>
<li>clock：时钟设置命令</li>
<li>data：日期设置命令</li>
<li>path：显示MATLAB的当前搜索路径</li>
<li>getenv：getenv（‘matlabpath’）显示当前的MATLAB路径</li>
<li>diary on，diary off：利用diary可以记录MATLAB窗口中进行的所有操作</li>
<li>！（escape）：符号！是MATLAB的扩展运算符，通过该符号，用户有权使用DOS或UNIX命令</li>
<li>demo：该命令引导使用者通过菜单选择为数众多的演示程序</li>
<li>format：数据显示格式。系统默认的数据显示格式是5位</li>
<li>clear：清除工作空间中所有的变量</li>
<li>clear all：从工作空间中清除所有变量和函数</li>
<li>clf：清除图形窗口内容</li>
<li>delete&lt;文件名>：从磁盘中删除指定文件</li>
<li>load name：载入‘name’文件中的所有变量到工作空间</li>
<li>load name x y：载入‘name’文件中的变量x，y到工作空间</li>
<li>save name：保存工作空间变量到文件name.mat中</li>
<li>save name x y：保存工作空间变量x y到文件name.mat中</li>
<li>pack：整理工作空间内存</li>
<li>size：显示当前工作空间中变量的尺寸</li>
<li>length：显示当前工作空间中变量的长度</li>
<li>disp：显示当前工作空间中的变量</li>
</ol>


<h2>运算符</h2>

<ul>
<li>反除运算符：:该运算符得到商的倒数，即a\b等于b/a</li>
<li>不等于：~=</li>
<li>逻辑与：&amp;</li>
<li>逻辑或：|</li>
<li>逻辑非：~</li>
</ul>


<h2>变量名</h2>

<ol>
<li>区分大小写</li>
<li>长度不能超过31位</li>
<li>变量名以字母开头，可以是字母、数字、下划线组成</li>
</ol>


<h2>分支结构</h2>

<blockquote><p>if-else-end语句中的else子句是可选项
嵌套：if-elseif-elseif-&hellip;-else-end</p></blockquote>

<h2>循环结构</h2>

<blockquote><p>for-end
while-end；该语句中的循环判断语句为矩阵时，当且仅当所有的矩阵元素非零时，逻辑表达式的值为真
break；退出循环体，执行循环后的其他语句</p></blockquote>

<h2>数据输入与输出</h2>

<ol>
<li>input：通过键盘输入数据</li>
<li>fprintf：输出格式化信息和数字</li>
<li>disp：可以在命令窗口输出数字、向量、矩阵或字符串，无需变量名</li>
<li>sprintf：将输出写入字符串</li>
</ol>


<h2>数组</h2>

<ol>
<li>MATLAB中，行数组与行向量是同义语，列数组和列向量是同义语</li>
<li>对于加法和减法，数组运算与线性代数中的向量运算相同。但是符号.*和./分别被称为数组乘法运算符和数组除法运算符，它们不同于矩阵和向量乘除法。</li>
<li>计算数组长度：length（x）</li>
<li>删除数组元素：z（3）=[]</li>
<li>MATLAB里，二维数组变量等同于一个矩阵，每一行的元素以分号结束</li>
<li>二维数组的整行或整列可以用一个冒号表示。例如：m(1,:)和m(:,3)分别表示m的第一列和第三列</li>
<li>只有长度相同的向量才能在if语句中进行比较，如果将两个长度不同的向量进行比较，命令窗口会出现出错信息提示。在if语句中比较字符串之前一定要通过增加空格使字符串长度完全相同</li>
</ol>


<h2>MATLAB特有的数字特性</h2>

<blockquote><p>在MATLAB里，所有的变量均为双精度，整数变量和实数变量之间没有区别，实数变量和复数变量同样也没有区别</p></blockquote>

<h2>初等数学函数</h2>

<ul>
<li>sin(x)</li>
<li>cos(x)</li>
<li>tan(x)</li>
<li>asin(x)</li>
<li>acos(x)</li>
<li>atan(x):[-π/2,π/2]</li>
<li>atan2(y,x):与atan(y/x)结果相同，但是-π/2≥atan2(y,x)≥π</li>
<li>sinh(x)</li>
<li>cosh(x)</li>
<li>tanh(x)</li>
<li>asinh(x)</li>
<li>acosh(x)</li>
<li>atanh(x)</li>
<li>abs(x):x的绝对值</li>
<li>angle(x):复数x的相位角</li>
<li>sqrt(x):x的平方根</li>
<li>real(x)</li>
<li>imag(x)</li>
<li>conj(x):复数x的共轭数</li>
<li>round(x):向最近整数取整</li>
<li>fix(x):向0取整</li>
<li>floor(x):向-∞取整</li>
<li>ceil(x):向+∞取整</li>
<li>sign(x):如果x>0,则为+1；如果x&lt;0,则为-1</li>
<li>mod(x,y)：除后余数：x-y*fix(x/y)</li>
<li>rem(x,y):除后余数：x-y*fix(x/y).如果y≤0，则与mod不同</li>
<li>exp(x):以e为底的指数</li>
<li>log(x):以e为底的对数</li>
<li>log10(x):以10为底的对数</li>
<li>factor(x):将x分解质因数</li>
<li>isprime(x):如果x为素数，值为1，否则为0</li>
<li>factorial(x):x!</li>
</ul>


<h2>功能函数</h2>

<ol>
<li>sort(x):将x按照升序重新排列,如果x是矩阵，则重新排列按列进行</li>
<li>sum(x):如果是x是矩阵，返回值由矩阵各列元素和组成的一个行向量</li>
<li>max(x),min(x):如果x是矩阵，函数值为一个行向量，每个元素为矩阵相应列的最大或最小值</li>
<li>rand(n),返回一个nxn的矩阵，元素全是随机数。除非特别规定，否则所生成的是0~1之间均匀分布的随机数</li>
<li>eval：该命令可以作为字符串被编辑，然后用eval执行。字符串可以通过input读取，或在程序中创建</li>
</ol>


<h2>M文件</h2>

<ol>
<li>M文件可以分为脚本文件和函数文件两种</li>
<li>脚本文件操作对象为MATLAB工作空间内的变量，并且在脚本执行结束后，脚本中对变量的一切操作均会被保留。在MATLAB语言中也可以在脚本内部定义变量，并且该变量将会自动地被加入到当前的MATLAB工作空间中，并可以为其他的脚本或函数引用，直到MATLAB被关闭或采用一定的命令将其删除</li>
<li>MATLAB语言的函数文件包含5个部分：

<ol>
<li>函数题头：指函数的定义行，是函数语句的第一行，在该行中将定义函数名，输入变量列表以及输出变量列表等</li>
<li>HI行：指函数帮助文档的第一行</li>
<li>帮助信息</li>
<li>函数体</li>
<li>注释部分：注释语句是以%引导的</li>
</ol>
</li>
<li>echo on,echo off:M文件执行过程中，其命令语句通常不出现在屏幕上，但是当echo on命令将echo开启后，屏幕上会显示所有语句。这时，用户可以看到正在执行的那部分M文件。</li>
<li>开发函数M文件最基本且很有效的一个办法是将第一行的函数语句用%注释掉，然后作为一个命令M文件进行测试。测试通过后，再将函数语句恢复</li>
</ol>


<h2>保存和载入数据</h2>

<ol>
<li>save，load：如果直接使用save，则所有当前变量将被保存到默认文件matlab.mat里。load是与save相反的命令，它取回所有被save保存的变量。</li>
<li>save file_name data-ascii：save能以ASCII码格式保存数据。带有ASCII选项的save和load非常重要，因为他们可以从MATLAB导入和导出数据</li>
<li>自动创建文件名：在一个M文件中，常常需要自动创建一些文件名。如果整条命令连同文件名写为一个字符串，则可通过eval执行。</li>
</ol>


<h2>硬拷贝</h2>

<ul>
<li>使用diary命令制作一个屏幕内容的拷贝，如果其后不加任何文件名，屏幕内容将存入名为diary的文件中，此文件可以用文本方式打开。但是在diary文件里无法得到图形</li>
</ul>


<h2>Matlab中的默认常量</h2>

<ol>
<li>pi：圆周率</li>
<li>inf：无穷大</li>
<li>nan：不定值，即0/0</li>
<li>realmax：最大正实数</li>
<li>realmin：最小正实数</li>
<li>eps：浮点数的相对误差</li>
<li>i：虚数单位</li>
<li>nargin：函数实际输入参数个数</li>
<li>nargout：函数实际输出参数个数</li>
<li>ans：默认变量名</li>
</ol>


<h2>常用矩阵函数运算</h2>

<ol>
<li>rot90（）：矩阵逆时针旋转90°</li>
<li>flipud（）：矩阵上下翻转</li>
<li>fliplr（）：矩阵左右翻转</li>
<li>flipdim（）：矩阵的某维元素翻转</li>
<li>shiftdim（）：矩阵的元素移位</li>
<li>eig（）：计算矩阵的特征值和特征向量</li>
<li>rank（）：计算矩阵的秩</li>
<li>trace（）：计算矩阵的迹</li>
<li>norm（）：计算矩阵的范数</li>
<li>poly（）：计算矩阵的特征方程的根</li>
<li>svd（）：矩阵的奇异值分解</li>
<li>qr（）：矩阵的QR分解</li>
<li>chol（）：矩阵的Cholesky分解</li>
<li>schur（）：矩阵的Schur分解</li>
<li>lu（）：矩阵的LU分解</li>
</ol>


<h2>符号运算</h2>

<ol>
<li>syms 符号变量名1 符号变量名2 &hellip; 符号变量名n

<ol>
<li>用这种格式定义符号变量时不要在变量名上加字符串分界符，变量间用空格而不用逗号分隔</li>
</ol>
</li>
<li>含有符号对象的表达式称为符号表达式，建立符号表达式有以下3中方法：

<ol>
<li>利用单引号来生成符号表达式</li>
<li>用sym函数建立符号表达式</li>
<li>使用已经定义的符号变量组成符号表达式
<img src="http://i.imgur.com/sjfydxI.png" alt="符号表达式创建实例" /></li>
</ol>
</li>
<li>Matlab中，数值矩阵不能直接参与符号运算，必须先转化为符号矩阵

<ol>
<li>将数值矩阵转化为符号矩阵：sym（数值矩阵）</li>
<li>将符号矩阵转化为数值矩阵：numeric（A）</li>
</ol>
</li>
<li>关于符号矩阵的函数

<ol>
<li>transpose（S）：返回S矩阵的转置矩阵</li>
<li>determ（S）：返回S矩阵的行列式值</li>
<li>许多数值矩阵的函数，如diag，triu，tril，inv，det，rank，eig等也可直接应用于符号矩阵</li>
</ol>
</li>
<li>符号表达式的四则运算

<ol>
<li>factor（S）：对S分解因式，S是符号表达式或符号矩阵</li>
<li>expand（S）：对S进行展开，S是符号表达式或符号矩阵</li>
<li>collect（S，v）：对S按变量v合并同类项，S是符号表达式或符号矩阵</li>
<li>simplify（S）：应用函数规则对S进行简化</li>
<li>simple（S）：调用MATLAB的其他函数对表达式进行综合化简，并显示化简过程</li>
</ol>
</li>
<li>常用的符号运算

<ol>
<li>limit，求极限的符号函数，常用的格式：limit（F，x，a，‘right’）或limit（F，x，a，‘left’）。当自变量x从右侧或左侧逼近a时，函数F的极值</li>
<li>diff，求微分用的符号函数，常用格式：diff（f，x，n），表示f关于x求n阶导数</li>
<li>int，求积分用的符号函数，常用格式：int（f，r，x0，x1），f为所要积分的表达式，r为积分变量，若为定积分，则x0与x1为积分上下限</li>
<li>symsum，级数求和的符号函数，常用的格式：S=symsum（fk，k，k0，kn），其中fk为级数的通项，k为级数自变量，k0和kn为级数求和的起始项和终止项，且可设为inf</li>
<li>dsolve，求解常微分方程的符号函数，常用格式：dsolve（'eqnl',&lsquo;condition&rsquo;,&lsquo;var'）;该函数求解微分方程eqnl在初始条件condition下的特解。参数var描述方程中的自变量符号，省略时按默认原则处理，若没有给出初值条件condition，则求方程的通解
<img src="http://i.imgur.com/o1KV20Q.png" alt="极限和极值的符号运算实例" />
<img src="http://i.imgur.com/Hp0qYod.png" alt="微积分的符号运算实例" />
<img src="http://i.imgur.com/sHRwiap.png" alt="常微分方程符号运算实例" /></li>
</ol>
</li>
</ol>


<h2>图形绘制</h2>

<ol>
<li>ploy,绘制二维图形，常用格式：plot(x1,y,option1,x2,y2,option2,&hellip;)</li>
<li>plot3,绘制三维图形，常用格式：plot3(x1,y1,z1,option1,x2,y2,z2,option2,&hellip;)</li>
<li>mesh,绘制三维曲面，常用格式：mesh(X,Y,Z,C),参数X,Y,Z都为矩阵值，C表示网格曲面的颜色分布。mesh(x,y,Z,C),参数x，y为长度分别是n和m的向量值，而参数Z是维数为mxn的矩阵</li>
<li>surf，绘制三维阴影曲面，常用格式：surf(X,Y,Z,C),surf(x,y,Z,C)
<img src="http://i.imgur.com/pZGpcxE.png" alt="三维网格曲面图绘制应用实例" />
<img src="http://i.imgur.com/0hS4l6O.png" alt="绘图命令使用实例" /></li>
</ol>


<h2>MATLAB程序</h2>

<p><img src="http://i.imgur.com/xWXusd3.png" alt="MATLAB程序基本组成结构" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[UML-Knowledges]]></title>
    <link href="http://suda-morris.github.io/blog/2015/11/10/uml-knowledges/"/>
    <updated>2015-11-10T15:44:29+08:00</updated>
    <id>http://suda-morris.github.io/blog/2015/11/10/uml-knowledges</id>
    <content type="html"><![CDATA[<h2>StarUML 软件破解</h2>

<ol>
<li><a href="http://staruml.io">官网地址</a></li>
<li>该软件为跨平台的UML建模工具，采用NodeJs编写</li>
<li>破解：安装目录/www/license/node/LicenseManagerDomain.js文件修改为如下：</li>
</ol>


<figure class='code'><figcaption><span>LicenseManagerDomain.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">NodeRSA</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-rsa&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">PK</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">product</span><span class="p">,</span> <span class="nx">licenseKey</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">pk</span><span class="p">,</span> <span class="nx">decrypted</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;morris&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">product</span><span class="o">:</span> <span class="s2">&quot;StarUML&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">licenseType</span><span class="o">:</span> <span class="s2">&quot;vip&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">quantity</span><span class="o">:</span> <span class="s2">&quot;suda_morris.github.io&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">licenseKey</span><span class="o">:</span> <span class="s2">&quot;later equals never!&quot;</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>        <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">pk</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NodeRSA</span><span class="p">(</span><span class="nx">PK</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">decrypted</span> <span class="o">=</span> <span class="nx">pk</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span><span class="nx">licenseKey</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">terms</span> <span class="o">=</span> <span class="nx">decrypted</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">name</span> <span class="o">&amp;&amp;</span> <span class="nx">terms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="nx">product</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">product</span><span class="o">:</span> <span class="nx">product</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">licenseType</span><span class="o">:</span> <span class="nx">terms</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span class='line'>                <span class="nx">quantity</span><span class="o">:</span> <span class="nx">terms</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span class='line'>                <span class="nx">licenseKey</span><span class="o">:</span> <span class="nx">licenseKey</span>
</span><span class='line'>            <span class="p">};</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Initializes the domain with several commands.</span>
</span><span class='line'><span class="cm">     * @param {DomainManager} domainManager The DomainManager for the server</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">init</span><span class="p">(</span><span class="nx">domainManager</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">domainManager</span><span class="p">.</span><span class="nx">hasDomain</span><span class="p">(</span><span class="s2">&quot;LicenseManager&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">domainManager</span><span class="p">.</span><span class="nx">registerDomain</span><span class="p">(</span><span class="s2">&quot;LicenseManager&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">major</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">minor</span><span class="o">:</span> <span class="mi">1</span><span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nx">domainManager</span><span class="p">.</span><span class="nx">registerCommand</span><span class="p">(</span>
</span><span class='line'>            <span class="s2">&quot;LicenseManager&quot;</span><span class="p">,</span> <span class="c1">// domain name</span>
</span><span class='line'>            <span class="s2">&quot;validate&quot;</span><span class="p">,</span>       <span class="c1">// command name</span>
</span><span class='line'>            <span class="nx">validate</span><span class="p">,</span>         <span class="c1">// command handler function</span>
</span><span class='line'>            <span class="kc">false</span><span class="p">,</span>            <span class="c1">// this command is synchronous in Node (&quot;false&quot; means synchronous&quot;)</span>
</span><span class='line'>            <span class="s2">&quot;Validate License&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="p">[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;PK&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">description</span><span class="o">:</span> <span class="s2">&quot;PK&quot;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">description</span><span class="o">:</span> <span class="s2">&quot;name of license owner&quot;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;product&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">description</span><span class="o">:</span> <span class="s2">&quot;product name&quot;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;licenseKey&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">description</span><span class="o">:</span> <span class="s2">&quot;license key&quot;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="p">[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="c1">// return values</span>
</span><span class='line'>                    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">description</span><span class="o">:</span> <span class="s2">&quot;result&quot;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">exports</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="nx">init</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">}());</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>打开软件，，help->Enter License,随便输入用户名密码即可破解成功</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Review C++]]></title>
    <link href="http://suda-morris.github.io/blog/2015/11/09/c++Primer/"/>
    <updated>2015-11-09T18:08:50+08:00</updated>
    <id>http://suda-morris.github.io/blog/2015/11/09/c++Primer</id>
    <content type="html"><![CDATA[<h2>补码的好处</h2>

<ol>
<li>0的表示唯一</li>
<li>符号位可以直接参与运算</li>
</ol>


<h2>常用的I/O流类库操纵符</h2>

<ol>
<li>dec：数值数据采用十进制表示</li>
<li>hex：数值数据采用十六进制表示</li>
<li>oct： 数值数据采用八进制表示</li>
<li>ws：  提取空白符</li>
<li>endl：插入换行符，并刷新流</li>
<li>ends： 插入空字符</li>
<li>setsprecision(int)： 设置浮点数的小数位数（包括小数点）</li>
<li>setw(int)： 设置域宽</li>
</ol>


<h2>类型别名</h2>

<ol>
<li>typedef 已有类型名 新类型名</li>
<li>using 新类型名 = 已有类型名</li>
</ol>


<h2>auto类型与decltype类型</h2>

<ol>
<li>auto：编译器通过初始值自动推断变量的类型</li>
<li>decltype：定义一个变量与某一表达式的类型相同，但并不用该表达式初始化变量

<ol>
<li>decltype（i） j=2,表示j以2作为初始值，类型与i一致</li>
</ol>
</li>
</ol>


<h2>引用类型</h2>

<ol>
<li>引用（&amp;）是标识符的别名

<ol>
<li>int i；int &amp;ri = i；</li>
</ol>
</li>
<li>定义一个引用时，必须同时对它初始化，使它指向一个已存在的对象</li>
<li>一旦一个引用被初始化后，就不能改为指向其它对象</li>
</ol>


<h2>泛型编程</h2>

<ol>
<li>泛型编程是C++支持的另一种编程模式，指的是创建独立于类型的代码</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LCD]]></title>
    <link href="http://suda-morris.github.io/blog/2015/11/05/lcd/"/>
    <updated>2015-11-05T10:19:01+08:00</updated>
    <id>http://suda-morris.github.io/blog/2015/11/05/lcd</id>
    <content type="html"><![CDATA[<h2>TFTLCD驱动芯片</h2>

<ul>
<li>ILI9341、ILI9325、RM68042、RM68021、ILI9320、ILI9328、LGDP4531、SSD1289等</li>
</ul>


<h2>ILI9341</h2>

<ol>
<li>自带显存，其显存总大小为172800（240X320X18/8），即18位模式下（26万色）的显存量。在16位模式下，ILI9341采用RGB565格式存储颜色数据</li>
<li>ILI9341所有的指令都是8位的，高8位无效，且参数除了读写GRAM的时候是16位，其他操作参数都是8位的。这个和ILI9320等驱动器不一样</li>
<li>命令

<ol>
<li>0xD3，这个是读ID4指令，用于读取LCD控制器的ID，这可以用来判断所用的LCD驱动器是什么型号，这样就可以根据控制器的型号去执行对应驱动IC的初始化代码。0xD3指令后跟了4个参数，最后2个参数读出来是0x93和0x41</li>
<li>0x36，这个是存储访问控制指令，可以控制ILI9341存储器的读写方向。简单说木九十在连续写GRAM的时候，可以控制GRAM指针增长的方向，从而控制显示方式。0x36指令后面紧跟一个参数，用来设置GRAM自增方式</li>
<li>0x2A，这是列地址设置指令，在从左到右、从上到下的扫描方式（默认）下面，该指令用于设置横坐标（x坐标）。该指令带有4个参数，实际上是2个坐标值：SC和EC，即列地址的起始值和结束值，SC必须小于等于EC。一般在设置x坐标的时候，我们只需要带2个参数即可，也就是设置SC即可，因为EC没有变化，我们只需要设置一次即可（在初始化ILI9341的时候设置）</li>
<li>0x2B，是页地址设置指令，在从左到右、从上到下的扫描方式（默认）下面，该指令用于设置纵坐标（y坐标）</li>
<li>0x2C，该指令是写GRAM指令，在发送该指令之后，我们便可以网LCD的GRAM里面写入颜色数据了。该指令支持连续写。ILI9341在收到0x2C指令之后，数据有效位宽变为16位，我们可以连续写入LCD GRAM值，而GRAM的地址将根据MY/MX/MV设置的扫描方式进行自增。</li>
<li>0x2E，该指令是读GRAM指令，用于读取ILI9341的显存GRAM。ILI9341在收到该指令后，第一次输出的是dummy数据，也就是无效的数据，第二次开始读取到的才是有效的GRAM数据（从坐标SC、SP开始），输出规律为：每个颜色分量占8位，一次输出2个颜色分量。比如第一次输出的是R1G1，随后的规律为B1R2->G2B2->R3G3->B3R4->G4B4->R5G5&hellip;以此类推。</li>
</ol>
</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CMOS图像传感器OV7670]]></title>
    <link href="http://suda-morris.github.io/blog/2015/11/04/ov7670/"/>
    <updated>2015-11-04T20:19:43+08:00</updated>
    <id>http://suda-morris.github.io/blog/2015/11/04/ov7670</id>
    <content type="html"><![CDATA[<h2>OV7670简介</h2>

<ol>
<li>通过SCCB总线控制，可以输出整帧、子采样、取窗口等方式及各种分辨率的8位影响数据。VGA图像最高达到30帧/秒。用户可以完全控制图像质量、数据格式和传输方式</li>
<li>具有自动曝光控制、自动增益控制、自动白平衡，自动消除灯光条纹、自动黑电平校准等自动影像控制功能</li>
<li>支持VGA、GIF和从CIF到40X30的各种尺寸。</li>
<li>所有图像处理功能过程包括伽马曲线、白平衡、饱和度、色度等都可以通过SCCB接口编程。</li>
<li>OV7670 CMOS图像传感器通过减少或消除光学或电子缺陷（如固定图案噪声、拖尾、浮散等），提高图像质量，得到清晰的稳定的彩色图像</li>
<li>OV7670芯片内部有：感光阵列、模拟信号处理模块（包括自动增益和自动白平衡）、10位的ADC、测试图案发生器（八色彩条图案渐变至黑白色条图案）、数字信号处理器（控制由原始信号差值到RGB信号的过程，并控制边缘锐化、颜色空间转换等图像质量处理）、图像缩放模块（按照预先设置的要求输出数据格式）、时许发生模块（产生阵列控制和帧率、帧率的时序、自动曝光控制、输出外部时序）、数字视频端口、SCCB接口、LED和闪光灯输出控制电路等</li>
</ol>


<h2>OV7670参数</h2>

<ol>
<li>感光阵列：640*480</li>
<li>稳定工作温度0~50℃</li>
<li>输出格式：

<ol>
<li>YUV/YCbCr4:2:2</li>
<li>RGB565/555/444</li>
<li>GRB4:2:2</li>
<li>Raw RGB Data</li>
</ol>
</li>
<li>光学尺寸：1/6″</li>
<li>视场角：25°</li>
<li>最大帧率：VGA30 f/s</li>
</ol>


<h2>视频帧存储器AL422B简介</h2>

<ol>
<li>AL422B是一个存储容量为3Mb的视频帧存储器，能够配置为384KB（393，216）X8b FIFO，支持VGA、CCIR、NTSC、PAL和HDTV分辨率</li>
<li>具有独立的读写操作能力，读/写周期时间为20ns，访问时间为15ns，具有高速异步串行存取、输出使能控制、自行刷新数据等功能。</li>
<li>目前1帧图像信息通常包含640X480或者720X480字节。</li>
<li>操作过程：

<ol>
<li>初始化。上电后，分别给nWRST和nRRST各0.1ms的初始化脉冲，使AL422B初始化。</li>
<li>复位操作。通常，复位信号可在任何时候给出而不考虑nWE，nRE以及nOE的状态，但是它们仍然要参照时钟信号的输入情况，使它们满足建立时间和保持时间的要求。如果在禁止时钟周期内给给出复位信号，必须等到允许周期到来后才会执行复位操作。当nWRST和nRRST均为低电平时，数据的输入和输出均从地址0开始</li>
<li>写操作。当写使能信号nWE为低电平时，在WCK信号的上升沿，数据通过DI7~DI0写入寄存器，参照WCK的输入周期，写入的数据必须满足建立时间和保持时间的要求。当nWE为高电平时，写操作被禁止，写地址指针停在当前位置上；当nWE再次变为低电平时，写地址指针从当前位置继续开始</li>
<li>读操作。当读使能nRE和数据输出使能nOE均为低电平时，在RCK信号的上升沿，数据由DO7~DO0输出。当nRE为高电平时，读地址指针停在当前位置上；当nRE再次变为低电平时，读地址指针从当前位置开始。执行读操作时，nOE须为低电平，如nOE为高电平，则数据输出端均为高阻态，且读地址指针任然同步加1.nRE和nOE须参照RCK的输入周期，满足建立时间和保持时间的要求。</li>
</ol>
</li>
</ol>

]]></content>
  </entry>
  
</feed>
