
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>WenRis Blog</title>
	<meta name="author" content="suda-morris">

	
	<meta name="description" content="WenRis Blog">
	<meta name="keywords" content="C/C++,Python,Lua">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="WenRis Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//libs.baidu.com/jquery/1.9.1/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">WenRis Blog</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/blog/categories">Categories</a></li>
	<li><a href="/aboutme">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/blog/categories">Categories</a></li>
	<li><a href="/aboutme">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.baidu.com" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:suda-morris.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/Morris1106com" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/suda-morris" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.baidu.com" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:suda-morris.github.io">
	</form>
</nav>

</header>
	
		
	

	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/01/20/android/">
		
			Android</a>
	</h2>
	<div class="entry-content">
		<h2>Android系统架构图</h2>

<p><img src="http://i.imgur.com/fNWm4KQ.png" alt="Android系统架构" /></p>

<ol>
<li>应用程序框架

<ol>
<li>Activity Manager：管理各个应用程序生命周期以及通常的导航回退功能</li>
<li>Window Manager：管理所有的窗口程序</li>
<li>Content Provider：使得不同应用程序之间存取或者分享数据</li>
<li>View System：构建应用程序的基本组件</li>
<li>NotificationManager：使得应用程序可以在状态栏中显示自定义的提示信息</li>
<li>Package Manager：Android系统内的程序管理</li>
<li>TelephonyManager：管理所有的移动设备功能</li>
<li>Resource Manager：提供应用程序使用的各种非代码资源，如本地化字符串、图片、布局文件、颜色文件等</li>
<li>LocationManager：提供位置服务</li>
<li>XMPP Service：提供GoogleTalk服务</li>
</ol>
</li>
<li>系统运行库分成两个部分，分别是系统库和Android运行时。

<ol>
<li>系统库是应用程序框架的支撑，是连接应用程序框架层与Linux内核层的重要纽带。

<ol>
<li>Surface Manager：执行多个应用程序的时候，负责管理显示与存取操作间的互动，另外也负责2D绘图与3D绘图进行显示合成</li>
<li>Media Framework：多媒体库，基于PacketVideo OpenCore；支持多种常用的音频、视频格式录制和回放，编码格式包络MPEG4、MP3、H.264、AAC、ARM</li>
<li>SQLite：小型的关系型数据库引擎</li>
<li>OpenGL|ES：根据OpenGLES1.0API标准实现的3D绘图函数库</li>
<li>FreeType：提供点阵字与向量字的描绘与显示</li>
<li>WebKit：一套网页浏览器的软件引擎</li>
<li>SGL：底层的2D图形渲染引擎</li>
<li>SSL:在Android上通信过程中实现握手</li>
<li>Libc：从BSD继承来的标准C系统函数库，专门为基于embedded linux的设备定制</li>
</ol>
</li>
<li>Android运行时，程序在Android运行时中执行，其运行分为核心库和Dalvik虚拟机两部分

<ol>
<li>核心库：核心库提供了Java语言API中的大多数功能，同时也包含了Android的一些核心API，如android.os、android.net、android.media等等</li>
<li>Dalvik虚拟机：Android程序不同于J2ME程序，每个Android应用程序都有一个专有的进程，并且不是多个程序运行在一个虚拟机中，而是每个Android程序都有一个Dalvik虚拟机的实例，并在该实例中执行。Dalvik虚拟机是一种基于寄存爱的Java虚拟机，而不是传统的基于栈的虚拟机，并进行了内存资源使用的优化，以及支持多个虚拟机的特点。需要注意，不同于J2ME，Android程序在虚拟机中执行的并非编译后的字节码，而是通过转换工具dx将java字节码转换成dex格式的中间码</li>
</ol>
</li>
</ol>
</li>
</ol>


<h2>Adnroid UI基础</h2>

<ol>
<li>Android UI由View和ViewGroup组成，ViewGroup是不可见的，用于组织和排版View和ViewGroup。View显示用户内容，以及相应用户的操作。Android UI可以在code中生产，不过更加方便的方式是在Android的XML文件中定义UI</li>
<li>可以通过2种方式定义界面结构，一种是在XML中定义视图结构，另一种是在运行时动态创建视图结构，

<ol>
<li>通过XML定义视图结构，可以有效做到代码与界面的分离，并且提高界面的可读性。XML的文件西部包含一个root，可以是View或者ViewGroup。在节点下面增加子界面的方式来构造界面结构</li>
<li>在编译阶段，所有的XML layout文件都会编译到一个统一的View资源里面，在需要使用layout资源的时候，需要将资源加载到程序中，一般做法是在Activity.onCreate()中做加载的资源操作</li>
</ol>
</li>
<li>每一个View或者ViewGroup都有一个ID属性，该属性由class View定义。其定义语法为：android:id=&ldquo;@+id/my_button"。

<ol>
<li>@的意思是指示XML parser解析并且展开后面的内容，将其作为一个ID的资源</li>
<li>+的意思是指示这是一个新的ID，需要将其加到资源定义文件R.java中去。有一些系统自定的ID，如果引用这些系统自定的ID，则不需要加+号，但是要加上包的命名空间，其定义非语法为：android：id=“@android：id/empty”</li>
</ol>
</li>
<li>在XML文件中，通常使用layout_something来定义View在ViewGroup中的位置。ViewGroup类会实现一个嵌套类来扩展ViewGroup.LayoutParms。这个内嵌的子类会定义类型来指定字View的位置和大小。每个view group一般都会包含width和height参数，因此每个在其内部的view都需要定义这两个属性。一般不会将其指定为某一个宽度或者高度，一般写为相对的，这样可以保证适用于多种屏幕大小的设备。其中，wrap_content会根据内容的大小来调节大小。fill_parent，最大化达到父几点所允许的，在API level8后名字改为match_parent</li>
<li>View作为一个几何图形，具有4个属性对应于它所属的容器，分别是left，top，width和height，每个属性的单位是pixel。参考API文档，可以很多函数获取位置以及View的大小信息。getLeft()，getTop(),getRight(),getBottom()。获取的值一本都是相对应与父节点的位置和大小信息。Padding是内容与View空间直接的间隔。View并未提供Margin属性，该属性一般由ViewGroup设置</li>
<li>如果需要在界面上显示的内容是动态获取的话，可以使用Adapter和继承AdapterView的View来动态显示。Adapter是数据源和AdapterView之间的桥梁，由它从数据源获取数据，然后转换为一组实体，填充到View</li>
<li>可以简单的使用继承自AdapterView的View来绑定Adapter，来获取外部数据源的数据。Android也提供了一些继承自Adapter的子类用于处理不同的数据形式来建立View，下面是三种比较常见的Adapter：

<ol>
<li>ArrayAdapter，当数据源是一个数组的时候，可以使用这个Adapter，默认，ArrayAdapter在调用toString()后会为每个Item创建一个TextView</li>
<li>SimpleCursorAdapter，如果数据源是来自于游标的时候，使用这个Adapter。使用这个Adapter的时候，需要指定Cursor的哪个行，哪个列插入Layout的View</li>
</ol>
</li>
<li>可以通过实现AdapterView.OnItemClickListener接口来让AdapterView响应点击事件</li>
</ol>


<h2>Android开发中高效的数据结构</h2>

<ol>
<li>SimpleArrayMap与ArrayMap

<ol>
<li>实质上ArrayMap继承自SimpleArrayMap，主要是为了实现像HashMap一样的api方法，让习惯使用HashMap的开发者感觉不到差异，本质上是SimpleArrayMap+Map的再封装。一般来说使用这两个类来代替HashMap，因为它们比HashMap更加高效，也对内存进行了优化</li>
</ol>
</li>
<li>SparseArray与SparseArrayCompat和LongSparseArray

<ol>
<li>这3个类中，前2个基本上是同一类，只不过第二个类有removeAt方法，第三个是Long类型的。这3个类也是用来代替HashMap，只不过它们的键的类型是整形Integer或者Long类型，在实际开发中，如月份缩写的映射，或者进行文件缓存映射，viewHolder都特别适用</li>
</ol>
</li>
<li>AtomicFile

<ol>
<li>AtomicFile首先不是用来代替File的，而是作为File的辅助类存在，AtomicFile的作用是实现事务性原子操作，即文件读写必须完整，适合多线程中的文件读写操作</li>
</ol>
</li>
</ol>


<h2>Intent</h2>

<ol>
<li>Intent是不同组件中提供运行时绑定的对象。Intent代表一个应用“想去做什么事情”，你可以用它做各种各样的任务，不过大部分的时候他们被用来启动另一个Activity。</li>
<li>在Activity之间传递数据包Bundle</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">//发送端</span>
</span><span class='line'><span class="n">Bundle</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Bundle</span><span class="o">();</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span><span class="s">&quot;morris&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="s">&quot;age&quot;</span><span class="o">,</span><span class="mi">20</span><span class="o">);</span>
</span><span class='line'><span class="n">intent</span><span class="o">.</span><span class="na">putExtras</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'><span class="c1">//接收端</span>
</span><span class='line'><span class="n">Bundle</span> <span class="n">data</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getExtras</span><span class="o">();</span>
</span><span class='line'><span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">);</span>
</span><span class='line'><span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;age&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>在Activity之间传递值对象</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/*方法1，使用Java的序列化，效率比较低*/</span>
</span><span class='line'><span class="c1">//前提要求User类实现Serializable接口</span>
</span><span class='line'><span class="c1">//发送端</span>
</span><span class='line'><span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span><span class="k">new</span> <span class="nf">User</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span><span class="mi">20</span><span class="o">));</span>
</span><span class='line'><span class="c1">//接收端</span>
</span><span class='line'><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span><span class="n">intent</span><span class="o">.</span><span class="na">getSerializableExtra</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*方法2，使用Android的Parcelable，效率比较高*/</span>
</span><span class='line'><span class="c1">//前提要求User类实现了Parcelable接口,并且重写了writeToParcel方法来手动实现序列化</span>
</span><span class='line'><span class="c1">//在User类中实现方法</span>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeToParcel</span><span class="o">(</span><span class="n">Parcel</span> <span class="n">dest</span><span class="o">,</span><span class="kt">int</span> <span class="n">flags</span><span class="o">){</span>
</span><span class='line'>  <span class="n">dest</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">getName</span><span class="o">());</span>
</span><span class='line'>  <span class="n">dest</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">getAge</span><span class="o">());</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c1">//在User类中实现常量对象CREATOR</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Creator</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">CREATOR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CREATOR</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(){</span>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">User</span> <span class="nf">createFromParcel</span><span class="o">(</span><span class="n">Parcel</span> <span class="n">source</span><span class="o">){</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">User</span><span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">readString</span><span class="o">(),</span><span class="n">source</span><span class="o">.</span><span class="na">readInt</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">User</span><span class="o">[]</span> <span class="nf">newArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">){</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="n">User</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c1">//发送端</span>
</span><span class='line'><span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span><span class="k">new</span> <span class="nf">User</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span><span class="mi">20</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//接收端</span>
</span><span class='line'><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>获取Activity的返回参数</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">//发送端</span>
</span><span class='line'><span class="n">startActivityForResult</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span><span class="n">requestCode</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onActivityResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span><span class="n">Intent</span> <span class="n">data</span><span class="o">){</span>
</span><span class='line'>  <span class="kd">super</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span><span class="n">resultCode</span><span class="o">,</span><span class="n">data</span><span class="o">);</span>
</span><span class='line'>  <span class="c1">//ToDo</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c1">//接收端</span>
</span><span class='line'><span class="n">setResult</span><span class="o">(</span><span class="n">resultCode</span><span class="o">,</span><span class="n">intent</span><span class="o">);</span>
</span><span class='line'><span class="n">finish</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>隐式Intent

<ol>
<li>在AndroidManifest文件中，为activity添加<intent-filter>标签，并为其指名category和action</li>
</ol>
</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;</span><span class="n">category</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.intent.category.DEFAULT&quot;</span><span class="o">/&gt;</span> <span class="c1">//表示该intent-filter的行为方式是activity</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">action</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;字符串A&quot;</span><span class="o">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>2. 然后在创建Intent实例的时候把“字符串A”传入构造函数
3. 一般来说，字符串A约定的格式为：包名.intent.action.类名
4. 通过这种方式能够访问其他应用中的activity，但是如果在activity的标签中指名`android:exported="false"`的话，别的应用便无法访问该activity
</code></pre>

<h2>Activity的启动模式</h2>

<ol>
<li>在AndroidManifest文件中，为activity添加参数：android:lanuchMode=&ldquo;standard"。在standard启动模式中，所有实例放入同一个任务栈，因此支持后退键导航</li>
<li>在AndroidManifest文件中，为activity添加参数：android:lanuchMode=&ldquo;singleTop"。singleTop模式和standard模式都会将intent发送给新的实例，不过，singleTop要求如果创建intent的时候栈顶已经有了要创建的Activity的实例，则将intent发送给该实例，而不创建新的实例。singleTop模式，可用来解决栈顶多个重复相同的Activity的问题。如果是A activity跳转到B activity，在跳转到A activity，行为就和standard模式一样了，会在B activity跳转到A activity的时候创建A activity的新实例，因为当时的栈顶不是A activity实例。</li>
<li>在AndroidManifest文件中，为activity添加参数：android:lanuchMode=&ldquo;singleTask"。当intent到来，需要穿件singleTask模式Activity的时候，系统会检查任务栈里面是否已经有该Activity的实例，如果有直接将intent发送给它。</li>
<li>在AndroidManifest文件中，为activity添加参数：android:lanuchMode=&ldquo;singleInstance"。<strong>一个任务栈只包括一个activity</strong>。比如有A，B，C三个Activity，其中B为sigleInstance模式，他们之间的跳转关系是A->B->C，现在在C中按下返回键，由于B位于独立的task中，它不属于C的上下文activity，所以此时直接返回到A中。</li>
</ol>


<h2>Get a string resource from you app&rsquo;s Resources</h2>

<blockquote><p>String hello = getResources().getString(R.string.hello_world);</p></blockquote>

<h2>Toast使用方法</h2>

<blockquote><p>Toast.makeText(activity对象，“显示内容”，Toast.LENGTH_SHORT).show();</p></blockquote>

<h2>适配不同的屏幕</h2>

<ol>
<li>安卓设备的屏幕的分类指标：大小(size)和分辨率(density)</li>
<li>有四种size：small，normal，large，xlarge</li>
<li>有四种density：low（ldpi），medium（mdpi），high（hdpi），extra high（xhdpi）</li>
<li>每份图片需要四种分辨率的备份，比如，如果你为xhdpi设备生成一张200X200的照片，同样，你需要为hdpi设备生成150X150的照片，为mdpi设备生成100X100的照片，为ldpi设备生成75X75的照片

<ol>
<li>xhdpi：2.0</li>
<li>hdpi：1.5</li>
<li>mdpi：1.0（baseline）</li>
<li>ldpi：0.75</li>
</ol>
</li>
<li>一般来说，ldpi的素材是可以不需要的，因为如果你提供了hdpi的素材，系统会自动将它缩小一半来适应ldpi的设备</li>
</ol>


<h2>Activity的生命周期</h2>

<p><img src="http://i.imgur.com/gzlBPwv.png" alt="Activity生命周期" /></p>

<ol>
<li>onPause主要完成的工作（为了快速切换到下一个Activity，这个函数里面的操作内容应该尽量简单些）

<ol>
<li>停止动画或者其他正在消耗CPU的动作</li>
<li>提交未保存的变化，比如草稿邮件</li>
<li>释放系统资源，包括broadcast receiver，传感器句柄等</li>
</ol>
</li>
<li>onStop函数用来执行占用CPU大的shut-down操作，比如往数据库中写入数据</li>
</ol>


<h2>Context</h2>

<ol>
<li>它是用来访问全局信息（比如，应用程序的资源）的接口，一些常用的资源都会实现Context，这样就可以方便访问资源</li>
<li>System.out.println(R.string.hello_world)等同于System.out.println(getContext().getResources().getText(R.string.hello_world));</li>
</ol>


<h2>Application</h2>

<ol>
<li>安装一个app应用后可以在桌面上显示多个应用图标(即同一个应用程序有多个主Activity)，那是因为在Manifest文件中设置了多个activity的category为android.intent.category.LAUNCHER，action为android.intent.category.LAUNCHER。但是这几个应用同属于一个Application，表现为在Manifest文件中，这些activity在同一个application标签下。</li>
<li>在Manifest文件中，为application标签设置属性name,其值为一个继承自Application的某个自定义类，这样在任意一个activity中可以通过getApplicationContext来获取该自定义Application类的实例。从某种意义上来说，该自定义Appliacation类中的资源可以更加方便的为全局共享，里面可以存放一些全局的逻辑资源（区别于UI的资源）</li>
<li>Application的生命周期相关的方法

<ol>
<li>onCreate，创建Application的时候调用，先于activity的onCreate</li>
<li>onTerminate，结束后调用</li>
<li>onLowMemory，低内存时候调用</li>
<li>onTrimMemory，操作系统内存整理的时候调用</li>
<li>onConfigurationChanged，配置改变的时候调用</li>
</ol>
</li>
</ol>


<h2>Service</h2>

<ol>
<li>启动服务：startService，service内部会执行onStartCommand</li>
<li>停止服务：stopService</li>
<li>绑定服务：bindService</li>
<li>解绑服务：unbindService</li>
<li>当activity与service绑定后，如果activity退出，响应的service也会停止。即service的生命周期伴随着activity的存在于消亡。若是是使用startService来启动service的话，service的生命将会独立于activity，只有通过调用stopService才能将其停止。当startService与bindService都调用了的话，若想退出服务，unbindService与stopService都必须执行</li>
<li>同一个service只会创建1次</li>
</ol>


<h2>普通辅线程不允许修改UI线程中的资源！</h2>

<h2>AIDL(Android Interface Definition Language)</h2>

<ol>
<li></li>
</ol>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-01-20T18:01:40+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/develop/'>develop</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/01/20/jetbrains/">
		
			Jetbrains</a>
	</h2>
	<div class="entry-content">
		<h2>如何破解DataGrid</h2>

<blockquote><p>启动，在要求输出注册码的界面选<code>License server</code>输入<code>http://idea.lanyus.com/</code>，点击OK，快速激活</p></blockquote>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-01-20T11:27:47+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/software/'>software</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/01/19/android-studio/">
		
			Android_Studio</a>
	</h2>
	<div class="entry-content">
		<h2>最新安装的Android Studio打开软件特别慢，总是卡在“Fetching Android SDK component information”，如何解决？</h2>

<ol>
<li>进入Android Studio的安装目录下的bin目录，找到idea.properties文件，用文本编辑器打开</li>
<li>在idea.properties文件末尾天剑一行：disable.android.first.run=true,然后保存文件</li>
<li>关闭Android Studio后重新启动</li>
</ol>


<h2>给Android Studio安装Genymotion插件</h2>

<ol>
<li>File->Settings</li>
<li>找到plugins设置项，点击Browser，输入：genymotion关键字，安装相应插件</li>
<li>重启android studio后，点击Genymotion插件的图标，设置Genymotion在本地的路径，完成后就告成</li>
</ol>


<h2>设置自动导入依赖包</h2>

<ol>
<li>File->Settings->Editor</li>
<li>找到Auto Import选项，使能：show import popup，Optimize imports on the fly，Add unambiguous imports on the fly</li>
</ol>


<h2>常用功能</h2>

<ol>
<li>Gradle同步，在项目运行或者更改Gradle配置的时候都要点击下这个按钮，会下载相应的依赖</li>
<li>AVD Manager，模拟器管理</li>
<li>SDK Manager，管理SDK版本</li>
<li>DDMS即Dalvik Debug Monitor Service，Dalvik调试监控服务</li>
</ol>


<h2>Gradle</h2>

<ol>
<li>Gradle是一种依赖管理工具，基于Groovy语言，面向Java应用为主，它抛弃了基于XML的各种繁琐配置，而取而代之的是一种基于Groovy的内部领域特定（DSL）语言</li>
<li>Android Studio中新建项目成功后会自动下载Gradle，Windows下回安装到：C:\Documents and Settings\&lt;用户名>.gradle\wrapper\dists 目录</li>
<li>命令行Gradle编译过程

<ol>
<li>切换到项目根目录，执行./gradlew -v来查看项目所用的Gradle版本，如果是第一次执行，将会去下载Gradle</li>
<li>接着执行./gradlew clean，清除项目根目录/app目录下的build文件夹</li>
<li>最后执行./gradlew build,检查依赖，直接编译生成相应的apk文件。接着在项目根目录/app/build/outputs/apk目录下会看到类似于app-debug-unaligned.apk，app-release-unsigned.apk等，unaligned代表没有进行zip优化的，unsigned代表没有签名的。</li>
<li>gradlew build命令吧debug、release环境的包都打出来，如果正式发布只需要打Release的包，就需要这样使用：

<ol>
<li>./gradlew assembleDebug编译并打Debug包</li>
<li>./gradlew assembleRelease编译并打Release包</li>
</ol>
</li>
<li>除此以外，assemble除了能和BuildType结合外还能和ProductFlavor结合，实质上，assemble是和Build Variants一起结合使用的，而Build Variants=Build Type + Product Flavor，例如如果想打包豌豆荚渠道的release版本，执行如下命令：<code>./gradle assembleWandoujiaRelease</code>,如果只打豌豆荚渠道的版本，则：<code>./gradle assembleWandoujia</code></li>
</ol>
</li>
<li>与Gradle相关的几个文件

<ol>
<li>项目根目录/app/build.gradle,这个文件是app文件下下这个Module的gradle配置文件，在里面会指明要编译成安卓的应用程序（com.android.application）还是库（com.android.library）；指明编译SDK的版本，build tools的版本（根据实际开发者已经下载好的版本来修改），指明应用的包名，支持的最小的SDK版本，目标SDK版本，要编译在lib目录下的哪些jar包。</li>
<li>项目根目录/build.gradle，这个文件是整个项目的基础配置文件，内容主要包括两个方面，一个是声明仓库的源，一般是jcenter，jcenter可以理解成是一个新的中央远程仓库，兼容maven中心仓库，而且性能更优。另一个是声明了android gradle plugin的版本</li>
<li>项目根目录/settings.gradle，这个文件是全局的项目配置文件，里面主要声明一些需要加入gradle的module，例如：<code>include ':app', ':extras:ShimmerAndroid'</code>,文件中的app，extra：ShimmerAndroid都是module，如果还有其他module都需要按照如上格式加进去</li>
</ol>
</li>
<li>完整的gradle脚本</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">apply</span> <span class="nl">plugin</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="n">android</span><span class="p">.</span><span class="n">application</span><span class="err">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">def</span> <span class="n">releaseTime</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">new</span> <span class="n">Date</span><span class="p">().</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;yyyy-MM-dd&quot;</span><span class="p">,</span> <span class="n">TimeZone</span><span class="p">.</span><span class="n">getTimeZone</span><span class="p">(</span><span class="s">&quot;UTC&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">android</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">compileSdkVersion</span> <span class="mi">21</span>
</span><span class='line'>    <span class="n">buildToolsVersion</span> <span class="err">&#39;</span><span class="mf">21.1.2</span><span class="err">&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">defaultConfig</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">applicationId</span> <span class="s">&quot;com.boohee.*&quot;</span>
</span><span class='line'>        <span class="n">minSdkVersion</span> <span class="mi">14</span>
</span><span class='line'>        <span class="n">targetSdkVersion</span> <span class="mi">21</span>
</span><span class='line'>        <span class="n">versionCode</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">versionName</span> <span class="s">&quot;1.0&quot;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// dex突破65535的限制</span>
</span><span class='line'>        <span class="n">multiDexEnabled</span> <span class="nb">true</span>
</span><span class='line'>        <span class="c1">// 默认是umeng的渠道</span>
</span><span class='line'>        <span class="n">manifestPlaceholders</span> <span class="o">=</span> <span class="p">[</span><span class="nl">UMENG_CHANNEL_VALUE</span><span class="p">:</span> <span class="s">&quot;umeng&quot;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">lintOptions</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">abortOnError</span> <span class="nb">false</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">signingConfigs</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// No debug config</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">release</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">storeFile</span> <span class="n">file</span><span class="p">(</span><span class="s">&quot;../yourapp.keystore&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="n">storePassword</span> <span class="s">&quot;your password&quot;</span>
</span><span class='line'>            <span class="n">keyAlias</span> <span class="s">&quot;your alias&quot;</span>
</span><span class='line'>            <span class="n">keyPassword</span> <span class="s">&quot;your password&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">buildTypes</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 显示Log</span>
</span><span class='line'>            <span class="n">buildConfigField</span> <span class="s">&quot;boolean&quot;</span><span class="p">,</span> <span class="s">&quot;LOG_DEBUG&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">versionNameSuffix</span> <span class="s">&quot;-debug&quot;</span>
</span><span class='line'>            <span class="n">minifyEnabled</span> <span class="nb">false</span>
</span><span class='line'>            <span class="n">zipAlignEnabled</span> <span class="nb">false</span>
</span><span class='line'>            <span class="n">shrinkResources</span> <span class="nb">false</span>
</span><span class='line'>            <span class="n">signingConfig</span> <span class="n">signingConfigs</span><span class="p">.</span><span class="n">debug</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">release</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 不显示Log</span>
</span><span class='line'>            <span class="n">buildConfigField</span> <span class="s">&quot;boolean&quot;</span><span class="p">,</span> <span class="s">&quot;LOG_DEBUG&quot;</span><span class="p">,</span> <span class="s">&quot;false&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">minifyEnabled</span> <span class="nb">true</span>
</span><span class='line'>            <span class="n">zipAlignEnabled</span> <span class="nb">true</span>
</span><span class='line'>            <span class="c1">// 移除无用的resource文件</span>
</span><span class='line'>            <span class="n">shrinkResources</span> <span class="nb">true</span>
</span><span class='line'>            <span class="n">proguardFiles</span> <span class="n">getDefaultProguardFile</span><span class="p">(</span><span class="err">&#39;</span><span class="n">proguard</span><span class="o">-</span><span class="n">android</span><span class="p">.</span><span class="n">txt</span><span class="err">&#39;</span><span class="p">),</span> <span class="err">&#39;</span><span class="n">proguard</span><span class="o">-</span><span class="n">rules</span><span class="p">.</span><span class="n">pro</span><span class="err">&#39;</span>
</span><span class='line'>            <span class="n">signingConfig</span> <span class="n">signingConfigs</span><span class="p">.</span><span class="n">release</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">applicationVariants</span><span class="p">.</span><span class="n">all</span> <span class="p">{</span> <span class="n">variant</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="n">variant</span><span class="p">.</span><span class="n">outputs</span><span class="p">.</span><span class="n">each</span> <span class="p">{</span> <span class="n">output</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="n">def</span> <span class="n">outputFile</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">outputFile</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="n">outputFile</span> <span class="o">!=</span> <span class="n">null</span> <span class="o">&amp;&amp;</span> <span class="n">outputFile</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">endsWith</span><span class="p">(</span><span class="err">&#39;</span><span class="p">.</span><span class="n">apk</span><span class="err">&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                        <span class="c1">// 输出apk名称为boohee_v1.0_2015-01-15_wandoujia.apk</span>
</span><span class='line'>                        <span class="n">def</span> <span class="n">fileName</span> <span class="o">=</span> <span class="s">&quot;boohee_v${defaultConfig.versionName}_${releaseTime()}_${variant.productFlavors[0].name}.apk&quot;</span>
</span><span class='line'>                        <span class="n">output</span><span class="p">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">new</span> <span class="n">File</span><span class="p">(</span><span class="n">outputFile</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 友盟多渠道打包</span>
</span><span class='line'>    <span class="n">productFlavors</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">wandoujia</span> <span class="p">{}</span>
</span><span class='line'>        <span class="n">_360</span> <span class="p">{}</span>
</span><span class='line'>        <span class="n">baidu</span> <span class="p">{}</span>
</span><span class='line'>        <span class="n">xiaomi</span> <span class="p">{}</span>
</span><span class='line'>        <span class="n">tencent</span> <span class="p">{}</span>
</span><span class='line'>        <span class="n">taobao</span> <span class="p">{}</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">productFlavors</span><span class="p">.</span><span class="n">all</span> <span class="p">{</span> <span class="n">flavor</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="n">flavor</span><span class="p">.</span><span class="n">manifestPlaceholders</span> <span class="o">=</span> <span class="p">[</span><span class="nl">UMENG_CHANNEL_VALUE</span><span class="p">:</span> <span class="n">name</span><span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">dependencies</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">compile</span> <span class="n">fileTree</span><span class="p">(</span><span class="nl">dir</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">libs</span><span class="err">&#39;</span><span class="p">,</span> <span class="nl">include</span><span class="p">:</span> <span class="p">[</span><span class="err">&#39;</span><span class="o">*</span><span class="p">.</span><span class="n">jar</span><span class="err">&#39;</span><span class="p">])</span>
</span><span class='line'>    <span class="n">compile</span> <span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="n">android</span><span class="p">.</span><span class="nl">support</span><span class="p">:</span><span class="n">support</span><span class="o">-</span><span class="nl">v4</span><span class="p">:</span><span class="mf">21.0.3</span><span class="err">&#39;</span>
</span><span class='line'>    <span class="n">compile</span> <span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="nl">jakewharton</span><span class="p">:</span><span class="nl">butterknife</span><span class="p">:</span><span class="mf">6.0.0</span><span class="err">&#39;</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-01-19T10:06:41+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/software/'>software</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/01/11/nrf51822/">
		
			nRF51822</a>
	</h2>
	<div class="entry-content">
		<h2>nRF51822介绍</h2>

<p><img src="http://i.imgur.com/W7Ksvm4.jpg" alt="nRF51822引脚图" /></p>

<ol>
<li>通信距离30m（条件:空旷区域/1M速率）</li>
<li>工作频段：2.4GHz</li>
<li>工作电压：2.0V~3.6V</li>
<li>nRF51822整合了Nordic一流的无线传送器，同时支持BLE和专用的2.4GHz蓝牙协议栈</li>
<li>基本情况：

<ol>
<li>2.4GHz多协议无线射频</li>
<li>32位ARM CortexM0 处理器</li>
<li>128位AES硬件加密处理器</li>
<li>256KB Flash，32KB RAM(最新的QF AC版本)</li>
<li>可编程外设接口PPI</li>
<li>全功能数字接口：SPI、I2C、UART</li>
<li>10位ADC</li>
<li>可编程的输出功率+4dBm到-20dBm</li>
<li>应用开发和协议栈完全独立</li>
<li>固定的系统时钟：16MHz</li>
</ol>
</li>
<li>参考资料：

<ol>
<li><a href="http://infocenter.nordicsemi.com/index.jsp">参考文档</a></li>
<li><a href="https://devzone.nordicsemi.com/questions/">官方论坛</a></li>
<li><a href="http://www.qfv8.com/forum.php">青风电子社区</a></li>
</ol>
</li>
<li>与新版芯片的各种版本搭配：

<ol>
<li>QFN48封装</li>
<li>HWID=0084</li>
<li>Rev：3</li>
<li>nRF51 SDK:10.0.0</li>
<li>software device:S130-1.0.0</li>
<li>software device specification:S130-1.0</li>
<li>Qualified Design ID（QD ID）=68915（for S130 v1.0.0）</li>
</ol>
</li>
</ol>


<h2>工程配置</h2>

<p><img src="http://i.imgur.com/tVItFZn.png" alt="工程配置-Target" />
<img src="http://i.imgur.com/MTbnCdA.png" alt="工程配置-Linker" />
<img src="http://i.imgur.com/HtCEJLi.png" alt="工程配置-Debug" />
<img src="http://i.imgur.com/WPiTpWa.png" alt="工程配置-Download" /></p>

<h2>Bluetooth</h2>

<ol>
<li>蓝牙4.0提出了“低功耗蓝牙”、“经典蓝牙”和“高速蓝牙”三种模式。其中，高速蓝牙主攻数据交换与传输；经典蓝牙则以信息沟通、设备连接为重点；蓝牙低功耗以不需占用太多带宽的设备连接为主。</li>
<li>Bluetooth SmartReady与Bluetooth Smart

<ol>
<li>Bluetooth SmartReady设备包括智能电话、平板电脑、PC、智能电视这些在用户周边设备中充当中心并且要求Bluetooth v4.0 dual-mode通讯的智能设备</li>
<li>Bluetooth Smart设备时传感器类型的设备，比如心率计、电子计步器这种以电池并用来收集特定信息的设备，通常他们只需要single-mode low energy Bluetooth v4.0通讯
<img src="http://i.imgur.com/P9w7f76.png" alt="Bluetooth设备分类" /></li>
</ol>
</li>
<li>Bluetooth4.0低功耗模式由双模和单模两种应用。双模应用中，蓝牙低功耗功能集成在现有的经典蓝牙控制器中，或在现有经典蓝牙技术的芯片上增加低功耗堆栈，整体架构基本不变，因此成本增加有限。单模应用面向高度集成、紧凑的设备，具备轻量级链路层，支持超低功耗的待机模式操作、简单设备恢复、可靠的点对点数据传输、安全的加密连接等；而链路层则适用于网络互连传感器，并确保在无线传输中，皆能通过蓝牙低功耗传输。单模式蓝牙低功耗设备与现有蓝牙设备不能兼容，无法向下兼容，仅能支持BLE技术；而双模式芯片可同时支持蓝牙低功耗和传统蓝牙技术。一般而言，手机和个人电脑等设备将会安装双模式芯片，以便于蓝牙低功耗设备已传统蓝牙进行互操作。</li>
</ol>


<h2>SoftDevice</h2>

<ol>
<li>S110和S120由于协议栈大小有区别，因此在内部ROM和RAM分配的空间是有区别的。如下图：
<img src="http://i.imgur.com/JUv2wQy.png" alt="芯片内部资源分配" /></li>
<li>应用程序的向量表地址，取决于芯片是否已下载了SoftDevice，SoftDevice的下载地址从0x0开始，应用程序的向量表必须紧跟在SoftDevice之后，应用程序可以使用除去SoftDevice空间之外的Flash空间。相应的，SoftDevice数据区从最低的RAM地址开始，应用程序的数据区要跟在SoftDevice的数据区域后面布置</li>
<li>如果芯片烧写了SoftDevice，那么用户应用程序和SoftDevice共享同一个call stack（堆栈），应用程序必须保证call stack有足够的空间给自己和SoftDevice，SoftDevice的call stack空间需求跟不同的设备和不同的协议版本都有关系。用户应用程序应该把call stack的大小设置为它本身的需求加上SoftDevice的需求，然后设置堆栈指针（stack pointer）到应用程序的复位向量（Reset Vector）的首地址。</li>
<li>为了保证SoftDevice的正确性，微处理器包含了一个MPU（Memory Protection Unit），它可以防止对特定区域的访问，debugger读取这些区域将会返回0x0000。被SoftDevice占用的空间将禁止write和erase，使能SoftDevice后，MPU将会对协议栈进行写保护。为了避免单步调式保护区域，请在SVC calls后面设置断点，然后直接运行到该断点，也可以使用“step over”方法跳过SVC calls。</li>
</ol>


<h2>GPIO</h2>

<ol>
<li>在使用GPIO的input功能之前，需要将input buffer连接上，不使用的时候可以断开，这样可以一定程度上省电</li>
<li>GPIO pin的上下拉电阻使用标准的13KΩ的内部电阻</li>
<li>GPIO pin的驱动强度，标准情况下是0.5mA，高驱动能力下为5mA</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cm">/*****************************************************/</span>
</span><span class='line'><span class="cp">#define LED_PORT     NRF_GPIO_PORT_SELECT_PORT2</span>
</span><span class='line'><span class="cp">#define LED_NUMBER       5</span>
</span><span class='line'><span class="cp">#define LED_OFFSET       2</span>
</span><span class='line'><span class="cp">#define LED_START        18</span>
</span><span class='line'><span class="cp">#define LED0         18</span>
</span><span class='line'><span class="cp">#define LED1         19</span>
</span><span class='line'><span class="cp">#define LED2         20</span>
</span><span class='line'><span class="cp">#define LED3         21</span>
</span><span class='line'><span class="cp">#define LED4         22</span>
</span><span class='line'><span class="cp">#define LED_END          22</span>
</span><span class='line'><span class="k">extern</span> <span class="kt">void</span> <span class="nf">platform_led_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'><span class="cm">/****************************************************/</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">platform_led_init</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">nrf_gpio_range_cfg_output</span><span class="p">(</span><span class="n">LED_START</span><span class="p">,</span><span class="n">LED_END</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cm">/****************************************************/</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">SEGGER_RTT_printf</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;***Welcome to nRF51822***</span><span class="se">\r\n</span><span class="s">***System Clock=%dHz***</span><span class="se">\r\n</span><span class="s">Press </span><span class="se">\&#39;</span><span class="s">y</span><span class="se">\&#39;</span><span class="s"> to begin</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">SystemCoreClock</span><span class="p">);</span>
</span><span class='line'>  <span class="k">while</span><span class="p">(</span><span class="sc">&#39;y&#39;</span> <span class="o">!=</span> <span class="n">SEGGER_RTT_WaitKey</span><span class="p">());</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">platform_led_init</span><span class="p">();</span>
</span><span class='line'>  <span class="kt">uint8_t</span> <span class="n">led_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span><span class='line'>      <span class="n">nrf_gpio_port_write</span><span class="p">(</span><span class="n">LED_PORT</span><span class="p">,</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">led_status</span><span class="o">+</span><span class="n">LED_OFFSET</span><span class="p">));</span>
</span><span class='line'>      <span class="n">led_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">led_status</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">LED_NUMBER</span><span class="p">;</span>
</span><span class='line'>      <span class="n">nrf_delay_ms</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Power</h2>

<ol>
<li>实际中如果供电电压在1.75-1.95的时候，可以旁路内部的DC/DC转换器，直接使用内部的LDO，此时电源电压不高，在LDO上产生的功耗比较小，不会对整机功耗产生多达影响。当实际产品的供电电压高于1.95V，需要使能DC/DC转换器，以期将电源的效率提高。DC/DC转换器工作的时候会消耗300uA的电流。DC/DC转换器工作与否通过配置寄存器DCDCEN来实现。</li>
</ol>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-01-11T11:41:13+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/01/05/free-rtos/">
		
			Free-RTOS</a>
	</h2>
	<div class="entry-content">
		<h2>如何在FreeRTOS下实现低功耗</h2>

<ol>
<li>可以在空任务或者空任务钩子函数中进入低功耗模式，在系统滴答时钟中断服务函数中重新回到正常工作模式，</li>
<li>多数操作系统都包含一个空任务，空任务优先级最低且一直保持就绪状态，空任务可以用于统计CPU的使用率，或者让MCU进入低功耗状态。如果不想修改空任务，还可以通过空任务的钩子函数插入实现低功耗的代码。</li>
<li>在FreeRTOS中，若需打开空任务钩子函数，需要在FreeRTOSConfig.h中定义#define configUSE_IDLE_HOOK 1</li>
<li>然后在钩子函数中实现低功耗的代码，比如430中：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void vApplicationIdleHook( void )
</span><span class='line'>{
</span><span class='line'>    /* Called on each iteration of the idle task.  In this case the idle task
</span><span class='line'>    just enters a low power mode. */
</span><span class='line'>    __bis_SR_register( LPM3_bits + GIE );
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ol>
<li>在大多数嵌入式操作系统中可以在系统滴答中断函数中退出低功耗模式</li>
</ol>


<h2>任务间使用队列同步数据</h2>

<ol>
<li>在嵌入式操作系统中，队列是人物间数据交换的常用手段，队列是生产者消费之模型的重要组成部分。</li>
<li>xQueueHandle MsgQueue;声明一个队列句柄，队列句柄可以理解成一个队列的标记，不同的队列具有不同的标记。</li>
<li>MsgQueue = xQueueCreate( 5 , sizeof( int16_t ) );创建队列，即在内存中开辟固定大小的区域。FreeRTOS中需要指定队列的深度和每个元素的字节长度</li>
<li>xQueueSend( MsgQueue, ( void* )&amp;SendNum, 0 );向队列中填充内容，第二参数需要取出地址并进行类型转换，第三参数设置等待时间，在队列满的情况下再往队列中填充内容会阻塞任务，知道等待时间溢出；若此处填充的内容为0的话，则立即返回插入队列结果</li>
<li>xQueueReceive( MsgQueue, &amp;ReceiveNum, 100/portTICK_RATE_MS )；从队列中取出内容，第二参数需要取出地址，第三参数为等待最大时间，若在等待的时间内队列中没有数据则返回阻塞任务。</li>
</ol>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-01-05T20:58:43+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/12/24/makefile/">
		
			Makefile</a>
	</h2>
	<div class="entry-content">
		<h2>wildcard(扩展通配符)用法</h2>

<h2>patsubst(替换通配符)用法</h2>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-12-24T23:31:10+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/12/10/eclipse-plus-cygwin/">
		
			Eclipse+cygwin</a>
	</h2>
	<div class="entry-content">
		<h2>eclipse+cdt+cygwin配置c/c++开发环境</h2>

<ol>
<li><a href="https://cygwin.com/mirrors.html">下载cygwin</a>,默认情况下Cygwin没有选择C++开发所需要的包，在安装时需要选中：

<ul>
<li>gcc,gcc-core,gcc-g++,gcc-mingw-core,gcc-mingw-g++,make,gdb,bunutils</li>
</ul>
</li>
<li>安装好后，需要把Cygwin加入到Windows环境变量</li>
<li>下载安装CDT插件，或者直接下载安装带有CDT插件的eclipse软件</li>
<li>配置路径映射，eclipse中调试时，由于GDB使用的是unix格式的路径，而eclipse使用的是windows路径，导致找不到匹配的代码，需要手工设置：

<ol>
<li>进入eclipse的preference，搜索“lookup path”</li>
<li>进入后添加新的“Path Mapping”</li>
<li>把linux的路径映射到windows的路径，比如/cygdrive/c 映射成C:/</li>
</ol>
</li>
</ol>


<h2>cygwin技巧</h2>

<ol>
<li>清屏：ctrl+l</li>
</ol>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-12-10T13:21:49+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/12/09/spansion-fm4/">
		
			Spansion-FM4</a>
	</h2>
	<div class="entry-content">
		

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-12-09T12:53:06+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/12/06/esp8266/">
		
			ESP8266使用</a>
	</h2>
	<div class="entry-content">
		<h2>NodeMCU-V1.0</h2>

<ol>
<li>核心板型号：ESP-12-E,4Mbytes（32Mbits）的flash</li>
<li><a href="https://github.com/nodemcu/nodemcu-firmware">开源官网</a></li>
<li>官网烧录工具使用：

<ol>
<li>SPI模式选择：DIO</li>
<li>FLASH SIZE选择：32Mbit</li>
<li>将最新的固件烧写到0x00000处</li>
<li>在烧写之前，需要按住FLASH按键不动然后按下RST按键一次</li>
</ol>
</li>
<li>nodemcu专用烧录工具：只需连接USB串口，选择好烧录文件，单击Flash即可完成烧写</li>
<li>Pin map
<img src="http://i.imgur.com/PoUJ0sw.png" alt="Node MCU Pin Map" />

<ul>
<li>其中D0（GPIO16）只能被用作gpio read/write，不支持中断，不支持pwm、i2c、onewire</li>
</ul>
</li>
<li>Lua core based on eLua project</li>
<li>cjson based on lua-cjson</li>
<li>File system based on spiffs</li>
<li>事件驱动的编程模型</li>
<li>内建的模块：node,json,file,timer,pwm,i2c,spi,onewire,net,mqtt,coap,gpio,wifi,adc,uart,bit,u8g,ucg,ws2801,ws2812,crypto,dht,rtc,sntp,bmp085,tls2561,hx711,system</li>
<li><a href="https://github.com/nodemcu/nodemcu-firmware/wiki/nodemcu_api_cn#noderestart">Node MCU API</a></li>
</ol>


<h2>ESP8266介绍</h2>

<p><img src="http://i.imgur.com/OC5vpzm.png" alt="ESP8266结构图" />
1. 内核架构：XtensaLX106（32位），由Tensilica公司开发，是个可配置软核CPU，指令集可扩展，扩展的指令集通过硬件实现。通常扩展指令集有几种方式：
    1. fusion，就是将多条指令合并为一条指令，从而缩短程序所需要的cycle数
    2. SIMD，就是单指令多数据
2. 默认串口波特率9600。当工作在AP模式时，默认的ip地址为192.168.4.1
3. CPU主频支持80MHz和160MHz，支持RTOS。内部三条总线：iBus访问内部，外部存储器；dBus访问数据RAM；AHB访问内部寄存器
4. 支持的无线网络类型：STA/AP/STA+AP
5. 安全机制：WEP/WPA-PSK/WPA2-PSK
6. 加密类型：WEP64/WEP128/TKIP/AES
7. 固件升级：本地串口，OTA云端升级
8. 网络协议：IPv4，TCP/UDP/FTP/HTTP
9. 支持的硬件接口：UART，I2C，PWM，GPIO，ADC（10位，ADC的范围在0~1V）
10. 串口数据传输最大传输速率为460800bps
11. 系统上电会运行厂商芯片内部的Boot loader，而在bootloader中串口波特率被设置为了<strong>74880</strong>
12. ESP8266的PWM频率100~500Hz
13. GPIO输出电压为VDD_IO（比如3.3V），输出电流应该不超过20mA
14. ESP8266有两个uart，其中uart0有Tx、Rx，可做数据传输，uart1仅有Tx，可做串口调试信息打印
15. ESP8266有两套MAC，因此可以支持softAP+station共存的模式
16. ESP8266 softAP可连接4个station
17. ESP8266低功耗只针对station模式，对于softAP则没有低功耗模式
18. ESP8266的TCP连接最多可以建立5个，UDP连接最多可以建立5个，可同时建立5个TCP连接和5个UDP连接
19. ESP8266片上没有ROM，用户程序存放在外部SPI Flash中。最大支持16MByte的容量。支持的SPI模式：Standard SPI，Dual SPI，DIO SPI，QIO SPI以及Quad SPI。注意，在下载固件时需要在下载工具选择对应模式，否则下载后程序将无法得到正确的运行
20. ESP8266芯片定义了1个SDIO Slave接口，SDIO由硬件实现，支持4位25MHz SDIOv1.1和4位50MHz SDIO v2.0</p>

<h2>最小系统</h2>

<p><img src="http://i.imgur.com/6Hsgedk.png" alt="ESP8266最下系统" />
1. Pin11和Pin17两个数字电源管脚，数字电源无需在电路中增加滤波电容。数字电源工作电压范围1.8v~3.3V
2. 在模拟电源部分，要注意当ESP8266工作在TX时候，瞬间电流会加大，往往会引起电源的轨道塌陷，所以在设计时在模拟电源电路上增加一个0603或者0805封装的10uF电容，此电容可与0402封装的0.1uF电容搭配
3. 在PIN21 SD_CLK管脚上串联一个0402封装的电阻连接到Flash CLK管脚上。此电阻的作用主要为：降低驱动电流，减小串扰和外部干扰，调节时序等。串联电阻大小为200ohm
4. RES12K（Pin31）需外接12K对地电阻，该电阻作为芯片bias控制电流的电阻，对精度要求比较高，建议采用12K±1%精度的电阻
5. ESP8266模组
    1. Layout：
        1. 第一层Top层主要用于走信号线和摆件
        2. 第二层为GND层，不走信号线，保证一个完整的GND平面
        3. 第三层为POWER层，尽量走电源线
        4. 第四层为Bottom层，建议Bottom层不摆件，只走信号线
    2. 3.3V电源线线宽必须＞15mil，走线尽量走第三层（POWER层），到达芯片管脚处时打过孔到达TOP层连接芯片管脚。在过孔处理上，VIA的直径需要大于电源走线的宽度，而且drill应始终，略大于VIA的半径即可
    3. 晶振位置尽量靠近芯片的XTAL Pins，走线不要太长，同时晶振走线必须用地包起来良好屏蔽；晶振的输入输出走线不能打孔走线，即不能跨层。金正的输入输出走线不能交叉，跨层较差也不行。晶振的输入输出的bypass电容要靠近芯片左右侧摆放，尽量不要放在走线上；晶振下方4层都不能走高频数字信号，最佳情况是晶振下方不走任何信号线，晶振TOP面的铺铜区域越大越好。晶振为敏感器件，晶振周围不能有磁感应器件，比如大电感。
    4. RF走线必须控制特性阻抗为50Ω，保证第二层完整地平面，周围地孔屏蔽，走线长度尽量短。RF走线尽量保持在10mil以上；RF走线需预留一个π型匹配网络，且π性匹配电路靠近芯片RF Pin脚摆放。芯片到天线的RF走线不能有过孔，即不能跨层走线。RF走线不能走直角或者45°角，如果有需要则使用圆弧走线。RF走线附近不能有高频信号线。RF上的天线必须远离所有传输高频信号的器件，比如<strong>晶振</strong>，DDR，一些高频时钟</p>

<h2>编译</h2>

<p><img src="http://i.imgur.com/ORglsN7.png" alt="编译参数" />
1. esp_iot_sdk_v0.9.5及之后版本的软件简化了编译脚本，编译指令：./gen_misc.sh，根据提示按要求输入编译参数
    1. boot_v1.1与boot_v1.2+：boot_v1.2相对编译时将程序排列的更紧凑，省flash空间；boot_v1.3主要支持增强启动模式可用于产测
    2. 不支持云端升级：flash.bin+iromtext.bin，支持云端升级：boot.bin+user1.bin
    3. 注意编译不同大小的bin时，其烧录地址不同
2. bin目录存放需要下载到Flash的bin文件
    1. at文件夹：Espressif提供的支持AT指令的bin文件
    2. upgrade文件夹，编译生成的支持云端升级的bin文件（user1.bin或user2.bin）
    3. bin文件下根目录，编译生成的不支持云端升级的bin文件，和其他Espressif提供的bin文件
3. 编译生成user1.bin后，先运行make clean清除上次编译生成的临时文件后，再编译生成user2.bin
4. 每个bin编译成功后，会提示该bin的烧录位置,典型烧写位置：
<img src="http://i.imgur.com/pO5yrDq.png" alt="烧写" />
5. 编译esp_iot_sdk_v0.9.4及之前版本软件
    1. 指令：./gen_misc.sh
    2. 支持云端升级（FOTA）的编译步骤如下：
        1. 运行./gen_misc_plus.sh 1，在esp_iot_sdk/bin/upgrade路径下生成user1.bin
        2. 运行make clean，清除之前的编译信息
        3. 运行./gen_misc_plus.sh 2，在esp_iot_sdk/bin/upgrade路径下生成user2.bin
6. 针对编译时STEP1和STEP5的选择不同，对应的flash size和flash map不同。
    1. 系统参数区（system param）始终为flash的最后16KB
    2. 用户参数区（User param）指Espressif提供的示例软件（IOT_Demo或AT）中设定的用户参数区。如果用户自行实现应用程序，则可以将用户参数存放在flash任意空闲区域
    3. 用户数据区（UserData），可能空闲，当程序区域未占满flash空间时，剩余空间可供用户存储数据
7. none boot-不支持云端升级。编译时Step1选择2，编译生成eagle.flash.bin（简称flash.bin）和eagle.irom0text.bin（简称irom0text.bin），不支持云端升级，则STEP5时选择不同flash size对应的布局如下：
    1. 512KB flash
<img src="http://i.imgur.com/I6YK0Jx.png" alt="none-boot-512KB" />
<img src="http://i.imgur.com/n9onmx8.png" alt="none-boot-512KB-ld文件" />
    2. 1024KB flash
<img src="http://i.imgur.com/1tluP12.png" alt="none-boot-1024KB" /></p>

<ul>
<li><p>\esp_iot_sdk\ld 路径的“eagle.app.v6.ld”文件，其中irom0_0_seg的len即设置irom0text.bin的上限值。对于1024KB flash，此len最大可修改为0xBC000，irom0text.bin 最大支持到752KB</p>

<ol>
<li>2048KB flash
<img src="http://i.imgur.com/x7x40sM.png" alt="none-boot-2048KB" /></li>
</ol>
</li>
<li><p>\esp_iot_sdk\ld 路径的“eagle.app.v6.ld”文件，其中irom0_0_seg的len即设置irom0text.bin的上限值。对于2048KB flash，此len最大可修改为0xC0000，irom0text.bin 最大支持到768KB（因为ESP8266目前程序区最大支持1024KB，1024-256=768）</p>

<ol>
<li>4096KB flash
<img src="http://i.imgur.com/yRtUCDG.png" alt="none-boot-4096KB" /></li>
</ol>
</li>
<li><p>\esp_iot_sdk\ld 路径的“eagle.app.v6.ld”文件，其中irom0_0_seg的len即设置irom0text.bin的上限值。对于2048KB flash，此len最大可修改为0xC0000，irom0text.bin 最大支持到768KB（因为ESP8266目前程序区最大支持1024KB，1024-256=768）</p></li>
<li>with boot-支持云端升级。编译时STEP1选择1，便一两次，分别生成user1.bin和user2.bin，支持云端升级功能。STEP5时选择不同的flash size对应的布局：
<img src="http://i.imgur.com/rlr2rLh.png" alt="with-boot-512KB" />
<img src="http://i.imgur.com/ciZmOP4.png" alt="with-boot-1024KB" />
<img src="http://i.imgur.com/7y3TiXf.png" alt="with-boot-2048KB" />
<img src="http://i.imgur.com/dyOkeMh.png" alt="with-boot-4096KB" /></li>
</ul>


<h2>烧录</h2>

<ol>
<li>系统参数区固定为flash的最后四个扇区，每个扇区4KBytes，即flash最后16KB</li>
<li>master_device_key.bin是ESP8266设备享受Espressif云端服务的身份证明，如果不使用Espressif Cloud可以不少路，否则仅烧录一次。烧录地址在IOT_Demo中设置为用户参数区的第三个扇区</li>
<li>blank.bin初始化系统参数，烧录地址为flash的倒数第二个扇区</li>
<li>esp_init_data_default.bin初始化射频相关参数，烧录地址为flash的倒数第四个扇区</li>
<li>不支持云端升级
<img src="http://i.imgur.com/Bf5iLCd.png" alt="不支持云端程序的烧录地址" /></li>
<li>支持云端升级（FOTA）。支持云端升级的软件无需烧录user2.bin，可以通过网络升级下载user2.bin到Flash并重启运行。
<img src="http://i.imgur.com/AKXb5Vn.png" alt="支持云端程序的烧录地址" /></li>
<li>从esp_iot_sdk_v1.4.0版本起，开发者可以通过设置esp_init_data_default.bin（0~128byte）的114byte控制上电时的RF初始化的行为。
<img src="http://i.imgur.com/8qvF0y6.png" alt="改变RF初始化行为" /></li>
</ol>


<h2>SDK二次开发</h2>

<ol>
<li>如果函数添加了ICACHE_FLASH_ATTR,该函数会被放在irom中，CPU仅在调用到他们的时候，将他们读到cache中运行；没有条件ICACHE_FLASH_ATTR宏的函数，将在一开始上电运行时，就加载到iram中运行。由于空间有限，我们无法将所有代码都一次性加载到iram中运行，因此在大部分函数前添加ICACHE_FLASH_ATTR宏。注意，不能在GPIO或UART中断处理函数中调用带有“ICACHE_FLASH_ATTR”宏的函数，否则将引起异常。</li>
<li>wifi_set_ip_info、wifi_set_macaddr仅在user_init中调用才生效</li>
<li>system_timer_reinit建议在user_init中调用，否则调用后，需要重新arm所有timer</li>
<li>wifi_station_set_config如果在user_init中调用，底层会自动连接对应的路由，不需要再调用wifi_station_connect来进行连接，否则需要。</li>
<li>使能us级定时器

<ol>
<li>在user_config.h中#define USE_US_TIMER，并在user_init中调用system_timer_reinit(),此时可以同时使用os_timer_arm_us和os_timer_arm</li>
<li>未定义USE_US_TIMER时，os_timer_arm（）的时间参数范围0~6871947ms，os_timer_arm_us不可用</li>
<li>定义了USE_US_TIMER时，os_timer_arm（）的时间参数范围0~429496ms，os_timer_arm_us的时间参数范围是0~429496729us</li>
</ol>
</li>
<li>blank.bin，有Espressif提供，烧录到0x7E000地址。不是每次都要烧录，仅当sdk升级版本或需要擦除WIFI配置参数时进行烧录</li>
<li>eagle.app.v6.flash.bin,用户编译生成，烧录到0x0000地址</li>
<li>master_device_key.bin，向Espressif服务器申请，烧录到0x3E000地址</li>
<li>eagle.app.v6.irom0text.bin，用户编译生成，烧录到0x40000地址</li>
<li>esp_init_data_default.bin有Espressif提供，烧录到0x7c000地址</li>
<li>system_restore将wifi相关参数复位，即擦出了路由器信息以及恢复了softAP默认名称</li>
<li>固件云端升级成功后，需要调用system_upgrade_reboot，否则不切换</li>
<li>system_timer_reinit需要放在程序最开始，usr_init第一句</li>
</ol>


<h2>重要API介绍</h2>

<ol>
<li>bool wifi_station_scan (struct scan_config *config, scan_done_cb_t cb);功能：获取AP的信息。注意：不能在user_init中调用此接口，该接口必须在系统初始化完成后，并且ESP8266 station接口使能的情况下调用</li>
<li>bool wifi_station_set_config (struct station_config *config)；功能：设置WiFi station接口的配置参数，并保存到flash。注意：如果wifi_station_set_config在user_init中调用，则ESP8266 station接口在系统初始化完成后，自动连接AP（路由），无需再调用wifi_station_connect；否则，需要调用wifi_station_connect连接AP（路由）。station_config.bssid_set一般设置为0，仅当需要检查AP的MAC地址时（用于有重名AP的情况下）设置为1、本设置如果与原设置不同，会更新保存到flash系统参数区</li>
</ol>


<h2>降低功耗的方法</h2>

<ol>
<li>Modem-Sleep：CPU一直工作，在保持wifi连接，如果没有数据传输则关闭WiFi Modem电路来省电</li>
<li>Light-Sleep：CPU暂停工作，保持Wifi连接</li>
<li>Deep-Sleep：WiFi不需要一直保持连接时采用该模式</li>
</ol>


<h2>ADC应用场景</h2>

<ol>
<li>测量VDD3P3管脚3和4的电源电压

<ol>
<li>TOUT必须悬空</li>
<li>RF_init参数：esp_init_data_default.bin（0~127byte）中的低107byte为“vdd33_const”，必须设为0xFF，即255</li>
<li>RF Calibration工作过程：自测VDD3P3管脚3和管脚4上的电源电压，根据测量结果优化RF电路工作状态</li>
<li>用户软件：可使用system_get_vdd33，不可使用system_adc_read</li>
</ol>
</li>
<li>测量TOUT管脚6的输入电压

<ol>
<li>TOUT管脚接外部电路，输入电压范围限定为0-1.0V</li>
<li>RF_init参数：esp_init_data_default.bin（0~127byte）中的第107byte为“vdd33_const”，必须设为真实的VDD3P3管脚3和管脚4上的电源电压，ESP8266的工作电压范围1.8V-3.6V，“vdd33_const”单位0.1V，因此“vdd33_const”有效取值18~36.若电源电压不稳定，会动态变化，“vdd33_const”应输入为电源电压变化的最小值0x10.</li>
<li>RF Calibration工作过程：根据RF_init第107byte“vdd33_const”的值来优化RF电路工作状态，容许误差约为±0.2V</li>
<li>用户软件：不可使用system_get_vdd33；可使用system_adc_read</li>
</ol>
</li>
</ol>


<h2>电源管理</h2>

<ol>
<li>关闭（OFF）：CHIP_PD管脚处于低功耗状态。RTC失效，所有寄存器被清空</li>
<li>深度睡眠（DEEP_SLEEP）：RTC开着，芯片的其他部分都是关着的。RTC内部recovery memory可保存基本的WiFi连接信息</li>
<li>睡眠（SLEEP）：只有RTC在运行。晶体振荡器停止工作。任何部位唤醒（MAC、主机、RTC计时器、外部中断）将唤醒整个芯片</li>
<li>环形（WAKEUP）：在这种状态下，系统从睡眠状态下转为启动（PWR）状态。晶体振荡器和PLL均转化为使能状态</li>
<li>开启状态（CPU ON）：告诉时钟可以运行，并发送至各个被时钟控制寄存器使能的模块。各个模块，包括CPU在内，执行较低电平的时钟门控。系统运作时，可以通过WAITI指令关闭CPU内部时钟</li>
<li>工作状态（RF WORK）：在开启状态的基础上打开WiFi功能</li>
</ol>


<h2>2.4GHz接收器</h2>

<p>2.4GHz接收器把RF信号降频，编程正交基带信号，用2个高分辨率的高速ADC将后者转为数字信号。为了适应不同的信号频道，无线电接收器集成了RF滤波器、自动增益控制AGC、DC偏移补偿电路和基带滤波器</p>

<h2>2.4GHz发射器</h2>

<p>2.4GHz发射器将正交基带信号升频到2.4GHz，使用大功率CMOS功率放大器驱动天线。数字校准的使用进一步改善了功率放大器的线性，从而在802.11b传输中达到+17dBm的平均功率，在802.11n中达到了13dBm的平均功率。为了抵消无线电接收器的瑕疵，还另增了校准措施：
    1. 载波泄露
    2. I/Q相位匹配
    3. 基带非线性</p>

<h2>SDK_IOT_Demo使用方法</h2>

<ol>
<li>ESP8266物联网平台的所有网络功能均在库中实现，对用户不透明。用户应用的初始化功能可以在user_main.c中实现。</li>
<li>void user_init(void)是上层程序的入口函数，给用户提供一个初始化接口，用户可在该函数内增加硬件初始化、网络参数配置、定时器初始化等功能。</li>
<li>SDK中提供了对json包的处理API，用户也可以采用自定义数据包格式，自行对数据进行处理</li>
<li>user_config.h,该头文件中可以选择具体的应用示例，仅支持每次打开一个宏定义，使能一个设备，具体支持：

<ol>
<li>PLUG_DEVICE（只能插座）</li>
<li>LIGHT_DEVICE（灯）</li>
<li>SENSOR_DEVICE（传感器）

<ol>
<li>HUMITURE_SUB_DEVICE（温湿度传感器）</li>
<li>FLAMMABLE_GAS_SUB_DEVICE（可燃气体检测）</li>
</ol>
</li>
</ol>
</li>
<li>需要注意，以下头文件中的宏定义只是用户参数区，用户需要根据编译时的flash map自行调整

<ol>
<li>user_esp_platform.h中的#define ESP_PARAM_START_SEC 0x3D //or 0x7D, or 0xFD</li>
<li>user_light.h中的#define PRIV_PARAM_START_SEC   0x3C //or ox7C, or 0xFC</li>
<li>user_plug.h中的#define PRIV_PARAM_START_SEC 0x3C // or 0x7C, or 0xFC</li>
</ol>
</li>
</ol>


<h2>SDK编程指南</h2>

<ol>
<li>SDK_v1.1.0及之后版本，请在user_main.c增加void user_rf_pre_init(void)，可参考IOT_Demo的user_main.c。用户可在user_rf_pre_init中配置RF初始化，相关RF设置接口为system_phy_set_rfoption，或者在deep-sleep前调用system_deep_sleep_set_option。如果设置为RF不打开，则ESP8266 station及soft-AP均无法使用</li>
<li>非OS SDK中，由于是单线程，任何task都不能长期占用CPU

<ol>
<li>如果一个task占用CPU不退出，将导致看门狗的喂狗函数无法执行，系统重启</li>
<li>如果关闭中断，请勿占用CPU超过10微妙；如果不关闭中断，建议不超过500毫秒</li>
</ol>
</li>
<li>建议使用定时器实现周期性的查询功能，如需在定时器的执行函数中调用os_delay_us或者while、for等函数进行延时或者循环操作，占用时间请勿超过15毫秒</li>
<li>非OS SDK在终端处理函数中，请勿使用任何ICACHE_FLASH_ATTR定义的函数</li>
<li>内存必须4字节对齐进行读写，请勿直接进行指针转换。例如语句：float temp=<em>（（float</em>）data）；可能引起异常，建议使用os_memcpy</li>
<li>如需在中断处理函数中打印，请使用os_printf_plus，且不能加入太多打印信息，尤其是频繁的中断，中断占用时间过长可能引起底层异常</li>
</ol>


<h2>应用程序接口（APIs）</h2>

<ol>
<li><p>软件定时器（/esp_iot_sdk/include/osapi.h）</p>

<ol>
<li>该定时器由软件实现，定时器的函数在任务中被执行，因为任务可能被中断，或者被其他高优先级的任务延迟，因此以下os_timer系列的接口并不能保证定时器精确执行</li>
<li>如果需要精确的定时，请使用硬件中断定时器，硬件定时器的执行函数在中断里被执行</li>
<li>对于同一个timer，os_timer_arm或os_timer_arm_us不能重复调用，必须先os_timer_disarm</li>
<li>os_timer_setfn必须在timer未使能的情况下调用，在os_timer_arm或os_timer_arm_us之前或者os_timer_disarm之后
<img src="http://i.imgur.com/ut3L04J.png" alt="os_timer_arm" />
<img src="http://i.imgur.com/g4r2Hqy.png" alt="os_timer_disarm" />
<img src="http://i.imgur.com/NJSnALl.png" alt="os_timer_setfn" />
<img src="http://i.imgur.com/rjtHFxg.png" alt="system_timer_reinit" />
<img src="http://i.imgur.com/YGqHnPH.png" alt="os_timer_arm_us" /></li>
</ol>
</li>
<li><p>硬件中断定时器（esp_iot_sdk/example/driver_lib/hw_timer.c）</p>

<ol>
<li>如果使用NMI中断源，且为自动填装的定时器，调用hw_timer_arm时参数val必须大于100</li>
<li>如果使用NMI中断源，那么该定时器将为最高优先级，可打断其他ISR</li>
<li>如果使用FRC1中断源，那么该定时器无法打断其他ISR</li>
<li>hw_timer.c的接口不能跟PWM驱动函数同时使用，因为两者共用了同一个硬件定时器
<img src="http://i.imgur.com/4IYnD4u.png" alt="hw_timer_init" />
<img src="http://i.imgur.com/HJSwcP1.png" alt="hw_timer_arm" />
<img src="http://i.imgur.com/AdwUQnK.png" alt="hw_timer_set_func" /></li>
</ol>
</li>
<li><p>系统接口
<img src="http://i.imgur.com/wwOKGue.png" alt="system_get_sdk_version" />
<img src="http://i.imgur.com/FhDEzk9.png" alt="system_restore" />
<img src="http://i.imgur.com/KebuEg2.png" alt="system_restart" />
<img src="http://i.imgur.com/gd7wPOu.png" alt="system_init_done_cb" />
<img src="http://i.imgur.com/1kbe7QR.png" alt="system_get_chip_id" />
<img src="http://i.imgur.com/VYY0bm0.png" alt="system_get_vdd33" />
<img src="http://i.imgur.com/qcos9q2.png" alt="system_adc_read" />
<img src="http://i.imgur.com/BvIJ9j3.png" alt="system_deep_sleep" />
<img src="http://i.imgur.com/7GyREOv.png" alt="system_deep_sleep_set_option" />
<img src="http://i.imgur.com/iN58kRk.png" alt="system_phy_set_rfoption" />
<img src="http://i.imgur.com/q9kfPIR.png" alt="system_phy_set_powerup_option" />
<img src="http://i.imgur.com/xpDL6g5.png" alt="system_phy_set_max_tpw" />
<img src="http://i.imgur.com/WmKLDfl.png" alt="system_phy_set_tpw_via_vdd33" />
<img src="http://i.imgur.com/sBL3Dxe.png" alt="system_set_os_print" />
<img src="http://i.imgur.com/b65IXuv.png" alt="system_print_meminfo" />
<img src="http://i.imgur.com/PR7wSZc.png" alt="system_get_free_heap_size" />
<img src="http://i.imgur.com/VdxyQlN.png" alt="system_os_task" />
<img src="http://i.imgur.com/zdplehL.png" alt="system_os_post" />
<img src="http://i.imgur.com/NyzEjjf.png" alt="system_get_time" />
<img src="http://i.imgur.com/mKDWnWa.png" alt="system_get_rtc_time" />
<img src="http://i.imgur.com/LygTWoX.png" alt="system_rtc_clock_cali_proc" />
<img src="http://i.imgur.com/A72POUy.png" alt="system_rtc_mem_read" />
<img src="http://i.imgur.com/TFeTFTD.png" alt="system_uart_swap" />
<img src="http://i.imgur.com/qvrBExO.png" alt="system_uart_de_swap" />
<img src="http://i.imgur.com/Kgy6Klz.png" alt="system_get_boot_version" />
<img src="http://i.imgur.com/fTlFRgx.png" alt="system_get_userbin_addr" />
<img src="http://i.imgur.com/TsZutcF.png" alt="system_get_boot_mode" />
<img src="http://i.imgur.com/Hz979AN.png" alt="system_restart_enhance" />
<img src="http://i.imgur.com/XSo84Zh.png" alt="system_update_cpu_freq" />
<img src="http://i.imgur.com/vvaN0rO.png" alt="system_get_cpu_freq" />
<img src="http://i.imgur.com/VvcFGtr.png" alt="system_get_flash_size_map" />
<img src="http://i.imgur.com/qS1DJbK.png" alt="system_get_rst_info" />
<img src="http://i.imgur.com/L4Val81.png" alt="system_soft_wdt_stop" />
<img src="http://i.imgur.com/a84yBT6.png" alt="system_soft_wdt_restart" />
<img src="http://i.imgur.com/ae9oSIE.png" alt="system_soft_wdt_feed" />
<img src="http://i.imgur.com/a1phXi6.png" alt="system_show_malloc" />
<img src="http://i.imgur.com/ih4sEt8.png" alt="os_memcpy" />
<img src="http://i.imgur.com/Z3lIfXz.png" alt="os_strlen" />
<img src="http://i.imgur.com/TAVUB3x.png" alt="os_printf" />
<img src="http://i.imgur.com/PJJjvLk.png" alt="os_bzero" />
<img src="http://i.imgur.com/7B4XZ86.png" alt="os_delay_us" />
<img src="http://i.imgur.com/D3sMS0i.png" alt="os_install_putc1" /></p></li>
<li><p>SPI Flash接口
<img src="http://i.imgur.com/XmmnjBi.png" alt="spi_flash_get_id" />
<img src="http://i.imgur.com/2ovYNiF.png" alt="spi_flash_erase_sector" />
<img src="http://i.imgur.com/iIj5npZ.png" alt="spi_flash_write" />
<img src="http://i.imgur.com/boQJjil.png" alt="spi_flash_read" />
<img src="http://i.imgur.com/IcZDndm.png" alt="system_param_save_with_protect" />
<img src="http://i.imgur.com/O97tZqz.png" alt="system_param_load" />
<img src="http://i.imgur.com/SmENox2.png" alt="spi_flash_set_read_func" /></p></li>
<li><p>Wi-Fi接口</p>

<ol>
<li>wifi_station系列接口以及ESP8266 station相关的设置、查询接口，请在ESP8266 station使能的情况下调用</li>
<li>wifi_softap系列接口以及ESP8266 soft-AP相关的设置、查询接口，请在ESP8266 soft-AP使能的情况下调用</li>
<li>后文的“flash系统参数区”位于flash的最后16KB
<img src="http://i.imgur.com/RlFFDxJ.png" alt="wifi_get_opmode" />
<img src="http://i.imgur.com/XaW34cD.png" alt="wifi_get_opmode_default" />
<img src="http://i.imgur.com/QGHqO0N.png" alt="wifi_set_opmode" />
<img src="http://i.imgur.com/Q4lSIWk.png" alt="wifi_set_opmode_current" />
<img src="http://i.imgur.com/wqkMEDJ.png" alt="wifi_station_get_config" />
<img src="http://i.imgur.com/k9VPDzA.png" alt="wifi_station_get_config_default" />
<img src="http://i.imgur.com/61GE3Ib.png" alt="wifi_station_set_config" />
<img src="http://i.imgur.com/qdYW054.png" alt="wifi_station_set_config_current" />
<img src="http://i.imgur.com/03hCjeQ.png" alt="wifi_station_set_cert_key" />
<img src="http://i.imgur.com/QPXjpWE.png" alt="wifi_station_clear_cert_key" />
<img src="http://i.imgur.com/Yh1PrWq.png" alt="wifi_station_connect" />
<img src="http://i.imgur.com/DZl8NZr.png" alt="wifi_station_disconnect" />
<img src="http://i.imgur.com/kApSlV0.png" alt="wifi_station_get_connect_status" />
<img src="http://i.imgur.com/Ts9TcYG.png" alt="wifi_station_scan" />
<img src="http://i.imgur.com/tmSeQd4.png" alt="scan_done_cb_t" />
<img src="http://i.imgur.com/3qUP8bn.png" alt="wifi_station_ap_number_set" />
<img src="http://i.imgur.com/KIVrSGI.png" alt="wifi_station_get_ap_info" />
<img src="http://i.imgur.com/TwvND65.png" alt="wifi_station_ap_change" />
<img src="http://i.imgur.com/5lvsPLw.png" alt="wifi_station_get_current_ap_id" />
<img src="http://i.imgur.com/4Kfn8ab.png" alt="wifi_station_get_auto_connect" />
<img src="http://i.imgur.com/oi0cgPi.png" alt="wifi_station_set_auto_connect" />
<img src="http://i.imgur.com/EWEmI4Z.png" alt="wifi_station_dhcpc_start" />
<img src="http://i.imgur.com/m82n4Zm.png" alt="wifi_station_dhcpc_stop" />
<img src="http://i.imgur.com/zaJSEFV.png" alt="wifi_station_dhcpc_status" />
<img src="http://i.imgur.com/SOkwKH3.png" alt="wifi_station_dhcpc_set_maxtry" />
<img src="http://i.imgur.com/E4qQCrP.png" alt="wifi_station_set_reconnect_policy" />
<img src="http://i.imgur.com/9rt7lqT.png" alt="wifi_station_get_rssi" />
<img src="http://i.imgur.com/ghg2o8V.png" alt="wifi_station_set_hostname" />
<img src="http://i.imgur.com/FAlGs8p.png" alt="wifi_station_get_hostname" />
<img src="http://i.imgur.com/5Pdrcxh.png" alt="wifi_softap_get_config" />
<img src="http://i.imgur.com/CZQUF2Q.png" alt="wifi_softap_get_config_default" />
<img src="http://i.imgur.com/UDNTbY5.png" alt="wifi_softap_set_config" />
<img src="http://i.imgur.com/ZDcmXW0.png" alt="wifi_softap_set_config_current" />
<img src="http://i.imgur.com/P9tlgeM.png" alt="wifi_softap_get_station_num" />
<img src="http://i.imgur.com/yHVy86S.png" alt="wifi_softap_get_station_info" />
<img src="http://i.imgur.com/x5ngKIb.png" alt="wifi_softap_free_station_info" />
<img src="http://i.imgur.com/78K07qB.png" alt="wifi_softap_dhcps_start" />
<img src="http://i.imgur.com/1qfrMUV.png" alt="wifi_softap_dhcps_stop" />
<img src="http://i.imgur.com/HxrV1vR.png" alt="wifi_softap_set_dhcps_lease" />
<img src="http://i.imgur.com/0E9KVU1.png" alt="wifi_softap_get_dhcps_lease" />
<img src="http://i.imgur.com/SRSOODU.png" alt="wifi_softap_set_dhcps_lease_time" />
<img src="http://i.imgur.com/Hx99GO2.png" alt="wifi_soft_dhcps_status" />
<img src="http://i.imgur.com/l97H0jZ.png" alt="wifi_softap_set_dhcps_offer_option" />
<img src="http://i.imgur.com/XcDbqxT.png" alt="wifi_set_phy_mode" />
<img src="http://i.imgur.com/GUa5O5O.png" alt="wifi_get_phy_mode" />
<img src="http://i.imgur.com/xyPVuhn.png" alt="wifi_get_ip_info" />
<img src="http://i.imgur.com/Zr9vWoq.png" alt="wifi_set_ip_info" />
<img src="http://i.imgur.com/Z9LwYlW.png" alt="wifi_set_macaddr" />
<img src="http://i.imgur.com/kTZanO6.png" alt="wifi_get_macaddr" />
<img src="http://i.imgur.com/uDAgvRn.png" alt="wifi_set_sleep_type" />
<img src="http://i.imgur.com/rYM4D3u.png" alt="wifi_get_sleep_type" />
<img src="http://i.imgur.com/lSCPGbX.png" alt="wifi_status_led_install" />
<img src="http://i.imgur.com/ggsdLte.png" alt="wifi_status_led_uninstall" />
<img src="http://i.imgur.com/ZjWAM9E.png" alt="wifi_set_broadcase_if" />
<img src="http://i.imgur.com/j7IEi5C.png" alt="wifi_get_broadcast_if" />
<img src="http://i.imgur.com/SDZx9vy.png" alt="wifi_set_event_handler_cb" />
<img src="http://i.imgur.com/WOrpmmZ.png" alt="wifi_wps_enable" />
<img src="http://i.imgur.com/nIabYMP.png" alt="wifi_wps_disable" />
<img src="http://i.imgur.com/mbemUfV.png" alt="wifi_wps_start" />
<img src="http://i.imgur.com/UjUURzV.png" alt="wifi_set_wps_cb" />
<img src="http://i.imgur.com/Fc9Vy7R.png" alt="wifi_register_send_pkt_freedom_cb" />
<img src="http://i.imgur.com/82xDFc1.png" alt="wifi_send_pkt_freedom" />
<img src="http://i.imgur.com/2KAsPlg.png" alt="wifi_rfid_locp_recv_open" />
<img src="http://i.imgur.com/gIVEqHb.png" alt="wifi_rfid_locp_recv_close" />
<img src="http://i.imgur.com/atfre24.png" alt="wifi_register_rfid_locp_recv_cb" />
<img src="http://i.imgur.com/ySvAcKR.png" alt="wifi_unregister_rfid_locp_recv_cb" /></li>
</ol>
</li>
<li><p>Rate Control 接口
<img src="http://i.imgur.com/hsHHgyu.png" alt="wifi_set_user_fixed_rate" />
<img src="http://i.imgur.com/mbJAoHb.png" alt="wifi_get_user_fixed_rate" />
<img src="http://i.imgur.com/qb8MnZh.png" alt="wifi_set_user_sup_rate" />
<img src="http://i.imgur.com/X0Upq9z.png" alt="wifi_set_user_rate_limit" />
<img src="http://i.imgur.com/asqAVuW.png" alt="wifi_set_user_limit_rate_mask" />
<img src="http://i.imgur.com/iqOBgeg.png" alt="wifi_get_user_limit_rate_mask" /></p></li>
<li><p>强制休眠接口
使用强制休眠功能，必须先设置WiFi工作模式位NULL_MODE，从强制休眠中唤醒ESP8266，或者休眠时间到，进入唤醒回调（wifi_fpm_set_wakeup_cb注册）后，先关闭强制休眠功能，才能再设置WiFi工作模式为station、soft-AP或sta+AP的正常工作模式。
<img src="http://i.imgur.com/LMJT80U.png" alt="wifi_fpm_open" />
<img src="http://i.imgur.com/H0ajlD1.png" alt="wifi_fpm_close" />
<img src="http://i.imgur.com/aFSgMZu.png" alt="wifi_fpm_do_wakeup" />
<img src="http://i.imgur.com/nSg5lrr.png" alt="wifi_fpm_set_wakeup_cb" />
<img src="http://i.imgur.com/XVbopKI.png" alt="wifi_fpm_do_sleep" />
<img src="http://i.imgur.com/RJFmtGe.png" alt="wifi_fpm_set_sleep_type" />
<img src="http://i.imgur.com/hbiNG8u.png" alt="wifi_fpm_get_sleep_type" />
示例
<img src="http://i.imgur.com/mQaZk2x.png" alt="示例代码" /></p></li>
<li><p>ESP-NOW
ESP-NOW软件接口使用时注意：</p>

<ol>
<li>ESP-NOW目前不支持广播包和组播包</li>
<li>ESP-NOW现阶段主要为智能灯项目，建议slave角色对应ESP8266 soft-AP模式或者soft-AP+station共存模式；controller角色对应station模式</li>
<li>当ESP8266处于soft-AP+station共存模式时，若作为slave角色，将从soft-AP接口通信；若作为controller角色，将从station接口通信</li>
<li>ESP-NOW不实现休眠环形功能，因此如果通信对方的ESP8266 station正处于休眠状态，ESP-NOW发包将会失败</li>
<li>ESP8266 station模式下，最多可设置10个加密的ESP-NOW peer，加上不加密的设备，综述不超过20个</li>
<li>ESP8266 soft-AP模式或者soft-AP+station模式下，最多设置6个加密的ESP-NOW peer，加上不加密的设备，总数不超过20个
<img src="http://i.imgur.com/ZqxmdUT.png" alt="esp_now_init" />
<img src="http://i.imgur.com/jnoadVK.png" alt="esp_now_deinit" />
<img src="http://i.imgur.com/hVQrHz9.png" alt="esp_now_register_recv_cb" />
<img src="http://i.imgur.com/KCRctG7.png" alt="esp_now_unregister_recv_cb" />
<img src="http://i.imgur.com/kqTxtwA.png" alt="esp_now_register_send_cb" />
<img src="http://i.imgur.com/6eVV4AH.png" alt="esp_now_unregister_send_cb" />
<img src="http://i.imgur.com/45s7eeI.png" alt="esp_now_send" />
<img src="http://i.imgur.com/500z8ub.png" alt="esp_now_add_peer" />
<img src="http://i.imgur.com/2S8zfbW.png" alt="esp_now_del_peer" />
<img src="http://i.imgur.com/JlYx4aq.png" alt="esp_now_set_self_role" />
<img src="http://i.imgur.com/Guzjbw0.png" alt="esp_now_get_self_role" />
<img src="http://i.imgur.com/osSgTqs.png" alt="esp_now_set_peer_role" />
<img src="http://i.imgur.com/0GiHi1M.png" alt="esp_now_get_peer_role" />
<img src="http://i.imgur.com/hIq3URt.png" alt="esp_now_set_peer_key" />
<img src="http://i.imgur.com/q945HqV.png" alt="esp_now_get_peer_key" />
<img src="http://i.imgur.com/ZL6L5o7.png" alt="esp_now_set_peer_channel" />
<img src="http://i.imgur.com/eOa2xH8.png" alt="esp_now_get_peer_channel" />
<img src="http://i.imgur.com/H3U5eoY.png" alt="esp_now_is_peer_exist" />
<img src="http://i.imgur.com/3bUBgdm.png" alt="esp_now_fetch_peer" />
<img src="http://i.imgur.com/0vxZrA2.png" alt="esp_now_get_cnt_info" />
<img src="http://i.imgur.com/diYBk7z.png" alt="esp_now_set_tok" /></li>
</ol>
</li>
<li><p>云端升级（FOTA）
<img src="http://i.imgur.com/vI1fgnj.png" alt="system_upgrade_userbin_check" />
<img src="http://i.imgur.com/5drhXqB.png" alt="system_upgrade_flag_set" />
<img src="http://i.imgur.com/RJoi4Ax.png" alt="system_upgrade_flag_check" />
<img src="http://i.imgur.com/yAC2blM.png" alt="system_upgrade_start" />
<img src="http://i.imgur.com/1YM4Vqy.png" alt="system_upgrade_reboot" /></p></li>
<li><p>Sniffer接口
<img src="http://i.imgur.com/hp8xnhl.png" alt="wifi_promiscuous_enable" />
<img src="http://i.imgur.com/IG127Hv.png" alt="wifi_promiscuous_set_mac" />
<img src="http://i.imgur.com/a83zveF.png" alt="wifi_set_promiscuous_rx_cb" />
<img src="http://i.imgur.com/Mv6Iz1J.png" alt="wifi_get_channel" />
<img src="http://i.imgur.com/ubo9cpS.png" alt="wifi_set_channel" /></p></li>
<li><p>smart config
开启smart config功能前，先要确保AP已经开启
<img src="http://i.imgur.com/LnOwF3z.png" alt="smartconfig_start" />
<img src="http://i.imgur.com/X8GqB53.png" alt="smartconfig_stop" />
<img src="http://i.imgur.com/KVw3EWh.png" alt="smartconfig_set_type" /></p></li>
<li><p>SNTP
<img src="http://i.imgur.com/JidngYO.png" alt="sntp_setserver" />
<img src="http://i.imgur.com/LoF3zE2.png" alt="sntp_getserver" />
<img src="http://i.imgur.com/Aa5MuMU.png" alt="sntp_setservername" />
<img src="http://i.imgur.com/TsNRL1v.png" alt="sntp_getservername" />
<img src="http://i.imgur.com/xdbOU1A.png" alt="sntp_init" />
<img src="http://i.imgur.com/edA5UWl.png" alt="sntp_stop" />
<img src="http://i.imgur.com/mjPbh2d.png" alt="sntp_get_current_timestamp" />
<img src="http://i.imgur.com/4LFCzuZ.png" alt="sntp_get_real_time" />
<img src="http://i.imgur.com/bhKWquX.png" alt="sntp_set_timezone" />
<img src="http://i.imgur.com/xLD8Muv.png" alt="sntp_get_timezone" />
<img src="http://i.imgur.com/d16kfdb.png" alt="sntp实例" /></p></li>
<li><p>TCP/UDP接口</p>

<ol>
<li>通用接口
<img src="http://i.imgur.com/b7JpuSF.png" alt="espconn_delete" />
<img src="http://i.imgur.com/oYeFFV5.png" alt="espconn_gethostbyname" />
<img src="http://i.imgur.com/byn3M8b.png" alt="espconn_port" />
<img src="http://i.imgur.com/RWTvtPX.png" alt="espconn_regist_sentcb" />
<img src="http://i.imgur.com/kyjCZLo.png" alt="espconn_regist_recvcb" />
<img src="http://i.imgur.com/9TiclzH.png" alt="espconn_sent_callback" />
<img src="http://i.imgur.com/EGx24RQ.png" alt="espconn_recv_callback" />
<img src="http://i.imgur.com/ZMdDW5D.png" alt="espconn_send" /></li>
<li>TCP APIs
<img src="http://i.imgur.com/tvFIHXv.png" alt="espconn_accept" />
<img src="http://i.imgur.com/MQDJ2dm.png" alt="espconn_regist_time" />
<img src="http://i.imgur.com/JHhTCX8.png" alt="espconn_get_connection_info" />
<img src="http://i.imgur.com/qnPMqHW.png" alt="espconn_connect" />
<img src="http://i.imgur.com/AXFBUEl.png" alt="espconn_regist_connectcb" />
<img src="http://i.imgur.com/PapbezX.png" alt="espconn_connect_callback" />
<img src="http://i.imgur.com/qDyblQ6.png" alt="espconn_set_opt" />
<img src="http://i.imgur.com/SGEKnoP.png" alt="espconn_clear_opt" />
<img src="http://i.imgur.com/p0qCJtW.png" alt="espconn_set_keepalive" />
<img src="http://i.imgur.com/zBb9208.png" alt="espconn_get_keepalive" />
<img src="http://i.imgur.com/vG8gNaV.png" alt="espconn_reconnect_callback" />
<img src="http://i.imgur.com/bsyzRMX.png" alt="espconn_regist_reconcb" />
<img src="http://i.imgur.com/D0ksaOd.png" alt="espconn_disconnect" />
<img src="http://i.imgur.com/5HlP8kD.png" alt="espconn_regist_disconcb" />
<img src="http://i.imgur.com/87L2XO8.png" alt="espconn_abort" />
<img src="http://i.imgur.com/g9FFQ2T.png" alt="espconn_regist_write_finish" />
<img src="http://i.imgur.com/4iDHlaW.png" alt="espconn_tcp_get_max_con" />
<img src="http://i.imgur.com/7zcoIEJ.png" alt="espconn_tcp_set_max_con" />
<img src="http://i.imgur.com/tj1A4IN.png" alt="espconn_tcp_get_max_con_allow" />
<img src="http://i.imgur.com/YnFUF40.png" alt="espconn_tcp_set_max_con_allow" />
<img src="http://i.imgur.com/Di7fpNE.png" alt="espconn_recv_hold" />
<img src="http://i.imgur.com/p9Wh4ar.png" alt="espconn_recv_unhold" />
<img src="http://i.imgur.com/x77iFAZ.png" alt="espconn_secure_accept" />
<img src="http://i.imgur.com/yf0nu6u.png" alt="espconn_secure_delete" />
<img src="http://i.imgur.com/aJTmXp1.png" alt="espconn_secure_set_size" />
<img src="http://i.imgur.com/LYSOddi.png" alt="espconn_secure_get_size" />
<img src="http://i.imgur.com/vWyey95.png" alt="espconn_secure_connect" />
<img src="http://i.imgur.com/MjT9kZI.png" alt="espconn_secure_send" />
<img src="http://i.imgur.com/Q8Pc8mB.png" alt="espconn_secure_disconnect" />
<img src="http://i.imgur.com/KbuaGLw.png" alt="espconn_secure_ca_disable" />
<img src="http://i.imgur.com/EjurJ9N.png" alt="espconn_secure_ca_enable" />
<img src="http://i.imgur.com/mLQrUcq.png" alt="espconn_secure_cert_req_enable" />
<img src="http://i.imgur.com/ssMcZnw.png" alt="espconn_secure_cert_req_disable" />
<img src="http://i.imgur.com/NOkGIJa.png" alt="espconn_secure_set_default_certificate" />
<img src="http://i.imgur.com/vSJnk8r.png" alt="espconn_secure_set_default_private_key" /></li>
<li>UDP APIs
<img src="http://i.imgur.com/b4U0hIS.png" alt="espconn_crerat" />
<img src="http://i.imgur.com/qJXFCtQ.png" alt="espconn_sendto" />
<img src="http://i.imgur.com/hnz1IKo.png" alt="espconn_igmp_join" />
<img src="http://i.imgur.com/IaZYyTV.png" alt="espconn_igmp_leave" />
<img src="http://i.imgur.com/3LSmGln.png" alt="espconn_dns_setserver" /></li>
<li>mDNS APIs
<img src="http://i.imgur.com/6ZtF0Cx.png" alt="espconn_mdns_init" />
<img src="http://i.imgur.com/4diP7CK.png" alt="espconn_mdns_close" />
<img src="http://i.imgur.com/JHgRWYC.png" alt="espconn_mdns_server_register" />
<img src="http://i.imgur.com/uWcpQwi.png" alt="espconn_mdns_server_unregister" />
<img src="http://i.imgur.com/WGx1eCJ.png" alt="espconn_mdns_get_servername" />
<img src="http://i.imgur.com/fQ1FfCr.png" alt="espconn_mdns_set_servername" />
<img src="http://i.imgur.com/5fmYZOd.png" alt="espconn_mdns_set_hostname" />
<img src="http://i.imgur.com/JztcNEV.png" alt="espconn_mdns_get_hostname" />
<img src="http://i.imgur.com/JWvn7uS.png" alt="espconn_mdns_disable" />
<img src="http://i.imgur.com/iyADme0.png" alt="espconn_mdns_enable" />
<img src="http://i.imgur.com/MlaoB7u.png" alt="nDNS示例" /></li>
</ol>
</li>
<li><p>MESH接口
<img src="http://i.imgur.com/IBvybY2.png" alt="espconn_mesh_enable" />
<img src="http://i.imgur.com/OAC3v1k.png" alt="espconn_mesh_disable" />
<img src="http://i.imgur.com/4VE4LfU.png" alt="espconn_mesh_get_status" />
<img src="http://i.imgur.com/nL1ApJU.png" alt="espconn_mesh_connect" />
<img src="http://i.imgur.com/HW2jL3C.png" alt="espconn_mesh_disconnect" />
<img src="http://i.imgur.com/bDVScnj.png" alt="espconn_mesh_sent" />
<img src="http://i.imgur.com/SWhdlPv.png" alt="espconn_mesh_set_max_hop" />
<img src="http://i.imgur.com/7XQeKKP.png" alt="espconn_mesh_get_max_hop" />
<img src="http://i.imgur.com/iPK4CLN.png" alt="espconn_mesh_get_node_info" />
<img src="http://i.imgur.com/9lqq5x0.png" alt="espconn_mesh_local_addr" />
<img src="http://i.imgur.com/hxtkS50.png" alt="espconn_mesh_server_init" />
<img src="http://i.imgur.com/kk27vxO.png" alt="espconn_mesh_get_router" />
<img src="http://i.imgur.com/8MO0BNo.png" alt="espconn_mesh_set_router" />
<img src="http://i.imgur.com/OYFa67D.png" alt="espconn_mesh_encrypt_init" />
<img src="http://i.imgur.com/UUmQjpb.png" alt="espconn_mesh_set_ssid_prefix" />
<img src="http://i.imgur.com/wsGGmGK.png" alt="espconn_mesh_group_id_init" />
<img src="http://i.imgur.com/ciwvwV1.png" alt="espconn_mesh_set_dev_type" />
<img src="http://i.imgur.com/crA8NVu.png" alt="espconn_mesh_get_dev_type" />
<img src="http://i.imgur.com/MddfA9d.png" alt="espconn_mesh_print_ver" />
<img src="http://i.imgur.com/oTx1V3H.png" alt="espconn_mesh_scan" /></p></li>
<li><p>AT接口
<img src="http://i.imgur.com/uBBcloa.png" alt="at_response_ok" />
<img src="http://i.imgur.com/Hl7Wxrw.png" alt="at_response_error" />
<img src="http://i.imgur.com/wMckYre.png" alt="at_cmd_array_regist" />
<img src="http://i.imgur.com/4bqK9gn.png" alt="at_get_next_int_dec" />
<img src="http://i.imgur.com/c0oafeU.png" alt="at_data_str_copy" />
<img src="http://i.imgur.com/UdkkoRg.png" alt="at_init" />
<img src="http://i.imgur.com/bRMNu26.png" alt="at_port_print" />
<img src="http://i.imgur.com/Qh4Egbh.png" alt="at_set_custom_info" />
<img src="http://i.imgur.com/ojVLj93.png" alt="at_enter_special_state" />
<img src="http://i.imgur.com/7893WIC.png" alt="at_leave_special_state" />
<img src="http://i.imgur.com/Ntv3tdk.png" alt="at_get_version" />
<img src="http://i.imgur.com/9DJBqHV.png" alt="at_register_uart_rx_intr" />
<img src="http://i.imgur.com/BX32Nhi.png" alt="at_response" />
<img src="http://i.imgur.com/JTr50kC.png" alt="at_register_response_func" /></p></li>
<li><p>JSON接口
<img src="http://i.imgur.com/ON88llK.png" alt="jsonparse_setup" />
<img src="http://i.imgur.com/QiEDpFB.png" alt="jsonparse_next" />
<img src="http://i.imgur.com/SCa6Qd3.png" alt="jsonparse_copy_value" />
<img src="http://i.imgur.com/brv0X37.png" alt="jsonparse_get_value_as_int" />
<img src="http://i.imgur.com/d5RR8Wt.png" alt="jsonparse_get_value_as_long" />
<img src="http://i.imgur.com/WVOl4Ue.png" alt="jsonparse_get_value_len" />
<img src="http://i.imgur.com/HOFZdUg.png" alt="jsonparse_get_value_as_type" />
<img src="http://i.imgur.com/37m1XVv.png" alt="jsonparse_strcmp_value" />
<img src="http://i.imgur.com/ACKNxRZ.png" alt="jsontree_set_up" />
<img src="http://i.imgur.com/MxdDQEF.png" alt="jsontree_reset" />
<img src="http://i.imgur.com/YKXsm2O.png" alt="jsontree_path_name" />
<img src="http://i.imgur.com/tpRuPOI.png" alt="jsontree_write_int" />
<img src="http://i.imgur.com/0dfzHBw.png" alt="jsontree_write_int_array" />
<img src="http://i.imgur.com/JMdzDbN.png" alt="jsontree_write_string" />
<img src="http://i.imgur.com/kTFiCg8.png" alt="jsontree_print_next" />
<img src="http://i.imgur.com/YPZRVqT.png" alt="jsontree_find_next" /></p></li>
<li><p>GPIO接口
<img src="http://i.imgur.com/l4cAWaW.png" alt="PIN相关宏定义" />
<img src="http://i.imgur.com/0dYog5W.png" alt="gpio_output_set" />
<img src="http://i.imgur.com/LMjDjU1.png" alt="GPIO输入输出相关宏" />
<img src="http://i.imgur.com/xh7jhE8.png" alt="GPIO中断" />
<img src="http://i.imgur.com/HBeRCSR.png" alt="gpio_pin_intr_state_set" />
<img src="http://i.imgur.com/myjm32J.png" alt="GPIO中断处理函数" /></p></li>
<li><p>UART接口
默认情况下，UART0作为系统的打印信息输出接口，当配置为双UART时，UART0作为数据收发接口，UART1作为打印信息输出接口
<img src="http://i.imgur.com/SG8nMkv.png" alt="uart_init" />
<img src="http://i.imgur.com/7xpciAa.png" alt="uart0_tx_buffer" />
<img src="http://i.imgur.com/yPCsPRq.png" alt="uart0_rx_intr_handler" /></p></li>
<li><p>I2C Master接口
ESP8266不能作为I2C从设备，但可以作为I2C主设备，对其他I2C从设备进行控制和读写。每个GPIO管脚内部都可以配置为开漏模式，从而可以灵活地将GPIO口用作I2C data或者clock功能。同时芯片内部提供上拉电阻，以节省外部的上拉电阻
<img src="http://i.imgur.com/cFCO4NY.png" alt="i2c_master_gpio_init" />
<img src="http://i.imgur.com/9dEjKkE.png" alt="i2c_master_init" />
<img src="http://i.imgur.com/lj8qJuy.png" alt="i2c_master_start" />
<img src="http://i.imgur.com/dKOHZpG.png" alt="i2c_master_stop" />
<img src="http://i.imgur.com/UTNUycs.png" alt="i2c_master_send_ack" />
<img src="http://i.imgur.com/3UGpatY.png" alt="i2c_master_send_nack" />
<img src="http://i.imgur.com/UU2TSbP.png" alt="i2c_master_checkAck" />
<img src="http://i.imgur.com/gjxuJFt.png" alt="i2c_master_readByte" />
<img src="http://i.imgur.com/xOwdzPq.png" alt="i2c_master_writeByte" /></p></li>
<li><p>PWM接口
PWM驱动接口不能跟hw_timer的接口同时使用，因为二者共用了同一个硬件定时器
<img src="http://i.imgur.com/Xtahx9b.png" alt="pwm_init" />
<img src="http://i.imgur.com/XIbDsa7.png" alt="pwm_start" />
<img src="http://i.imgur.com/iKhLfuh.png" alt="pwm_set_duty" />
<img src="http://i.imgur.com/sJ3mGcB.png" alt="pwm_get_duty" />
<img src="http://i.imgur.com/Ixgd7Kz.png" alt="pwm_set_period" />
<img src="http://i.imgur.com/7PB2YeI.png" alt="pwm_get_period" />
<img src="http://i.imgur.com/jxVThkr.png" alt="pwm_get_version" /></p></li>
</ol>


<h2>参数结构和宏定义</h2>

<ol>
<li>定时器
<img src="http://i.imgur.com/SWbnx7J.png" alt="ETSTimer" /></li>
<li>WiFi参数
<img src="http://i.imgur.com/dA8A124.png" alt="station参数" />
<img src="http://i.imgur.com/QNMFXtn.png" alt="soft-AP参数" />
<img src="http://i.imgur.com/E7jjlFd.png" alt="scan参数" />
<img src="http://i.imgur.com/Uw9zTI9.png" alt="WiFi event结构体" />
<img src="http://i.imgur.com/ZP29Rew.png" alt="smart config结构体" /></li>
<li>json相关结构体
<img src="http://i.imgur.com/wnY8lSb.png" alt="json结构体" />
<img src="http://i.imgur.com/amJ4Pbv.png" alt="json宏定义" /></li>
<li>espconn参数
<img src="http://i.imgur.com/YCKqSWm.png" alt="回调函数" />
<img src="http://i.imgur.com/glbsJWw.png" alt="espconn" /></li>
<li>中断相关宏定义
<img src="http://i.imgur.com/i8UAMcA.png" alt="中断宏定义" /></li>
</ol>


<h2>ESPCONN编程</h2>

<ol>
<li>TCP client模式，步骤：

<ol>
<li>依据工作协议初始化espconn参数</li>
<li>注册连接成功的回调函数和连接失败重连的回调函数</li>
<li>调用espconn_connect建立与TCP Secver的连接</li>
<li>TCP连接建立成功后，在连接成功的回调函数(espconn_connect_callback)中，注册接收数据的回调函数，发送数据成功的回调函数和断开连接的回调函数</li>
<li>在接收数据的回调函数，或者发送数据成功的回调函数中，执行断开连接操作时，建议适当延时一定时间，确保底层函数执行结束</li>
</ol>
</li>
<li>TCP Server模式，步骤

<ol>
<li>依据工作协议初始化espconn参数</li>
<li>注册连接成功的回调函数和连接失败重连的回调函数</li>
<li>调用espconn_accept侦听TCP连接</li>
<li>TCP连接建立成功后，在连接成功的回调函数中，注册接收数据的回调函数，发送数据成功的回调函数和断开连接的回调函数</li>
</ol>
</li>
<li>espconn callback
<img src="http://i.imgur.com/X0xci3I.png" alt="espconn callback" />

<ul>
<li>注意：回调函数中传入的指针arg，对应网络连接的结构体espconn指针。该指针为SDK内部维护的指针，不同回调传入的指针地址可能不一样，请勿依此判断网络连接。可根据espconn结构体中的remote_ip，remote_port判断多连接中的不同网络传输</li>
<li>如果espconn_connect（或者espconn_secure_connect）失败，返回非零值，连接未建立，不会进入任何espconn callback</li>
<li>请勿在espconn热河回调中调用espconn_disconnect（或者espconn_secure_disconnect）断开连接。如果有需要，可以在espconn回调中使用触发任务的方式（system_os_task和system_os_post）调用espconn_disconnect（或者espconn_secure_disconnect）断开连接</li>
</ul>
</li>
</ol>


<h2>RTC使用实例</h2>

<p>以下测试示例，可以验证RTC时间和系统时间，在system_restart时的变化，以及读写RTC memory
<img src="http://i.imgur.com/SqM8KtO.png" alt="RTC示例" /></p>

<h2>Sniffer结构体说明</h2>

<ol>
<li>ESP8266可以进入混杂模式，接收空气中的IEEE802.11包，可支持如下HT20的包：

<ol>
<li>802.11b</li>
<li>802.11g</li>
<li>802.11n（MCS0到MCS7）</li>
<li>AMPDU</li>
</ol>
</li>
<li>尽管有些类型的IEEE802.11包是ESP8266不能完全接收的，但ESP8266可以获得它们的包长。因此，sniffer模式下，ESP8266或者可以接收完整的包，或者可以获得包的长度</li>
<li>ESP8266可完全接收的包，包含：

<ol>
<li>一定长度的MAC头信息（包含了收发双发的MAC地址和加密方式）</li>
<li>整个包的长度</li>
</ol>
</li>
<li>ESP8266不可完全接收的包，它包含：

<ol>
<li>整个包的长度</li>
</ol>
</li>
<li>结构体RxControl和sniffer_buf分别用于via哦是这两种类型的包。其中结构体sniffer_buf包含结构体RxControl。
<img src="http://i.imgur.com/WiqsD0p.png" alt="sniffer结构体" />
回调函数wifi_promiscuous_rx含两个参数（buf和len）。len表示buf的长度，分为三种情况：len=128，len为10的整数倍，len=12；

<ol>
<li>LEN==128的情况

<ul>
<li>buf的数据是结构体sniffer_buf2，该结构体对应的数据包是管理包，含有112字节的数据</li>
<li>sniffer_buf2.cnt为1</li>
<li>sniffer_buf2.len为管理包的长度</li>
</ul>
</li>
<li>LEN为10的整数倍的情况

<ul>
<li>buf的数据是结构体sniffer_buf，该结构体是比较可信的，它对应的数据包是通过CRC校验正确的</li>
<li>sniffer_buf.cnt表示了该buf包含的包的个数，len的值由sniffer_buf.cnt决定</li>
<li>sniffer_buf.cnt==0表示此buf无效；否则len=5=+cnt*10</li>
<li>sniffer_buf.buf表示IEEE802.11包的前36字节。从成员sniffer_buf.lenseq[0]开始，每一个lenseq结构体表示一个包长信息</li>
<li>当sniffer_buf.cnt>1，由于该包是一个AMPDU，认为每个MPDU的包头基本是相同的，因此没有给出所有的MPDU包头，只给出了每个包的长度（从MAC包头开始到FCS）</li>
<li>该结构体中较为游泳的信息有：包长、包的发送者和接收者、包头长度</li>
</ul>
</li>
<li>LEN==12的情况

<ul>
<li>buf的数据是一个结构体RxControl，该结构体是不太可信的，它无法表示包所属的发送和接收者，也无法判断该报的包头长度</li>
<li>对于AMPDU包，也无法判断子包的个数和每个子包的长度</li>
<li>该结构体中较为有用的信息有：包长，rssi和FEC_CODING</li>
<li>RSSI和FEC_CODING可以用于评估是否是同一个设备所发</li>
</ul>
</li>
</ol>
</li>
</ol>


<h2>ESP8266信道的定义</h2>

<ol>
<li>虽然ESP8266支持soft-AP和station共存模式，但是ESP8266实际只有一个硬件通道。因此在soft-AP+station模式时，ESP8266 soft-AP会动态调整信道值与ESP8266 station一致
<img src="http://i.imgur.com/0l6M5tU.png" alt="ESP8266 soft-AP+station模式注意事项" /></li>
</ol>


<h2>AT 官方指令</h2>

<ol>
<li>如果开发板Flash为4Mbit，则无法使用固件升级功能（对应指令AT+CIUPDATE），只能采用non-boot的烧录方式。固件升级功能要求Flash容量为8Mbit或以上，采用boot mode的烧录方式</li>
<li>AT底层已经占用system_os_task优先级0和1，因此用户如基于AT开发，仅支持建立一个优先级为2的任务</li>
<li>波特率为115200</li>
<li>AT指令必须大写，以回车换行符结尾“\r\n”</li>
<li>AT Demo仅在ESP8266作为TCP client单连接或者UDP传输时，支持透传</li>
<li>目前AT Demo ESP8266仅支持一个TCP服务器，且必须使能多连接，即可连接多个TCP client
<img src="http://i.imgur.com/ZHMdvIV.png" alt="基础AT指令" />
<img src="http://i.imgur.com/KWLgQRV.png" alt="WiFi功能AT指令" />
<img src="http://i.imgur.com/qftT477.png" alt="TCP/IP相关AT指令" />
<img src="http://i.imgur.com/iY82gSq.png" alt="保存设置到Flash的AT指令" /></li>
</ol>


<h2>GPIO</h2>

<p><img src="http://i.imgur.com/DtNrGiF.png" alt="ESP8266-GPIO" /></p>

<ol>
<li>ESP8266共有16个通用IO，管脚的位置和管脚的名称分别为：</li>
<li>在四线（QUAD）模式flash下，有6个IO用于flash通讯；在两线（DUAL）模式flash下，有四个IO用于与flash通讯</li>
<li>与其他IO口不同，GPIO16不属于通用GPIO模块，它属于RTC模块，可以用来在深度睡眠时候唤醒整个芯片，可以配置为输入或者输出模式，但是无法触发IO中断

<ol>
<li>将GPIO16配置为输出模式：gpio16_output_conf(void)</li>
<li>从GPIO16输出高/低电平，需要先配置为输出模式：gpio16_output_set(uint8 value)</li>
<li>将GPIO16配置为输入模式:gpio16_input_conf(void)</li>
<li>读取GPIO16的输入电平状态，需要先配置为输入模式:gpio16_input_get(void)</li>
</ol>
</li>
</ol>


<h2>Free-RTOS</h2>

<ol>
<li>编程注意事项：

<ol>
<li>建议使用定时器实现长时间的查询功能，可将定时器设置为循环调用,注意：

<ol>
<li>定时器（freeRTOS timer或os_timer）执行函数内部请勿使用while（1）或其他能阻塞线程的方式延时，例如，不能在定时器回调中进行socket send操作，因为send函数会阻塞线程</li>
<li>定时器回调执行请勿超过15毫秒</li>
<li>os_timer_t建立的变量不能为局部变量，必须为全局变量、静态变量或os_malloc分配的指针</li>
</ol>
</li>
<li>从esp_iot_rtos_sdk_v1.2.0起，无需添加宏ICACHE_FLASH_ATTR，函数默认存放在CACHE区，中断函数也可以存放在CACHE区；如需将部分频繁调用的函数定义在RAM中，请在函数前面添加宏IRAM_ATTR</li>
<li>网络编程使用通用的socket编程，网络通信时，socket请勿绑定在同一个端口</li>
<li>RTOS SDK的系统任务最高优先级为14，创建任务的接口xTaskCreate为freeRTOS自带接口，使用下TaskCreate创建任务时，任务堆栈甚至范围为【176，512】

<ol>
<li>在任务内部如需使用长度超过60的大数组，建议使用os_malloc和os_free的方式操作，否则，大数组将占用任务的堆空间</li>
<li>SDK底层已占用部分优先级：watchdog task优先级14，pp task优先级13，高精度timer(ms)线程优先级12，TCP/IP task优先级10，freeRTOS timer优先级2，idle task优先级为0，pm task优先级1</li>
<li>可供用户线程使用的优先级为1~9</li>
<li>请勿修改FreeRTOSConfig.h，此处修改头文件并不能生效，设置由SDK库文件决定</li>
</ol>
</li>
</ol>
</li>
<li>esp_iot_rtos_sdk默认使用UART0打印调试信息，默认波特率为74880</li>
<li>esp_iot_rtos_sdk支持多线程，可以建立多个任务。创建任务的接口xTaskCreate为freeRTOS自带接口，使用xTaskCreate创建任务时，任务堆栈设置范围为[176,512]</li>
<li>RTC使用
<img src="http://i.imgur.com/qBVkRA7.png" alt="复位对RTC的影响" /></li>
</ol>


<h2>非OS SDK与RTOS SDK创建任务的方式对比</h2>

<figure class='code'><figcaption><span>非OS SDK创建任务</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#define Q_NUM （10）</span>
</span><span class='line'><span class="n">ETSEvent</span> <span class="n">test_q</span><span class="p">[</span><span class="n">Q_NUM</span><span class="p">];</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">test_task</span><span class="p">(</span><span class="n">ETSEvent</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">switch</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>      <span class="n">func1</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>      <span class="n">func2</span><span class="p">();</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>      <span class="n">func3</span><span class="p">();</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">default</span><span class="o">:</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">func_send_Sig</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">ETSSignal</span> <span class="n">sig</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>  <span class="n">system_os_post</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">task_ini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">system_os_task</span><span class="p">(</span><span class="n">test_task</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">test_q</span><span class="err">，</span><span class="n">Q_NUM</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">// test_q is the corresponding array of test_task.</span>
</span><span class='line'>  <span class="c1">// (2) is the priority of test_task.</span>
</span><span class='line'>  <span class="c1">// Q_NUM is the queue length of test_task.</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>RTOS SDK创建任务</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#define Q_NUM （10）</span>
</span><span class='line'><span class="n">xQueueHandle</span> <span class="n">test_q</span><span class="p">;</span>
</span><span class='line'><span class="n">xTaskHandle</span> <span class="n">test_task_hdl</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">test_task</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pvParameters</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">sig</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(;;){</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">pdTRUE</span> <span class="o">==</span> <span class="n">xQueueReceive</span><span class="p">(</span><span class="n">test_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="p">(</span><span class="n">portTickType</span><span class="p">)</span><span class="n">portMAX_DELAY</span><span class="p">)</span> <span class="p">){</span>
</span><span class='line'>          <span class="n">vTaskSuspendAll</span><span class="p">();</span>
</span><span class='line'>          <span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">sig</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>              <span class="n">func1</span><span class="p">();</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>              <span class="n">func2</span><span class="p">();</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">default</span><span class="o">:</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="n">free</span><span class="p">(</span><span class="n">sig</span><span class="p">);</span>
</span><span class='line'>          <span class="n">xTaskResumeAll</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">func_send_Sig</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">evt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">sizeif</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span><span class='line'>  <span class="o">*</span><span class="n">evt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">xQueueSend</span><span class="p">(</span><span class="n">test_q</span><span class="p">,</span><span class="o">&amp;</span><span class="n">evt</span><span class="p">,</span><span class="mi">10</span><span class="o">/</span><span class="n">portTick_RATE_MS</span><span class="p">)</span><span class="o">!=</span><span class="n">pdTRUE</span><span class="p">){</span>
</span><span class='line'>      <span class="n">os_printf</span><span class="p">(</span><span class="s">&quot;test_q is full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// It is the address of parameter that stored in test_q, so int *evt and int</span>
</span><span class='line'>  <span class="o">*</span><span class="n">sig</span> <span class="n">can</span> <span class="n">be</span> <span class="n">other</span> <span class="n">types</span><span class="p">.</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">task_ini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">test_q</span> <span class="o">=</span> <span class="n">xQueueCreate</span><span class="p">(</span><span class="n">Q_NUM</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
</span><span class='line'>  <span class="n">xTaskCreate</span><span class="p">(</span><span class="n">test_task</span><span class="p">,(</span><span class="kt">signed</span> <span class="n">portCHAR</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;test_task&quot;</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span><span class='line'>              <span class="o">&amp;</span><span class="n">test_task_hdl</span> <span class="p">);</span>
</span><span class='line'>  <span class="c1">// 512 means the heap size of this task, 512 * 4 byte.</span>
</span><span class='line'>  <span class="c1">// NULL is a pointer of parameter to test_task.</span>
</span><span class='line'>  <span class="c1">// (1) is the priority of test_task.</span>
</span><span class='line'>  <span class="c1">// test_task_hdl is the pointer of the task of test_task.</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>强制系统休眠</h2>

<ol>
<li>强制休眠接口调用后，并不会立即休眠，而是等到系统idle task执行时才进入休眠</li>
<li>Modem-sleep</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#define FPM_SLEEP_MAX_TIME 0xFFFFFFF</span>
</span><span class='line'><span class="n">wifi_station_disconnect</span><span class="p">();</span>
</span><span class='line'><span class="n">wifi_set_opmode</span><span class="p">(</span><span class="n">NULL_MODE</span><span class="p">);</span> <span class="c1">// set WiFi mode to null mode</span>
</span><span class='line'><span class="n">wifi_fpm_set_sleep_type</span><span class="p">(</span><span class="n">MODEM_SLEEP_T</span><span class="p">);</span> <span class="c1">// set modem sleep</span>
</span><span class='line'><span class="n">wifi_fpm_open</span><span class="p">();</span> <span class="c1">// enable force sleep</span>
</span><span class='line'><span class="n">wifi_fpm_do_sleep</span><span class="p">(</span><span class="n">FPM_SLEEP_MAX_TIME</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="n">wifi_fpm_do_wakeup</span><span class="p">();</span> <span class="c1">// wake up to use WiFi again</span>
</span><span class='line'><span class="n">wifi_fpm_close</span><span class="p">();</span> <span class="c1">// disable force sleep</span>
</span><span class='line'><span class="n">wifi_set_opmode</span><span class="p">(</span><span class="n">STATION_MODE</span><span class="p">);</span> <span class="c1">//set station mode</span>
</span><span class='line'><span class="n">wifi_station_connect</span><span class="p">();</span> <span class="c1">//connect to AP</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Light-sleep</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="kt">void</span> <span class="nf">fpm_wakup_cb_func1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="n">wifi_fpm_close</span><span class="p">();</span> <span class="c1">// disable force sleep function</span>
</span><span class='line'><span class="n">wifi_set_opmode</span><span class="p">(</span><span class="n">STATION_MODE</span><span class="p">);</span> <span class="c1">// set station mode</span>
</span><span class='line'><span class="n">wifi_station_connect</span><span class="p">();</span> <span class="c1">// connect to AP</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">user_func</span><span class="p">(...)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="n">wifi_station_disconnect</span><span class="p">();</span>
</span><span class='line'><span class="n">wifi_set_opmode</span><span class="p">(</span><span class="n">NULL_MODE</span><span class="p">);</span> <span class="c1">// set WiFi mode to null mode.</span>
</span><span class='line'><span class="n">wifi_fpm_set_sleep_type</span><span class="p">(</span><span class="n">LIGHT_SLEEP_T</span><span class="p">);</span> <span class="c1">// light sleep</span>
</span><span class='line'><span class="n">wifi_fpm_open</span><span class="p">();</span> <span class="c1">// enable force sleep</span>
</span><span class='line'><span class="n">wifi_fpm_set_wakeup_cb</span><span class="p">(</span><span class="n">fpm_wakup_cb_func1</span><span class="p">)</span><span class="err">；</span> <span class="c1">// Set wakeup callback</span>
</span><span class='line'><span class="n">wifi_fpm_do_sleep</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>spiffs文件系统应用</h2>

<h2>Windows下网络防火墙对TCP Server的屏蔽</h2>

<ol>
<li>Win+R，输入wf.msc,进入高级安全Windows防火墙</li>
<li>在<strong>入站规则</strong>右击新建规则</li>
<li>在<strong>规则类型</strong>对话框中选择“程序”</li>
<li>指名程序的路径</li>
<li>允许连接</li>
</ol>


<h2>PWM接口</h2>

<ol>
<li>ESP8266系统的PWM由<strong>FRC1</strong>在软件上实现，可实现同频率、不同占空比的多路PWM，可用来控制彩灯、蜂鸣器和电机等设备</li>
<li>FRC1是一个23bit的硬件定时器</li>
<li>使用NMI中断，更加精确</li>
<li>可扩展最多8路PWM信号</li>
<li>大于14bit的分辨率，最小分辨率45ns</li>
<li>PWM的时钟源由高速系统时钟提供，其频率高达80MHz。PWM通过预分频器将时钟源16分频，其输入时钟频率为5MHz。PWM通过FRC1来产生粗调定时，结合高速系统时钟的微调，可将分辨率提高到45ns</li>
<li>PWM时钟周期：100Hz~1KHz</li>
</ol>


<h2>UART接口</h2>

<ol>
<li>UART0默认情况下会在上电booting期间输出一些打印，此期间打印内容的波特率与所用的外部晶振频率有关。使用40M晶振时，该段打印波特率为115200。使用26M晶振时，该段打印波特率为74880</li>
<li>UART0和UART1各有一个长度为128Byte的硬件FIFO，读写FIFO都在同一个地址操作</li>
<li>如何屏蔽上电打印：使用uart的内部引脚交换功能，在初始化的时候，将U0TXD、U0RXD分别与U0RTS、U0CTS交换</li>
</ol>


<h2>Sleep接口</h2>

<p><img src="http://i.imgur.com/5VMutHe.png" alt="三种sleep模式的区别" />
1. 对于Modem-sleep和Light-sleep模式，SDK提供接口来使能睡眠模式，并由系统底层决定何时进入睡眠。在deep-sleep模式下，何时进入睡眠由用户控制，调用接口函数就可立即进入deep-sleep模式，
2. Modem-sleep仅工作在Station模式下，连接路由器后生效，ESP8266通过Wi-Fi的DTIM（Delivery Traffic Indication Message）Beacon机制与路由器保持连接。一般路由器的DTIM Beacon间隔为100ms~1000ms。在Modem-sleep模式下，ESP8266会在两次DTIM Beacon间隔时间内，关闭Wi-Fi模块电路，达到省电效果，在下次Beacon到来前自动唤醒。睡眠时间由路由器的DTIM Beacon时间决定。睡眠同时可以保持与路由器的Wi-Fi连接，并通过路由器接受来自手机或者服务器的交互信息。
3. 在Modem-sleep模式下，系统可以自动被唤醒，无需配置接口。Modem-sleep一般用于必须打开CPU的应用场景，例如PWM彩灯，需要CPU实时控制
4. Light-sleep的工作模式与Modem-sleep相似，不同的是，除了关闭Wi-Fi模块电路以为，在Light-sleep模式下，还会关闭时钟并暂停内部的CPU。在Wi-Fi连接后，并且CPU处于空闲状态时，会自动进入Light-sleep状态
5. 在Light-sleep模式下，CPU在暂停状态下不会响应来自外围硬件接口的信号与终端，因此需要配置通过外部GPIO信号将ESP8266唤醒，唤醒过程小于3ms。通过GPIO唤醒只能配置为<strong>电平触发模式</strong>。接口如下：<strong>void gpio_pin_wakeup_enable(uint32 i, GPIO_INT_TYPE intr_state);</strong>，其中i为唤醒功能的IO序号，intr_state为唤醒的触发模式，只能是GPIO_PIN_INTR_LOLEVEL或者GPIO_PIN_INTR_HILEVEL。
6. Light-sleep模式可用于需要保持与路由器的链接，可以实时响应路由器发来的数据的场合。并且在未收到命令时，CPU可以处于空闲状态。比如Wi-Fi开关的应用，大部分时间CPU都是空闲的，知道收到控制命令，CPU才需要进行GPIO的操作。若系统应用中有小于DTIM Beacon间隔时间的循环定时，系统将不能进入Light-sleep模式。
7. Deep-sleep由用户控制，调用接口函数就可立即进入Deep-sleep模式，在该模式下，芯片会断开所有的Wi-Fi连接与数据连接，进入睡眠模式，只有RTC模块仍然工作，负责芯片的定时唤醒。使用Deep-sleep必须将GPIO16与芯片EXT_RSTB管脚连接。
8. 配置Deep-sleep
<img src="http://i.imgur.com/4kuXKWI.png" alt="配置Deep-sleep" />
9. 在Deep-sleep状态下，可以通过外部IO在芯片EXT_RSTB管脚上产生一个低电平脉冲，芯片即可被唤醒并启动
10. Deep-sleep可以用于低功耗的传感器应用，或者大部分时间都不需要进行数据传输的情况。设备可以每隔一段时间从Deep-sleep状态醒来测量数据并上传，之后继续进入Deep-sleep。也可以将多个数据存储于RTC memory（RTC memory在Deep-sleep模式下任然可以保存数据），然后一次发送出去</p>

<h2>I2C接口</h2>

<ol>
<li>每个GPIO管脚内部都可以配置为开漏模式，从而可以灵活地将GPIO口用作I2C data或clock功能，同时芯片内部提供上拉电阻，以节省外部的上拉电阻。ESP8266作为I2C主机的SDA与SCL线波形由GPIO模拟产生，在SCL的上升沿之后SDA读取数据。SCL高低电平各保持5us，因此I2C时钟频率约为100KHz</li>
</ol>


<h2>OTA升级</h2>

<ol>
<li>在支持云端升级的软件中，boot.bin用于选择运行user1还是user2，而主程序由原本的eagle.flash.bin和eagle.iromtext.bin合并为user1.bin或user2.bin</li>
<li>system param区存了一个flag，标识启动时应当运行user1还是user2</li>
<li>启动时先运行boot，boot读取system param区中的flag，判断运行user1还是user2，然后到SPI Flash的对应位置去取</li>
<li>上传时，将新版本的 user1.bin 和 user2.bin 均上传⾄至服务器，由设备⾃自⾏行判断应该下载user1.bin 还是 user2.bin</li>
<li>user1.bin 和 user2.bin 是同样的可执⾏行软件，差别仅在于 flash 的存放位置不同</li>
<li><a href="http://iot.espressif.cn/#/">固件升级服务器网址</a></li>
<li>软件接口
<img src="http://i.imgur.com/M0E9B5D.png" alt="struct upgrade_server_info" />
<img src="http://i.imgur.com/CqL3FLL.png" alt="FOTA升级" /></li>
<li>上传服务器的固件版本命名形如：[v|b]Num1.Num2.Num3.tPTYPE([o|l|a|n])

<ol>
<li>v：表示发布版本，b：表示测试版本</li>
<li>版本值为：Num1<em>1000</em>1000 + Num2*1000 + Num3</li>
<li>Light ptype = 45772</li>
<li>Switch ptype = 23701</li>
<li>general ptype = 27388</li>
<li>o表示支持在线升级</li>
<li>l表示支持本地升级</li>
<li>a表示既支持在线升级，也支持本地升级</li>
<li>n表示不支持升级</li>
</ol>
</li>
</ol>


<h2>红外遥控</h2>

<ol>
<li>用于发送的载波可以采用以下几种方式：

<ol>
<li>I2S的BCK</li>
<li>WS脚产生38KHz载波</li>
<li>由GPIO中的sigma-delta功能在任意GPIO口产生载波，但sigma-delta产生的载波占空比约为20%，推荐使用MTMS脚（GPIO14），可产生准确的38KHz且占空比为50%的标准方波</li>
<li>通过系统FRC2的DSR TIMER接口，产生发送序列并驱动红外发送状态机。由于发送NEC红外码需要精确到us级的定时，所以在IR TX初始化时候，会先调用system_timer_reinit来提高FRC2 timer的精度。</li>
</ol>
</li>
<li>红外接收功能主要通过GPIO的边沿中断完成。读取系统时间，将两次时间相减可以得到波形持续时间。由软件状态机ir_intr_handler进行处理</li>
<li>红外接收通过GPIO中断实现，而同时，系统只能注册一个IO中断处理程序，如果有其他IO口也需要中断的话，请将这些中断在同一个处理程序中处理（判断中断源并相应处理）</li>
<li>在非OS版本的SDK中，进入中断处理（GPIO、UART、FRC等）直到退出中断的整个过程中，不可调用带ICACHE_FLASH_ATTR属性的函数，包括打印函数os_printf</li>
<li>硬件电路图</li>
</ol>


<p><img src="http://i.imgur.com/z3EJhmR.png" alt="硬件电路图" /></p>

<h2>SSL/TLS加密</h2>

<p><img src="http://i.imgur.com/YJZiqwC.png" alt="SSL协议报文" /></p>

<ol>
<li>SSL运行在TCP/IP层之上、应用层之下，为应用程序提供加密数据通道，它采用了RC4、MD5以及RSA等加密算法，使用40位的密钥。</li>
<li>HTTPS实际上就是HTTP over SSL，它使用默认端口443，而不是像HTTP那样使用端口80。</li>
<li>HTTPS协议使用SSL在发送方把原始数据进行加密，然后在接收方进行解密，加密和解密需要发送方和接收方通过交换公知的密钥来实现，因此，所传送的数据不容易被网络何可截获和解密
<img src="http://i.imgur.com/rahzPAL.png" alt="SSL通信过程" /></li>
<li>工作流程

<ol>
<li>建立安全能力。SSL捂手的第一阶段启动逻辑连接，建立这个连接的安全能力。首先客户机向服务器发出client hello消息并等待服务器响应，随后服务器向客户机返回server hello消息，对client hello消息中的信息进行确认。

<ol>
<li>Client hello消息包括：

<ol>
<li>客户端可以支持的SSL最高版本号</li>
<li>一个客户端生成的随机数，稍后用于生成“对话密钥”</li>
<li>一个确定会话的会话ID</li>
<li>一个客户端可以支持的密码套件列表，每个套件都以SSL开头，紧跟着的是密钥交换算法，用with这个词把密钥交换算法、机密算法、散列算法分开。例如：SSL_DHE_RSA_WITH_DES_CBC_SHA, 表示把DHE_RSA(带有RSA数字签名的暂时Diffie-HellMan)定义为密钥交换算法；把DES_CBC定义为加密算法；把SHA定义为散列算法。</li>
<li>一个客户端可以支持的压缩算法列表</li>
</ol>
</li>
<li>Server Hello消息包括

<ol>
<li>一个SSL版本号。去客户端支持的最高版本号和服务端支持的最高笨笨好中的较低者</li>
<li>一个服务器生成的随机数，稍后用于生成“对话密钥”</li>
<li>会话ID</li>
<li>从客户端的密码条件列表中选择的一个密码套件</li>
<li>从客户端的压缩方法的列表中选择的压缩方法</li>
</ol>
</li>
<li>这个阶段之后，客户端服务端知道了下列内容：

<ol>
<li>SSL版本</li>
<li>密钥交换、信息验证和加密算法</li>
<li>压缩方法</li>
<li>有关密钥生成的两个随机数</li>
</ol>
</li>
</ol>
</li>
<li>服务器鉴别与密钥交换。服务器启动SSL握手第二阶段，是本阶段所有消息的唯一发送方，客户机是所有消息的唯一接收方。该阶段分为4步

<ol>
<li>证书：服务器将数字证书和到根CA整个链发给客户端，使客户端能用服务器证书中的服务器公钥认证服务器</li>
<li>服务器密钥交换：这里视密钥交换算法而定</li>
<li>证书请求：服务端可能会要求客户自身进行验证</li>
<li>服务器握手完成</li>
</ol>
</li>
<li>客户机鉴别与密钥交换。客户机启动SSL握手第三阶段，是本阶段所有消息的唯一发送方，服务器是所有消息的唯一接收方。该阶段分为3歩：

<ol>
<li>证书：为了对服务器证明自身，客户要发送一个整数信息，这是可选的</li>
<li>客户机密钥交换：这里客户端将预备主密钥发送给服务端，注意这里会使用服务端的公钥进行加密</li>
<li>证书验证：对预备密钥和随机数进行签名</li>
</ol>
</li>
<li>完成，客户机启动SSL握手的第四阶段，是服务器结束。该阶段分成4歩</li>
</ol>
</li>
<li>SSL协议可分为两层：

<ol>
<li>SSL记录协议：它建立在可靠的传输协议之上，为高层协议提供数据封装、压缩、加密等基本功能的支持</li>
<li>SSL握手协议：它建立在SSL记录协议之上，用于在实际数据传输开始前，通讯双方进行身份认证、协商加密算法、交换密钥等</li>
</ol>
</li>
<li>ESP8266作为SSL server时，提供加密证书的制作脚本，生成SSL加密所需的头文件cert.h和private_key.h。CA认证功能默认关闭，用户可调用接口espconn_secure_ca_enable使能CA认证

<ol>
<li>证书制作：tool文件夹下，修改makefile.sh文件里面的IP地址为实际SSL 服务器的IP地址；然后./makefile.sh</li>
<li>开发者必须调用espconn_secure_set_default_certificate和espconn_secure_set_default_private_key传入证书和密钥</li>
<li>证书制作脚本makefile.sh生成默认SSL server证书由Espressif System颁发，并非由CA颁发。如果用户需要CA认证，请将运行脚本Makefile.sh生成的TLS.ca_x509.cer导入SSL client，并使用脚本make_cacert.py将CA文件生成eap_ca_cert.bin烧写到Flash对应的地址</li>
</ol>
</li>
<li>ESP8266作为SSL client时，可支持双向认证。CA认证功能默认关闭，用户可调用接口espconn_secure_ca_enable使能CA认证</li>
<li>ESP8266作为SSL client时支持证书认证功能，但此功能默认关闭，开发者可以调用接口espconn_secure_cert_req_enable使能证书认证，证书制作：

<ol>
<li>修改脚本makefile.sh，制作开发者自行签发的CA证书，例如，证书实例中的TLS.ca_x509.cer</li>
<li>使用签发的CA制作供SSL client使用的证书，例如，证书示例中的TLS.x509_1024.cer</li>
<li>去除制作SSL client使用的证书时所用的密钥，例如证书示例中的TLS.key_1024</li>
<li>将证书合成脚本make_cacert.py与CA文件放在同一目录下</li>
<li>运行脚本“make_cacert.py”将合成同一目录下的CA文件生成sap_ca_cert.bin，esp_ca_cert.bin的烧录位置由接口espconn_secure_ca_enable设置，用户可以自行定义</li>
<li>重命名证书名称（例如TLS.x509_1024.cer）；重命名密钥名称，改为private_key.key_1024。</li>
<li>将重命名后的文件，与脚本make_cert.py拷贝到同一目下下</li>
<li>运行脚本make_cert.py生成esp_cert_private_key.bin，esp_cert_private_key.bin的烧录位置由接口espconn_secure_cert_enable设置，用户可自行定义</li>
</ol>
</li>
<li>软件接口

<ol>
<li>SSL系列软件接口与普通TCP软件接口，在SDK底层是两套不同的处理流程，因此不能混用两种软件接口。SSL连接时，仅支持使用：

<ol>
<li>espconn_secure_XXX系列接口</li>
<li>espconn_regist_XXX系列注册回调的接口</li>
<li>espconn_port获得一个空闲的端口</li>
</ol>
</li>
</ol>
</li>
<li>在SSL中会使用密钥交换算法交换密钥；使用密钥对数据进行加密；使用散列算法对数据的完整性进行验证，使用数字证书证明自己的身份</li>
<li>SSL/TLS协议的基本思路是采用<strong>公钥加密法</strong>，也就是说，客户端先向服务器所要公钥，然后用公钥加密信息，服务器收到密文后，用自己的私钥解密。

<ol>
<li>如何保证公钥不被篡改？

<ul>
<li>将公钥放在数字证书中。只要证书时可信的，公钥就是可信的</li>
</ul>
</li>
<li>公钥加密计算量太大，如何减少耗用的时间？

<ul>
<li>每一次对话（session），客户端和服务器都生成一个“对话密钥”，用它来加密信息。由于“对话密钥”是对称加密，所以运算速度非常快，而服务器公钥只用于加密“对话密钥”本身，这样就减少了加密运算的消耗时间</li>
</ul>
</li>
<li>SSL/TLS协议的基本过程是这样的：

<ol>
<li>客户端向服务端索要并验证公钥</li>
<li>双方协商生成“对话密钥”</li>
<li>双方采用“对话密钥”进行加密通信</li>
</ol>
</li>
<li>为什么要用三个随机数来生成“会话密钥”？

<ul>
<li>不管是客户端还是服务器，都需要随机数，这样生成的密钥才不会每次都一样。由于SSL协议中证书是静态的，因此十分有必要引入一种随机因素来保证协商出来的密钥的随机性。对于RSA密钥交换算法来说，pre-master-key本身就是一个随机数，再加上hello消息中的随机，三个随机数通过一个密钥导出器最终导出一个对称密钥。pre master的存在在于SSL协议不信任每个主机都能产生完全随机的随机数，如果随机数不随机，那么pre master secret就有可能被猜出来，那么仅适用pre master secret作为密钥就不合适了，因此必须引入新的随机因素，那么客户端和服务器加上pre master secret三个随机数一同生成的密钥就不容易被猜出了，一个伪随机可能完全不随机，可是是三个伪随机就十分接近随机了，每增加一个自由度，随机性增加的可不是一。</li>
</ul>
</li>
</ol>
</li>
</ol>


<h2>Flash接口</h2>

<ol>
<li>一个扇区为4KB，从扇区0开始计数，以下接口可以读写整个Flash的任意区域

<ol>
<li>SpiFlashOpResult spi_flash_erase_sector (uint16 sec)：擦除Flash的某个扇区</li>
<li>SpiFlashOpResult spi_flash_write (uint32 des_addr,uint32 *src_addr, uint32 size)：将数据写入Flash</li>
<li>SpiFlashOpResult spi_flash_read(uint32 src_addr,uint32 * des_addr, uint32 size)：读取Flash中的数据</li>
</ol>
</li>
<li>在IoT_Demo中，将应用级数据存储在了0x3C000开始的4X4KB区域。例如，master_device_key.bin(用户参数，仅在需使用Espressif Cloud的情况需烧录)烧录在0x3E000地址</li>
<li>Flash擦除的最小单元为一个扇区，当存储在某个扇区的数据需要改写时，流程是先擦掉整个扇区，再将该扇区的数据写回去</li>
<li>读写保护的方法：

<ul>
<li>使用三个扇区，提供4KB的可靠存储空间

<ol>
<li>将sector1和sector2作为数据sector，轮流读写，时钟分别存放“本次”数据和“前一次”数据，确保了至少有一份数据存储安全；sector3作为flag sector，标志最新的数据存储sector。</li>
<li>初次上电时，数据存储在sector2中，从sector2中将数据读到RAM</li>
<li>第一次写数据时，将数据写入sector1.此时若突然掉电，sector1写入失败，sector2&amp;3数据未改变；重新上电时，仍是从sector2中读取数据，不影响使用。</li>
<li>改写sector3，将标志置为0，表示数据存于sector1.此时若突然掉电，sector3写入失败，sector1&amp;2均存有一份完整的数据，重新上电时，因为sector3无效，默认从sector2中读取数据，则仍能正常使用，只是未能包含掉电前对sector1写入的数据</li>
<li>再一次写数据时，先从sector3读取flag，若flag为0，则上次数据存于sector1，此次应将数据写入sector2；若flag为非0，则认为上次数据存于sector2，此时应将数据写入sector1.</li>
<li>写入sector1或者sector2完成后才会写sector3，重置flag</li>
</ol>
</li>
</ul>
</li>
</ol>


<h2>cJSON使用</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">cJSON</span> <span class="p">{</span>
</span><span class='line'> <span class="k">struct</span> <span class="n">cJSON</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span><span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span><span class='line'> <span class="k">struct</span> <span class="n">cJSON</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
</span><span class='line'> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'> <span class="kt">char</span> <span class="o">*</span><span class="n">valuestring</span><span class="p">;</span>
</span><span class='line'> <span class="kt">int</span> <span class="n">valueint</span><span class="p">;</span>
</span><span class='line'> <span class="kt">double</span> <span class="n">valuedouble</span><span class="p">;</span>
</span><span class='line'> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">cJSON</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>cJSON结构体为一个双向链表，并可通过child指针访问下一层</li>
<li>type变量决定数据类型，数据项可以是字符串可以是整形，也可以是浮点型。如果是整形的话可以从valueint取出，如果是浮点型的话可以从valuedouble取出，以此类推</li>
<li>主要函数说明

<ol>
<li>解析

<ol>
<li>cJSON_Parse函数负责解析JSON数据包，并按照cJSON结构体的结构序列化整个数据包。使用该函数会通过malloc函数在内存中开辟一个空间，使用完成需要手动释放</li>
<li>cJSON_GetObjectItem函数可以从cJSON结构体中查找某个子节点名称，如果查找成功，可把该子节点序列化到cJSON结构体中</li>
<li>如果需要使用cJSON结构体中的内容，可通过cJSON结构体中的valueint和valuestring取出有价值的内容</li>
<li>通过cJSON_Delete释放内存空间</li>
</ol>
</li>
<li>组装

<ol>
<li>cJSON_CreateObject函数可创建一个根数据项，之后便可向该根数据项中添加string或int等内容</li>
<li>cJSON_AddNumberToObject向节点中添加子节点</li>
<li>cJSON_Print函数可以打印跟数据项</li>
</ol>
</li>
</ol>
</li>
<li>使用例子：</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'> <span class="n">cJSON</span><span class="o">*</span> <span class="n">pRoot</span> <span class="o">=</span> <span class="n">cJSON_CreateObject</span><span class="p">();</span>
</span><span class='line'> <span class="n">cJSON</span><span class="o">*</span> <span class="n">pArray</span> <span class="o">=</span> <span class="n">cJSON_CreateArray</span><span class="p">();</span>
</span><span class='line'> <span class="n">cJSON_AddItemToObject</span><span class="p">(</span><span class="n">pRoot</span><span class="p">,</span> <span class="s">&quot;students_info&quot;</span><span class="p">,</span> <span class="n">pArray</span><span class="p">);</span>
</span><span class='line'> <span class="kt">char</span><span class="o">*</span> <span class="n">szOut</span> <span class="o">=</span> <span class="n">cJSON_Print</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="n">cJSON</span><span class="o">*</span> <span class="n">pItem</span> <span class="o">=</span> <span class="n">cJSON_CreateObject</span><span class="p">();</span>
</span><span class='line'> <span class="n">cJSON_AddStringToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;chenzhongjing&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddStringToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;sex&quot;</span><span class="p">,</span> <span class="s">&quot;male&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddNumberToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="mi">28</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddItemToArray</span><span class="p">(</span><span class="n">pArray</span><span class="p">,</span> <span class="n">pItem</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="n">pItem</span> <span class="o">=</span> <span class="n">cJSON_CreateObject</span><span class="p">();</span>
</span><span class='line'> <span class="n">cJSON_AddStringToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;fengxuan&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddStringToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;sex&quot;</span><span class="p">,</span> <span class="s">&quot;male&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddNumberToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddItemToArray</span><span class="p">(</span><span class="n">pArray</span><span class="p">,</span> <span class="n">pItem</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="n">pItem</span> <span class="o">=</span> <span class="n">cJSON_CreateObject</span><span class="p">();</span>
</span><span class='line'> <span class="n">cJSON_AddStringToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;tuhui&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddStringToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;sex&quot;</span><span class="p">,</span> <span class="s">&quot;male&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddNumberToObject</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_AddItemToArray</span><span class="p">(</span><span class="n">pArray</span><span class="p">,</span> <span class="n">pItem</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="kt">char</span><span class="o">*</span> <span class="n">szJSON</span> <span class="o">=</span> <span class="n">cJSON_Print</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span><span class='line'> <span class="n">cJSON_Delete</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span><span class='line'> <span class="c1">//free(szJSON);</span>
</span><span class='line'>
</span><span class='line'> <span class="n">pRoot</span> <span class="o">=</span> <span class="n">cJSON_Parse</span><span class="p">(</span><span class="n">szJSON</span><span class="p">);</span>
</span><span class='line'> <span class="n">pArray</span> <span class="o">=</span> <span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">pRoot</span><span class="p">,</span> <span class="s">&quot;students_info&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pArray</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>     <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kt">int</span> <span class="n">iCount</span> <span class="o">=</span> <span class="n">cJSON_GetArraySize</span><span class="p">(</span><span class="n">pArray</span><span class="p">);</span>
</span><span class='line'> <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iCount</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>     <span class="n">cJSON</span><span class="o">*</span> <span class="n">pItem</span> <span class="o">=</span> <span class="n">cJSON_GetArrayItem</span><span class="p">(</span><span class="n">pArray</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>     <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pItem</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>         <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">string</span> <span class="n">strName</span> <span class="o">=</span> <span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">;</span>
</span><span class='line'>     <span class="n">string</span> <span class="n">strSex</span> <span class="o">=</span> <span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;sex&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">valuestring</span><span class="p">;</span>
</span><span class='line'>     <span class="kt">int</span> <span class="n">iAge</span> <span class="o">=</span> <span class="n">cJSON_GetObjectItem</span><span class="p">(</span><span class="n">pItem</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">valueint</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="n">cJSON_Delete</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span><span class='line'> <span class="n">free</span><span class="p">(</span><span class="n">szJSON</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-12-06T18:06:10+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/12/03/power-design/">
		
			电源设计</a>
	</h2>
	<div class="entry-content">
		<h2>开关电源芯片</h2>

<ol>
<li>MP1584</li>
</ol>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-12-03T12:21:30+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>

<nav id="pagenavi">
    
    
        <a href="/posts/2" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2016

    suda-morris

Powered by Octopress-WenRis Group
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>