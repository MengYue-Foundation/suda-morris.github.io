
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>WenRis Blog</title>
	<meta name="author" content="suda-morris">

	
	<meta name="description" content="WenRis Blog">
	<meta name="keywords" content="C/C++,Python,Lua">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="WenRis Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//libs.baidu.com/jquery/1.9.1/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">WenRis Blog</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/blog/categories">Categories</a></li>
	<li><a href="/aboutme">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/blog/categories">Categories</a></li>
	<li><a href="/aboutme">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.baidu.com" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:suda-morris.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/Morris1106com" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/suda-morris" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.baidu.com" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:suda-morris.github.io">
	</form>
</nav>

</header>
	
		
	

	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/20/nand-cp-dot-c/">
		
			nand_cp.c</a>
	</h2>
	<div class="entry-content">
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;common.h&gt;</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_S3C64XX</span>
</span><span class='line'><span class="cp">#include &lt;asm/io.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;regs.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">nandll_read_page</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">large_block</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">page_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">large_block</span><span class="p">)</span>    
</span><span class='line'>      <span class="n">page_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">NAND_ENABLE_CE</span><span class="p">();</span>               <span class="cm">/*使能芯片*/</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">NFCMD_REG</span> <span class="o">=</span> <span class="n">NAND_CMD_READ0</span><span class="p">;</span>       <span class="cm">/*读命令*/</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Write Address */</span>
</span><span class='line'>        <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                  <span class="cm">/*页内起始地址*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">large_block</span><span class="p">)</span>
</span><span class='line'>          <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>            <span class="cm">/*页地址*/</span>
</span><span class='line'>  <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>  <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">large_block</span><span class="p">)</span>
</span><span class='line'>      <span class="n">NFCMD_REG</span> <span class="o">=</span> <span class="n">NAND_CMD_READSTART</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">NF_TRANSRnB</span><span class="p">();</span>                  <span class="cm">/*循环判断是否已经准备好*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">page_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">NFDATA8_REG</span><span class="p">;</span>               
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">NAND_DISABLE_CE</span><span class="p">();</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Read data from NAND.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">nandll_read_blocks</span> <span class="p">(</span><span class="n">ulong</span> <span class="n">dst_addr</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">large_block</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="n">uchar</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">dst_addr</span><span class="p">;</span>                     <span class="cm">/*这里buf就是指定的0x57e0 0000物理地址*/</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>  <span class="n">uint</span> <span class="n">page_shift</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">large_block</span><span class="p">)</span>
</span><span class='line'>      <span class="n">page_shift</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Read pages */</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mh">0x50000</span><span class="o">&gt;&gt;</span><span class="n">page_shift</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">buf</span><span class="o">+=</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">page_shift</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">nandll_read_page</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">large_block</span><span class="p">);</span>        <span class="cm">/*一次读取一个页*/</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">copy_uboot_to_ram</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">large_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>  <span class="n">vu_char</span> <span class="n">id</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>    <span class="n">NAND_ENABLE_CE</span><span class="p">();</span>               <span class="cm">/*使能芯片*/</span>
</span><span class='line'>    <span class="n">NFCMD_REG</span> <span class="o">=</span> <span class="n">NAND_CMD_READID</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NFADDR_REG</span> <span class="o">=</span>  <span class="mh">0x00</span><span class="p">;</span>              
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* wait for a while */</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
</span><span class='line'>  <span class="n">id</span> <span class="o">=</span> <span class="n">NFDATA8_REG</span><span class="p">;</span>
</span><span class='line'>  <span class="n">id</span> <span class="o">=</span> <span class="n">NFDATA8_REG</span><span class="p">;</span>               <span class="cm">/*取第二次的返回值*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mh">0x80</span><span class="p">)</span>                    <span class="c1">//判断读取的id是否大于0x80</span>
</span><span class='line'>      <span class="n">large_block</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* read NAND Block.</span>
</span><span class='line'><span class="cm">  * 128KB -&gt;240KB because of U-Boot size increase. by scsuh</span>
</span><span class='line'><span class="cm">  * So, read 0x3c000 bytes not 0x20000(128KB).</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">nandll_read_blocks</span><span class="p">(</span><span class="n">CFG_PHY_UBOOT_BASE</span><span class="p">,</span> <span class="mh">0x50000</span><span class="p">,</span> <span class="n">large_block</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-20T15:17:22+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/kdm/'>kdm</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/u-boot/'>u-boot</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/19/cpu-init-dot-s/">
		
			cpu_init.S</a>
	</h2>
	<div class="entry-content">
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;config.h&gt;                      </span><span class="cm">/*里面包含mini6410.h*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#include &lt;s3c6410.h&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">mem_ctrl_asm_init</span>
</span><span class='line'><span class="nl">mem_ctrl_asm_init</span><span class="p">:</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_MEM_SYS_CFG</span>          <span class="err">@</span><span class="n">Memory</span> <span class="n">sussystem</span> <span class="n">address</span> <span class="mh">0x7e00f120</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xd</span>                     <span class="err">@</span> <span class="n">Xm0CSn2</span> <span class="o">=</span> <span class="n">NFCON</span> <span class="n">CS0</span><span class="p">,</span> <span class="n">Xm0CSn3</span> <span class="o">=</span> <span class="n">NFCON</span> <span class="n">CS1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_DMC1_BASE</span>            <span class="err">@</span><span class="n">DMC1</span> <span class="n">base</span> <span class="n">address</span> <span class="mh">0x7e001000</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 1. 使dramc进入&quot;config&quot;状态 */</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x04</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_MEMC_CMD</span><span class="p">]</span> 
</span><span class='line'>
</span><span class='line'><span class="cm">/* 2. 设置timing parameter*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_REFRESH_PRD</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_REFRESH_PRD</span><span class="p">]</span>      <span class="cm">/*刷新周期7.8us */</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_CAS_LATENCY</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_CAS_LATENCY</span><span class="p">]</span>      <span class="cm">/*CAS Latency:指的是内存存取数据所需的延迟时间，简单的说，就是内存接到CPU的指令后的反应速度。一般的参数值是2和3*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_DQSS</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_DQSS</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_MRD</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_MRD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_RAS</span>                      <span class="cm">/*RAS=45ns*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_RAS</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_RC</span>                       <span class="cm">/*RC=68ns*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_RC</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_RCD</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_schedule_RCD</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_RCD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_RFC</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_schedule_RFC</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_RFC</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_RP</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_schedule_RP</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_RP</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_RRD</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_RRD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_WR</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_WR</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_WTR</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_WTR</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_XP</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_XP</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_XSR</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_XSR</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_ESR</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_ESR</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 3.设置chip configuration*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC1_MEM_CFG</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_MEMORY_CFG</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC1_MEM_CFG2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_MEMORY_CFG2</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC1_CHIP0_CFG</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_CHIP_0_CFG</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_32_CFG</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_USER_CONFIG</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 4. 初始化sdram */</span>
</span><span class='line'>  <span class="err">@</span><span class="n">DMC0</span> <span class="n">DDR</span> <span class="n">Chip</span> <span class="mi">0</span> <span class="n">configuration</span> <span class="n">direct</span> <span class="n">command</span> <span class="n">reg</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_NOP0</span>                                   <span class="cm">/* NOP*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">Precharge</span> <span class="n">All</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_PA0</span>                                    <span class="cm">/*precharge*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">Auto</span> <span class="n">Refresh</span>    <span class="mi">2</span> <span class="n">time</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_AR0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>                   <span class="cm">/*auto refresh*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">MRS</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_mDDR_EMR0</span>                              <span class="cm">/*EMRS*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">Mode</span> <span class="n">Reg</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_mDDR_MR0</span>                               <span class="cm">/*MRS*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_SMDK6410_X5A</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC1_CHIP1_CFG</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_CHIP_1_CFG</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">DMC0</span> <span class="n">DDR</span> <span class="n">Chip</span> <span class="mi">0</span> <span class="n">configuration</span> <span class="n">direct</span> <span class="n">command</span> <span class="n">reg</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_NOP1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">Precharge</span> <span class="n">All</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_PA1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">Auto</span> <span class="n">Refresh</span>    <span class="mi">2</span> <span class="n">time</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_AR1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">MRS</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_mDDR_EMR1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">Mode</span> <span class="n">Reg</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_mDDR_MR1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 5. 使dramc进入&quot;ready&quot;状态  */</span>
</span><span class='line'>  <span class="err">@</span><span class="n">Enable</span> <span class="n">DMC1</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_MEMC_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="nl">check_dmc1_ready</span><span class="p">:</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_MEMC_STATUS</span><span class="p">]</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r2</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x3</span>
</span><span class='line'>  <span class="n">and</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">cmp</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">check_dmc1_ready</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>                             <span class="cm">/*内存控制器初始化完毕，返回*/</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Below code is for ARM926EJS and ARM1026EJS */</span>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">cleanDCache</span>
</span><span class='line'><span class="nl">cleanDCache</span><span class="p">:</span>
</span><span class='line'>  <span class="n">mrc</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">c7</span><span class="p">,</span> <span class="n">c10</span><span class="p">,</span> <span class="mi">3</span>   <span class="cm">/* test/clean D-Cache */</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">cleanDCache</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">cleanFlushDCache</span>
</span><span class='line'><span class="nl">cleanFlushDCache</span><span class="p">:</span>
</span><span class='line'>  <span class="n">mrc</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">c7</span><span class="p">,</span> <span class="n">c14</span><span class="p">,</span> <span class="mi">3</span>   <span class="cm">/* test/cleanflush D-Cache */</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">cleanFlushDCache</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">cleanFlushCache</span>
</span><span class='line'><span class="nl">cleanFlushCache</span><span class="p">:</span>
</span><span class='line'>  <span class="n">mrc</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">c7</span><span class="p">,</span> <span class="n">c14</span><span class="p">,</span> <span class="mi">3</span>   <span class="cm">/* test/cleanflush D-Cache */</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">cleanFlushCache</span>
</span><span class='line'>  <span class="n">mcr</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c7</span><span class="p">,</span> <span class="n">c5</span><span class="p">,</span> <span class="mi">0</span>    <span class="cm">/* flush I-Cache */</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">ltorg</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-19T17:28:03+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/kdm/'>kdm</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/u-boot/'>u-boot</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/18/lowlevel-init-dot-s/">
		
			lowlevel_init.S</a>
	</h2>
	<div class="entry-content">
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;config.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;version.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;s3c6410.h&gt;</span>
</span><span class='line'><span class="cp">#include &quot;mini6410_val.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">_TEXT_BASE</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">TEXT_BASE</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">lowlevel_init</span>
</span><span class='line'><span class="nl">lowlevel_init</span><span class="p">:</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r12</span><span class="p">,</span> <span class="n">lr</span>                        <span class="cm">/*bl指令会把下一条指令的地址赋给lr，在这里保存lr是为了最后能够成功地函数返回*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* LED on only #8 */</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_GPIO_BASE</span>        <span class="cm">/*Regs.h中的宏定义，就是s3c6410.h中的宏定义*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x55540000</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPNCON_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPN15~GPN9均是输出(01),GPN0~GPN8均是输入(00)*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x55555555</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPNPUD_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPN0~GPN15均是下拉使能*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0xf000</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPNDAT_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPN15~GPN12输出高电平，GPN10~11输出低电平*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_GPIO_BASE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPECON_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPE0设置为输出，GPE1~GPE15设置为输入*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPEDAT_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPE0输出低电平,LCD_BL_EN=0*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_GPIO_BASE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x2A5AAAAA</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPPCON_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPP15设置为输入，GPP11~GPP10设置为输出，其余设置为片内外设功能*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPPDAT_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPP11和GPP10输出低电平*/</span>
</span><span class='line'>  
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x55555555</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">MEM1DRVCON_OFFSET</span><span class="p">]</span>  <span class="cm">/*由于ddr芯片的工作电压在1.8V，所以驱动电流设置为7mA*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Disable Watchdog */</span>              <span class="cm">/*关闭片内看门狗*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x7e000000</span>        <span class="err">@</span><span class="mh">0x7e004000</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x4000</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span> <span class="n">External</span> <span class="n">interrupt</span> <span class="n">pending</span> <span class="n">clear</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="p">(</span><span class="n">ELFIN_GPIO_BASE</span><span class="o">+</span><span class="n">EINTPEND_OFFSET</span><span class="p">)</span>  <span class="cm">/*EINTPEND*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>                     <span class="cm">/*读一次外部中断就能清楚外部中断信号*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_VIC0_BASE_ADDR</span>   <span class="err">@</span><span class="mh">0x71200000</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_VIC1_BASE_ADDR</span>   <span class="err">@</span><span class="mh">0x71300000</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span> <span class="n">Disable</span> <span class="n">all</span> <span class="n">interrupts</span> <span class="p">(</span><span class="n">VIC0</span> <span class="n">and</span> <span class="n">VIC1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">mvn</span>  <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>                     <span class="cm">/*0取反为全1*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">oINTMSK</span><span class="p">]</span>                <span class="cm">/*禁用所有中断*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="n">oINTMSK</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span> <span class="n">Set</span> <span class="n">all</span> <span class="n">interrupts</span> <span class="n">as</span> <span class="n">IRQ</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">oINTMOD</span><span class="p">]</span>                <span class="cm">/*将所有中断设置为IRQ中断*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="n">oINTMOD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span> <span class="n">Pending</span> <span class="n">Interrupt</span> <span class="n">Clear</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>                     <span class="cm">/*清除所有当前激活的中断服务程序的地址*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">oVECTADDR</span><span class="p">]</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="n">oVECTADDR</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* init system clock */</span>
</span><span class='line'>  <span class="n">bl</span> <span class="n">system_clock_init</span>              <span class="cm">/*初始化系统时钟*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* for UART */</span>
</span><span class='line'>  <span class="n">bl</span> <span class="n">uart_asm_init</span>                  <span class="cm">/*初始化串口*/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_NAND)</span>
</span><span class='line'>  <span class="cm">/* simple init for NAND */</span>
</span><span class='line'>  <span class="n">bl</span> <span class="n">nand_asm_init</span>                  <span class="cm">/*nand flash初始化*/</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">mem_ctrl_asm_init</span>                <span class="cm">/*内存控制器初始化,函数位于/CPU/s3c6410/CPU_init.S*/</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="p">(</span><span class="n">ELFIN_CLOCK_POWER_BASE</span><span class="o">+</span><span class="n">RST_STAT_OFFSET</span><span class="p">)</span>      <span class="cm">/*7e00_f904-&gt;RST_STAT*/</span>
</span><span class='line'>    <span class="n">ldr</span>     <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">bic</span>     <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xfffffff7</span>
</span><span class='line'>    <span class="n">cmp</span>     <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x8</span>                    <span class="cm">/*bit[3]=1,表明从SLEEP状态中唤醒*/</span>
</span><span class='line'>    <span class="n">beq</span>     <span class="n">wakeup_reset</span>
</span><span class='line'>
</span><span class='line'><span class="mi">1</span><span class="o">:</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_UART_BASE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x4b4b4b4b</span>                    <span class="cm">/*通过串口发送字母“K”*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UTXH_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">lr</span><span class="p">,</span> <span class="n">r12</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>                         <span class="cm">/*lowlevel_init结束，返回*/</span>
</span><span class='line'>
</span><span class='line'><span class="nl">wakeup_reset</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="p">(</span><span class="n">ELFIN_CLOCK_POWER_BASE</span><span class="o">+</span><span class="n">WAKEUP_STAT_OFFSET</span><span class="p">)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>                     <span class="cm">/*Clear wakeup status register*/</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*LED test*/</span>
</span><span class='line'>    <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_GPIO_BASE</span>
</span><span class='line'>    <span class="n">ldr</span>     <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x3000</span>
</span><span class='line'>    <span class="n">str</span>     <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPNDAT_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/*Load return address and jump to kernel*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="p">(</span><span class="n">ELFIN_CLOCK_POWER_BASE</span><span class="o">+</span><span class="n">INF_REG0_OFFSET</span><span class="p">)</span>       <span class="cm">/*0x4c00_0a00-&gt;INFORM0*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>                                         <span class="cm">/* r1 = physical address of s3c6400_cpu_resume function*/</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">r1</span>                                             <span class="cm">/*Jump to kernel (sleep-s3c6400.S)*/</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * system_clock_init: Initialize core clock and bus clock.</span>
</span><span class='line'><span class="cm"> * void system_clock_init(void)</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nl">system_clock_init</span><span class="p">:</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_CLOCK_POWER_BASE</span> <span class="err">@</span><span class="mh">0x7e00f000</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef   CONFIG_SYNC_MODE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r2</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x40</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>              
</span><span class='line'>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x80</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>          <span class="cm">/*bit[6],bit[7]都置1，设置成同步模式*/</span>
</span><span class='line'>
</span><span class='line'><span class="nl">check_syncack</span><span class="p">:</span>                             <span class="cm">/*等待时钟完成同步*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="mh">0xf00</span>
</span><span class='line'>  <span class="n">and</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>                           <span class="cm">/*只查看bit[8]~bit[11]，这几位是SYNC mode相应位，只读,只有在AYNC模式才能读1*/</span>
</span><span class='line'>  <span class="n">cmp</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xf00</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">check_syncack</span>
</span><span class='line'><span class="cp">#else                                        </span><span class="cm">/* 否则配置成异步时钟模式 */</span><span class="cp"></span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xC0</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x40</span>                      <span class="cm">/*bit[6]置1，bit[7]清0*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>          
</span><span class='line'>
</span><span class='line'><span class="nl">wait_for_async</span><span class="p">:</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">and</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xf00</span>
</span><span class='line'>  <span class="n">cmp</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">wait_for_async</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x40</span>                      <span class="cm">/*bit[6]清0*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xff00</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xff</span>                      <span class="cm">/*设置各PLL的LOCK_TIME,使用最大值*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">APLL_LOCK_OFFSET</span><span class="p">]</span>           <span class="cm">/*APLL_LOCK，供cpu使用*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">MPLL_LOCK_OFFSET</span><span class="p">]</span>           <span class="cm">/*MPLL_LOCK，供AHB(存储/中断/lcd等控制器)/APB(看门狗，定时器，SD等)总线上的设备使用*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">EPLL_LOCK_OFFSET</span><span class="p">]</span>           <span class="cm">/*EPLL_LOCK，供UART,IIS,IIC使用*/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_CLKSRC_CLKUART)</span>
</span><span class='line'>  <span class="n">ldr</span>      <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CLK_DIV2_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x70000</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x30000</span>                   <span class="cm">/*CLK_DIV2的bit[16]~bit[19]即UART_RATIO,设置为3,CLKUART(66.5Mhz)=CLKUART_input(532/2=266Mhz)/(UART_RATIO(3)+1)*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CLK_DIV2_OFFSET</span><span class="p">]</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>      <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CLK_DIV0_OFFSET</span><span class="p">]</span>        <span class="cm">/*Set Clock Divider*/</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x30000</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xff00</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xff</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="n">CLK_DIV_VAL</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CLK_DIV0_OFFSET</span><span class="p">]</span>            <span class="cm">/*设置时钟的分频系数*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">APLL_VAL</span>                       <span class="cm">/*设置APLL_MDIV=266,APLL_PDIV=3,APLL_SDIV=1*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">APLL_CON_OFFSET</span><span class="p">]</span>            <span class="cm">/*FOUT = MDIV X FIN / (PDIV X 2^SDIV) = 266*12/(3*2^1) = 532MHz*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">MPLL_VAL</span>                       <span class="cm">/*设置MPLL_MDIV=266,MPLL_PDIV=3,MPLL_SDIV=1*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">MPLL_CON_OFFSET</span><span class="p">]</span>            <span class="cm">/*FOUT = MDIV X FIN / (PDIV X 2^SDIV) = 266*12/(3*2^1) = 532MHz*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x80200102</span>                        <span class="cm">/*设置EPLL_MDIV=32,EPLL_PDIV=1,EPLL_SDIV=2*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">EPLL_CON0_OFFSET</span><span class="p">]</span>           <span class="cm">/*FOUT = (MDIV+KDIV/2^16) X FIN / (PDIV X 2^SDIV) = (32+0)*12/(1*2^2) = 96MHz*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x0</span>                           <span class="cm">/*设置EPLL_KDIV=0*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">EPLL_CON1_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CLK_SRC_OFFSET</span><span class="p">]</span>         <span class="cm">/*读取CLK_SRC寄存器的值*/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_CLKSRC_CLKUART)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x2007</span>                                    
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x7</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>                           <span class="cm">/*APLL,MPLL,EPLL的时钟源选择各自的Fout；UART的时钟源选择DOUT_MPLL*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CLK_SRC_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x10000</span>                     <span class="cm">/*等待所有时钟稳定，至少200us*/</span>
</span><span class='line'><span class="mi">1</span><span class="o">:</span> <span class="n">subs</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mi">1</span>                     <span class="cm">/*非0则跳转*/</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="mi">1</span><span class="n">b</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_SYNC_MODE                      </span><span class="cm">/* Synchronization for VIC port */</span><span class="cp"></span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x20</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x20</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>                             <span class="cm">/*系统时钟初始化完成，返回*/</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * uart_asm_init: Initialize UART in asm mode, 115200bps fixed.</span>
</span><span class='line'><span class="cm"> * void uart_asm_init(void)</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nl">uart_asm_init</span><span class="p">:</span>
</span><span class='line'>  <span class="cm">/*配置GPIO的功能为串口UART*/</span>
</span><span class='line'>  <span class="cm">/*UART0_RXD=GPA0,UART0_TXD=GPA1,UART1_RXD=GPA4,UART1_TXD=GPA5*/</span>
</span><span class='line'>  <span class="cm">/*UART2_RXD=GPB0,UART2_TXD=GPB1,UART3_RXD=GPB2,UART3_TXD=GPB3*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_GPIO_BASE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x22222222</span>
</span><span class='line'>  <span class="n">str</span>      <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPACON_OFFSET</span><span class="p">]</span>      <span class="cm">/*配置UART0和UART1使用的GPIO引脚,UART0和UART1具有流控功能(GPA0~GPA7)*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x2222</span>
</span><span class='line'>  <span class="n">str</span>      <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPBCON_OFFSET</span><span class="p">]</span>      <span class="cm">/*配置UART2和UART3使用的GPIO引脚,UART2和UART3不具有流控功能(GPB0~GPB3)*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_UART_CONSOLE_BASE</span>        <span class="cm">/*ELFIN_UART_CONSOLE_BASE=0x7F005000,即UART0*/</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UFCON_OFFSET</span><span class="p">]</span>               <span class="cm">/*禁止使用FIFO*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UMCON_OFFSET</span><span class="p">]</span>               <span class="cm">/*禁止流控，调制解调功能*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x3</span>                         <span class="cm">/*配置UART0：数据位:8, 无校验, 停止位: 1, 8n1*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">ULCON_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*设置波特率 */</span>
</span><span class='line'><span class="cm">/*DIV_VAL = (EXT_UCLK1 / (bps x 16 ) ) - 1 = (66500000/(115200x16))-1 = 35.08*/</span>
</span><span class='line'><span class="cm">/*DIV_VAL = 35.08 = UBRDIVn + (num of 1’s in UDIVSLOTn)/16*/</span>
</span><span class='line'><span class="cp">#if defined(CONFIG_CLKSRC_CLKUART)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0xe45</span>                         <span class="cm">/* UARTCLK_SRC=11 =&gt; EXT_UCLK1,EXT_UCLK1由MPLL或者EPLL分频得到,这里是66.5MHz。串口数据接收发送采用轮训或者中断的方式*/</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x245</span>                         <span class="cm">/* UARTCLK_SRC=x0 =&gt; PCLK */</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UCON_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_UART_50)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x1A</span>
</span><span class='line'><span class="cp">#elif defined(CONFIG_UART_66)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x23</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x1A</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UBRDIV_OFFSET</span><span class="p">]</span>          <span class="cm">/*UBRDIV0=35*/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_UART_50)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x3</span>
</span><span class='line'><span class="cp">#elif defined(CONFIG_UART_66)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x0080</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x3</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UDIVSLOT_OFFSET</span><span class="p">]</span>            <span class="cm">/*UDIVSLOT0中有1个‘1’*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x4f4f4f4f</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UTXH_OFFSET</span><span class="p">]</span>                <span class="cm">/*UART0串口发送字母‘O’*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>                             <span class="cm">/*串口配置结束，返回*/</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Nand Interface Init for SMDK6410 </span>
</span><span class='line'><span class="cm"> * /</span>
</span><span class='line'><span class="cm">nand_asm_init:                               /*初始化NandFlash控制器*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_NAND_BASE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">NFCONF_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x70</span>                      <span class="cm">/*TWRPH1=7*/</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x7700</span>                        <span class="cm">/*TWRPH0=7,TACLS=7*/</span>
</span><span class='line'>  <span class="n">str</span>     <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">NFCONF_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">NFCONT_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x03</span>                      <span class="cm">/*使能NandFlash控制器*/</span>
</span><span class='line'>  <span class="n">str</span>     <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">NFCONT_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>                             <span class="cm">/*NandFlash控制器初始化完毕，返回*/</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_ENABLE_MMU</span>
</span><span class='line'>                                          <span class="cm">/*为Uboot服务的MMU页表在这里创建*/</span>
</span><span class='line'>                                          <span class="cm">/* form a first-level section entry */</span>
</span><span class='line'><span class="cm">/*定义一个可以生成描述符的宏*/</span>
</span><span class='line'><span class="cm">/*描述符的最低两位00为无效，01为二级页表方式（由高地址12位的一级页表(TTB的高18位指定的虚拟基地址)位置取出对应二级页表(coarse page table)的基地址，由中间地址8位的二级页表取出对应4KB页表（small page）的基地址，最后由低12为地址的页表取出最终的内存值），10为一级页表方式（如果bit18为0，则为section，bit18为1，则为supersection），11保留。*/</span>
</span><span class='line'><span class="p">.</span><span class="n">macro</span> <span class="n">FL_SECTION_ENTRY</span> <span class="n">base</span><span class="p">,</span><span class="n">ap</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">b</span>     
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="p">(</span><span class="err">\</span><span class="n">base</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="err">\</span><span class="n">ap</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> \
</span><span class='line'>        <span class="p">(</span><span class="err">\</span><span class="n">d</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="err">\</span><span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="err">\</span><span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="n">endm</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*按照section方式映射，每个section必须是1M，占20位地址，这里共256M物理内存，映射到整个4G地址空间，所以共有4096（0x1000）个描述符。虚拟地址的高12位（4096）作为描述符位置，低20位作为section里面的地址*/</span>
</span><span class='line'><span class="p">.</span><span class="n">section</span> <span class="p">.</span><span class="n">mmudata</span><span class="p">,</span> <span class="s">&quot;a&quot;</span>                        <span class="cm">/*指名该段的名称是.mmudata,在u-boot.lds中会为该段分配具体的空间，.a表示这是一个需要鉴权的段*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">align</span> <span class="mi">14</span>                             <span class="cm">/*对齐到0x4000*/</span>
</span><span class='line'>  <span class="c1">// the following alignment creates the mmu table at address 0x4000.</span>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">mmu_table</span>                       <span class="cm">/*mmu页表地址需要在start.S中告诉CPU以启动MMU，因此需要声明为全局变量*/</span>
</span><span class='line'><span class="nl">mmu_table</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">set</span> <span class="n">__base</span><span class="p">,</span><span class="mi">0</span>
</span><span class='line'>  <span class="c1">// 1:1 mapping for debugging</span>
</span><span class='line'>  <span class="p">.</span><span class="n">rept</span> <span class="mh">0xA00</span>                               <span class="cm">/*共2048个描述符*/</span>
</span><span class='line'>  <span class="n">FL_SECTION_ENTRY</span> <span class="n">__base</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>           <span class="cm">/*ap为3表示读允许,d为0表示这些描述符都属于domain0，domain用来做权限控制,c和b为0表示共享，互斥读写*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">set</span> <span class="n">__base</span><span class="p">,</span><span class="n">__base</span><span class="o">+</span><span class="mi">1</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// access is not allowed.</span>
</span><span class='line'>  <span class="p">.</span><span class="n">rept</span> <span class="mh">0xC00</span> <span class="o">-</span> <span class="mh">0xA00</span>                        <span class="cm">/*共512个描述符*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="mh">0x00000000</span>                      <span class="cm">/*ap为0表示不允许访问*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 128MB for SDRAM 0xC0000000 -&gt; 0x50000000</span>
</span><span class='line'>  <span class="p">.</span><span class="n">set</span> <span class="n">__base</span><span class="p">,</span> <span class="mh">0x500</span>
</span><span class='line'>  <span class="p">.</span><span class="n">rept</span> <span class="mh">0xC80</span> <span class="o">-</span> <span class="mh">0xC00</span>                        <span class="cm">/*共128个描述符*/</span>
</span><span class='line'>  <span class="n">FL_SECTION_ENTRY</span> <span class="n">__base</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>           <span class="cm">/*ap为3表示读允许,d为0表示这些描述符都属于domain0，domain用来做权限控制,c和b为1表示内存输入输出都为回写模式*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">set</span> <span class="n">__base</span><span class="p">,</span><span class="n">__base</span><span class="o">+</span><span class="mi">1</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// access is not allowed.</span>
</span><span class='line'>  <span class="p">.</span><span class="n">rept</span> <span class="mh">0x1000</span> <span class="o">-</span> <span class="mh">0xc80</span>                       <span class="cm">/*共896个描述符*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="mh">0x00000000</span>                      <span class="cm">/*ap为0表示不允许访问*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-18T15:38:36+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/kdm/'>kdm</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/u-boot/'>u-boot</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/17/mini6410-dot-h/">
		
			Mini6410.h</a>
	</h2>
	<div class="entry-content">
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#define CONFIG_S3C6410     1       </span><span class="cm">/* in a SAMSUNG S3C6410 SoC */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CONFIG_S3C64XX       1       </span><span class="cm">/* in a SAMSUNG S3C64XX Family  */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CONFIG_MINI6410      1       </span><span class="cm">/* in a FriendlyARM MINI6410 Board */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CFG_UBOOT_SIZE       (2*1024*1024)   </span><span class="cm">/*定义Uboot大小为2M字节*/</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_ENABLE_MMU    </span><span class="cm">/*在Uboot中开启MMU,目的为了开启DCache来提高运行速度*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define MEMORY_BASE_ADDRESS  0x50000000  </span><span class="cm">/*DDR起始地址*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_PHY_UBOOT_BASE   MEMORY_BASE_ADDRESS + 0x7e00000 </span><span class="cm">/*Uboot的物理地址0x57e00000*/</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_ENABLE_MMU</span>
</span><span class='line'><span class="cp">#define CFG_UBOOT_BASE       0xc7e00000</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="cp">#define CFG_UBOOT_BASE       0x57e00000</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CFG_ENV_OFFSET       0x00040000      </span><span class="cm">/*Uboot中环境变量偏移地址*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_ENV_SIZE     0x20000         </span><span class="cm">/* Total Size of Environment Sector */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/***********************************************Size of malloc() pool********************************/</span>
</span><span class='line'><span class="cp">#define CFG_MALLOC_LEN       (CFG_ENV_SIZE + 1024*1024)</span>
</span><span class='line'><span class="cp">#define CFG_GBL_DATA_SIZE    128 </span><span class="cm">/* size in bytes reserved for initial data */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CFG_STACK_SIZE       512*1024</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/****************************************NANDFlash宏定义*********************************************/</span>
</span><span class='line'><span class="cp">#define CFG_MAX_NAND_DEVICE     1</span>
</span><span class='line'><span class="cp">#define CFG_NAND_BASE           (0x70200010)</span>
</span><span class='line'><span class="cp">#define NAND_MAX_CHIPS          1</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define NAND_DISABLE_CE()    (NFCONT_REG |= (1 &lt;&lt; 1))</span>
</span><span class='line'><span class="cp">#define NAND_ENABLE_CE() (NFCONT_REG &amp;= ~(1 &lt;&lt; 1))</span>
</span><span class='line'><span class="cp">#define NF_TRANSRnB()        do { while(!(NFSTAT_REG &amp; (1 &lt;&lt; 0))); } while(0)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CFG_NAND_SKIP_BAD_DOT_I  1  </span><span class="cm">/* &quot;.i&quot; read skips bad blocks   */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define  CFG_NAND_WP     1</span>
</span><span class='line'><span class="cp">#define CFG_NAND_YAFFS_WRITE 1  </span><span class="cm">/* support yaffs write */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(FRIENDLYARM_BOOT_MEDIA_NAND) </span><span class="cm">/*启动介质是NandFlash*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CONFIG_BOOT_NAND</span>
</span><span class='line'><span class="cp">#elif defined(FRIENDLYARM_BOOT_MEDIA_SD) </span><span class="cm">/*启动介质是SD Card*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CONFIG_BOOT_MOVINAND</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="cp">#error Boot media not defined</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define  CONFIG_NAND</span>
</span><span class='line'><span class="cp">#define CONFIG_MOVINAND</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_MEMORY_UPPER_CODE         </span><span class="cm">/*用户内存位于代码之上*/</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#undef CONFIG_USE_IRQ                        </span><span class="cm">/* Uboot中不使用IRQ/FIQ*/</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/******************************************系统时钟宏定义*******************************************/</span>
</span><span class='line'><span class="cp">#define CONFIG_CLK_532_133_66                </span><span class="cm">/*FIN=12MHz,Fout=532MHz*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define APLL_MDIV    266</span>
</span><span class='line'><span class="cp">#define APLL_PDIV    3</span>
</span><span class='line'><span class="cp">#define APLL_SDIV    1</span>
</span><span class='line'><span class="cp">#define CONFIG_SYNC_MODE</span>
</span><span class='line'><span class="cp">#define set_pll(mdiv, pdiv, sdiv)    (1&lt;&lt;31 | mdiv&lt;&lt;16 | pdiv&lt;&lt;8 | sdiv)</span>
</span><span class='line'><span class="cp">#define APLL_VAL set_pll(APLL_MDIV, APLL_PDIV, APLL_SDIV)</span>
</span><span class='line'><span class="cp">#define Startup_APLL (CONFIG_SYS_CLK_FREQ/(APLL_PDIV&lt;&lt;APLL_SDIV)*APLL_MDIV)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define MPLL_MDIV    266                     </span><span class="cm">/* fixed MPLL 533MHz */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define MPLL_PDIV    3</span>
</span><span class='line'><span class="cp">#define MPLL_SDIV    1</span>
</span><span class='line'><span class="cp">#define MPLL_VAL set_pll(MPLL_MDIV, MPLL_PDIV, MPLL_SDIV)</span>
</span><span class='line'><span class="cp">#define Startup_MPLL ((CONFIG_SYS_CLK_FREQ)/(MPLL_PDIV&lt;&lt;MPLL_SDIV)*MPLL_MDIV)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define Startup_APLLdiv      0</span>
</span><span class='line'><span class="cp">#define Startup_HCLKx2div    1</span>
</span><span class='line'><span class="cp">#define  Startup_PCLKdiv     3</span>
</span><span class='line'><span class="cp">#define Startup_HCLKdiv      1</span>
</span><span class='line'><span class="cp">#define Startup_MPLLdiv      1</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CLK_DIV_VAL  ((Startup_PCLKdiv&lt;&lt;12)|(Startup_HCLKx2div&lt;&lt;9)|(Startup_HCLKdiv&lt;&lt;8)|(Startup_MPLLdiv&lt;&lt;4)|Startup_APLLdiv)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_SYNC_MODE)</span>
</span><span class='line'><span class="cp">#define Startup_HCLK (Startup_APLL/(Startup_HCLKx2div+1)/(Startup_HCLKdiv+1))</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="cp">#define Startup_HCLK (Startup_MPLL/(Startup_HCLKx2div+1)/(Startup_HCLKdiv+1))</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_CLKSRC_CLKUART</span>
</span><span class='line'><span class="cp">#define CONFIG_UART_66                       </span><span class="cm">/*CLKUART=66.5MHz*/</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/*****************************************DDR控制器宏定义*******************************************/</span>
</span><span class='line'><span class="cp">#if defined(FRIENDLYARM_BOOT_RAM256)</span>
</span><span class='line'><span class="cp">#define DMC1_MEM_CFG     ((1&lt;&lt;30) | (2&lt;&lt;15) | (3&lt;&lt;3) | (2&lt;&lt;0))   </span><span class="cm">/*column address(10):A0~A9;row address(14):A0~A13;Burst Length =4*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DMC1_CHIP0_CFG       0x150F0                                 </span><span class="cm">/*Bank-Row-Column organization */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define PHYS_SDRAM_1_SIZE    0x10000000 </span><span class="cm">/* 256 MB */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#elif defined(FRIENDLYARM_BOOT_RAM128)</span>
</span><span class='line'><span class="cp">#define DMC1_MEM_CFG     ((1&lt;&lt;30) | (2&lt;&lt;15) | (2&lt;&lt;3)| (2&lt;&lt;0))</span>
</span><span class='line'><span class="cp">#define DMC1_CHIP0_CFG       0x150F8</span>
</span><span class='line'><span class="cp">#define PHYS_SDRAM_1_SIZE    0x8000000 </span><span class="cm">/* 128 MB */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="cp">#error RAM size must be defined</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define DMC1_MEM_CFG2        0xB41       </span><span class="cm">/*Memory with=32,Mobile DDR SDRAM,Read delay 1 cycle*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DMC_DDR_32_CFG       0x0         </span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* DDR Parameters */</span>
</span><span class='line'><span class="cp">#define DDR_tREFRESH     7800        </span><span class="cm">/* ns */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tRAS     45      </span><span class="cm">/* ns (min: 45ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tRC      68      </span><span class="cm">/* ns (min: 67.5ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tRCD     23      </span><span class="cm">/* ns (min: 22.5ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tRFC     80      </span><span class="cm">/* ns (min: 80ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tRP      23      </span><span class="cm">/* ns (min: 22.5ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tRRD     15      </span><span class="cm">/* ns (min: 15ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tWR      15      </span><span class="cm">/* ns (min: 15ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tXSR     120     </span><span class="cm">/* ns (min: 120ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_CASL     3       </span><span class="cm">/* CAS Latency 3 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define DMC_DDR_BA_EMRS  2</span>
</span><span class='line'><span class="cp">#define DMC_DDR_MEM_CASLAT   3</span>
</span><span class='line'><span class="cp">#define DMC_DDR_CAS_LATENCY  (DDR_CASL&lt;&lt;1)                     </span><span class="c1">//6   Set Cas Latency to 3</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_DQSS       1                           </span><span class="c1">// Min 0.75 ~ 1.25</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_MRD        2                           </span><span class="c1">//Min 2 tck</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_RAS        (((Startup_HCLK / 1000 * DDR_tRAS) - 1) / 1000000 + 1)  </span><span class="c1">//7, Min 45ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_RC     (((Startup_HCLK / 1000 * DDR_tRC) - 1) / 1000000 + 1)   </span><span class="c1">//10, Min 67.5ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_RCD        (((Startup_HCLK / 1000 * DDR_tRCD) - 1) / 1000000 + 1)  </span><span class="c1">//4,5(TRM), Min 22.5ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_schedule_RCD ((DMC_DDR_t_RCD - 3) &lt;&lt; 3)</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_RFC        (((Startup_HCLK / 1000 * DDR_tRFC) - 1) / 1000000 + 1)  </span><span class="c1">//11,18(TRM) Min 80ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_schedule_RFC ((DMC_DDR_t_RFC - 3) &lt;&lt; 5)</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_RP     (((Startup_HCLK / 1000 * DDR_tRP) - 1) / 1000000 + 1)   </span><span class="c1">//4, 5(TRM) Min 22.5ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_schedule_RP  ((DMC_DDR_t_RP - 3) &lt;&lt; 3)</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_RRD        (((Startup_HCLK / 1000 * DDR_tRRD) - 1) / 1000000 + 1)  </span><span class="c1">//3, Min 15ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_WR     (((Startup_HCLK / 1000 * DDR_tWR) - 1) / 1000000 + 1)   </span><span class="c1">//Min 15ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_WTR        2</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_XP     2                           </span><span class="c1">//1tck + tIS(1.5ns)</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_XSR        (((Startup_HCLK / 1000 * DDR_tXSR) - 1) / 1000000 + 1)  </span><span class="c1">//17, Min 120ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_ESR        DMC_DDR_t_XSR</span>
</span><span class='line'><span class="cp">#define DMC_DDR_REFRESH_PRD  (((Startup_HCLK / 1000 * DDR_tREFRESH) - 1) / 1000000)  </span><span class="c1">// TRM 2656</span>
</span><span class='line'><span class="cp">#define DMC_DDR_USER_CONFIG  1                           </span><span class="c1">// 2b01 : mDDR</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_NR_DRAM_BANKS 1      </span><span class="cm">/* we have 2 bank of DRAM */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define PHYS_SDRAM_1     MEMORY_BASE_ADDRESS </span><span class="cm">/* SDRAM Bank #1 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cm">/***************************************************************************************************************/</span>
</span><span class='line'><span class="cp">#define CONFIG_DISPLAY_CPUINFO</span>
</span><span class='line'><span class="cp">#define CONFIG_DISPLAY_BOARDINFO</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/************************************************DM9000*********************************************************/</span>
</span><span class='line'><span class="cp">#define CONFIG_DRIVER_DM9000 1</span>
</span><span class='line'><span class="cp">#define CONFIG_DRIVER_DM9000_NO_EEPROM   1</span>
</span><span class='line'><span class="cp">#define CONFIG_DM9000_USE_16BIT 1</span>
</span><span class='line'><span class="cp">#define CONFIG_DM9000_BASE   0x18000300</span>
</span><span class='line'><span class="cp">#define DM9000_IO CONFIG_DM9000_BASE</span>
</span><span class='line'><span class="cp">#define DM9000_DATA (CONFIG_DM9000_BASE+4)</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/***************************************************************************************************************/</span>
</span><span class='line'><span class="cp">#define CONFIG_INCLUDE_TEST</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_ZIMAGE_BOOT</span>
</span><span class='line'><span class="cp">#define CONFIG_IMAGE_BOOT</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define BOARD_LATE_INIT</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_SETUP_MEMORY_TAGS</span>
</span><span class='line'><span class="cp">#define CONFIG_CMDLINE_TAG</span>
</span><span class='line'><span class="cp">#define CONFIG_INITRD_TAG</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/******************************************************Shell*******************************************************/</span>
</span><span class='line'><span class="cp">#define CONFIG_SERIAL1          1            </span><span class="cm">/* we use SERIAL 1 on SMDK6410 */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_HUSH_PARSER                      </span><span class="cm">/* use &quot;hush&quot; command parser  */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CFG_HUSH_PARSER</span>
</span><span class='line'><span class="cp">#define CFG_PROMPT_HUSH_PS2  &quot;&gt; &quot;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*******************************************************Command definition*****************************************/</span>
</span><span class='line'><span class="cp">#define CONFIG_COMMANDS \</span>
</span><span class='line'><span class="cp">                        (CONFIG_CMD_DFL | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_CACHE   | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_USB     | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_REGINFO | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_LOADS   | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_LOADB   | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_ENV     | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_NAND    | \</span>
</span><span class='line'><span class="cp">                     CFG_CMD_PING    | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_MOVINAND) \</span>
</span><span class='line'><span class="cp">                        &amp; ~(CFG_CMD_AUTOSCRIPT  | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_BOOTD   | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_IMI     | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_RUN     | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_CONSOLE | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_DOCG3P3 | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_EEPROM   | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_I2C     | \</span>
</span><span class='line'><span class="cp">                                0)</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*********************************************************************************************************************/</span>
</span><span class='line'><span class="cp">#include &lt;cmd_confdefs.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_BOOTDELAY 0</span>
</span><span class='line'><span class="cp">#define CONFIG_BOOTARGS      &quot;root=/dev/mtdblock2 rootfstype=yaffs2 init=/linuxrc console=ttySAC0,115200&quot;</span>
</span><span class='line'><span class="cp">#define CONFIG_ETHADDR       08:90:90:90:90:90</span>
</span><span class='line'><span class="cp">#define CONFIG_NETMASK          255.255.255.0</span>
</span><span class='line'><span class="cp">#define CONFIG_IPADDR        192.168.1.230</span>
</span><span class='line'><span class="cp">#define CONFIG_SERVERIP      192.168.1.88</span>
</span><span class='line'><span class="cp">#define CONFIG_GATEWAYIP 192.168.1.1</span>
</span><span class='line'><span class="cp">#define CONFIG_DEVICENUM    0</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_ZERO_BOOTDELAY_CHECK</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/************************************************************************************************************************/</span>
</span><span class='line'><span class="cp">#define CFG_LONGHELP             </span><span class="cm">/* undef to save memory     */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_PROMPT       &quot;iggsensor # &quot;    </span><span class="cm">/* Monitor Command Prompt   */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_CBSIZE       256     </span><span class="cm">/* Console I/O Buffer Size  */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_PBSIZE       384     </span><span class="cm">/* Print Buffer Size */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_MAXARGS      16      </span><span class="cm">/* max number of command args   */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_BARGSIZE     CFG_CBSIZE  </span><span class="cm">/* Boot Argument Buffer Size    */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*************************************************************************************************************************/</span>
</span><span class='line'><span class="cp">#define MACH_TYPE        2520</span>
</span><span class='line'><span class="cp">#define UBOOT_MAGIC      (0x43090000 | MACH_TYPE)</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-17T11:49:49+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/kdm/'>kdm</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/u-boot/'>u-boot</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/14/raw-machine-code/">
		
			Raw_machine_code</a>
	</h2>
	<div class="entry-content">
		<h3>把外设的基地址告诉CPU</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">ldr</span> <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x70000000</span>                     <span class="c1">//对于6410来说,内存(0x00000000～0x60000000),外设(0x70000000-0x7fffffff)</span>
</span><span class='line'><span class="n">orr</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x13</span>                     <span class="c1">//外设大小:256M</span>
</span><span class='line'><span class="n">mcr</span> <span class="n">p15</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">r0</span><span class="p">,</span><span class="n">c15</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="mi">4</span>                   <span class="c1">//把r0的值(包括了外设基地址+外设大小)告诉cpu</span>
</span></code></pre></td></tr></table></div></figure>


<h3>关看门狗</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">ldr</span> <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x7E004000</span>
</span><span class='line'><span class="n">mov</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
</span><span class='line'><span class="n">str</span> <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>开启icaches</h3>

<blockquote><ol>
<li>基于程序访问的局限性，在主存和CPU通用寄存器之间设置了一类高速的、容量较小的存储器，把正在执行的指令地址附件的一部分指令或数据从主存调入这类存储器，供CPU在一段时间内使用，这对提高程序的运行速度又很大的作用。这类介于主存和CPU之间的高速小容量存储器称作cahce。比较常见的cache有icache和dcache，icache的使用比较简单，系统刚上电时，icache中的内容是无效的，并且icache的功能是关闭的，往CP15协处理器中的寄存器1的bit【12】写1可以启动icache，写0可以停止icache。icache关闭时，CPU每次取指令都要读主存，性能非常低，因为icache可以随时启动，所以越早开启越好。，</li>
<li>与icache相似，dcache在系统刚上电时候里面的内容是无效的，并且dcache的功能是关闭的，往CP15协处理器中的寄存器1的bit【2】写1可以启动dcache，写0可以停止dcache。<code>注意dcache必须在启动mmu后才能被启动</code></li>
</ol>
</blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#ifdef  CONFIG_SYS_ICACHE_OFF</span>
</span><span class='line'>  <span class="n">bic</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x00001000</span>                 <span class="err">@</span> <span class="n">clear</span> <span class="n">bit</span> <span class="mi">12</span> <span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="n">I</span><span class="o">-</span><span class="n">cache</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">orr</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x00001000</span>                 <span class="err">@</span> <span class="n">set</span> <span class="n">bit</span> <span class="mi">12</span> <span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="n">I</span><span class="o">-</span><span class="n">cache</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">mcr</span> <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<h3>死循环</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="nl">halt</span><span class="p">:</span>
</span><span class='line'>  <span class="n">b</span> <span class="n">halt</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>b与bl都是跳转指令，但是bl会把下一条指令的地址保存到寄存器lr中</p></blockquote>

<h3>Makefile</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">led</span><span class="p">.</span><span class="nl">bin</span> <span class="p">:</span> <span class="n">start</span><span class="p">.</span><span class="n">o</span> <span class="n">clock</span><span class="p">.</span><span class="n">o</span> <span class="n">led</span><span class="p">.</span><span class="n">o</span>
</span><span class='line'>  <span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">ld</span> <span class="o">-</span><span class="n">T</span> <span class="n">leds</span><span class="p">.</span><span class="n">lds</span> <span class="o">-</span><span class="n">o</span> <span class="n">led</span><span class="p">.</span><span class="n">elf</span> <span class="n">start</span><span class="p">.</span><span class="n">o</span> <span class="n">clock</span><span class="p">.</span><span class="n">o</span> <span class="n">led</span><span class="p">.</span><span class="n">o</span>
</span><span class='line'>  <span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">objcopy</span> <span class="o">-</span><span class="n">O</span> <span class="n">binary</span> <span class="n">led</span><span class="p">.</span><span class="n">elf</span> <span class="n">led</span><span class="p">.</span><span class="n">bin</span>
</span><span class='line'>  <span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">objdump</span> <span class="o">-</span><span class="n">D</span> <span class="n">led</span><span class="p">.</span><span class="n">elf</span> <span class="o">&gt;</span> <span class="n">led</span><span class="p">.</span><span class="n">dis</span>
</span><span class='line'><span class="o">%</span><span class="p">.</span><span class="nl">o</span> <span class="p">:</span> <span class="o">%</span><span class="p">.</span><span class="n">S</span>
</span><span class='line'>  <span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gcc</span> <span class="o">-</span><span class="n">o</span> <span class="err">$@</span> <span class="err">@</span><span class="o">&lt;</span> <span class="o">-</span><span class="n">c</span>
</span><span class='line'><span class="o">%</span><span class="p">.</span><span class="nl">o</span> <span class="p">:</span> <span class="o">%</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'>  <span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gcc</span> <span class="o">-</span><span class="n">o</span> <span class="err">$@</span> <span class="err">@</span><span class="o">&lt;</span> <span class="o">-</span><span class="n">c</span>
</span><span class='line'><span class="nl">clean</span><span class="p">:</span>
</span><span class='line'>  <span class="n">rm</span> <span class="o">*</span><span class="p">.</span><span class="n">o</span> <span class="n">led</span><span class="p">.</span><span class="n">elf</span> <span class="n">led</span><span class="p">.</span><span class="n">bin</span> <span class="n">led</span><span class="p">.</span><span class="n">dis</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><ol>
<li>6410一上电后，nandflash前8K内容会被硬件原原本本地复制到片内的一个叫stepping stone的区域，该区域被映射到CPU内存地址0处</li>
<li>在ARM中，pc:r15,lr:r14,sp:r13,ip:r12,fp:r11</li>
</ol>
</blockquote>

<h3>CPU时钟设置</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="nl">clock_init</span><span class="p">:</span>
</span><span class='line'>  <span class="c1">// 1. 设置各PLL的LOCK_TIME,使用默认值  </span>
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x7E00F000</span>                         <span class="c1">// APLL_LOCK，供cpu使用 </span>
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x0000FFFF</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">str</span> <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="p">]</span>                          <span class="c1">// MPLL_LOCK，供AHB(存储/中断/lcd等控制器)/APB(看门狗，定时器，SD等)总线上的设备使用 </span>
</span><span class='line'>  <span class="n">str</span> <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">8</span><span class="p">]</span>                          <span class="c1">// EPLL_LOCK，供UART,IIS,IIC使用 </span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// 2. 设置为异步模式(Asynchronous mode)  </span>
</span><span class='line'><span class="cp">#define OTHERS   0x7E00F900</span>
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">OTHERS</span>                              <span class="c1">// OTHERS</span>
</span><span class='line'>                                              <span class="c1">// 《linux installation for u-boot》3.7中：用MPLL作为HCLK和PCLK的Source是异步(ASYNC)模式(当内存时钟与CPU时钟源不一样时需要设置成异步模式)</span>
</span><span class='line'>                                              <span class="c1">// 用APLL是同步(SYNC)模式</span>
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>  <span class="n">bic</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xc0</span>                           <span class="c1">// bit[6:7]清0,即SYNCMODE=0/SYNCMUXSEL=0</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'><span class="nl">loop</span><span class="p">:</span>          
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">OTHERS</span>
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>  <span class="n">and</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xf00</span>                  
</span><span class='line'>  <span class="n">cmp</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
</span><span class='line'>  <span class="n">bne</span> <span class="n">loop</span>      
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// 3. 设置分频系数  </span>
</span><span class='line'><span class="cp">#define ARM_RATIO    0                           </span><span class="c1">// ARMCLK   = DOUTAPLL / (ARM_RATIO + 1)    = 532/(0+1) = 532  MHz</span>
</span><span class='line'><span class="cp">#define MPLL_RATIO   0                           </span><span class="c1">// DOUTMPLL = MOUTMPLL / (MPLL_RATIO + 1)   = 532/(0+1) = 532  MHz</span>
</span><span class='line'><span class="cp">#define HCLKX2_RATIO 1                           </span><span class="c1">// HCLKX2   = HCLKX2IN / (HCLKX2_RATIO + 1) = 532/(1+1) = 266  MHz</span>
</span><span class='line'><span class="cp">#define HCLK_RATIO   1                           </span><span class="c1">// HCLK     = HCLKX2   / (HCLK_RATIO + 1)   = 266/(1+1) = 133  MHz</span>
</span><span class='line'><span class="cp">#define PCLK_RATIO   3                           </span><span class="c1">// PCLK     = HCLKX2   / (PCLK_RATIO + 1)   = 266/(3+1) = 66.5 MHz</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x7E00F020</span>                         <span class="c1">// CLK_DIV0</span>
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="p">(</span><span class="n">ARM_RATIO</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">MPLL_RATIO</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">HCLK_RATIO</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">HCLKX2_RATIO</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">PCLK_RATIO</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// 4. 设置PLL,放大时钟  </span>
</span><span class='line'>  <span class="c1">// 4.1 配置APLL  </span>
</span><span class='line'><span class="cp">#define APLL_CON_VAL  ((1&lt;&lt;31) | (266 &lt;&lt; 16) | (3 &lt;&lt; 8) | (1)) </span>
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x7E00F00C</span>                         <span class="c1">// APLL_CON</span>
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">APLL_CON_VAL</span>                        <span class="c1">// FOUT = MDIV X FIN / (PDIV X 2SDIV) = 266*12/(3*2^1) = 532MHz</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>      
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// 4.2 配置MPLL  </span>
</span><span class='line'><span class="cp">#define MPLL_CON_VAL  ((1&lt;&lt;31) | (266 &lt;&lt; 16) | (3 &lt;&lt; 8) | (1))</span>
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x7E00F010</span>                         <span class="c1">// MPLL_CON</span>
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">MPLL_CON_VAL</span>                        <span class="c1">// FOUT = MDIV X FIN / (PDIV X 2SDIV) = 266*12/(3*2^1) = 532MHz</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>      
</span><span class='line'>
</span><span class='line'><span class="cp">#define MPLL_SEL 1</span>
</span><span class='line'><span class="cp">#define APLL_SEL 1   </span>
</span><span class='line'>  <span class="c1">// 5.选择PLL的输出作为时钟源  </span>
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x7E00F01C</span>                         <span class="c1">// CLK_SRC</span>
</span><span class='line'>  <span class="n">ldr</span> <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="p">(</span><span class="n">MPLL_SEL</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">APLL_SEL</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">mov</span> <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>
</span></code></pre></td></tr></table></div></figure>


<h3>串口UART</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#define ULCON0     (*((volatile unsigned long *)0x7F005000))</span>
</span><span class='line'><span class="cp">#define UCON0      (*((volatile unsigned long *)0x7F005004))</span>
</span><span class='line'><span class="cp">#define UFCON0     (*((volatile unsigned long *)0x7F005008))</span>
</span><span class='line'><span class="cp">#define UMCON0     (*((volatile unsigned long *)0x7F00500C))</span>
</span><span class='line'><span class="cp">#define UTRSTAT0   (*((volatile unsigned long *)0x7F005010))</span>
</span><span class='line'><span class="cp">#define UFSTAT0    (*((volatile unsigned long *)0x7F005018))</span>
</span><span class='line'><span class="cp">#define UTXH0      (*((volatile unsigned char *)0x7F005020))</span>
</span><span class='line'><span class="cp">#define URXH0      (*((volatile unsigned char *)0x7F005024))</span>
</span><span class='line'><span class="cp">#define UBRDIV0    (*((volatile unsigned short *)0x7F005028))</span>
</span><span class='line'><span class="cp">#define UDIVSLOT0  (*((volatile unsigned short *)0x7F00502C))</span>
</span><span class='line'><span class="cp">#define GPACON     (*((volatile unsigned long *)0x7F008000))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">init_uart</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="cm">/* 1. 配置引脚 */</span>
</span><span class='line'>  <span class="n">GPACON</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>  <span class="n">GPACON</span> <span class="o">|=</span> <span class="mh">0x22</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="cm">/* 2. 设置数据格式等 */</span>
</span><span class='line'>  <span class="n">ULCON0</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>                      <span class="c1">// 数据位:8, 无校验, 停止位: 1, 8n1 </span>
</span><span class='line'>  <span class="n">UCON0</span>  <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>                      <span class="c1">// 时钟：PCLK，禁止中断，使能UART发送、接收 </span>
</span><span class='line'>  <span class="n">UFCON0</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>                     <span class="c1">// FIFO ENABLE</span>
</span><span class='line'>  <span class="n">UMCON0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                        <span class="c1">// 无流控</span>
</span><span class='line'>  
</span><span class='line'>  <span class="cm">/* 3. 设置波特率 */</span>
</span><span class='line'>  <span class="c1">// DIV_VAL = (PCLK / (bps x 16 ) ) - 1 = (66500000/(115200x16))-1 = 35.08</span>
</span><span class='line'>  <span class="c1">// DIV_VAL = 35.08 = UBRDIVn + (num of 1’s in UDIVSLOTn)/16 </span>
</span><span class='line'>  <span class="n">UBRDIV0</span>   <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>
</span><span class='line'>  <span class="n">UDIVSLOT0</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 接收一个字符 */</span>
</span><span class='line'><span class="kt">char</span> <span class="nf">getchar</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">while</span> <span class="p">((</span><span class="n">UFSTAT0</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>  <span class="c1">// 如果RX FIFO空，等待 </span>
</span><span class='line'>  <span class="k">return</span> <span class="n">URXH0</span><span class="p">;</span>                   <span class="c1">// 取数据 </span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 发送一个字符 */</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">putchar</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">while</span> <span class="p">(</span><span class="n">UFSTAT0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">));</span>       <span class="c1">// 如果TX FIFO满，等待 </span>
</span><span class='line'>  <span class="n">UTXH0</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>                      <span class="c1">// 写数据 </span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>链接脚本</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">SECTIONS</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">.</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>                        <span class="cm">/*当前地址*/</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">text</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">start</span><span class="p">.</span><span class="n">o</span>
</span><span class='line'>      <span class="o">*</span> <span class="p">(.</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">rodata</span> <span class="p">:{</span>
</span><span class='line'>      <span class="o">*</span> <span class="p">(.</span><span class="n">rodata</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>        
</span><span class='line'>  <span class="p">.</span><span class="nl">data</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="o">*</span> <span class="p">(.</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>  <span class="n">bss_start</span> <span class="o">=</span> <span class="p">.;</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">bss</span> <span class="p">:</span> <span class="p">{</span>                       <span class="cm">/*二进制文件中并不包含bss数据*/</span>
</span><span class='line'>      <span class="o">*</span> <span class="p">(.</span><span class="n">bss</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">bss_end</span>  <span class="o">=</span> <span class="p">.;</span>  
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><ol>
<li>位置无关吗：跳转指令使用相对地址，如b和bl，并且程序中不使用全局变量,静态变量</li>
<li>程序运行时应该位于它的链接地址上</li>
</ol>
</blockquote>

<h3>DRAM控制器初始化</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#define MEMCCMD        0x7e001004</span>
</span><span class='line'><span class="cp">#define P1REFRESH    0x7e001010</span>
</span><span class='line'><span class="cp">#define P1CASLAT 0x7e001014</span>
</span><span class='line'><span class="cp">#define MEM_SYS_CFG  0x7e00f120</span>
</span><span class='line'><span class="cp">#define P1MEMCFG 0x7e00100c</span>
</span><span class='line'><span class="cp">#define P1T_DQSS 0x7e001018</span>
</span><span class='line'><span class="cp">#define P1T_MRD      0x7e00101c</span>
</span><span class='line'><span class="cp">#define P1T_RAS      0x7e001020</span>
</span><span class='line'><span class="cp">#define P1T_RC       0x7e001024</span>
</span><span class='line'><span class="cp">#define P1T_RCD      0x7e001028</span>
</span><span class='line'><span class="cp">#define P1T_RFC      0x7e00102c</span>
</span><span class='line'><span class="cp">#define P1T_RP       0x7e001030</span>
</span><span class='line'><span class="cp">#define P1T_RRD      0x7e001034</span>
</span><span class='line'><span class="cp">#define P1T_WR       0x7e001038</span>
</span><span class='line'><span class="cp">#define P1T_WTR      0x7e00103c</span>
</span><span class='line'><span class="cp">#define P1T_XP       0x7e001040</span>
</span><span class='line'><span class="cp">#define P1T_XSR      0x7e001044</span>
</span><span class='line'><span class="cp">#define P1T_ESR      0x7e001048</span>
</span><span class='line'><span class="cp">#define P1MEMCFG2    0X7e00104c</span>
</span><span class='line'><span class="cp">#define P1_chip_0_cfg    0x7e001200</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define P1MEMSTAT    0x7e001000</span>
</span><span class='line'><span class="cp">#define P1MEMCCMD    0x7e001004</span>
</span><span class='line'><span class="cp">#define P1DIRECTCMD  0x7e001008</span>
</span><span class='line'>  
</span><span class='line'><span class="cp">#define HCLK 133000000</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define nstoclk(ns)  ( ns/(1000000000/HCLK)+1 )          </span><span class="c1">//+1是四舍五入</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 根据6410手册P192页相关步骤和sdram手册来初始化dram控制器(dramc) */</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">sdram_init</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="cm">/* 1. 使dramc进入&quot;config&quot;状态 */</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span><span class="n">P1MEMCCMD</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* 2. 设置timing parameter, chip configuration,id configuration registers */</span>
</span><span class='line'>  <span class="cm">/* 2.1 刷新周期 */</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span><span class="n">P1REFRESH</span><span class="p">,</span> <span class="n">nstoclk</span><span class="p">(</span><span class="mi">7800</span><span class="p">));</span>                 <span class="c1">//刷新周期:(7.8us)/((1/HCLK)s)=(7.8*10^3)/(1/133*10^6)</span>
</span><span class='line'>  <span class="cm">/* 2.2 时间参数，下列设置全都是取了最小值 */</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1CASLAT</span><span class="p">,</span> <span class="p">(</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">);</span>                      <span class="c1">//CAS Latency:指的是内存存取数据所需的延迟时间，简单的说，就是内存接到CPU的指令后的反应速度。一般的参数值是2和3两种。K4X1G163PQ的芯片手册上CAS Latency=3 </span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1T_DQSS</span><span class="p">,</span> <span class="mh">0x1</span> <span class="p">);</span>                            <span class="c1">//下列设置均在sdram手册中可查询到             </span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1T_MRD</span><span class="p">,</span> <span class="mh">0x2</span> <span class="p">);</span>                         
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1T_RAS</span><span class="p">,</span> <span class="n">nstoclk</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="p">);</span>                    
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1T_RC</span><span class="p">,</span> <span class="n">nstoclk</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span> <span class="p">);</span>     
</span><span class='line'>  <span class="n">u32</span> <span class="n">trcd</span> <span class="o">=</span> <span class="n">nstoclk</span><span class="p">(</span> <span class="mi">18</span> <span class="p">);</span>                         
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1T_RCD</span><span class="p">,</span> <span class="n">trcd</span> <span class="o">|</span> <span class="p">((</span> <span class="n">trcd</span> <span class="o">-</span> <span class="mi">3</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">);</span>
</span><span class='line'>  <span class="n">u32</span> <span class="n">trfc</span> <span class="o">=</span> <span class="n">nstoclk</span><span class="p">(</span> <span class="mi">72</span> <span class="p">);</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1T_RFC</span><span class="p">,</span> <span class="n">trfc</span> <span class="o">|</span> <span class="p">(</span> <span class="p">(</span> <span class="n">trfc</span><span class="o">-</span><span class="mi">3</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">);</span>
</span><span class='line'>  <span class="n">u32</span> <span class="n">trp</span> <span class="o">=</span> <span class="n">nstoclk</span><span class="p">(</span> <span class="mi">18</span> <span class="p">);</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1T_RP</span><span class="p">,</span> <span class="n">trp</span> <span class="o">|</span> <span class="p">(</span> <span class="p">(</span> <span class="n">trp</span> <span class="o">-</span> <span class="mi">3</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">);</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1T_RRD</span><span class="p">,</span> <span class="n">nstoclk</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1T_WR</span><span class="p">,</span> <span class="n">nstoclk</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1T_WTR</span><span class="p">,</span> <span class="mh">0x1</span> <span class="p">);</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1T_XP</span><span class="p">,</span> <span class="mh">0x1</span> <span class="p">);</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1T_XSR</span><span class="p">,</span> <span class="n">nstoclk</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1T_ESR</span><span class="p">,</span> <span class="n">nstoclk</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>  
</span><span class='line'>  <span class="cm">/* 2.3 chip configuration */</span>
</span><span class='line'>  <span class="n">set_nbit</span><span class="p">(</span> <span class="n">P1MEMCFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x2</span> <span class="p">);</span>                   <span class="c1">// column address(10):A0~A9</span>
</span><span class='line'>  <span class="n">set_nbit</span><span class="p">(</span> <span class="n">P1MEMCFG</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x3</span> <span class="p">);</span>                   <span class="c1">// row address(14):A0~A13</span>
</span><span class='line'>  <span class="n">set_zero</span><span class="p">(</span> <span class="n">P1MEMCFG</span><span class="p">,</span> <span class="mi">6</span> <span class="p">);</span>                         <span class="c1">// A10/AP </span>
</span><span class='line'>  <span class="n">set_nbit</span><span class="p">(</span> <span class="n">P1MEMCFG</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x2</span> <span class="p">);</span>                  <span class="c1">//  Burst Length (2, 4, 8, 16)</span>
</span><span class='line'>  <span class="n">set_nbit</span><span class="p">(</span> <span class="n">P1MEMCFG2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x5</span> <span class="p">);</span>
</span><span class='line'>  <span class="n">set_2bit</span><span class="p">(</span> <span class="n">P1MEMCFG2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x1</span> <span class="p">);</span>                        <span class="c1">// 32 bit </span>
</span><span class='line'>  <span class="n">set_nbit</span><span class="p">(</span> <span class="n">P1MEMCFG2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x3</span> <span class="p">);</span>                  <span class="c1">// Mobile DDR SDRAM    </span>
</span><span class='line'>  <span class="n">set_2bit</span><span class="p">(</span> <span class="n">P1MEMCFG2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0x1</span> <span class="p">);</span>
</span><span class='line'>  <span class="n">set_one</span><span class="p">(</span> <span class="n">P1_chip_0_cfg</span><span class="p">,</span> <span class="mi">16</span> <span class="p">);</span>                        <span class="c1">// Bank-Row-Column organization </span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* 3. 初始化sdram */</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1DIRECTCMD</span><span class="p">,</span> <span class="mh">0xc0000</span> <span class="p">);</span>                     <span class="c1">// NOP</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1DIRECTCMD</span><span class="p">,</span> <span class="mh">0x000</span> <span class="p">);</span>                       <span class="c1">// precharge</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1DIRECTCMD</span><span class="p">,</span> <span class="mh">0x40000</span> <span class="p">);</span>                 <span class="c1">// auto refresh</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1DIRECTCMD</span><span class="p">,</span> <span class="mh">0x40000</span> <span class="p">);</span>                 <span class="c1">// auto refresh</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1DIRECTCMD</span><span class="p">,</span> <span class="mh">0xa0000</span> <span class="p">);</span>                     <span class="c1">// EMRS</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1DIRECTCMD</span><span class="p">,</span> <span class="mh">0x80032</span> <span class="p">);</span>                     <span class="c1">// MRS</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">MEM_SYS_CFG</span><span class="p">,</span> <span class="mh">0x0</span> <span class="p">);</span>
</span><span class='line'>                  
</span><span class='line'>  <span class="cm">/* 4. 使dramc进入&quot;ready&quot;状态    */</span>
</span><span class='line'>  <span class="n">set_val</span><span class="p">(</span> <span class="n">P1MEMCCMD</span><span class="p">,</span> <span class="mh">0x000</span> <span class="p">);</span>
</span><span class='line'>  <span class="k">while</span><span class="p">(</span> <span class="o">!</span><span class="p">((</span> <span class="n">read_val</span><span class="p">(</span> <span class="n">P1MEMSTAT</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span> <span class="p">)</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">));</span><span class="c1">// 等待dramc进入&quot;ready&quot;状态      </span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>简单重定位(从片内内存重定位到DDR)</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">adr</span> <span class="n">r0</span><span class="p">,</span> <span class="n">_start</span>          <span class="err">@获得</span><span class="n">_start</span><span class="err">指令当前所在的地址</span>
</span><span class='line'><span class="n">ldr</span> <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">_start</span>            <span class="err">@获得</span><span class="n">_start</span><span class="err">的链接地址</span>
</span><span class='line'><span class="n">ldr</span> <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="n">bss_start</span>     <span class="err">@</span><span class="n">bss</span><span class="err">段的起始链接地址</span>
</span><span class='line'><span class="n">cmp</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span>
</span><span class='line'><span class="n">beq</span> <span class="n">clean_bss</span>
</span><span class='line'><span class="nl">copy_loop</span><span class="p">:</span>
</span><span class='line'><span class="n">ldr</span> <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">],</span> <span class="err">#</span><span class="mi">4</span>       <span class="err">@将</span><span class="n">r0</span><span class="err">所指向的内容复制到</span><span class="n">r3</span><span class="err">中，然后将</span><span class="n">r0</span><span class="err">加</span><span class="mi">4</span>
</span><span class='line'><span class="n">str</span> <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r1</span><span class="p">],</span> <span class="err">#</span><span class="mi">4</span>       <span class="err">@将</span><span class="n">r3</span><span class="err">中的内容保存到</span><span class="n">r1</span><span class="err">所指向的地址中，然后将</span><span class="n">r1</span><span class="err">加</span><span class="mi">4</span>
</span><span class='line'><span class="n">cmp</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'><span class="n">bne</span> <span class="n">copy_loop</span>
</span><span class='line'>  
</span><span class='line'><span class="cm">/* 把BBS段对应的内存清零 */</span>
</span><span class='line'><span class="nl">clean_bss</span><span class="p">:</span>
</span><span class='line'><span class="n">ldr</span> <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">bss_start</span>
</span><span class='line'><span class="n">ldr</span> <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">bss_end</span>
</span><span class='line'><span class="n">mov</span> <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
</span><span class='line'><span class="n">cmp</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span>
</span><span class='line'><span class="n">beq</span> <span class="n">on_ddr</span>
</span><span class='line'><span class="nl">clean_loop</span><span class="p">:</span>
</span><span class='line'><span class="n">str</span> <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">],</span> <span class="err">#</span><span class="mi">4</span>
</span><span class='line'><span class="n">cmp</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span>    
</span><span class='line'><span class="n">bne</span> <span class="n">clean_loop</span>  
</span><span class='line'><span class="nl">on_ddr</span><span class="p">:</span>
</span><span class='line'><span class="n">ldr</span> <span class="n">pc</span><span class="p">,</span> <span class="o">=</span><span class="n">main</span>          <span class="err">@</span><span class="n">pc</span><span class="err">等于</span><span class="n">main</span><span class="err">的链接地址</span>
</span></code></pre></td></tr></table></div></figure>


<h3>NandFlash驱动</h3>

<blockquote><ol>
<li>地址，数据，命令复用</li>
<li>地址多次发出</li>
<li>NandFlash一页是2K字节，另外每页都会有一个64字节的区域叫做OOB，共64字节,存放校验码</li>
<li>NandFlash一个块的大小是128K字节</li>
</ol>
</blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#define ELFIN_NAND_BASE        0x70200000</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define NFCONF_OFFSET           0x00</span>
</span><span class='line'><span class="cp">#define NFCONT_OFFSET           0x04</span>
</span><span class='line'><span class="cp">#define NFCMMD_OFFSET           0x08</span>
</span><span class='line'><span class="cp">#define NFADDR_OFFSET           0x0c</span>
</span><span class='line'><span class="cp">#define NFDATA_OFFSET            0x10</span>
</span><span class='line'><span class="cp">#define NFMECCDATA0_OFFSET      0x14</span>
</span><span class='line'><span class="cp">#define NFMECCDATA1_OFFSET      0x18</span>
</span><span class='line'><span class="cp">#define NFSECCDATA0_OFFSET      0x1c</span>
</span><span class='line'><span class="cp">#define NFSBLK_OFFSET           0x20</span>
</span><span class='line'><span class="cp">#define NFEBLK_OFFSET           0x24</span>
</span><span class='line'><span class="cp">#define NFSTAT_OFFSET           0x28</span>
</span><span class='line'><span class="cp">#define NFESTAT0_OFFSET         0x2c</span>
</span><span class='line'><span class="cp">#define NFESTAT1_OFFSET         0x30</span>
</span><span class='line'><span class="cp">#define NFMECC0_OFFSET          0x34</span>
</span><span class='line'><span class="cp">#define NFMECC1_OFFSET          0x38</span>
</span><span class='line'><span class="cp">#define NFSECC_OFFSET           0x3c</span>
</span><span class='line'><span class="cp">#define NFMLCBITPT_OFFSET       0x40</span>
</span><span class='line'><span class="cp">#define NF8ECCERR0_OFFSET        0x44</span>
</span><span class='line'><span class="cp">#define NF8ECCERR1_OFFSET        0x48</span>
</span><span class='line'><span class="cp">#define NF8ECCERR2_OFFSET        0x4c</span>
</span><span class='line'><span class="cp">#define NFM8ECC0_OFFSET          0x50</span>
</span><span class='line'><span class="cp">#define NFM8ECC1_OFFSET          0x54</span>
</span><span class='line'><span class="cp">#define NFM8ECC2_OFFSET          0x58</span>
</span><span class='line'><span class="cp">#define NFM8ECC3_OFFSET          0x5c</span>
</span><span class='line'><span class="cp">#define NFMLC8BITPT0_OFFSET      0x60</span>
</span><span class='line'><span class="cp">#define NFMLC8BITPT1_OFFSET      0x64</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define NFCONF               (ELFIN_NAND_BASE+NFCONF_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFCONT               (ELFIN_NAND_BASE+NFCONT_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFCMMD               (ELFIN_NAND_BASE+NFCMMD_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFADDR               (ELFIN_NAND_BASE+NFADDR_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFDATA           (ELFIN_NAND_BASE+NFDATA_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFMECCDATA0      (ELFIN_NAND_BASE+NFMECCDATA0_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFMECCDATA1      (ELFIN_NAND_BASE+NFMECCDATA1_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFSECCDATA0          (ELFIN_NAND_BASE+NFSECCDATA0_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFSBLK           (ELFIN_NAND_BASE+NFSBLK_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFEBLK               (ELFIN_NAND_BASE+NFEBLK_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFSTAT               (ELFIN_NAND_BASE+NFSTAT_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFESTAT0             (ELFIN_NAND_BASE+NFESTAT0_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFESTAT1             (ELFIN_NAND_BASE+NFESTAT1_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFMECC0              (ELFIN_NAND_BASE+NFMECC0_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFMECC1              (ELFIN_NAND_BASE+NFMECC1_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFSECC               (ELFIN_NAND_BASE+NFSECC_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFMLCBITPT          (ELFIN_NAND_BASE+NFMLCBITPT_OFFSET)</span>
</span><span class='line'><span class="cp">#define NF8ECCERR0           (ELFIN_NAND_BASE+NF8ECCERR0_OFFSET)</span>
</span><span class='line'><span class="cp">#define NF8ECCERR1           (ELFIN_NAND_BASE+NF8ECCERR1_OFFSET)</span>
</span><span class='line'><span class="cp">#define NF8ECCERR2           (ELFIN_NAND_BASE+NF8ECCERR2_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFM8ECC0         (ELFIN_NAND_BASE+NFM8ECC0_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFM8ECC1         (ELFIN_NAND_BASE+NFM8ECC1_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFM8ECC2         (ELFIN_NAND_BASE+NFM8ECC2_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFM8ECC3         (ELFIN_NAND_BASE+NFM8ECC3_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFMLC8BITPT0     (ELFIN_NAND_BASE+NFMLC8BITPT0_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFMLC8BITPT1     (ELFIN_NAND_BASE+NFMLC8BITPT1_OFFSET)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define __REG(x)             (*(volatile unsigned long *)(x))</span>
</span><span class='line'><span class="cp">#define __REGb(x)                (*(volatile unsigned char *)(x))</span>
</span><span class='line'><span class="cp">#define NFCONF_REG               __REG(ELFIN_NAND_BASE+NFCONF_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFCONT_REG               __REG(ELFIN_NAND_BASE+NFCONT_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFCMD_REG                __REG(ELFIN_NAND_BASE+NFCMMD_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFADDR_REG               __REG(ELFIN_NAND_BASE+NFADDR_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFDATA_REG           __REG(ELFIN_NAND_BASE+NFDATA_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFDATA8_REG              __REGb(ELFIN_NAND_BASE+NFDATA_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFMECCDATA0_REG      __REG(ELFIN_NAND_BASE+NFMECCDATA0_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFMECCDATA1_REG      __REG(ELFIN_NAND_BASE+NFMECCDATA1_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFSECCDATA0_REG          __REG(ELFIN_NAND_BASE+NFSECCDATA0_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFSBLK_REG           __REG(ELFIN_NAND_BASE+NFSBLK_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFEBLK_REG               __REG(ELFIN_NAND_BASE+NFEBLK_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFSTAT_REG               __REG(ELFIN_NAND_BASE+NFSTAT_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFESTAT0_REG             __REG(ELFIN_NAND_BASE+NFESTAT0_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFESTAT1_REG             __REG(ELFIN_NAND_BASE+NFESTAT1_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFMECC0_REG              __REG(ELFIN_NAND_BASE+NFMECC0_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFMECC1_REG              __REG(ELFIN_NAND_BASE+NFMECC1_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFSECC_REG               __REG(ELFIN_NAND_BASE+NFSECC_OFFSET)</span>
</span><span class='line'><span class="cp">#define NFMLCBITPT_REG           __REG(ELFIN_NAND_BASE+NFMLCBITPT_OFFSET)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define NAND_DISABLE_CE()    (NFCONT_REG |= (1 &lt;&lt; 1))</span>
</span><span class='line'><span class="cp">#define NAND_ENABLE_CE() (NFCONT_REG &amp;= ~(1 &lt;&lt; 1))</span>
</span><span class='line'><span class="cp">#define NF_TRANSRnB()        do { while(!(NFSTAT_REG &amp; (1 &lt;&lt; 0))); } while(0)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// Standard NAND flash commands</span>
</span><span class='line'><span class="cp">#define NAND_CMD_READ0       0</span>
</span><span class='line'><span class="cp">#define NAND_CMD_READ1       1</span>
</span><span class='line'><span class="cp">#define NAND_CMD_RNDOUT      5</span>
</span><span class='line'><span class="cp">#define NAND_CMD_PAGEPROG    0x10</span>
</span><span class='line'><span class="cp">#define NAND_CMD_READOOB 0x50</span>
</span><span class='line'><span class="cp">#define NAND_CMD_ERASE1      0x60</span>
</span><span class='line'><span class="cp">#define NAND_CMD_STATUS      0x70</span>
</span><span class='line'><span class="cp">#define NAND_CMD_STATUS_MULTI    0x71</span>
</span><span class='line'><span class="cp">#define NAND_CMD_SEQIN       0x80</span>
</span><span class='line'><span class="cp">#define NAND_CMD_RNDIN       0x85</span>
</span><span class='line'><span class="cp">#define NAND_CMD_READID      0x90</span>
</span><span class='line'><span class="cp">#define NAND_CMD_ERASE2      0xd0</span>
</span><span class='line'><span class="cp">#define NAND_CMD_RESET       0xff</span>
</span><span class='line'><span class="c1">// Extended commands for large page devices</span>
</span><span class='line'><span class="cp">#define NAND_CMD_READSTART   0x30</span>
</span><span class='line'><span class="cp">#define NAND_CMD_RNDOUTSTART 0xE0</span>
</span><span class='line'><span class="cp">#define NAND_CMD_CACHEDPROG  0x15</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define MEM_SYS_CFG     (*((volatile unsigned long *)0x7E00F120))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">nand_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// 设置NAND Flash控制器</span>
</span><span class='line'>  <span class="n">NFCONF_REG</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="mh">0x2</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mh">0xf</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mh">0x7</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>  <span class="n">NFCONT_REG</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x3</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 读一页，即2048byte</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">nandll_read_page</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">page_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 发片选</span>
</span><span class='line'>  <span class="n">NAND_ENABLE_CE</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 发读命令：0x00</span>
</span><span class='line'>  <span class="n">NFCMD_REG</span> <span class="o">=</span> <span class="n">NAND_CMD_READ0</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// 发地址</span>
</span><span class='line'>  <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>  <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>  <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// 发读命令：0x30</span>
</span><span class='line'>  <span class="n">NFCMD_REG</span> <span class="o">=</span> <span class="n">NAND_CMD_READSTART</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 等待数据</span>
</span><span class='line'>  <span class="n">NF_TRANSRnB</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 连续读2048个字节</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">page_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">NFDATA8_REG</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 取消片选</span>
</span><span class='line'>  <span class="n">NAND_DISABLE_CE</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// 从NAND中拷贝代码到DRAM</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">copy2ddr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nand_start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ddr_start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ddr_start</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page_shift</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 发片选</span>
</span><span class='line'>  <span class="n">NAND_ENABLE_CE</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 使len为2048的整数倍</span>
</span><span class='line'>  <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span><span class="o">/</span><span class="mi">2048</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2048</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 循环拷贝，每次拷贝一页数据</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">len</span><span class="o">&gt;&gt;</span><span class="n">page_shift</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">buf</span><span class="o">+=</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">page_shift</span><span class="p">))</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 读一页，即2048byte</span>
</span><span class='line'>      <span class="n">nandll_read_page</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>异常向量表</h3>

<blockquote><ol>
<li>CPU一上电进入SVC模式</li>
<li>当CPU进入异常模式后，当前的cpsr的值会被保存到相应的spsr_xxx中</li>
<li>swi用来做系统调用</li>
<li>未定义异常用来做调试，打断点</li>
</ol>
</blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="p">.</span><span class="n">globl</span> <span class="n">_start</span>
</span><span class='line'><span class="nl">_start</span><span class="p">:</span>
</span><span class='line'>  <span class="c1">// 异常向量表</span>
</span><span class='line'>  <span class="n">b</span> <span class="n">reset</span>                           <span class="cm">/* 复位时,cpu跳到0地址 */</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">_undefined_instruction</span>  <span class="cm">/* 未定义指令异常 */</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">_swi</span>                   <span class="cm">/* swi异常，进入svc模式 */</span>
</span><span class='line'>  <span class="err">@</span><span class="n">ldr</span>    <span class="n">pc</span><span class="p">,</span> <span class="n">_prefetch_abort</span>            <span class="cm">/* 预取中止异常 */</span>
</span><span class='line'>  <span class="err">@</span><span class="n">ldr</span>    <span class="n">pc</span><span class="p">,</span> <span class="n">_data_abort</span>            <span class="cm">/* 数据访问异常 */</span>
</span><span class='line'>  <span class="err">@</span><span class="n">ldr</span>    <span class="n">pc</span><span class="p">,</span> <span class="n">_not_used</span>              <span class="cm">/* 没用到 */</span>
</span><span class='line'>  <span class="err">@</span><span class="n">ldr</span>    <span class="n">pc</span><span class="p">,</span> <span class="n">_irq</span>                   <span class="cm">/* 中断异常 */</span>
</span><span class='line'>  <span class="err">@</span><span class="n">ldr</span>    <span class="n">pc</span><span class="p">,</span> <span class="n">_fiq</span>                   <span class="cm">/* 快中断异常 */</span>
</span></code></pre></td></tr></table></div></figure>


<h3>进入user模式</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="c1">// 进入user 模式</span>
</span><span class='line'><span class="n">mrs</span> <span class="n">r0</span><span class="p">,</span> <span class="n">cpsr</span>
</span><span class='line'><span class="n">bic</span>    <span class="n">r0</span><span class="p">,</span><span class="n">r0</span><span class="p">,</span><span class="err">#</span><span class="mh">0x1f</span>
</span><span class='line'><span class="n">orr</span>    <span class="n">r0</span><span class="p">,</span><span class="n">r0</span><span class="p">,</span><span class="err">#</span><span class="mh">0x10</span>
</span><span class='line'><span class="n">msr</span>    <span class="n">cpsr</span><span class="p">,</span><span class="n">r0</span>
</span></code></pre></td></tr></table></div></figure>


<h3>中断</h3>

<blockquote><ol>
<li>CPU执行每一条指令前都会先判断有无中断发生，如果有，则硬件自动完成以下工作：

<ul>
<li>CPU进入IRQ模式</li>
<li>当前的CPSR值保存到自己的SPSR寄存器中</li>
<li>切换使用当前模式的R13和R14</li>
<li>将下一条指令的地址保存到寄存器R14(即lr寄存器)中</li>
<li>跳转到0x18地址</li>
</ul>
</li>
<li>软件执行的工作：

<ul>
<li>分辨中断源，调用对应的中断处理函数</li>
</ul>
</li>
</ol>
</blockquote>

<h3>LCD</h3>

<blockquote><ul>
<li>怎么写LCD驱动程序

<ol>
<li>设置LCD控制器

<ul>
<li>分辨率</li>
<li>时间参数</li>
</ul>
</li>
<li>分配一部分DDR中的内存，并告诉LCD控制器</li>
<li>设置像素的颜色格式</li>
</ol>
</li>
</ul>
</blockquote>

<h3>内存管理单元</h3>

<blockquote><ul>
<li>功能：权限管理，地址映射</li>
<li>段映射的单位是1M</li>
<li>步骤：

<ol>
<li>建立表格</li>
<li>把表格地址告诉MMU</li>
<li>启动MMU</li>
</ol>
</li>
</ul>
</blockquote>

<h3>从SD卡启动</h3>

<blockquote><ol>
<li>SD卡启动，实际上是先执行片内IROM中的一段程序，该程序从SD卡中读取代码，写到stepping stone 中，stepping stone是位于0x0c000000、size为8K的片内内存</li>
<li>在SD启动方式下，S3C6410内部的IROM程序BL0首先运行，并将SD中的最后18个扇区开始的16个扇区内容复制到片内的8K SRAM，也就是SteppingStone，接着跳转到这块SRAM的开始地址开始运行,这8K的代码也叫BL1,在这8K代码中必须要负责将SD内的uboot完整地复制到SDRAM，这时候完整的uboot也叫BL2，这个任务由一个叫做movi_bl2_copy的函数完成,这个函数实际上是
调用了以下函数：
CopyMovitoMem(HSMMC_CHANNEL, MOVI_BL2_POS, MOVI_BL2_BLKCNT, (uint *)BL2_BASE, MOVI_INIT_REQUIRED);</li>
<li>HSMMC_CHANNEL这是SD/MMC通道号,6410是0</li>
<li>MOVI_BL2_POS 是需要拷贝的数据位于SD的起始扇区,其计算办法是这样的，先得到这个SD的总扇区数TOTAL，再减去256K的BL2和8K的BL1所占的扇区数，再减去环境变量占据的128K，最后减去0.5K的eFuse和0.5K的保留区所占的扇区数，而这里还定义SD的扇区为512B。总扇区数TOTAL是从(TCM_BASE - 0x4)这个地址读取到的，至于TOTAL是如何被放到这里的就只能从BL0的代码找答案了</li>
<li>MOVI_BL2_BLKCNT是需要复制的扇区数目，这里就是定义为256K</li>
<li>BL2_BASE是目的地址，也就是SDRAM中的地址。这里定义为0x57E00000</li>
<li>MOVI_INIT_REQUIRED定义为0</li>
<li>Linux下使用dd命令进行烧写SD卡</li>
</ol>
</blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#for SD Card,total sectors=1961984</span>
</span><span class='line'><span class="n">dd</span> <span class="n">iflag</span><span class="o">=</span><span class="n">dsync</span> <span class="n">oflag</span><span class="o">=</span><span class="n">dsync</span> <span class="k">if</span><span class="o">=</span><span class="n">u</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">sd</span><span class="p">.</span><span class="n">bin</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb</span> <span class="n">bs</span><span class="o">=</span><span class="mi">512</span> <span class="n">count</span><span class="o">=</span><span class="mi">16</span> <span class="n">seek</span><span class="o">=</span><span class="mi">1961966</span>
</span><span class='line'><span class="n">dd</span> <span class="n">iflag</span><span class="o">=</span><span class="n">dsync</span> <span class="n">oflag</span><span class="o">=</span><span class="n">dsync</span> <span class="k">if</span><span class="o">=</span><span class="n">u</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">sd</span><span class="p">.</span><span class="n">bin</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb</span> <span class="n">bs</span><span class="o">=</span><span class="mi">512</span> <span class="n">count</span><span class="o">=</span><span class="mi">512</span> <span class="n">seek</span><span class="o">=</span><span class="mi">1961198</span>
</span><span class='line'><span class="n">sync</span>
</span><span class='line'><span class="cp">#BL1:total sectors - 2 - 1024(if your SD Card Size &gt; 2G) -16</span>
</span><span class='line'><span class="cp">#BL2:total sectors - 2 - 1024(if your SD Card Size &gt; 2G) -16 - 512 - 256</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-14T19:39:49+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/s3c6410/'>s3c6410</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/13/start-dot-s/">
		
			start.S</a>
	</h2>
	<div class="entry-content">
		<figure class='code'><figcaption><span>start.S</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
<span class='line-number'>457</span>
<span class='line-number'>458</span>
<span class='line-number'>459</span>
<span class='line-number'>460</span>
<span class='line-number'>461</span>
<span class='line-number'>462</span>
<span class='line-number'>463</span>
<span class='line-number'>464</span>
<span class='line-number'>465</span>
<span class='line-number'>466</span>
<span class='line-number'>467</span>
<span class='line-number'>468</span>
<span class='line-number'>469</span>
<span class='line-number'>470</span>
<span class='line-number'>471</span>
<span class='line-number'>472</span>
<span class='line-number'>473</span>
<span class='line-number'>474</span>
<span class='line-number'>475</span>
<span class='line-number'>476</span>
<span class='line-number'>477</span>
<span class='line-number'>478</span>
<span class='line-number'>479</span>
<span class='line-number'>480</span>
<span class='line-number'>481</span>
<span class='line-number'>482</span>
<span class='line-number'>483</span>
<span class='line-number'>484</span>
<span class='line-number'>485</span>
<span class='line-number'>486</span>
<span class='line-number'>487</span>
<span class='line-number'>488</span>
<span class='line-number'>489</span>
<span class='line-number'>490</span>
<span class='line-number'>491</span>
<span class='line-number'>492</span>
<span class='line-number'>493</span>
<span class='line-number'>494</span>
<span class='line-number'>495</span>
<span class='line-number'>496</span>
<span class='line-number'>497</span>
<span class='line-number'>498</span>
<span class='line-number'>499</span>
<span class='line-number'>500</span>
<span class='line-number'>501</span>
<span class='line-number'>502</span>
<span class='line-number'>503</span>
<span class='line-number'>504</span>
<span class='line-number'>505</span>
<span class='line-number'>506</span>
<span class='line-number'>507</span>
<span class='line-number'>508</span>
<span class='line-number'>509</span>
<span class='line-number'>510</span>
<span class='line-number'>511</span>
<span class='line-number'>512</span>
<span class='line-number'>513</span>
<span class='line-number'>514</span>
<span class='line-number'>515</span>
<span class='line-number'>516</span>
<span class='line-number'>517</span>
<span class='line-number'>518</span>
<span class='line-number'>519</span>
<span class='line-number'>520</span>
<span class='line-number'>521</span>
<span class='line-number'>522</span>
<span class='line-number'>523</span>
<span class='line-number'>524</span>
<span class='line-number'>525</span>
<span class='line-number'>526</span>
<span class='line-number'>527</span>
<span class='line-number'>528</span>
<span class='line-number'>529</span>
<span class='line-number'>530</span>
<span class='line-number'>531</span>
<span class='line-number'>532</span>
<span class='line-number'>533</span>
<span class='line-number'>534</span>
<span class='line-number'>535</span>
<span class='line-number'>536</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;config.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;version.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;regs.h&gt;      </span><span class="cm">/*6410外设寄存器头文件*/</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*6410在Uboot中是开启MMU的，目的为了开启DCache来提高运行速度,CFG_PHY_UBOOT_BASE=0x57e00000*/</span>
</span><span class='line'><span class="cp">#ifndef CONFIG_ENABLE_MMU</span>
</span><span class='line'><span class="cp">#ifndef CFG_PHY_UBOOT_BASE</span>
</span><span class='line'><span class="cp">#define CFG_PHY_UBOOT_BASE   CFG_UBOOT_BASE</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> *************************************************************************</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Jump vector table as in table 3.1 in [1]</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *************************************************************************</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="p">.</span><span class="n">globl</span> <span class="n">_start</span>        <span class="cm">/*在u-boot.lds中指明了ENTRY(_start),所以这里需要对外公开_start的地址*/</span>
</span><span class='line'><span class="cm">/*下面是异常向量表,地址范围0~0x20,正好8条指令，每条指令4字节*/</span>
</span><span class='line'><span class="nl">_start</span><span class="p">:</span> <span class="n">b</span>   <span class="n">reset</span>    <span class="cm">/*相对跳转指令，位置无关码*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">_undefined_instruction</span> <span class="cm">/*undefined异常由arm核译码单元检测，并触发未定义指令异常请求，硬件设置pc的值为0x4，强制程序从内存0x4地址执行指令*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">_software_interrupt</span>        <span class="cm">/*arm中使用swi指令时触发软件中断，硬件设置PC的值为0x8，同时进入系统模式，多用在系统库的编写*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">_prefetch_abort</span>            <span class="cm">/*prefetch异常，预取指中止异常，导致正在取的指令无法正常取出，这里需要注意流水线造成的pc值*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">_data_abort</span>                <span class="cm">/*data中止，无法获取数据，产生的原因有可能是内存未准备好、内存无读或写权限等一些原因产生的异常*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">_not_used</span>              <span class="cm">/* 0x14暂时未使用*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">_irq</span>                   <span class="cm">/* 0x18提供系统硬件中断跳转接口*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">_fiq</span>                   <span class="cm">/* 0x1c地址为_fiq快速中断，一个系统在中断流水线上可能产生很多中断，但快中断只会有一个*/</span>
</span><span class='line'>
</span><span class='line'><span class="nl">_undefined_instruction</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">undefined_instruction</span>
</span><span class='line'><span class="nl">_software_interrupt</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">software_interrupt</span>
</span><span class='line'><span class="nl">_prefetch_abort</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">prefetch_abort</span>
</span><span class='line'><span class="nl">_data_abort</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">data_abort</span>
</span><span class='line'><span class="nl">_not_used</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">not_used</span>
</span><span class='line'><span class="nl">_irq</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">irq</span>
</span><span class='line'><span class="nl">_fiq</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">fiq</span>
</span><span class='line'><span class="nl">_pad</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="mh">0x12345678</span> <span class="cm">/* now 16*4=64 */</span>
</span><span class='line'><span class="p">.</span><span class="n">global</span> <span class="n">_end_vect</span>    <span class="cm">/*全局变量_end_vect*/</span>
</span><span class='line'><span class="nl">_end_vect</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">balignl</span> <span class="mi">16</span><span class="p">,</span><span class="mh">0xdeadbeef</span>         <span class="cm">/*.balign 的作用同.align,用于表示对齐方式:通过添加填充字节使当前位置满足一定的对齐方式,以下代码按照16位对齐，不足位补上0xdeadbeef*/</span>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> *************************************************************************</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Startup Code (reset vector)</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * do important init only if we don&#39;t start from memory!</span>
</span><span class='line'><span class="cm"> * setup Memory and board specific bits prior to relocation.</span>
</span><span class='line'><span class="cm"> * relocate armboot to ram</span>
</span><span class='line'><span class="cm"> * setup stack</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *************************************************************************</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="nl">_TEXT_BASE</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">TEXT_BASE</span>        <span class="cm">/*定义uboot程序的运行地址，值为0xc7e0 0000,TEXT_BASE在编译的时候，通过向编译器传递参数获得,值的定义在config.mk中，Makefile会包含它*/</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Below variable is very important because we use MMU in U-Boot.</span>
</span><span class='line'><span class="cm"> * Without it, we cannot run code correctly before MMU is ON.</span>
</span><span class='line'><span class="cm"> * by scsuh.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nl">_TEXT_PHY_BASE</span><span class="p">:</span>                <span class="cm">/*MMU开启前uboot在内存存放的是真实物理地址,0x57e0 0000*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">CFG_PHY_UBOOT_BASE</span>
</span><span class='line'>
</span><span class='line'><span class="p">.</span><span class="n">globl</span> <span class="n">_armboot_start</span>
</span><span class='line'><span class="nl">_armboot_start</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">_start</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * These are defined in the board-specific linker script.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="p">.</span><span class="n">globl</span> <span class="n">_bss_start</span>
</span><span class='line'><span class="nl">_bss_start</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">__bss_start</span>      <span class="cm">/*_bss_start 保存的是__bss_start 这个标号所在的地址,不受编译时地址的影响，表示当前代码所在的地址不是编译时的地址*/</span>
</span><span class='line'>
</span><span class='line'><span class="p">.</span><span class="n">globl</span> <span class="n">_bss_end</span>
</span><span class='line'><span class="nl">_bss_end</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">_end</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*uboot里面没有开启IRQ中断功能*/</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_USE_IRQ</span>
</span><span class='line'><span class="cm">/* IRQ stack memory (calculated at run-time) */</span>
</span><span class='line'><span class="p">.</span><span class="n">globl</span> <span class="n">IRQ_STACK_START</span>
</span><span class='line'><span class="nl">IRQ_STACK_START</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="mh">0x0badc0de</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* IRQ stack memory (calculated at run-time) */</span>
</span><span class='line'><span class="p">.</span><span class="n">globl</span> <span class="n">FIQ_STACK_START</span>
</span><span class='line'><span class="nl">FIQ_STACK_START</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="mh">0x0badc0de</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * the actual reset code</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*MRS {} Rd,CPSR/SPSR语句的意思：将 CPSR/SPSR的值传送到Rd*/</span>
</span><span class='line'><span class="cm">/*MSR {} CPSR|SPSR,Rm语句的意思：将Rm中的值保存到CPSR/SPSR*/</span>
</span><span class='line'><span class="nl">reset</span><span class="p">:</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * set the cpu to SVC32 mode</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="cm">/*进入SVC模式(保证CPSR寄存器的最低5位为10011)，由于ARM上电就处于SVC模式，故此代码可以省略*/</span>
</span><span class='line'>  <span class="n">mrs</span>  <span class="n">r0</span><span class="p">,</span><span class="n">cpsr</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r0</span><span class="p">,</span><span class="n">r0</span><span class="p">,</span><span class="err">#</span><span class="mh">0x1f</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r0</span><span class="p">,</span><span class="n">r0</span><span class="p">,</span><span class="err">#</span><span class="mh">0xd3</span>            <span class="cm">/*把0xd3赋给CPSR，即1101 0011，最高两位置1的意思是关闭中断和快中断,bit【5】为0的意思是cpu的状态为arm状态，如果是1则cpu进入thumb状态*/</span>
</span><span class='line'>  <span class="n">msr</span>  <span class="n">cpsr</span><span class="p">,</span><span class="n">r0</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> *************************************************************************</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * CPU_init_critical registers</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * setup important registers</span>
</span><span class='line'><span class="cm"> * setup memory timing</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *************************************************************************</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>         <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * we do sys-critical inits only at reboot,</span>
</span><span class='line'><span class="cm">         * not when booting from ram!</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'><span class="nl">cpu_init_crit</span><span class="p">:</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * flush v4 I/D caches</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="cm">/*mcr的意思是把arm寄存器的值赋给coprocesser寄存器*/</span>
</span><span class='line'><span class="cm">/*mrc的意思是把coprocesser寄存器的值赋给arm寄存器*/</span>
</span><span class='line'><span class="cm">/*mcr{cond} coproc,opcode1,Rd,CRn,CRm,{opcode2}:coproc是协处理器，标准名为Pn，n=1~15，对应CPn；opcode1位协处理器行为操作吗，必须为0，否则协处理器状态不确定；Rd为ARM的寄存器；CRn为目标寄存器；CRm为附加寄存器，不使用的时候设为0*/</span>
</span><span class='line'><span class="cm">/*CP15是系统控制协处理器，用于连接在内存中的页表描述符,它是外部内存端口映射寄存器,32位，在开关MMU的时候发生作用，且优先级最高*/</span>
</span><span class='line'><span class="cm">/*c7，c8都被清零*/</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
</span><span class='line'>  <span class="n">mcr</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c7</span><span class="p">,</span> <span class="n">c7</span><span class="p">,</span> <span class="mi">0</span>    <span class="cm">/* flush v3/v4 cache */</span>
</span><span class='line'>  <span class="n">mcr</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c8</span><span class="p">,</span> <span class="n">c7</span><span class="p">,</span> <span class="mi">0</span>    <span class="cm">/* flush v4 TLB */</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * disable MMU stuff and caches</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="cm">/*c1是控制寄存器,其中13,9,8位为 V、R、S：V位是对高端异常向量表的支持，如果选择0异常向量表为0x00000000-0x0000001c，如果选择1异常向量表就是FFFF0000-FFFF001c；R位用于ROM保护的，具体的还要与c5里面的配合,S在这里面的意思也是用于系统保护的*/</span>
</span><span class='line'>  <span class="n">mrc</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="mi">0</span>        
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x00002300</span>    <span class="err">@</span> <span class="n">clear</span> <span class="n">bits</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">9</span><span class="o">:</span><span class="mi">8</span> <span class="p">(</span><span class="o">--</span><span class="n">V</span><span class="o">-</span> <span class="o">--</span><span class="n">RS</span><span class="p">)</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x00000087</span>    <span class="err">@</span> <span class="n">clear</span> <span class="n">bits</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="o">:</span><span class="mi">0</span> <span class="p">(</span><span class="n">B</span><span class="o">---</span> <span class="o">-</span><span class="n">CAM</span><span class="p">)</span>      <span class="cm">/*B为0表示支持小little-endian,M为0代表禁止MMU,A为0代表禁止地址对齐检查，C为0代表禁止指令数据cache控制*/</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x00000002</span>    <span class="err">@</span> <span class="n">set</span> <span class="n">bit</span> <span class="mi">2</span> <span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="n">Align</span>                <span class="cm">/*A为1代表使能地址对齐检查*/</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x00001000</span>    <span class="err">@</span> <span class="n">set</span> <span class="n">bit</span> <span class="mi">12</span> <span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="n">I</span><span class="o">-</span><span class="n">Cache</span>               <span class="cm">/*I为1代表打开指令缓存*/</span>
</span><span class='line'>  <span class="n">mcr</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Peri port setup */</span>
</span><span class='line'><span class="cm">/*把外设的基地址告诉CPU*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x70000000</span>            <span class="cm">/*对于6410来说,内存(0x00000000～0x60000000),外设(0x70000000-0x7fffffff)*/</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x13</span>          <span class="cm">/*外设大小:256M*/</span>
</span><span class='line'>    <span class="n">mcr</span>    <span class="n">p15</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">r0</span><span class="p">,</span><span class="n">c15</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="mi">4</span>       <span class="err">@</span> <span class="mi">256</span><span class="n">M</span><span class="p">(</span><span class="mh">0x70000000</span><span class="o">-</span><span class="mh">0x7fffffff</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*关闭看门狗*/</span>
</span><span class='line'><span class="cm">/*一般都在外部专门有一个看门狗,做一个外部的电路,不在cpu内部使用看门狗,cpu内部的看门狗只是复位一个cpu,当开发板很复杂时,有好几个cpu 时,就不能完全让板子复位*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * Go setup Memory and board specific bits prior to relocation.</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="cm">/*在lowlevel.S中实现比如说点亮LED灯、关闭watchdog、关闭中断、系统时钟初始、nand flash初始化、内存控制器初始化*/</span>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">lowlevel_init</span>    <span class="cm">/* go setup pll,mux,memory */</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* when we already run in ram, we don&#39;t need to relocate U-Boot.</span>
</span><span class='line'><span class="cm">  * and actually, memory controller must be configured before U-Boot</span>
</span><span class='line'><span class="cm">  * is running in ram.</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="cm">/*跳转出来以后，继续执行下面的代码，下面的代码是判断程序是否已经在ram中了，在的话就不拷贝，直接跳转到after_copy了，否则继续执行下面的代码*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="mh">0xff000fff</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">r0</span>       <span class="cm">/* r0 &lt;- current base addr of code */</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="n">_TEXT_BASE</span>     <span class="cm">/* r1 &lt;- original base addr in ram */</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r2</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r0</span>       <span class="cm">/* r0 &lt;- current base addr of code */</span>
</span><span class='line'>  <span class="n">cmp</span>     <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>                  <span class="cm">/* compare r0, r1                  */</span>
</span><span class='line'>  <span class="n">beq</span>     <span class="n">after_copy</span>        <span class="cm">/* r0 == r1 then skip flash copy   */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_BOOT_NAND      </span><span class="cm">/*从Nand启动*/</span><span class="cp"></span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1000</span>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">copy_from_nand</span>       <span class="cm">/*具体实现在后面的代码*/</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_BOOT_MOVINAND  </span><span class="cm">/*从SD卡启动*/</span><span class="cp"></span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">sp</span><span class="p">,</span> <span class="n">_TEXT_PHY_BASE</span> <span class="cm">/*因为要调用C函数，所以先要设置栈指针，此时MMU没有开启，堆栈栈顶地址为0x57e00000,ARM中的栈向下(低地址)生长*/</span>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">movi_bl2_copy</span>        <span class="cm">/*具体实现代码在于cpu/s3c64xx/movi.c*/</span>
</span><span class='line'>  <span class="n">b</span>    <span class="n">after_copy</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="nl">after_copy</span><span class="p">:</span>
</span><span class='line'>  
</span><span class='line'><span class="cm">/*协处理器c3的作用是存储的保护和控制，用在MMU中为内存的域访问控制，c3为32位寄存器，每两位为一个访问控制特权，0x00代表没有访问权限，这时候访问将失效；0x01为客户类型，将根据地址变换条目中的访问控制位决定是否允许特定内存访问；0x10是保留的，暂时没有使用，0x11为管理者权限，不考虑地址变换条目中的权限控制位，将不会访问内存失效。*/</span>
</span><span class='line'><span class="cm">/*协处理器c2用于保存页表基地址。所谓页表基地址即是虚实转换的内存页表的首地址*/</span>    
</span><span class='line'><span class="cp">#ifdef CONFIG_ENABLE_MMU</span>
</span><span class='line'><span class="nl">enable_mmu</span><span class="p">:</span>
</span><span class='line'>  <span class="cm">/* enable domain access */</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r5</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x0000ffff</span>
</span><span class='line'>  <span class="n">mcr</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r5</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="mi">0</span>        <span class="cm">/*代码的含义为设置高8个域无访问权限，低8个域为管理者权限*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Set the TTB register */</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">_mmu_table_base</span>            <span class="cm">/*_mmu_table_base=mmu_table,mmu_table在lowlevel_init.S中*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">CFG_PHY_UBOOT_BASE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="mh">0xfff00000</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span>
</span><span class='line'>  <span class="n">mcr</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="mi">0</span>        <span class="cm">/*r1的值为0x57exxxxx*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Enable the MMU */</span>
</span><span class='line'><span class="nl">mmu_on</span><span class="p">:</span>
</span><span class='line'>  <span class="n">mrc</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">1</span>                 <span class="cm">/* Set CR_M to enable MMU */</span>
</span><span class='line'>  <span class="n">mcr</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="mi">0</span>        <span class="cm">/*将c1的最后一位置1*/</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="nl">skip_hw_init</span><span class="p">:</span>
</span><span class='line'>  <span class="cm">/* Set up the stack    */</span>
</span><span class='line'><span class="nl">stack_setup</span><span class="p">:</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_MEMORY_UPPER_CODE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">sp</span><span class="p">,</span> <span class="o">=</span><span class="p">(</span><span class="n">CFG_UBOOT_BASE</span> <span class="o">+</span> <span class="n">CFG_UBOOT_SIZE</span> <span class="o">-</span> <span class="mh">0xc</span><span class="p">)</span> <span class="cm">/*sp = 0xc7e0 0000+0x20 0000-0xc=0xc7ff fff4*/</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">_TEXT_BASE</span>                                 <span class="cm">/* upper 128 KiB: relocated uboot */</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CFG_MALLOC_LEN</span>                         <span class="cm">/* malloc area */</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CFG_GBL_DATA_SIZE</span>                      <span class="cm">/* bdinfo  */</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_USE_IRQ</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="p">(</span><span class="n">CONFIG_STACKSIZE_IRQ</span><span class="o">+</span><span class="n">CONFIG_STACKSIZE_FIQ</span><span class="p">)</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">sp</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">12</span>                                        <span class="cm">/* leave 3 words for abort-stack    */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="nl">clear_bss</span><span class="p">:</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">_bss_start</span>                                 <span class="cm">/* find start of bss segment*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">_bss_end</span>                               
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r2</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x00000000</span>                              
</span><span class='line'>
</span><span class='line'><span class="nl">clbss_l</span><span class="p">:</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r2</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>     
</span><span class='line'>  <span class="n">add</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>
</span><span class='line'>  <span class="n">cmp</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span>
</span><span class='line'>  <span class="n">ble</span>  <span class="n">clbss_l</span>                                          <span class="cm">/*ble指令表明：小于或者等于就跳转*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">_start_armboot</span>                             <span class="cm">/*跳转到uboot代码的第二个阶段的入口点。这里不能使用b跳转指令，因为此时代码还没有在ddr中运行*/</span>
</span><span class='line'>
</span><span class='line'><span class="nl">_start_armboot</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">start_armboot</span>                                    <span class="cm">/*定义在lib_arm/board.c中的函数*/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_ENABLE_MMU</span>
</span><span class='line'><span class="nl">_mmu_table_base</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">mmu_table</span>                                        <span class="cm">/*在lowlevel_init.S中将mmu_tabel声明为全局变量*/</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * copy U-Boot to SDRAM and jump to ram (from NAND or OneNAND)</span>
</span><span class='line'><span class="cm"> * r0: size to be compared</span>
</span><span class='line'><span class="cm"> * Load 1&#39;st 2blocks to RAM because U-boot&#39;s size is larger than 1block(128k) size</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">copy_from_nand</span>
</span><span class='line'><span class="nl">copy_from_nand</span><span class="p">:</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r10</span><span class="p">,</span> <span class="n">lr</span>                                            <span class="cm">/* save return address */</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r9</span><span class="p">,</span> <span class="n">r0</span>
</span><span class='line'>  <span class="cm">/* get ready to call C functions */</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">sp</span><span class="p">,</span> <span class="n">_TEXT_PHY_BASE</span>                             <span class="cm">/*设置好临时的堆栈指针,此时MMU还没有开启，所以sp=0x57e0 0000*/</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">12</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>                                           <span class="cm">/* no previous frame, so fp=0 */</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r9</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1000</span>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">copy_uboot_to_ram</span>                                <span class="cm">/*函数在cpu/s3c64xx/Nand_cp.c中.从nand中读取0x50000(大于uboot实际大小)大小的内容到内存0x57e00000中,*/</span>
</span><span class='line'>
</span><span class='line'><span class="mi">3</span><span class="o">:</span> <span class="n">tst</span>  <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>                                 <span class="cm">/*r0中保存着copy_uboot_to_ram的返回值，如果返回值不是0，就表明失败,进入死循环*/</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">copy_failed</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x0c000000</span>                                    <span class="cm">/*校验拷贝是否失真，比较的地址为：0x0c000000(stepping stone)和0x57e0 0000*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">_TEXT_PHY_BASE</span>
</span><span class='line'><span class="mi">1</span><span class="o">:</span> <span class="n">ldr</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">],</span> <span class="err">#</span><span class="mi">4</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r4</span><span class="p">,</span> <span class="p">[</span><span class="n">r1</span><span class="p">],</span> <span class="err">#</span><span class="mi">4</span>
</span><span class='line'>  <span class="n">teq</span>  <span class="n">r3</span><span class="p">,</span> <span class="n">r4</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">compare_failed</span>   <span class="cm">/* not matched */</span>               <span class="cm">/*如果发生了失真就进入死循环*/</span>
</span><span class='line'>  <span class="n">subs</span> <span class="n">r9</span><span class="p">,</span> <span class="n">r9</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>                                 <span class="cm">/*总共比较4K大小的数据，没有全部比较*/</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="mi">1</span><span class="n">b</span>
</span><span class='line'>
</span><span class='line'><span class="mi">4</span><span class="o">:</span> <span class="n">mov</span>  <span class="n">lr</span><span class="p">,</span> <span class="n">r10</span>        <span class="cm">/* all is OK */</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>
</span><span class='line'>
</span><span class='line'><span class="nl">copy_failed</span><span class="p">:</span>
</span><span class='line'>  <span class="n">nop</span>          <span class="cm">/* copy from nand failed */</span>
</span><span class='line'>  <span class="n">b</span>    <span class="n">copy_failed</span>
</span><span class='line'>
</span><span class='line'><span class="nl">compare_failed</span><span class="p">:</span>
</span><span class='line'>  <span class="n">nop</span>          <span class="cm">/* compare failed */</span>
</span><span class='line'>  <span class="n">b</span>    <span class="n">compare_failed</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * we assume that cache operation is done before. (eg. cleanup_before_linux())</span>
</span><span class='line'><span class="cm"> * actually, we don&#39;t need to do anything about cache if not use d-cache in U-Boot</span>
</span><span class='line'><span class="cm"> * So, in this function we clean only MMU. by scsuh</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * void  theLastJump(void *kernel, int arch_num, uint boot_params);</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_ENABLE_MMU</span>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">theLastJump</span>
</span><span class='line'><span class="nl">theLastJump</span><span class="p">:</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r9</span><span class="p">,</span> <span class="n">r0</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r3</span><span class="p">,</span> <span class="o">=</span><span class="mh">0xfff00000</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r4</span><span class="p">,</span> <span class="n">_TEXT_PHY_BASE</span>
</span><span class='line'>  <span class="n">adr</span>  <span class="n">r5</span><span class="p">,</span> <span class="n">phy_last_jump</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r5</span><span class="p">,</span> <span class="n">r5</span><span class="p">,</span> <span class="n">r3</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r5</span><span class="p">,</span> <span class="n">r5</span><span class="p">,</span> <span class="n">r4</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">r5</span>
</span><span class='line'><span class="nl">phy_last_jump</span><span class="p">:</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * disable MMU stuff</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="n">mrc</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x00002300</span>    <span class="cm">/* clear bits 13, 9:8 (--V- --RS) */</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x00000087</span>    <span class="cm">/* clear bits 7, 2:0 (B--- -CAM) */</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x00000002</span>    <span class="cm">/* set bit 2 (A) Align */</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x00001000</span>    <span class="cm">/* set bit 12 (I) I-Cache */</span>
</span><span class='line'>  <span class="n">mcr</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mcr</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c8</span><span class="p">,</span> <span class="n">c7</span><span class="p">,</span> <span class="mi">0</span>    <span class="cm">/* flush v4 TLB */</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">r9</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> *************************************************************************</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Interrupt handling</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *************************************************************************</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="err">@</span>
</span><span class='line'><span class="err">@</span> <span class="n">IRQ</span> <span class="n">stack</span> <span class="n">frame</span><span class="p">.</span>
</span><span class='line'><span class="err">@</span>
</span><span class='line'><span class="cp">#define S_FRAME_SIZE 72</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define S_OLD_R0 68</span>
</span><span class='line'><span class="cp">#define S_PSR        64</span>
</span><span class='line'><span class="cp">#define S_PC     60</span>
</span><span class='line'><span class="cp">#define S_LR     56</span>
</span><span class='line'><span class="cp">#define S_SP     52</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define S_IP     48</span>
</span><span class='line'><span class="cp">#define S_FP     44</span>
</span><span class='line'><span class="cp">#define S_R10        40</span>
</span><span class='line'><span class="cp">#define S_R9     36</span>
</span><span class='line'><span class="cp">#define S_R8     32</span>
</span><span class='line'><span class="cp">#define S_R7     28</span>
</span><span class='line'><span class="cp">#define S_R6     24</span>
</span><span class='line'><span class="cp">#define S_R5     20</span>
</span><span class='line'><span class="cp">#define S_R4     16</span>
</span><span class='line'><span class="cp">#define S_R3     12</span>
</span><span class='line'><span class="cp">#define S_R2     8</span>
</span><span class='line'><span class="cp">#define S_R1     4</span>
</span><span class='line'><span class="cp">#define S_R0     0</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define MODE_SVC 0x13</span>
</span><span class='line'><span class="cp">#define I_BIT     0x80</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * use bad_save_user_regs for abort/prefetch/undef/swi ...</span>
</span><span class='line'><span class="cm"> * use irq_save_user_regs / irq_restore_user_regs for IRQ/FIQ handling</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">macro</span>    <span class="n">bad_save_user_regs</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_FRAME_SIZE</span>       <span class="err">@</span> <span class="n">carve</span> <span class="n">out</span> <span class="n">a</span> <span class="n">frame</span> <span class="n">on</span> <span class="n">current</span> <span class="n">user</span> <span class="n">stack</span>
</span><span class='line'>  <span class="n">stmia</span>    <span class="n">sp</span><span class="p">,</span> <span class="p">{</span><span class="n">r0</span> <span class="o">-</span> <span class="n">r12</span><span class="p">}</span>         <span class="err">@</span> <span class="n">Save</span> <span class="n">user</span> <span class="n">registers</span> <span class="p">(</span><span class="n">now</span> <span class="n">in</span> <span class="n">svc</span> <span class="n">mode</span><span class="p">)</span> <span class="n">r0</span><span class="o">-</span><span class="n">r12</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="n">_armboot_start</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">r2</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="err">#</span><span class="p">(</span><span class="n">CFG_MALLOC_LEN</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">r2</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="err">#</span><span class="p">(</span><span class="n">CFG_GBL_DATA_SIZE</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span> <span class="err">@</span> <span class="n">set</span> <span class="n">base</span> <span class="mi">2</span> <span class="n">words</span> <span class="n">into</span> <span class="n">abort</span> <span class="n">stack</span>
</span><span class='line'>  <span class="n">ldmia</span>    <span class="n">r2</span><span class="p">,</span> <span class="p">{</span><span class="n">r2</span> <span class="o">-</span> <span class="n">r3</span><span class="p">}</span>          <span class="err">@</span> <span class="n">get</span> <span class="n">values</span> <span class="k">for</span> <span class="s">&quot;aborted&quot;</span> <span class="n">pc</span> <span class="n">and</span> <span class="n">cpsr</span> <span class="p">(</span><span class="n">into</span> <span class="n">parm</span> <span class="n">regs</span><span class="p">)</span>
</span><span class='line'>  <span class="n">add</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_FRAME_SIZE</span>       <span class="err">@</span> <span class="n">grab</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">old</span> <span class="n">stack</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">add</span>  <span class="n">r5</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_SP</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">lr</span>
</span><span class='line'>  <span class="n">stmia</span>    <span class="n">r5</span><span class="p">,</span> <span class="p">{</span><span class="n">r0</span> <span class="o">-</span> <span class="n">r3</span><span class="p">}</span>          <span class="err">@</span> <span class="n">save</span> <span class="n">sp_SVC</span><span class="p">,</span> <span class="n">lr_SVC</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">cpsr</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">sp</span>             <span class="err">@</span> <span class="n">save</span> <span class="n">current</span> <span class="n">stack</span> <span class="n">into</span> <span class="n">r0</span> <span class="p">(</span><span class="n">param</span> <span class="k">register</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endm</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">macro</span>    <span class="n">irq_save_user_regs</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_FRAME_SIZE</span>
</span><span class='line'>  <span class="n">stmia</span>    <span class="n">sp</span><span class="p">,</span> <span class="p">{</span><span class="n">r0</span> <span class="o">-</span> <span class="n">r12</span><span class="p">}</span>         <span class="err">@</span> <span class="n">Calling</span> <span class="n">r0</span><span class="o">-</span><span class="n">r12</span>
</span><span class='line'>  <span class="n">add</span>  <span class="n">r8</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_PC</span>           <span class="err">@</span> <span class="o">!!!!</span> <span class="n">R8</span> <span class="n">NEEDS</span> <span class="n">to</span> <span class="n">be</span> <span class="n">saved</span> <span class="o">!!!!</span> <span class="n">a</span> <span class="n">reserved</span> <span class="n">stack</span> <span class="n">spot</span> <span class="n">would</span> <span class="n">be</span> <span class="n">good</span><span class="p">.</span>
</span><span class='line'>  <span class="n">stmdb</span>    <span class="n">r8</span><span class="p">,</span> <span class="p">{</span><span class="n">sp</span><span class="p">,</span> <span class="n">lr</span><span class="p">}</span><span class="o">^</span>           <span class="err">@</span> <span class="n">Calling</span> <span class="n">SP</span><span class="p">,</span> <span class="n">LR</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">lr</span><span class="p">,</span> <span class="p">[</span><span class="n">r8</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span><span class="p">]</span>         <span class="err">@</span> <span class="n">Save</span> <span class="n">calling</span> <span class="n">PC</span>
</span><span class='line'>  <span class="n">mrs</span>  <span class="n">r6</span><span class="p">,</span> <span class="n">spsr</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r6</span><span class="p">,</span> <span class="p">[</span><span class="n">r8</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="p">]</span>         <span class="err">@</span> <span class="n">Save</span> <span class="n">CPSR</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">r8</span><span class="p">,</span> <span class="err">#</span><span class="mi">8</span><span class="p">]</span>         <span class="err">@</span> <span class="n">Save</span> <span class="n">OLD_R0</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">sp</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endm</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">macro</span>    <span class="n">irq_restore_user_regs</span>
</span><span class='line'>  <span class="n">ldmia</span>    <span class="n">sp</span><span class="p">,</span> <span class="p">{</span><span class="n">r0</span> <span class="o">-</span> <span class="n">lr</span><span class="p">}</span><span class="o">^</span>          <span class="err">@</span> <span class="n">Calling</span> <span class="n">r0</span> <span class="o">-</span> <span class="n">lr</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">lr</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_PC</span><span class="p">]</span>           <span class="err">@</span> <span class="n">Get</span> <span class="n">PC</span>
</span><span class='line'>  <span class="n">add</span>  <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="n">S_FRAME_SIZE</span>
</span><span class='line'>  <span class="n">subs</span> <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>         <span class="err">@</span> <span class="k">return</span> <span class="o">&amp;</span> <span class="n">move</span> <span class="n">spsr_svc</span> <span class="n">into</span> <span class="n">cpsr</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endm</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">macro</span> <span class="n">get_bad_stack</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r13</span><span class="p">,</span> <span class="n">_armboot_start</span>        <span class="err">@</span> <span class="n">setup</span> <span class="n">our</span> <span class="n">mode</span> <span class="n">stack</span> <span class="p">(</span><span class="n">enter</span> <span class="n">in</span> <span class="n">banked</span> <span class="n">mode</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">r13</span><span class="p">,</span> <span class="n">r13</span><span class="p">,</span> <span class="err">#</span><span class="p">(</span><span class="n">CFG_MALLOC_LEN</span><span class="p">)</span>   <span class="err">@</span> <span class="n">move</span> <span class="n">past</span> <span class="n">malloc</span> <span class="n">pool</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">r13</span><span class="p">,</span> <span class="n">r13</span><span class="p">,</span> <span class="err">#</span><span class="p">(</span><span class="n">CFG_GBL_DATA_SIZE</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span> <span class="err">@</span> <span class="n">move</span> <span class="n">to</span> <span class="n">reserved</span> <span class="n">a</span> <span class="n">couple</span> <span class="n">spots</span> <span class="k">for</span> <span class="n">abort</span> <span class="n">stack</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">str</span>  <span class="n">lr</span><span class="p">,</span> <span class="p">[</span><span class="n">r13</span><span class="p">]</span>            <span class="err">@</span> <span class="n">save</span> <span class="n">caller</span> <span class="n">lr</span> <span class="n">in</span> <span class="n">position</span> <span class="mi">0</span> <span class="n">of</span> <span class="n">saved</span> <span class="n">stack</span>
</span><span class='line'>  <span class="n">mrs</span>  <span class="n">lr</span><span class="p">,</span> <span class="n">spsr</span>           <span class="err">@</span> <span class="n">get</span> <span class="n">the</span> <span class="n">spsr</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">lr</span><span class="p">,</span> <span class="p">[</span><span class="n">r13</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="p">]</span>            <span class="err">@</span> <span class="n">save</span> <span class="n">spsr</span> <span class="n">in</span> <span class="n">position</span> <span class="mi">1</span> <span class="n">of</span> <span class="n">saved</span> <span class="n">stack</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r13</span><span class="p">,</span> <span class="err">#</span><span class="n">MODE_SVC</span>            <span class="err">@</span> <span class="n">prepare</span> <span class="n">SVC</span><span class="o">-</span><span class="n">Mode</span>
</span><span class='line'>  <span class="err">@</span> <span class="n">msr</span>   <span class="n">spsr_c</span><span class="p">,</span> <span class="n">r13</span>
</span><span class='line'>  <span class="n">msr</span>  <span class="n">spsr</span><span class="p">,</span> <span class="n">r13</span>          <span class="err">@</span> <span class="k">switch</span> <span class="n">modes</span><span class="p">,</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">moves</span> <span class="n">will</span> <span class="n">execute</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">lr</span><span class="p">,</span> <span class="n">pc</span>             <span class="err">@</span> <span class="n">capture</span> <span class="k">return</span> <span class="n">pc</span>
</span><span class='line'>  <span class="n">movs</span> <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>             <span class="err">@</span> <span class="n">jump</span> <span class="n">to</span> <span class="n">next</span> <span class="n">instruction</span> <span class="o">&amp;</span> <span class="k">switch</span> <span class="n">modes</span><span class="p">.</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endm</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">macro</span> <span class="n">get_bad_stack_swi</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">r13</span><span class="p">,</span> <span class="n">r13</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>           <span class="err">@</span> <span class="n">space</span> <span class="n">on</span> <span class="n">current</span> <span class="n">stack</span> <span class="k">for</span> <span class="n">scratch</span> <span class="n">reg</span><span class="p">.</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">r13</span><span class="p">]</span>            <span class="err">@</span> <span class="n">save</span> <span class="n">R0</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">value</span><span class="p">.</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">_armboot_start</span>     <span class="err">@</span> <span class="n">get</span> <span class="n">data</span> <span class="n">regions</span> <span class="n">start</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="p">(</span><span class="n">CFG_MALLOC_LEN</span><span class="p">)</span> <span class="err">@</span> <span class="n">move</span> <span class="n">past</span> <span class="n">malloc</span> <span class="n">pool</span>
</span><span class='line'>  <span class="n">sub</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="p">(</span><span class="n">CFG_GBL_DATA_SIZE</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span> <span class="err">@</span> <span class="n">move</span> <span class="n">past</span> <span class="n">gbl</span> <span class="n">and</span> <span class="n">a</span> <span class="n">couple</span> <span class="n">spots</span> <span class="k">for</span> <span class="n">abort</span> <span class="n">stack</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">lr</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>         <span class="err">@</span> <span class="n">save</span> <span class="n">caller</span> <span class="n">lr</span> <span class="n">in</span> <span class="n">position</span> <span class="mi">0</span> <span class="n">of</span> <span class="n">saved</span> <span class="n">stack</span>
</span><span class='line'>  <span class="n">mrs</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">spsr</span>           <span class="err">@</span> <span class="n">get</span> <span class="n">the</span> <span class="n">spsr</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">lr</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="p">]</span>         <span class="err">@</span> <span class="n">save</span> <span class="n">spsr</span> <span class="n">in</span> <span class="n">position</span> <span class="mi">1</span> <span class="n">of</span> <span class="n">saved</span> <span class="n">stack</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">r13</span><span class="p">]</span>            <span class="err">@</span> <span class="n">restore</span> <span class="n">r0</span>
</span><span class='line'>  <span class="n">add</span>  <span class="n">r13</span><span class="p">,</span> <span class="n">r13</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>           <span class="err">@</span> <span class="n">pop</span> <span class="n">stack</span> <span class="n">entry</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endm</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">macro</span> <span class="n">get_irq_stack</span>           <span class="err">@</span> <span class="n">setup</span> <span class="n">IRQ</span> <span class="n">stack</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">sp</span><span class="p">,</span> <span class="n">IRQ_STACK_START</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endm</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">macro</span> <span class="n">get_fiq_stack</span>           <span class="err">@</span> <span class="n">setup</span> <span class="n">FIQ</span> <span class="n">stack</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">sp</span><span class="p">,</span> <span class="n">FIQ_STACK_START</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endm</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * exception handlers</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>  <span class="p">.</span><span class="n">align</span>    <span class="mi">5</span>
</span><span class='line'><span class="nl">undefined_instruction</span><span class="p">:</span>
</span><span class='line'>  <span class="n">get_bad_stack</span>
</span><span class='line'>  <span class="n">bad_save_user_regs</span>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">do_undefined_instruction</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">align</span>    <span class="mi">5</span>
</span><span class='line'><span class="nl">software_interrupt</span><span class="p">:</span>
</span><span class='line'>  <span class="n">get_bad_stack_swi</span>
</span><span class='line'>  <span class="n">bad_save_user_regs</span>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">do_software_interrupt</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">align</span>    <span class="mi">5</span>
</span><span class='line'><span class="nl">prefetch_abort</span><span class="p">:</span>
</span><span class='line'>  <span class="n">get_bad_stack</span>
</span><span class='line'>  <span class="n">bad_save_user_regs</span>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">do_prefetch_abort</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">align</span>    <span class="mi">5</span>
</span><span class='line'><span class="nl">data_abort</span><span class="p">:</span>
</span><span class='line'>  <span class="n">get_bad_stack</span>
</span><span class='line'>  <span class="n">bad_save_user_regs</span>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">do_data_abort</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">align</span>    <span class="mi">5</span>
</span><span class='line'><span class="nl">not_used</span><span class="p">:</span>
</span><span class='line'>  <span class="n">get_bad_stack</span>
</span><span class='line'>  <span class="n">bad_save_user_regs</span>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">do_not_used</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_USE_IRQ</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">align</span>    <span class="mi">5</span>
</span><span class='line'><span class="nl">irq</span><span class="p">:</span>
</span><span class='line'>  <span class="n">get_irq_stack</span>
</span><span class='line'>  <span class="n">irq_save_user_regs</span>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">do_irq</span>
</span><span class='line'>  <span class="n">irq_restore_user_regs</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">align</span>    <span class="mi">5</span>
</span><span class='line'><span class="nl">fiq</span><span class="p">:</span>
</span><span class='line'>  <span class="n">get_fiq_stack</span>
</span><span class='line'>  <span class="cm">/* someone ought to write a more effiction fiq_save_user_regs */</span>
</span><span class='line'>  <span class="n">irq_save_user_regs</span>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">do_fiq</span>
</span><span class='line'>  <span class="n">irq_restore_user_regs</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">align</span>    <span class="mi">5</span>
</span><span class='line'><span class="nl">irq</span><span class="p">:</span>
</span><span class='line'>  <span class="n">get_bad_stack</span>
</span><span class='line'>  <span class="n">bad_save_user_regs</span>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">do_irq</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">align</span>    <span class="mi">5</span>
</span><span class='line'><span class="nl">fiq</span><span class="p">:</span>
</span><span class='line'>  <span class="n">get_bad_stack</span>
</span><span class='line'>  <span class="n">bad_save_user_regs</span>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">do_fiq</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="p">.</span><span class="n">align</span> <span class="mi">5</span>
</span><span class='line'><span class="p">.</span><span class="n">global</span> <span class="n">arm1136_cache_flush</span>
</span><span class='line'><span class="nl">arm1136_cache_flush</span><span class="p">:</span>
</span><span class='line'>      <span class="n">mcr</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">c7</span><span class="p">,</span> <span class="n">c5</span><span class="p">,</span> <span class="mi">0</span>    <span class="err">@</span> <span class="n">invalidate</span> <span class="n">I</span> <span class="n">cache</span>
</span><span class='line'>      <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>         <span class="err">@</span> <span class="n">back</span> <span class="n">to</span> <span class="n">caller</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_INTEGRATOR) &amp;&amp; defined(CONFIG_ARCH_CINTEGRATOR)</span>
</span><span class='line'><span class="cm">/* Use the IntegratorCP function from board/integratorcp/platform.S */</span>
</span><span class='line'><span class="cp">#elif defined(CONFIG_S3C64XX)</span>
</span><span class='line'><span class="cm">/* For future usage of S3C64XX*/</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="p">.</span><span class="n">align</span>    <span class="mi">5</span>
</span><span class='line'><span class="p">.</span><span class="n">globl</span> <span class="n">reset_cpu</span>
</span><span class='line'><span class="nl">reset_cpu</span><span class="p">:</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">rstctl</span> <span class="cm">/* get addr for global reset reg */</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x2</span> <span class="cm">/* full reset pll+mpu */</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r1</span><span class="p">]</span> <span class="cm">/* force reset */</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span>
</span><span class='line'><span class="nl">_loop_forever</span><span class="p">:</span>
</span><span class='line'>  <span class="n">b</span>    <span class="n">_loop_forever</span>
</span><span class='line'><span class="nl">rstctl</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">PM_RSTCTRL_WKUP</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://i.imgur.com/Nn7Krru.gif" alt="suda-morris" /></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-13T23:15:44+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/kdm/'>kdm</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/u-boot/'>u-boot</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/13/u-boot-dot-lds/">
		
			u-boot.lds</a>
	</h2>
	<div class="entry-content">
		<figure class='code'><figcaption><span>u-boot.lds</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">OUTPUT_FORMAT</span><span class="p">(</span><span class="s">&quot;elf32-littlearm&quot;</span><span class="p">,</span> <span class="s">&quot;elf32-littlearm&quot;</span><span class="p">,</span> <span class="s">&quot;elf32-littlearm&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">OUTPUT_ARCH</span><span class="p">(</span><span class="n">arm</span><span class="p">)</span>
</span><span class='line'><span class="n">ENTRY</span><span class="p">(</span><span class="n">_start</span><span class="p">)</span>
</span><span class='line'><span class="n">SECTIONS</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">.</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
</span><span class='line'>  <span class="p">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">text</span>      <span class="p">:</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">cpu</span><span class="o">/</span><span class="n">s3c64xx</span><span class="o">/</span><span class="n">start</span><span class="p">.</span><span class="n">o</span>  <span class="p">(.</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cpu</span><span class="o">/</span><span class="n">s3c64xx</span><span class="o">/</span><span class="n">s3c6410</span><span class="o">/</span><span class="n">cpu_init</span><span class="p">.</span><span class="n">o</span> <span class="p">(.</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cpu</span><span class="o">/</span><span class="n">s3c64xx</span><span class="o">/</span><span class="n">onenand_cp</span><span class="p">.</span><span class="n">o</span> <span class="p">(.</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cpu</span><span class="o">/</span><span class="n">s3c64xx</span><span class="o">/</span><span class="n">nand_cp</span><span class="p">.</span><span class="n">o</span>    <span class="p">(.</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">board</span><span class="o">/</span><span class="n">samsung</span><span class="o">/</span><span class="n">mini6410</span><span class="o">/</span><span class="n">nand_6410</span><span class="p">.</span><span class="n">fo</span>
</span><span class='line'>    <span class="n">cpu</span><span class="o">/</span><span class="n">s3c64xx</span><span class="o">/</span><span class="n">movi</span><span class="p">.</span><span class="n">o</span> <span class="p">(.</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="o">*</span><span class="p">(.</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">lib_arm</span><span class="o">/</span><span class="n">div0</span><span class="p">.</span><span class="n">o</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="p">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">rodata</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(.</span><span class="n">rodata</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">data</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(.</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">got</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(.</span><span class="n">got</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">__u_boot_cmd_start</span> <span class="o">=</span> <span class="p">.;</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">u_boot_cmd</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(.</span><span class="n">u_boot_cmd</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">__u_boot_cmd_end</span> <span class="o">=</span> <span class="p">.;</span>
</span><span class='line'>  <span class="p">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">mmudata</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(.</span><span class="n">mmudata</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>  <span class="n">__bss_start</span> <span class="o">=</span> <span class="p">.;</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">bss</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(.</span><span class="n">bss</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">_end</span> <span class="o">=</span> <span class="p">.;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://i.imgur.com/Nn7Krru.gif" alt="suda-morris" /></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-13T23:06:13+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/kdm/'>kdm</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/u-boot/'>u-boot</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/08/kdm-devenv/">
		
			KDM-DevEnv</a>
	</h2>
	<div class="entry-content">
		<h2>需要知道的知识点</h2>

<ol>
<li>ext4文件系统是Linux在PC机上最常用的磁盘文件系统，在嵌入式设备上则常用jffs2文件系统和yaffs2文件系统</li>
<li>在Linux操作系统中。对于SCSI磁盘。用sd*来表示，第一个磁盘x为a，第二个磁盘x为b，以此类推。磁盘上的第1个分区编号为1，第2个分区编号为2，以此类推。</li>
<li>swap分区用于Linux在运行期间的虚拟内存使用，其作用类似Windows中的交换文件pagefile.sys</li>
<li>ARM core的CPU在复位时通常都从0地址取它的第一条指令

<h2>开发环境搭建</h2>

<blockquote><ol>
<li>所使用的虚拟机是VirtualBox4.3.12，安装的虚拟机是UbuntuMate14.04</li>
<li>使用的开发板是友善出品的Tiny6410</li>
<li>虚拟机网络设置成桥接模式(笔记本的以太网卡，切勿错选成无线网卡)</li>
<li>虚拟机ip地址：192.168.1.88，网关192.168.1.1</li>
</ol>
</blockquote></li>
</ol>


<h2>系统烧写</h2>

<ol>
<li>Uboot中开发板的IP地址:192.168.1.230,网关192.168.1.1</li>
<li>开发板设置从SD卡启动，需要确保有一张烧写好UBoot的SD卡或者SDHC卡，Linux中的烧写方法：</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/sh
</span><span class='line'>#for SDHC Card,total sectors=15523840
</span><span class='line'>#dd iflag=dsync oflag=dsync if=u-boot-sd.bin of=/dev/sdb bs=512 count=16 seek=15522798
</span><span class='line'>#dd iflag=dsync oflag=dsync if=u-boot-sd.bin of=/dev/sdb bs=512 count=512 seek=15522030
</span><span class='line'>
</span><span class='line'>#for SD Card,total sectors=1961984
</span><span class='line'>dd iflag=dsync oflag=dsync if=u-boot-sd.bin of=/dev/sdb bs=512 count=16 seek=1961966
</span><span class='line'>dd iflag=dsync oflag=dsync if=u-boot-sd.bin of=/dev/sdb bs=512 count=512 seek=1961198
</span><span class='line'>sync
</span><span class='line'>#BL1:total sectors - 2 - 1024(if your SD Card Size &gt; 2G) -16
</span><span class='line'>#BL2:total sectors - 2 - 1024(if your SD Card Size &gt; 2G) -16 - 512 - 256</span></code></pre></td></tr></table></div></figure>


<ol>
<li>进入Uboot后，测试能否ping通虚拟主机：ping 192.168.1.88。在这之前可以先看看开发板的IP地址是否与虚拟主机在一个网段内，使用UBoot下的命令：pri</li>
<li>使用nfs命令获取虚拟主机上的uboot二进制文件供烧写(次UBoot是用来从NandFlash启动的，不能错选从SD卡启动的UBoot),成功以后会提示用户该文件的大小，这里记为filesize(切记要使用十六进制表示的数字)

<ul>
<li>nfs 50000000 192.168.1.88:/embeded/KDM/images/v1/u-boot.bin</li>
</ul>
</li>
<li>烧写uboot至NandFlash中

<ul>
<li>nand write.i 50000000 0 $(filesize)   从0地址开始烧写UBoot</li>
</ul>
</li>
<li>使用nfs命令获取虚拟主机上的kernel文件，成功以后会提示用户该文件的大小，这里记为filesize((切记要使用十六进制表示的数字))

<ul>
<li>nfs 50000000 192.168.1.88:/embeded/KDM/images/v1/Image</li>
</ul>
</li>
<li>烧写kernel到NandFlash中

<ul>
<li>nand write.i 50000000 80000 $(filesize)</li>
</ul>
</li>
<li>使用nfs命令获取虚拟主机上的根文件系统文件，成功以后会提示用户该文件的大小，这里记为filesize((切记要使用十六进制表示的数字))

<ul>
<li>nfs 50000000 192.168.1.88:/embeded/KDM/images/v1/yaff2.img</li>
</ul>
</li>
<li>烧写根文件系统到NandFlash中

<ul>
<li>nand write.yaffs 50000000 580000 $(filesize)</li>
</ul>
</li>
<li>根据需要修改启动参数并保存,例如

<ul>
<li>setenv bootargs root=/dev/mtdblock2 console=ttySAC0,115200</li>
<li>saveenv</li>
</ul>
</li>
</ol>


<h2>测试图形界面程序</h2>

<ul>
<li>图形界面工具使用的触摸屏校准程序为tslib源码附带的校准程序ts_calibrate,所以如果触摸屏没有校准，可以在Linux系统启动后运行/usr/local/bin/ts_calibrate程序对触摸屏进行校准(通过删除/etc/pointercal文件，可以使得图形界面工具自动调用ts_calibrate程序)，校准完毕会在etc目录下生成pointercal标准文件，供触摸屏库程序转换成符合屏幕的坐标，从而达到校准目的。</li>
</ul>


<h2>交叉编译器</h2>

<ul>
<li>arm-linux-gcc是一个“集合命令”，它包含了4个步骤：预处理，汇编，编译和链接，通过链接阶段便生成ELF格式的可执行文件。4个步骤对应执行的程序为arm-linux-cpp，arm-linux-as，ccl，arm-linux-ld。前三个步骤对应的命令行选项为：-E,-S，-c，如果没有任何参数，则代表经过这4个步骤产生可执行文件。</li>
<li>ELF文件的not stripped属性告诉我们在编译的时候产生的编译阶段需要的符号没有被删除</li>
<li>通常被编译出的程序都会使用到系统的动态库，而这些基本的动态库大部分也都是glibc库中的。例如open,read,write,select,ioctl等应用程序中的函数都是libc.so动态库中提供的，而glibc还提供了libm.so(数学库)，libcrypt.so(安全库)，libld.so(加载库)等。其中libld.so作为加载库负责在应用程序运行时，加载程序所使用到的动态库文件。在我们移植系统的过程中，这些最基本的动态库也需要被移植到根文件系统中去，这样才能保证程序被正常启动。</li>
<li>arm-linux-strip test可以删除可执行文件中不需要的编译符号和段描述信息</li>
<li>arm-linux-objcopy -O binary -S test test.bin 通常被用来将生成的ELF格式的文件转化为只含有二进制指令和程序数据的文件test.bin.也只有这样的二进制指令文件才能直接被硬件执行。</li>
<li>arm-linux-dump -D test > test.dis则是反编译，将ELF格式的可执行文件反编译成汇编信息文件test.dis，有助于代码的查看和调试</li>
<li>arm-linux-readelf -a test | grep &lsquo;Shared'用来获取ELF的头信息，grep 'Shared'是获取头信息中test可执行文件调用到的动态文件</li>
<li>arm-linux-gcc 针对arm11的设置：

<ol>
<li>&ndash;with-cpu=arm1176jzf-s</li>
<li>&ndash;with-tune=arm1176jzf-s</li>
<li>&ndash;with-float=softfp</li>
</ol>
</li>
</ul>


<h2>bootloader</h2>

<ul>
<li>目标机上的Bootloader通过串口与主机之间进行文件传输，传输协议通常是xmodem/ymodem/zmodem协议中的一种，但是，串口传输速度有限，因此通过以太网连接并借助tftp或者nfs协议来下载文件是个更好的选择</li>
<li>bootloader的stage1通常包括的步骤：

<ol>
<li>硬件设备初始化

<ul>
<li>屏蔽所有中断</li>
<li>设置CPU的速度和时钟频率</li>
<li>RAM初始化</li>
<li>关闭CPU内部指令/数据cache</li>
</ul>
</li>
<li>为加载Bootloader的stage2准备RAM空间</li>
<li>复制bootloader的stage2到RAM空间</li>
<li>设置好堆栈指针sp</li>
<li>跳转到stage2的C入口点（修改PC寄存器为核实的地址来实现）</li>
</ol>
</li>
<li>bootloader的stage2通常包括的步骤：

<ol>
<li>初始化本阶段要使用到的硬件设备

<ul>
<li>至少一个串口用来和终端用户进行I/O输出信息</li>
</ul>
</li>
<li>检测系统内存映射</li>
<li>将kernel镜像和根文件系统镜像从Flash上读到RAM空间中(需要编写Nand Flash裸驱动)</li>
<li>为内核设置启动参数

<ul>
<li>linux2.4以后的内核都期望以标记列表的形式来传递启动参数，启动参数标记列表以标记ATAG_CORE尅是，以标记ATAG_NONE结束</li>
<li>每个标记由标识被传递参数的tag_header结构以及随后的参数值数据结构来组成，数据结构tag和tag_header定义在Linux内核源码的include/asm/setup.h头文件中</li>
<li>在嵌入式Linux系统中，通常需要由Bootloader设置的常见启动参数有：ATAG_CORE,ATAG_MEN,ATAG_CMDLINE</li>
</ul>
</li>
<li>调用内核，跳转到内核第一条指令处，跳转时要满足下列条件

<ol>
<li>CPU寄存器的设置

<ul>
<li>R0=0</li>
<li>R1=机器类型ID，关于Machine Type Number可以参见linux/arch/arm/tools/mach-types</li>
<li>R2=启动参数标记列表在RAM中的起始基地址</li>
</ul>
</li>
<li>CPU模式

<ul>
<li> 必须禁止中断(IRQs和FIQs)</li>
<li>CPU必须处于SVC模式</li>
</ul>
</li>
<li>Cache和MMU的设置

<ul>
<li>MMU必须关闭</li>
<li>指令Cache可以打开亦可以关闭</li>
<li>数据Cache必须关闭</li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
<li>U-boot目录结构

<ol>
<li>与处理器体系结构或者开发板硬件直接相关</li>
<li>通用的函数或者驱动程序</li>
<li>U-Boot的应用程序、工具或者文档</li>
</ol>
</li>
</ul>


<h2>Uboot常用命令</h2>

<blockquote><ol>
<li>使用命令时，可以使用其开头的若干个字母代替它</li>
<li>当运行一个命令之后，如果它是可重复执行的（代码中使用U_BOOT_CMD定义这个命令时，第三个参数是1），若想再次运行可以直接输入回车</li>
<li>Uboot接受的数据都是16进制，输入时可以省略前缀0x</li>
</ol>
</blockquote>

<ol>
<li>运行<code>help</code>命令可以看到所有命令的作用，如果要查看某个命令的使用方法，运行<code>help 命令名</code>。可以使用<code>?</code>来代替<code>help</code></li>
<li>Uboot支持串口下载，网络下载，USB下载，相关命令有：loadb,loads,loadx,loady;tftpboot,nfs;usbslave。使用方法：

<ul>
<li>loadx [off] [baud];off表示文件下载后存放的内存地址，baud表示使用的波特率，如果off参数省略，存放的位置为配置文件中定义的宏CFG_LOAD_ADDR</li>
<li>tftpboot [loadAddress] [bootfilename]; loadAddress表示文件下载后存放的内存地址，bootfilename表示要下载的文件名称。loadAddress省略，存放的位置为配置文件中定义的宏CFG_LOAD_ADDR。如果bootfilename省略，则使用单板的IP地址构造一个文件名</li>
<li>nfs [loadAddress] [host ip addr:bootfilename];host ip addr表示服务器的IP地址</li>
<li>usbslave [wait] [loadAddress]；在PC端使用dnw工具发送文件，U-boot通过USB Device接口接收文件。wait可以取值1或0，表示是否等得数据传输完成，当wait取0时，在后台进行下载，这时在Uboot仍可执行其他操作。下载文件成功后，Uboot会自动创建或者更新环境变量filezise，它表示下载的文件长度，可以在后续命令中使用$(filesize)来引用它</li>
</ul>
</li>
<li>常用的内存操作命令有：查看内存命令md，修改内存命令mm,填充内存命令mw,复制命令cp。这些命令都可以带上后缀".b",&ldquo;.w&rdquo;,&ldquo;.l"表示以字节、字、双字为单位进行操作。

<ul>
<li>md[.b,.w,.l] address [count],表示以字节、字、双字（默认是双字）为单位，显示从地址address开始的内存数据，显示的数据个数为count</li>
<li>mm[.b,.w,.l] address,表示以字节、字或双字为单位，从地址address开始修改内存数据，执行mm命令后，输入新数据后回车，地址会自动增加，Ctrl+C退出</li>
<li>mw[.b,.w,.l] address value [count],表示以字节、字或双字为单位，往开始地址为address的内存中填充count个数据，数据值为value。</li>
<li>cp[.b,.w,.l] source target count,表示以字节、字或双字为单位，从原地址source的内存复制count个数据到目的地址target的内存</li>
</ul>
</li>
<li>常用的Nand Flash操作命令只有一个，它根据不同的参数进行不同的操作

<ul>
<li>nand info，查看Nand Flash信息</li>
<li>nand erase [clean] [off size],擦除Nand Flash，加上clean时表示在每个块的第一个扇区的OOB区加写入清除标记；off、size表示要擦除的开始偏移地址和长度，如果省略off和size表示要擦除整个Nand Flash</li>
<li>nand read[.jffs2] addr off size,从Nand Flash偏移地址off处读出size个字节的数据，存放到开始地址为addr的内存中。是否加后缀.jffs的差别只是读操作时ECC校验方法不同</li>
<li>nand write[.jffs2] addr off size,把开始地址为addr的内存中的size个字节数据，写到Nand Flash的偏移地址off处。是否加后缀.jffs的差别只是读操作时ECC校验方法不同</li>
<li>nand read.yaffs addr off size，从Nand Flash偏移地址off处读出size个字节的数据（包括OOB区域），存放到开始地址为addr的内存中</li>
<li>nand write.yaffs addr off size，把开始地址为addr的内存中的size个字节数据(只要有要写入OOB区域的数据)，写到Nand Flash的偏移地址off处</li>
<li>nand dump off，将Nand Flash偏移地址off的一个山区的数据打印出来，包括OOB数据</li>
</ul>
</li>
<li>环境变量命令(下面的命令只是在内存中进行，最后需要使用<code>saveenv</code>命令将更改后的所有环境变量写入Flash中)

<ul>
<li><code>printenv</code>命令打印全部环境变量，“printenv name1 name2 &hellip;”打印名字为name1,name2&hellip;&hellip;的环境变量</li>
<li><code>setenv name value</code>设置名字为name的环境变量的值为value</li>
<li><code>setenv name</code>删除名字为name的环境变量</li>
</ul>
</li>
<li>启动命令,不带参数的<code>boot</code>,<code>bootm</code>命令都是执行环境变量bootcmd所指定的命令

<ul>
<li>&ldquo;bootm [addr [arg &hellip;]]"命令启动存放在地址addr处的Uboot格式的映像文件（使用Uboot目录tools下的mkimage工具制作得到），[arg &hellip;]表示参数，如果addr参数省略，映像文件所在地址为配置文件中定义的宏CFG_LOAD_ADDR</li>
<li>go addr [arg &hellip;]与bootm命令类似，启动存放在地址addr处的二进制文件，[arg &hellip;]表示参数</li>
<li>nboot [[[loadAddr] dev] offset]命令将Nand Flash设备dev上偏移地址off处的映像文件复制到内存loadAddr处，然后，如果环境变量autostart的值为yes，就启动这个映像，如果loadAddr参数省略，存放地址为配置文件中定义的宏CFG_LOAD_ADDR。如果dev参数省略，则它的取值为环境变量bootdevice的值，如果offset参数省略，则默认为0</li>
</ul>
</li>
</ol>


<h2>根文件系统</h2>

<ol>
<li>所有的Linux发行版在对根文件系统布局上都遵循FHS标准的建议规定。该标准规定了根目录下各个子目录的名称及其存放的内容：

<ul>
<li>/bin：必备的用户命令，例如ls,cp等</li>
<li>/sbin:必备的系统管理员命令，例如ifconfig，reboot</li>
<li>/dev:设备文件，例如mtdblock0，tty1等</li>
<li>/etc:系统配置文件，包括启动文件，例如inittab</li>
<li>/lib:必要的链接库，例如C链接库、内核模块</li>
<li>/home:普通用户主目录</li>
<li>/root:root用户主目录</li>
<li>/usr/bin:非必备的用户程序，例如find、du等</li>
<li>/usr/sbin:非必备的管理员程序，例如chroot，inetd等</li>
<li>/usr/lib：库文件</li>
<li>/var:守护进程和工具程序所存放的可变，例如日志文件</li>
<li>/proc:用来提供内核和进程信息的虚拟文件系统，有内核自动生成目录下的内容</li>
<li>/sys:用来提供内核与设备信息的虚拟文件系统，由内核自动生成目录下的内容</li>
<li>/mnt:文件系统挂载点，用于临时安装文件系统</li>
<li>/tmp:临时性的文件，重启后将自动清除</li>
</ul>
</li>
<li>编译安装busybox：

<ul>
<li>下载源码包，解压缩后进入文件夹根目录</li>
<li>make defconfig</li>
<li>make menuconfig

<ul>
<li>Busybox Settings:选择动态链接C库，指定交叉编译器的prefix为arm-linux-，为各命令安装为指向busybox的软连接，指定busybox的安装位置，选择支持Tab completion和Username completion</li>
<li>Applets：基本保持默认设置</li>
</ul>
</li>
<li>make -j4</li>
<li>make install</li>
</ul>
</li>
<li>busybox只用到了2个库，通用C库(libc)、数学库(libm),每个库有4个文件，四个文件中，.a文件是静态库文件，另外三个是：实际的共享链接库（libLIBRARY_NAME-GLIBC_VERSION.so），主修订版本的符号链接，指向实际的共享链接库(libLIBRARY_NAME.so.MAJOR_REVISION_VERSION,一旦程序连接了特定的链接库，将会参用该符号链接)，与版本无关的符号链接，指向主修订版本的符号链接(libLIBRARY_NAME.so,是为编译程序时提供一个通用条目)</li>
<li>当使用<code>gcc hello.c -o hello -lm</code>编译程序的时候，gcc会根据-lm的提示，加头(lib)添尾(.so)得到libm.so，从而沿着与版本无关的符号链接(libm.so->libm.so.6)找到libm.so.6并记录在案(hello的ELF头中)，表示hello需要使用libm.so.6这个库文件所代表的数学库中的库函数。而当hello被执行的时候，动态链接库加载器会从hello的ELF头中找到libm.so.6这个记录，然后沿着主修订版本的符号链接(libm.so.6->libm-2.3.6.so)找到实际的共享链接库libm-2.3.6.so从而将其与hello做动态链接。可见<strong>与版本无关的符号链接是供编译器使用的，主修订版本的符号链接是供动态链接库加载器使用的，而实际的共享链接库则是供应用程序使用的</strong></li>
<li>init进程的主配置文件inittab用于决定init进程要启动哪些子进程，以及如何启动这些子进程。busybox的inittab文件的语法、语义和传统的SYSV的inittab有所不同

<ul>
<li>inittab文件中每个条目用来定义需要init启动的子进程，并确定它的启动方式，格式为<id>:<runlevel>:<action>:<process>,例如：ttySAC0：：ask-first:-/bin/sh</li>
<li><id>表示子进程要使用的控制台，若省略则使用与init进程一样的控制台</li>
<li><runlevel>表示运行级别，busybox init程序这个字段没有意义</li>
<li><action>表示init进程如何空着这个子进程

<ul>
<li>sysinit：以该方式启动的子进程最先被init启动，该子进程只会被启动一次，如该子进程结束，init将不会重新启动它</li>
<li>wait：系统执行完sysinit条目后才启动该子进程，该子进程只执行一次，init进程必须等待该子进程结束后才能继续执行启动其他子进程的动作</li>
<li>once:系统执行完wait条目后才启动该子进程，该子进程只执行一次，init进程不必等待该子进程的结束就可以执行启动其他子进程的动作</li>
<li>respawn：系统执行完once条目后才能启动该子进程，init进程会持续监测该子进程的状态，若发现该子进程退出，会重新启动它</li>
<li>askfirst：系统启动完respawn条目后才能启动该子进程，与respawn类似，不过init进程先输出“Please press Enter to active this console”，等用户输入回车后才启动子进程</li>
<li>shutdown：当系统关机时启动该子进程</li>
<li>restart：Busybox中配置了CONFIG_FEATURE_USE_INITAB，并且init进程接收到SIGUP信号时执行，先重新读取、解析/etc/inittab文件，再执行restart程序</li>
<li>ctrlaltdel：按下Ctrl+Alt+Del键时启动该子进程，不过在串口控制台中无法输入它</li>
</ul>
</li>
<li><process>表示进程对应的二进制文件，如果前面有-号，表示该程序是“可以与用户进行交互的”</li>
</ul>
</li>
<li>手工构建/dev目录：新建dev文件夹，在里面<code>sudo mknod console c 5 1</code>,它表示穿件console字符设备文件，主设备号是5，次设备号是1</li>
<li>构建/dev目录的方法是使用udev(user dev),mdev是busybox中对udev的简化实现，其工作原理是：操作系统启动的时候会将识别到的所有设备的信息自动导出到/sys目录，在此基础上，用户态的应用程序mdev -s就可以扫描/sys/class和/sys/block中所有的类设备目录，如果在目录中含有名为“dev”的文件，且文件中包含的是设备号，则mdev就利用这些信息为这个设备在/dev下创建设备节点文件</li>
<li>Linux系统下实现热插拔的机制：当有热插拔事件产生时，内核就会调用位于/sbin目录下的mdev。这时mdev通过环境变量中的ACTION和DEVPATH(这两个变量是系统自带的)来确定此次热插拔事件的动作以及影响了/dev中的哪个目录。接着会看看这个目录中是否有“dev”的属性文件，如果有就利用这些信息为这个设备在/dev下创建或删除设备节点文件。我们需要告知操作系统，当它发现热插拔事件时应调用mdev，而不是别的程序。</li>
<li>嵌入式Linux对文件系统的要求：

<ul>
<li>要求文件系统在频繁的文件操作下能够保持较高的读写性能，要求低碎片化</li>
<li>Linux下的日志文件系统(XFS,ReiserFS,Ext3等)能保持数据的完整性，但消耗过多的系统资源的弱点使之不能成为嵌入式系统中的主流应用。并且这些都是专门为硬盘类的存储设备进行了优化，对于Flash这类的存储介质并不适用</li>
<li>嵌入式文件系统的载体是以Flash为主的存储介质，Flash的擦除次数是有限的，所以为了延长Flash的使用寿命，应该尽量减少对Flash的读写操作，并尽量使对Flash的写入操作均匀分布在整个Flash上</li>
</ul>
</li>
<li>在内核的配置菜单中可以看到块设备中有哟个ramdisk选项，并可以设置它的大小，默认的大小为4096KB，在配置内核的时候用户也可以指定ramdisk的大小。ramdisk是基于ram的块设备，所以它占据了一块固定内存的大小，并且需要使用mke2fs格式化以及相对应的文件系统的驱动程序去读取设备上的内容。由于ramdisk在很多场合并不太实用，在Linux的2.4版本开始支持了ramfs文件系统，它是一个简单的基于Linux的。可以动态分配大小的内存文件系统，它属于内核虚拟文件系统层(VFS)，与ramdisk相比，并不是基于虚拟在内存中的其他文件系统，例如ext2文件系统。使用方法：

<ul>
<li>mkdir /mnt/ramfs</li>
<li>mount -t ramfs none /mnt/ramfs(缺省大小，被限制最大maxsize为内存总和/2)</li>
<li>mount -t ramfs none /mnt/ramfs -o maxsize=1000(创建最大大小为1M的ramfs文件系统)</li>
</ul>
</li>
<li>tmpfs文件系统既可以使用内存也可以使用磁盘来作为存储介质，并且它的大小和ramfs一样，可以动态分配。<strong>它主要用于减少对闪存不必要的写操作</strong>这唯一目的。因为tmpfs驻留在RAM中，所以写/读/擦除的操作发生在RAM中而不是在闪存中。因此，当将日志消息写入挂载为tmpfs文件系统的目录时，是将其写入RAM而不是闪存中，在重新引导时不会保留它们。它的原理是：

<ul>
<li>在Linux内核中有虚拟内存的概念，而虚拟内存是由物理内存RAM和交换分区swap组成，这些虚拟内存资源又是由Linux内核中的虚拟内存子系统管理。tmpfs会向虚拟内存子系统申请页来存储文件，但它不知道虚拟内存子系统分配给自己的页是在物理内存还是属于交换分区</li>
</ul>
</li>
<li>tmpfs文件系统在内核中的打开方式为：

<ul>
<li>在内核中选择“File systems&ndash;Pseudo filesystems&ndash;Virtual memory filesystem support”一项来支持对tmpfs虚拟文件系统的管理</li>
</ul>
</li>
<li>在启动时，经常可以看到启动脚本中有以下内容：

<ul>
<li><code>mount none /dev -t tmpfs</code></li>
<li>这也是由于Linux系统的设备可以热插拔的原因</li>
</ul>
</li>
<li>ramfs实现机制是将cache在物理内存的文件占用的page不标记为可释放，这样虚拟内存管理系统就不会将这些page释放或者交换到swap，从而实现文件总在物理内存中。tmpfs也是存放于内存中，但它可以被VM交换到swap，它其实是ramfs的一个变体</li>
<li>jffs文件系统被用到NorFlash和小于64MB的NandFlash闪存中</li>
<li>yaffs文件系统在mount的时候需要很少的内存（如果是小页&ndash;512B/Page,每1MB NandFlash大约需要4KB内存；大页需要大概1KB RAM/1 MB NandFlash）</li>
<li>yaffs文件系统的基本单位是Chunk，相当于页。Chunk中的资料包括两部分：一部分是资料区，占用Flash的一页；另一部分是文件信息以及冗余资料区，占用Flash页的OOB区。其冗余资料主要是ECC校验资料，对于小页的Flash，每页都有6位元祖的ECC资料，对于大页的Flash，每页有24位元祖的ECC资料</li>
<li>yaffs文件系统的第一个块用于存放整个文件系统的信息，所以真实的数据应该从第二个块开始。</li>
<li>ubifs在设计与性能上均较yaffs2、jffs2更适合MLC NandFlash。例如：ubifs支持write-back，其写入的资料会被cache，直到有必要写入时才写到Flash，大大降低分散小区块数量并提高I/O效率。</li>
</ol>


<h2>交叉编译移植所要修改的环境变量</h2>

<ol>
<li>CC编译器，系统默认gcc，需要修改为arm-linux-gcc</li>
<li>AR库工具，用以创建和修改库，需要修改为arm-linux-ar</li>
<li>LD链接器，系统默认为ld，需要修改为arm-linux-ld</li>
<li>RANLIB随机库创建器，系统默认为ranlib，需要修改为arm-linux-ranlib</li>
<li>AS汇编器，系统默认为as，需要修改为arm-linux-as</li>
<li>NM库查看工具，系统默认为nm，需要修改为arm-linux-nm</li>
</ol>


<h2>新建用户与用户组</h2>

<ul>
<li>在/etc/passwd中第一行新增：root:x:0:0:Root,,,:/root:/bin/sh</li>
<li>passwd root,设置root用户密码</li>
<li>chown root:root /bin/busybox,改变busybox的属主，否则将来u+s后第一个用户进程init的权限将不是root的权限</li>
<li>chmod u+s /bin/busybox，这使得普通用户能使用passwd修改自己的密码，同时也使login程序能够正常工作</li>
<li>adduser morris -h /home/morris -s /bin/sh -G morris</li>
<li>adduser ftp -h /var/ftp -s /bin/sh -G ftp</li>
<li>adduser ftpuser -h /sdcard/local -s /bin/sh -G ftp</li>
<li>adduser ftproot -h /sdcard/tmp -s /bin/sh -G ftp</li>
</ul>


<h2>移植telnet服务器</h2>

<ol>
<li>如上创建好用户</li>
<li>修改/etc/inittab,使得telnetd开机自动启动：

<ul>
<li>::once/usr/sbin/telnetd#这里一定要使用once，不能使用respawn，因为telnetd是守护进程，其实现会fork自己后让自己结束</li>
</ul>
</li>
<li>创建并挂载/dev/pts,它将供telnetd服务使用

<ul>
<li>mkdir /dev/pts</li>
<li>mount -t devpts devpts /dev/pts</li>
</ul>
</li>
<li>更改/dev/tty和/dev/console的权限，以使普通用户登录系统时也能读写控制终端

<ul>
<li>chmod 666 /dev/tty</li>
<li>chmod 600 /dev/console</li>
</ul>
</li>
</ol>


<h2>移植ftp服务器</h2>

<ol>
<li><a href="http://download.chinaunix.net/download/0001000/19.shtml">下载vsftpd2.3.5并解压</a></li>
<li>修改Makefile，指定交叉编译器<code>CC=arm-linux-gcc</code></li>
<li>修改vsf_findlibs.sh,将所有/lib和/usr/lib前面加上交叉编译器的库目录地址，比如<code>/embeded/crosstool/arm-wenris-linux-gnueabi/sysroot</code></li>
<li>make -j4,将生成的vsftp复制到开发板根文件系统相应目录/usr/sbin</li>
<li>复制vsftpd依赖的动态库文件到开发板根文件系统相应目录</li>
<li>将模板配置文件vsftpd.conf复制到开发板/etc目录，修改该配置文件，使有效配置如下：</li>
</ol>


<figure class='code'><figcaption><span>vsftpd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">anonymous_enable</span><span class="o">=</span><span class="n">NO</span>
</span><span class='line'><span class="n">local_enable</span><span class="o">=</span><span class="n">YES</span>
</span><span class='line'><span class="n">write_enable</span><span class="o">=</span><span class="n">YES</span>
</span><span class='line'><span class="n">anon_upload_enable</span><span class="o">=</span><span class="n">NO</span>
</span><span class='line'><span class="n">anon_mkdir_write_enable</span><span class="o">=</span><span class="n">NO</span>
</span><span class='line'><span class="n">dirmessage_enable</span><span class="o">=</span><span class="n">YES</span>
</span><span class='line'><span class="n">xferlog_enable</span><span class="o">=</span><span class="n">YES</span>
</span><span class='line'><span class="n">connect_from_port_20</span><span class="o">=</span><span class="n">YES</span>
</span><span class='line'><span class="n">xferlog_file</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">vsftpd</span><span class="p">.</span><span class="n">log</span>
</span><span class='line'><span class="n">xferlog_std_format</span><span class="o">=</span><span class="n">YES</span>
</span><span class='line'><span class="n">idle_session_timeout</span><span class="o">=</span><span class="mi">600</span>
</span><span class='line'><span class="n">data_connection_timeout</span><span class="o">=</span><span class="mi">120</span>
</span><span class='line'><span class="n">nopriv_user</span><span class="o">=</span><span class="n">ftp</span>
</span><span class='line'><span class="n">ftpd_banner</span><span class="o">=</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">WenRis</span> <span class="n">FTP</span> <span class="n">service</span>
</span><span class='line'><span class="n">listen</span><span class="o">=</span><span class="n">YES</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>由于vsftp源代码程序一定要使用一个目录/usr/share/empty,所以必须要预先创建它</li>
<li>修改/etc/inittab,使得vsftpd在开机时候自动启动：

<ul>
<li>::respawn:/usr/sbin/vsftpd</li>
</ul>
</li>
</ol>


<h2>移植httpd服务器</h2>

<ol>
<li>增加用户www：<code>adduser -S -D -H www</code></li>
<li>修改/etc/inittab文件，指名httpd的目录和运行账户：

<ul>
<li><code>::once:/usr/sbin/httpd -h /www -u www</code></li>
</ul>
</li>
<li>httpd运行时会以普通用户www的身份访问/dev/null设备，因此需要在rcS脚本中修改/dev/null的权限：<code>chmod 666 /dev/null</code></li>
<li>创建http服务器的主目录和主文件

<ul>
<li><code>mkdir /www</code></li>
<li><code>echo "this is my first web site" &gt; /www/index.html</code></li>
</ul>
</li>
</ol>


<h2>移植boa网页服务器</h2>

<ol>
<li><a href="http://www.boa.org/">获取源码，并解压缩</a></li>
<li>进入解压后的文件夹 内部的 src文件夹，对源文件进行如下修改：</li>
</ol>


<figure class='code'><figcaption><span>vsftpd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="err">由于</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gcc</span> <span class="err">编译器版本过高，对语法的支持有一些改变，所以需要修改</span><span class="n">compat</span><span class="p">.</span><span class="n">h</span><span class="err">中的</span>
</span><span class='line'>     <span class="cp">#define TIMEZONE_OFFSET(foo) foo##-&gt;tm_gmtoff</span>
</span><span class='line'><span class="err">为：</span>
</span><span class='line'>
</span><span class='line'>     <span class="cp">#define TIMEZONE_OFFSET(foo) foo-&gt;tm_gmtoff</span>
</span><span class='line'><span class="err">不然在编译的时候会提示如下错误：</span>
</span><span class='line'>    <span class="n">util</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span> <span class="mi">100</span><span class="o">:</span> <span class="mi">1</span><span class="o">:</span> <span class="n">pasting</span> <span class="err">“</span><span class="n">t</span><span class="err">”</span> <span class="n">and</span> <span class="err">“</span><span class="o">-&gt;</span><span class="err">”</span> <span class="n">does</span> <span class="n">not</span> <span class="n">give</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">preprocessing</span> <span class="n">token</span> <span class="nl">make</span><span class="p">:</span> <span class="p">[</span><span class="n">util</span><span class="p">.</span><span class="n">o</span><span class="p">]</span> <span class="n">Error1</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>vsftpd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="err">将</span><span class="n">boa</span><span class="p">.</span><span class="n">c</span> <span class="err">文件</span><span class="mi">225</span><span class="o">-</span><span class="mi">227</span><span class="err">三行的文件注释掉</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">DIE</span><span class="p">(</span><span class="err">”</span><span class="n">icky</span> <span class="n">Linux</span> <span class="n">kernel</span> <span class="n">bug</span><span class="o">!</span><span class="err">”</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="err">为</span>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">         if (setuid(0) != -1) {</span>
</span><span class='line'><span class="cm">                        DIE(”icky Linux kernel bug!”);</span>
</span><span class='line'><span class="cm">                }</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'>
</span><span class='line'><span class="err">，否则，但以</span><span class="n">root</span><span class="err">权限启动</span><span class="n">boa</span><span class="err">服务器的时候，会出现以下错误：</span><span class="n">boa</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">226</span> <span class="o">-</span> <span class="n">icky</span> <span class="n">Linux</span> <span class="n">kernel</span> <span class="n">bug</span><span class="o">!:</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>然后生成Makefile：./configure</li>
<li>修改生成的Makefile：默认生成的Makefile针对x86平台，我们的目标是针对嵌入式平台，所以需要修改编译器:</li>
</ol>


<figure class='code'><figcaption><span>vsftpd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="err">更改</span><span class="n">Makefile</span><span class="err">的</span><span class="mi">31</span><span class="err">行和</span><span class="mi">32</span><span class="err">行：</span>
</span><span class='line'><span class="n">CC</span> <span class="o">=</span> <span class="n">gcc</span>
</span><span class='line'><span class="n">CPP</span> <span class="o">=</span> <span class="n">gcc</span> <span class="o">-</span><span class="n">E</span>
</span><span class='line'><span class="err">更改为</span>
</span><span class='line'><span class="n">CC</span> <span class="o">=</span> <span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gcc</span>
</span><span class='line'><span class="n">CPP</span> <span class="o">=</span> <span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gcc</span> <span class="o">-</span><span class="n">E</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>在当前目录下编译Boa源文件： make</li>
<li>将生成的boa可执行程序复制到根文件系统的/usr/sbin目录下</li>
<li>将boa.conf文件复制到根文件系统/etc/boa文件夹下面，并且作如下修改：</li>
</ol>


<figure class='code'><figcaption><span>vsftpd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="err">修改</span><span class="mi">25</span><span class="err">行的</span><span class="n">port</span><span class="err">端口，用来设置服务器监听的端口：</span>
</span><span class='line'><span class="cp"># Port: The port Boa runs on.  The default port for http servers is 80.</span>
</span><span class='line'><span class="cp"># If it is less than 1024, the server must be started as root.</span>
</span><span class='line'>
</span><span class='line'><span class="n">Port</span> <span class="mi">80</span>
</span><span class='line'><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="err">注释</span><span class="mi">43</span><span class="err">行的监听</span><span class="n">IP</span><span class="err">地址：默认监听该主机上的所有</span><span class="n">IP</span><span class="err">地址</span>
</span><span class='line'><span class="cp">#Listen 192.68.0.5</span>
</span><span class='line'><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="err">修改</span><span class="mi">53</span><span class="err">、</span><span class="mi">54</span><span class="err">行的</span><span class="n">user</span><span class="err">和</span><span class="n">Group</span> <span class="err">启动的</span><span class="n">UID</span><span class="err">和</span><span class="n">GID</span><span class="err">，使其以</span><span class="n">root</span><span class="err">身份启动</span>
</span><span class='line'><span class="cp">#  User: The name or UID the server should run as.</span>
</span><span class='line'><span class="cp"># Group: The group name or GID the server should run as.</span>
</span><span class='line'>
</span><span class='line'><span class="n">User</span> <span class="n">root</span>
</span><span class='line'><span class="n">Group</span> <span class="n">root</span>
</span><span class='line'><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="err">修改</span><span class="mi">116</span><span class="err">行的</span><span class="n">DocumentRoot</span><span class="err">地址，即客户端要显示的</span><span class="n">HTML</span><span class="err">页面存放位置</span>
</span><span class='line'><span class="cp"># DocumentRoot: The root directory of the HTML documents.</span>
</span><span class='line'><span class="cp"># Comment out to disable server non user files.</span>
</span><span class='line'>
</span><span class='line'><span class="n">DocumentRoot</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">boa</span>
</span><span class='line'><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="err">修改输入网页输入主机</span><span class="n">IP</span><span class="err">时要显示的页面：这里设为</span><span class="n">index</span><span class="p">.</span><span class="n">html</span>
</span><span class='line'> <span class="cp"># DirectoryIndex: Name of the file to use as a pre-written HTML</span>
</span><span class='line'><span class="cp"># directory index.  Please MAKE AND USE THESE FILES.  On the</span>
</span><span class='line'><span class="cp"># fly creation of directory indexes can be _slow_.</span>
</span><span class='line'><span class="cp"># Comment out to always use DirectoryMaker</span>
</span><span class='line'>
</span><span class='line'><span class="n">DirectoryIndex</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span>
</span><span class='line'><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="err">修改</span><span class="n">CGI</span><span class="err">程序存放的位置：以</span><span class="nl">http</span><span class="p">:</span><span class="c1">//IP/cgi-bin/cginame 的方式运行cgi 程序时将在/usr/local/boa/cgi-bin 目录下寻找该程序</span>
</span><span class='line'><span class="cp"># ScriptAlias: Maps a virtual path to a directory for serving scripts</span>
</span><span class='line'><span class="cp"># Example: ScriptAlias /htbin/ /www/htbin/</span>
</span><span class='line'>
</span><span class='line'><span class="n">ScriptAlias</span> <span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">boa</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>创建/var/log/boa/ 目录，这样Boa服务器启动时会在该目录下创建日志文件</li>
<li>将Linux系统上/etc/mime.types 文件复制到根文件系统的/etc 目录下，否则Boa服务器启动不起来</li>
<li>修改/etc/inittab,使得vsftpd在开机时候自动启动：

<ul>
<li>::once:/usr/sbin/boa</li>
</ul>
</li>
<li>注意事项：

<ul>
<li>有时候boa服务器并不能随系统启动，运行 /sbin/boa 命令会提示：gethostbyname:: Success，需要如下修改

<ul>
<li><code>修改boa.conf 文件将  #ServerName  www.your.org.here  改为 ServerName  www.your.org.here</code></li>
</ul>
</li>
</ul>
</li>
</ol>


<h2>移植zlib库</h2>

<ol>
<li><a href="http://download.chinaunix.net/download.php?id=24014&amp;ResourceID=12241">下载zlib库,解压缩</a></li>
<li>进入终端，声明几个重要的环境变量：</li>
</ol>


<figure class='code'><figcaption><span>vsftpd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">export</span> <span class="n">CC</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gcc</span>
</span><span class='line'><span class="n">export</span> <span class="n">AR</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">ar</span>
</span><span class='line'><span class="n">export</span> <span class="n">LD</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">ld</span>
</span><span class='line'><span class="n">export</span> <span class="n">RANLIB</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">ranlib</span>
</span><span class='line'><span class="n">export</span> <span class="n">STRIP</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">strip</span>
</span><span class='line'><span class="n">export</span> <span class="n">CC_FOR_BUILD</span><span class="o">=</span><span class="n">gcc</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>./configure &ndash;shared &ndash;prefix=$PWD/results</li>
<li>make -j4</li>
<li>make install</li>
<li>成功后把lib里面的库文件复制到根文件系统对应目录，并把库文件和头文件复制到交叉编译器的对应文件夹中，注意复制到时候带上参数 <em>-P</em></li>
</ol>


<h2>移植libxml2库</h2>

<ol>
<li><a href="http://download.chinaunix.net/download/0007000/6095.shtml">下载libxml2库，解压缩</a></li>
<li>进入终端，声明几个重要的环境变量：</li>
</ol>


<figure class='code'><figcaption><span>vsftpd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">export</span> <span class="n">CC</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gcc</span>
</span><span class='line'><span class="n">export</span> <span class="n">AR</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">ar</span>
</span><span class='line'><span class="n">export</span> <span class="n">LD</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">ld</span>
</span><span class='line'><span class="n">export</span> <span class="n">RANLIB</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">ranlib</span>
</span><span class='line'><span class="n">export</span> <span class="n">STRIP</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">strip</span>
</span><span class='line'><span class="n">export</span> <span class="n">CC_FOR_BUILD</span><span class="o">=</span><span class="n">gcc</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>./configure &ndash;prefix=$PWD/results &ndash;host=arm-linux &ndash;target=arm-linux</li>
<li>make &amp;&amp; make install</li>
<li>将生成的lib和include移植到交叉编译器，将bin文件，lib文件移植到开发板根文件系统中的bin目录和lib目录中</li>
</ol>


<h2>移植SQLite数据库</h2>

<ol>
<li><a href="http://sqlite.org">获取源码,并解压缩</a></li>
<li>配置并进行交叉编译和安装

<ul>
<li><code>./configure --enable-shared --prefix=/work/rootfs/sqlite/result --host=arm-linux</code></li>
<li><code>make -j4 &amp;&amp; make install</code></li>
</ul>
</li>
<li>最终在result文件夹下面会得到四个文件夹:bin include lib share</li>
<li>将bin文件夹下的程序放到根文件系统的usr/bin 目录下</li>
<li>将lib文件夹下的动态库及其一个软连接复制到根文件系统的lib目录下，并将lib文件下的所有的动态链接库文件复制到交叉编译器的链接lib文件夹下</li>
<li>将include文件夹下的头文件复制到交叉编译器的头文件路径中</li>
</ol>


<h2>移植PHP5.4.42</h2>

<ol>
<li><a href="http://php.net/downloads.php">下载php源代码，解压缩</a></li>
<li>执行如下配置选项,配置之前需要先交叉编译好zlib，libxml2，sqlite3，iconv的库文件，然后在下面的脚本中指名其路径</li>
</ol>


<figure class='code'><figcaption><span>vsftpd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">arm</span> \
</span><span class='line'><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">arm</span><span class="o">/</span><span class="n">etc</span> \
</span><span class='line'><span class="o">--</span><span class="n">host</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span> \
</span><span class='line'><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">cli</span> \
</span><span class='line'><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">fileinfo</span> \
</span><span class='line'><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">debug</span> \
</span><span class='line'><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">rpath</span> \
</span><span class='line'><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">ftp</span> \
</span><span class='line'><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="kr">inline</span><span class="o">-</span><span class="n">optimization</span> \
</span><span class='line'><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">pdo</span> \
</span><span class='line'><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">bcmath</span> \
</span><span class='line'><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">calendar</span>
</span><span class='line'><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">sockets</span> \
</span><span class='line'><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">wddx</span> \
</span><span class='line'><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">mbstring</span> \
</span><span class='line'><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">mbregex</span> \
</span><span class='line'><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">sysvsem</span> \
</span><span class='line'><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">pear</span> \
</span><span class='line'><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">regex</span><span class="o">=</span><span class="n">system</span> \
</span><span class='line'><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">xmlrpc</span> \
</span><span class='line'><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">gettext</span> \
</span><span class='line'><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">sqlite3</span> \
</span><span class='line'><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">pdo</span><span class="o">-</span><span class="n">sqlite</span><span class="o">=/</span><span class="n">embeded</span><span class="o">/</span><span class="n">WenRisOS</span><span class="o">/</span><span class="n">rootfs</span><span class="o">/</span><span class="n">sqlite</span><span class="o">-</span><span class="mf">3.8.10.2</span><span class="o">/</span><span class="n">result</span> \
</span><span class='line'><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">libxml</span><span class="o">-</span><span class="n">dir</span><span class="o">=/</span><span class="n">embeded</span><span class="o">/</span><span class="n">WenRisOS</span><span class="o">/</span><span class="n">rootfs</span><span class="o">/</span><span class="n">third</span><span class="o">-</span><span class="n">libs</span><span class="o">/</span><span class="n">libxml2</span> \
</span><span class='line'><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">zlib</span><span class="o">-</span><span class="n">dir</span><span class="o">=/</span><span class="n">embeded</span><span class="o">/</span><span class="n">WenRisOS</span><span class="o">/</span><span class="n">rootfs</span><span class="o">/</span><span class="n">third</span><span class="o">-</span><span class="n">libs</span><span class="o">/</span><span class="n">zlib</span> \
</span><span class='line'><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">iconv</span><span class="o">-</span><span class="n">dir</span><span class="o">=/</span><span class="n">embeded</span><span class="o">/</span><span class="n">WenRisOS</span><span class="o">/</span><span class="n">rootfs</span><span class="o">/</span><span class="n">third</span><span class="o">-</span><span class="n">libs</span><span class="o">/</span><span class="n">iconv</span> \
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>configure执行完成以后，查看Makefile文件，确保里面的交叉编译器是arm-linux-gcc,重点检查：CC,CPP;检查EXTRA_LIBS是否有-liconv,-lxml2;检查头文件包含路径是否指向交叉编译的include路径(将所有的/usr/include替换掉交叉编译器对应的/usr/include)</li>
<li>make &amp;&amp; make install</li>
<li>将prefix所指路径的文件安装到开发板对应的地方(在这里也是开发板的/opt/php-arm文件下)</li>
<li>在开发板/opt/php-arm夹下新建文件夹etc，存放php配置文件php.ini(从源代码中复制一份修改名字即可)</li>
</ol>


<h2>嵌入式web服务器（Linux+lighttpd+Sqlite+PHP）移植 之lighttpd</h2>

<ol>
<li><a href="http://www.lighttpd.net/download/">下载lighttpd源码包，解压缩</a></li>
<li>执行如下配置：</li>
</ol>


<figure class='code'><figcaption><span>vsftpd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">lighttpd</span><span class="o">-</span><span class="n">arm</span> \
</span><span class='line'><span class="o">--</span><span class="n">host</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span> \
</span><span class='line'><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">shared</span> \
</span><span class='line'><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="k">static</span> \
</span><span class='line'><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">ipv6</span> \
</span><span class='line'><span class="o">--</span><span class="n">without</span><span class="o">-</span><span class="n">bzip2</span> \
</span><span class='line'><span class="o">--</span><span class="n">without</span><span class="o">-</span><span class="n">pcre</span> \
</span><span class='line'><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">zlib</span><span class="o">=/</span><span class="n">embeded</span><span class="o">/</span><span class="n">WenRisOS</span><span class="o">/</span><span class="n">rootfs</span><span class="o">/</span><span class="n">third</span><span class="o">-</span><span class="n">libs</span><span class="o">/</span><span class="n">zlib</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>configure执行完成后，检查Makefile文件CC是否指向了arm-linux-gcc，然后make &amp;&amp; make install</li>
<li>把生成的文件全都拷贝到目标板上对应的地方(prefix指名的路径下)。删除share文件夹，再新建cgi-bin,config,sockets,upload,vhosts,webpages路径</li>
<li>把lighttpd源代码里面doc/config路径下的conf.d,lighttpd.conf,modules.conf拷贝到上一步骤新建的config文件夹中</li>
<li>修改lighttpd.conf文件:

<ol>
<li>将16行至20行修改为如下褐色加粗字体所示：

<ul>
<li>var.log_root    = &ldquo;/var/log/lighttpd&rdquo;</li>
<li>var.server_root = &ldquo;/opt/lighttpd-arm&rdquo;</li>
<li>var.state_dir   = &ldquo;/opt/lighttpd-arm&rdquo;</li>
<li>var.home_dir    = &ldquo;/opt/lighttpd-arm&rdquo;</li>
<li>var.conf_dir    = &ldquo;/opt/lighttpd-arm/config&rdquo;</li>
</ul>
</li>
<li>将61行和93行修改为如下褐色加粗字体所示：

<ul>
<li>var.cache_dir   = &ldquo;/var/cache/lighttpd&rdquo;</li>
<li>server.use-ipv6 = &ldquo;disable&rdquo;</li>
</ul>
</li>
<li>将104和105行注释掉，如下所示：

<ul>
<li>#server.username  = &ldquo;lighttpd&rdquo;</li>
<li>#server.groupname = &ldquo;lighttpd&rdquo;</li>
</ul>
</li>
<li>将115行修改为如下褐色加粗字体所示：

<ul>
<li>server.document-root = server_root + &ldquo;/webpages&rdquo;</li>
</ul>
</li>
<li>将127行注释掉，如下所示：

<ul>
<li>#server.pid-file = state_dir + &ldquo;/lighttpd.pid&rdquo;</li>
</ul>
</li>
<li>如果不需要查看错误日志文件，可以将141行注释掉，如下所示：

<ul>
<li>#server.errorlog             = log_root + &ldquo;/error.log&rdquo;</li>
</ul>
</li>
<li>将152行、158行、191行注释掉，如下所示：

<ul>
<li>#include &ldquo;conf.d/access_log.conf&rdquo;</li>
<li>#include &ldquo;conf.d/debug.conf&rdquo;</li>
<li>#server.network-backend = &ldquo;linux-sendfile&rdquo;</li>
</ul>
</li>
<li>根据系统资源设置207行和225行的数值，本系统的设置分别如下褐色加粗字体所示：

<ul>
<li>server.max-fds = 256</li>
<li>server.max-connections = 128</li>
</ul>
</li>
<li>将314至316行注释掉，如下所示：

<ul>
<li>#$HTTP[&ldquo;url&rdquo;] =~ &ldquo;.pdf$&rdquo; {</li>
<li>#  server.range-requests = &ldquo;disable&rdquo;</li>
<li>#}</li>
</ul>
</li>
<li>将373行修改为如下褐色加粗字体所示：

<ul>
<li>server.upload-dirs = ( &ldquo;/opt/lighttpd-arm/upload&rdquo; )</li>
</ul>
</li>
</ol>
</li>
<li>修改modules.conf文件

<ol>
<li>找到43行，将光标定位到逗号后面，回车，插入如下内容(如果有就不用插入了)：

<ul>
<li>&ldquo;mod_alias&rdquo;,</li>
</ul>
</li>
<li>使能fastcgi模块，将132行的注释符去掉，如下所示：

<ul>
<li>include &ldquo;conf.d/fastcgi.conf&rdquo;</li>
</ul>
</li>
<li>使能cgi模块，将137行的注释符去掉，如下所示：

<ul>
<li>include &ldquo;conf.d/cgi.conf&rdquo;</li>
</ul>
</li>
</ol>
</li>
<li>修改conf.d/fastcgi.conf文件，在server.modules += (&ldquo;mod_fastcgi&rdquo;)下面添加如下：</li>
</ol>


<figure class='code'><figcaption><span>vsftpd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">fastcgi</span><span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;.php&quot;</span> <span class="o">=&gt;</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>      <span class="s">&quot;localhost&quot;</span> <span class="o">=&gt;</span>
</span><span class='line'>          <span class="p">(</span>
</span><span class='line'>          <span class="s">&quot;socket&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/tmp/php-fastcgi.socket&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s">&quot;bin-path&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/opt/php-arm/bin/php-cgi&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s">&quot;max-procs&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>          <span class="s">&quot;check-local&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;disable&quot;</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>修改conf.d/cgi.conf文件，在server.modules += ( &ldquo;mod_cgi&rdquo; )下面添加如下,接着去掉注释：<code>alias.url += ( "/cgi-bin" =&gt; server_root + "/cgi-bin" )</code></li>
</ol>


<figure class='code'><figcaption><span>vsftpd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">cgi</span><span class="p">.</span><span class="n">assign</span>         <span class="o">=</span> <span class="p">(</span><span class="s">&quot;.cgi&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<ol>
<li>在webpages文件夹下面添加网页文件和php文件进行测试</li>
<li>开机自启lighttpd服务器：<code>::once:/opt/lighttpd-arm/sbin/lighttpd -D -m /opt/lighttpd-arm/lib -f /opt/lighttpd-arm/config/lighttpd.conf</code></li>
</ol>


<h2>MP3播放器madplay移植</h2>

<ol>
<li><a href="ftp://ftp.mars.org/pub/mpeg/">进入官网下载3个源码包</a></li>
<li>移植libid3tag库需要依赖zlib库，所以需要先前把zlib的头文件和动态链接库文件保存在交叉编译器的头文件路径和库文件路径下</li>
<li>进入libid3tag源码文件夹，执行配置命令：./configure &ndash;prefix=/embeded/WenRisOS/rootfs/madplay/target-arm &ndash;host=arm-linux</li>
<li>make &amp;&amp; make install，把生成的头文件和库文件放入交叉编译器中</li>
<li>进入libmad源码文件夹，执行配置命令：./configure &ndash;prefix=/embeded/WenRisOS/rootfs/madplay/target-arm &ndash;host=arm-linux</li>
<li>make &amp;&amp; make install,把生成的头文件和库文件放入交叉编译器中</li>
<li>进入madplay源码文件夹，执行配置文件：./configure &ndash;prefix=/embeded/WenRisOS/rootfs/madplay/target-arm &ndash;host=arm-linux</li>
<li>make &amp;&amp; make install</li>
</ol>


<h2>移植嵌入式ssh服务器-dropbear</h2>

<ol>
<li><a href="http://matt.ucc.asn.au/dropbear/">下载源码包，解压缩</a></li>
<li>配置：</li>
</ol>


<figure class='code'><figcaption><span>vsftpd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="err">\#</span><span class="o">!/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=</span><span class="err">$</span><span class="n">PWD</span><span class="o">/</span><span class="n">results</span> \
</span><span class='line'><span class="o">--</span><span class="n">host</span><span class="o">=</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span> \
</span><span class='line'><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">zlib</span><span class="o">=/</span><span class="n">embeded</span><span class="o">/</span><span class="n">WenRisOS</span><span class="o">/</span><span class="n">rootfs</span><span class="o">/</span><span class="n">third</span><span class="o">-</span><span class="n">libs</span><span class="o">/</span><span class="n">zlib</span>
</span><span class='line'>
</span><span class='line'><span class="n">make</span>
</span><span class='line'><span class="n">make</span> <span class="n">scp</span>
</span><span class='line'><span class="n">make</span> <span class="n">install</span>
</span><span class='line'><span class="n">cp</span> <span class="n">scp</span> <span class="n">results</span><span class="o">/</span><span class="n">bin</span>
</span><span class='line'><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">strip</span> <span class="n">results</span><span class="o">/</span><span class="n">bin</span><span class="o">/*</span> <span class="n">results</span><span class="o">/</span><span class="n">sbin</span><span class="o">/*</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>将生成的bin，sin放到开发板相应文件夹下</li>
</ol>


<h2>编译tslib</h2>

<ol>
<li><a href="http://download.csdn.net/detail/liuqiqi677/3177449">源码下载地址</a></li>
<li>解压缩，进入tslib源码文件夹</li>
<li><code>./autogen.sh</code>生成configure源代码配置文件</li>
<li><code>./configure --host=arm-linux --disable-h3600 --disable-arctic2 --disable-mk712 --disable-collie --disable-corgi --disable-ucb1x00 --with-gnu-ld --prefix=/embeded/tslib_install ac_cv_func_malloc_0_nonnull=yes</code> 这里，&ndash;host的含义是你要安装的目标系统，后面的&ndash;disable 是因为我们不编译对指定触摸屏的支持，我们选择支持的是Linux的input子系统，&ndash;with-gnu-ld是确认使用GNU的LD连接器，因为我们使用的就是GNU的编译器，所以选择这一项。&ndash;prefix选项是指定安装的位置。ac_cv_func_malloc_0_nonnull会在./configure执行阶段测试GNU内置的malloc函数的功能是否可用或者说是否兼容</li>
<li>进入安装目录，这里是/embeded/tslib_install,进入etc目录，打开ts.conf进行修改.其中pthres主要用于处理触摸屏的灵敏度，而variance和dejitter分别用于处理触摸屏的滤波和去噪的算法，linear是触摸屏的坐标变换。

<ul>
<li>module_raw input</li>
<li>module pthres pmin=1</li>
<li>module variance delta=30</li>
<li>module dejitter delta=100</li>
<li>module linear</li>
</ul>
</li>
</ol>


<h2>Qt移植(Qt支持的嵌入式Linux平台需要有frambuffer支持)</h2>

<ol>
<li><a href="http://download.qt.io/development_releases/qt/5.4/5.4.0-rc/single/">下载软件包，解压缩</a></li>
<li>进入源代码根文件目录，执行配置命令如下：</li>
</ol>


<figure class='code'><figcaption><span>vsftpd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="err">\#</span><span class="o">!/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">-</span><span class="n">prefix</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">qt4</span><span class="mf">.8.5</span><span class="o">-</span><span class="n">arm</span> \
</span><span class='line'><span class="o">-</span><span class="n">opensource</span> \
</span><span class='line'><span class="o">-</span><span class="n">confirm</span><span class="o">-</span><span class="n">license</span> \
</span><span class='line'><span class="o">-</span><span class="n">release</span> \
</span><span class='line'><span class="o">-</span><span class="n">shared</span> \
</span><span class='line'><span class="o">-</span><span class="n">embedded</span> <span class="n">arm</span> <span class="err">\</span>                         <span class="err">#选择</span><span class="n">Qt</span><span class="err">的嵌入式平台为</span><span class="n">arm</span><span class="err">平台</span>
</span><span class='line'><span class="o">-</span><span class="n">xplatform</span> <span class="n">qws</span><span class="o">/</span><span class="n">linux</span><span class="o">-</span><span class="n">arm</span><span class="o">-</span><span class="n">g</span><span class="o">++</span> \
</span><span class='line'><span class="o">-</span><span class="n">platform</span> <span class="n">qws</span><span class="o">/</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="n">g</span><span class="o">++</span> \
</span><span class='line'><span class="o">-</span><span class="n">depths</span> <span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">32</span> \
</span><span class='line'><span class="o">-</span><span class="n">optimized</span><span class="o">-</span><span class="n">qmake</span> \
</span><span class='line'><span class="o">-</span><span class="n">qt</span><span class="o">-</span><span class="n">sql</span><span class="o">-</span><span class="n">sqlite</span> \
</span><span class='line'><span class="o">-</span><span class="n">qt</span><span class="o">-</span><span class="n">zlib</span> \
</span><span class='line'><span class="o">-</span><span class="n">webkit</span> \
</span><span class='line'><span class="o">-</span><span class="n">qt</span><span class="o">-</span><span class="n">gfx</span><span class="o">-</span><span class="n">transformed</span> \
</span><span class='line'><span class="o">-</span><span class="n">qt</span><span class="o">-</span><span class="n">libjpeg</span> <span class="err">\</span>                            <span class="err">#使</span><span class="n">Qt</span><span class="err">支持</span><span class="n">jpeg</span><span class="err">图片显示</span>
</span><span class='line'><span class="o">-</span><span class="n">qt</span><span class="o">-</span><span class="n">libpng</span> \
</span><span class='line'><span class="o">-</span><span class="n">qt</span><span class="o">-</span><span class="n">libtiff</span> \
</span><span class='line'><span class="o">-</span><span class="n">qt</span><span class="o">-</span><span class="n">libmng</span>  \
</span><span class='line'><span class="o">-</span><span class="n">qt</span><span class="o">-</span><span class="n">freetype</span> \
</span><span class='line'><span class="o">-</span><span class="n">little</span><span class="o">-</span><span class="n">endian</span> \
</span><span class='line'><span class="o">-</span><span class="n">host</span><span class="o">-</span><span class="n">little</span><span class="o">-</span><span class="n">endian</span> \
</span><span class='line'><span class="o">-</span><span class="n">make</span> <span class="n">libs</span> \
</span><span class='line'><span class="o">-</span><span class="n">nomake</span> <span class="n">tools</span> \
</span><span class='line'><span class="o">-</span><span class="n">nomake</span> <span class="n">docs</span> \
</span><span class='line'><span class="o">-</span><span class="n">make</span> <span class="n">examples</span> \
</span><span class='line'><span class="o">-</span><span class="n">make</span> <span class="n">demos</span> \
</span><span class='line'><span class="o">-</span><span class="n">qt</span><span class="o">-</span><span class="n">kbd</span><span class="o">-</span><span class="n">linuxinput</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">qt3support</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">phonon</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">phonon</span><span class="o">-</span><span class="n">backend</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">gif</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">dbus</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">rpath</span> \
</span><span class='line'><span class="o">-</span><span class="n">qt</span><span class="o">-</span><span class="n">mouse</span><span class="o">-</span><span class="n">tslib</span> <span class="err">\</span>                      <span class="err">#使</span><span class="n">Qt</span><span class="err">支持触摸方式，需要额外指定</span><span class="n">tslib</span><span class="err">的路径</span>
</span><span class='line'><span class="o">-</span><span class="n">qt</span><span class="o">-</span><span class="n">mouse</span><span class="o">-</span><span class="n">pc</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">mouse</span><span class="o">-</span><span class="n">linuxtp</span> \
</span><span class='line'><span class="o">-</span><span class="n">qt</span><span class="o">-</span><span class="n">gfx</span><span class="o">-</span><span class="n">linuxfb</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">neon</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">nis</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">cups</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">openssl</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">fast</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">scripttools</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">mmx</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="mi">3</span><span class="n">dnow</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">sse</span> \
</span><span class='line'><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">sse2</span> \
</span><span class='line'><span class="o">-</span><span class="n">I</span> <span class="o">/</span><span class="n">embeded</span><span class="o">/</span><span class="n">WenRisOS</span><span class="o">/</span><span class="n">rootfs</span><span class="o">/</span><span class="n">tslib</span><span class="o">/</span><span class="n">target</span><span class="o">-</span><span class="n">arm</span><span class="o">/</span><span class="n">include</span> \
</span><span class='line'><span class="o">-</span><span class="n">L</span> <span class="o">/</span><span class="n">embeded</span><span class="o">/</span><span class="n">WenRisOS</span><span class="o">/</span><span class="n">rootfs</span><span class="o">/</span><span class="n">tslib</span><span class="o">/</span><span class="n">target</span><span class="o">-</span><span class="n">arm</span><span class="o">/</span><span class="n">lib</span> \
</span><span class='line'><span class="o">-</span><span class="n">R</span> <span class="o">/</span><span class="n">embeded</span><span class="o">/</span><span class="n">WenRisOS</span><span class="o">/</span><span class="n">rootfs</span><span class="o">/</span><span class="n">tslib</span><span class="o">/</span><span class="n">target</span><span class="o">-</span><span class="n">arm</span><span class="o">/</span><span class="n">lib</span> \
</span><span class='line'><span class="o">-</span><span class="n">D__ARM_ARCH_5TEJ_</span>                      <span class="err">#选择处理器平台</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>make &amp;&amp; make install</li>
<li>将生成的lib文件和plugins文件部署到根文件系统中，字体保存在lib下的fonts目录下</li>
</ol>


<h2>gdb/gdbserver</h2>

<blockquote><p>gdb和gdbserver可以看作两个不同的命令。gdb放在宿主机上运行，而gdbserver被放在开发板上运行。启动gdbserver运行制定的需要调试的可执行文件，而在宿主机中使用gdb来运行同样的可执行文件，通过串口或者tcp就可以达到远程调试的目的。由于宿主机gdb所运行的程序和gdbserver是一样的，都是arm指令的elf文件，那么作为宿主机gdb工具必须能够明确地知道遵循ABI接口的ARM的ELF文件格式。因此，传统的宿主机自身携带的gdb不能用于调试嵌入式ARM程序，我们需要下载gdb的源代码，增加对ARM的ELF格式的支持才能够调试ARM程序。</p></blockquote>

<ol>
<li>编译宿主机上的arm-linux-gdb程序（如果在busybox中添加过了gdb的选项，不必再编译arm-linux-gdb了，已经有了）

<ul>
<li>./configure &ndash;target=arm-linux &ndash;enable-werror=no</li>
<li>&ndash;target指定宿主机调试的目标机类型，在编译的时候会编译出符合arm-linux的调试的gdb工具</li>
<li>&ndash;enable-werror的含义是在编译的时候增加-Werror选项，这样会把一些原本的警告信息当做错误。由于gdb的部分代码写的并不规范，所以-Werror会报出一些错误</li>
</ul>
</li>
<li>进入gdb/gdbserver目录下，执行以下命令：

<ul>
<li>./configure &ndash;host=arm-linux &ndash;target=arm-linux</li>
<li>make</li>
<li>arm-linux-strip gdbserver</li>
<li>&ndash;host指定编译出的工具运行在什么平台</li>
<li>&ndash;target为指定的编译器配置目标环境</li>
</ul>
</li>
<li>gdb远程调试命令

<ul>
<li>Target remote ip：port executable；target命令用于连接一个远程的gdbserver，ip和port为远程主机的ip和端口号，executable为gdbserver需要调试的程序，这个文件在gdb所在的宿主机上不能被strip，否在调试需要的symbols就不存在了</li>
<li>file executable；在gdb调试之前，需要使用file命令获取可执行文件的符号，以获得调试需要的符号列表</li>
<li>show/set sysroot；因为调试的时候需要用到交叉编译器的库文件和工具，所以必须制定，set用于设置sysroot路径，show用于显示gdb内置变量的值</li>
<li>show/set solib-search-path;solib-search-path必须设置，因为远程调试的程序在运行时会调用到动态库，需要把所有的动态库都加载到这个变量中，像LD_LIBRARY_PATH一样</li>
<li>List/l;调试的时候我们可以通过这个命令查看源代码</li>
<li>break/b linenumber/function;设置断点，在运行时会停止在设置的断点处，断点可以设置为代码的行号，也可以在指定的函数处停止</li>
<li>continue/c;继续，使用gdb/gdbserver，没有run这个命令，因为程序实际通过stub在gdbserver所对应的开发板上运行</li>
<li>next/n;执行一条指令，但不会进入函数内部</li>
<li>print/p;打印变量的值</li>
<li>step/s;单步跟踪，如果有函数，会进入函数内部，可以通过finish命令退出函数</li>
<li>quit/q;退出gdb调试环境</li>
</ul>
</li>
<li>步骤演示

<ul>
<li>开发板执行arm-linux-gdbserver命令，开启调试服务端程序test：arm-linux-gdbserver 192.168.1.230:6410 test;命令的参数类型为<ip>:<port> <app>,ip为开发板的网络地址，端口号由用户指定，代表服务应用程序所使用的网络端口，app为需要调试的应用程序的名字</li>
<li>宿主机把调试文件载入gdb调试器（可执行文件必须要有调试信息，比如编译时候加上-g，Qt下是qmake CONFIG+=debug）：arm-linux-gdb test</li>
<li>向应用程序传递参数，比如：set args -qws</li>
<li>确认参数是否被正学设置：show args</li>
<li>设置交叉编译器动态库文件路径：set sysroot /embeded/wenris-xtools/arm-wenris-linux-gnueabi/sysroot;如果在交叉编译的时候指定&ndash;with-sysroot，则可以省略。最后通过show sysroot命令查看是否设置成功</li>
<li>设置程序运行时的动态库：set solib-search-path /work/qt/qt-4.7-arm/lib:/work/qt/tslib_install/lib:/work/qt/tslib_install/lib/ts</li>
<li>链接到gdbserver：target remote 192.168.1.230:6410</li>
<li>执行gdb相关的代码调试命令进行远程调试</li>
</ul>
</li>
</ol>


<p><img src="http://i.imgur.com/Nn7Krru.gif" alt="suda-morris" /></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-08T22:30:05+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/develop/'>develop</a>, <a class='category' href='/blog/categories/kdm/'>kdm</a>, <a class='category' href='/blog/categories/linux/'>linux</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/08/gns3-install/">
		
			GNS3_Install</a>
	</h2>
	<div class="entry-content">
		<h2>GNS3模拟器安装步骤</h2>

<ol>
<li><a href="https://community.gns3.com/community/software/download/">下载GNS3</a>，并且安装</li>
<li><a href="https://community.gns3.com/community/software/download/">下载GNS3 IOU VM虚拟机镜像</a></li>
<li>下载路由器和交换机的IOS镜像文件(百度搜索并下载)

<ul>
<li>i86bi-linux-l2-ipbasek9-15.1g.bin(交换机)</li>
<li>i86bi-linux-l3-adventerprisek9-15.4.1T.bin(路由器)</li>
</ul>
</li>
<li>安装virtualbox</li>
<li>导入步骤2中下载的GNS3虚拟机镜像，设置网卡为hostonly，并启动虚拟机</li>
<li>GNS3是基于linux系统的，root用户登录，密码为cisco，然后查看网卡ip地址ifconfig</li>
<li>在浏览器中输入刚才查找到的IP地址，并指名端口号8000下的upload，例如：<a href="http://192.168.172.101:8000/upload">http://192.168.172.101:8000/upload</a></li>
<li>打开GNS3软件，在edit->Preference->Server中添加虚拟机的IP地址以及端口(ip地址来自步骤6)</li>
<li>在edit->Preference->IOS on UNIX中，指名iourc.txt的路径</li>
<li>在edit->Preference->IOU devices中，添加switch和router镜像路径(路径为上传到虚拟机中的具体路径，例如：/home/gns3/GNS3/images/IOU/i86bi-linux-l2-ipbasek9-15.1g.bin)</li>
<li>启动设备</li>
</ol>


<p><img src="http://i.imgur.com/Nn7Krru.gif" alt="suda-morris" /></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-08T11:24:09+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/gns3/'>gns3</a>, <a class='category' href='/blog/categories/study/'>study</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/05/28/python-baseknowledge/">
		
			Python-BaseKnowledge</a>
	</h2>
	<div class="entry-content">
		<h2>Python中的常量</h2>

<figure class='code'><figcaption><span>常量定义</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='Python'><span class='line'><span class="k">class</span> <span class="nc">_const</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">ConstError</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span> <span class="k">pass</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
</span><span class='line'>      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span><span class='line'>          <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">ConstError</span><span class="p">,</span><span class="s">&quot;Can&#39;t rebind const(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">name</span>
</span><span class='line'>      <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
</span><span class='line'>          <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">ConstError</span><span class="p">,</span><span class="s">&quot;Can&#39;t unbind const(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">name</span>
</span><span class='line'>      <span class="k">raise</span> <span class="ne">NameError</span><span class="p">,</span> <span class="n">name</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">_const</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>把以上代码变成const.py文件放到Python安装目录的Lib文件夹下</li>
</ul>


<h2>引号的使用与区别</h2>

<ol>
<li>单引号与双引号可以交叉使用，即双引号中的单引号维持原样，单引号中的双引号维持原样</li>
<li>三引号里面不能使用单引号和双引号，三引号中的格式维持不变，该回车就回车，该空格就空格</li>
<li>当需要把转义字符原样输出的时候可以使用自然字符串，即在字符串前面加r</li>
<li>子字符串运算方法：

<ul>
<li>索引运算（从0开始索引）</li>
<li>切片运算（[a:b]是指从第a下标开始到第b-1下标结束，同样第一位下标为0）</li>
</ul>
</li>
<li>列表中的元素是有序的

<ul>
<li>students=[&ldquo;小明&rdquo;,&ldquo;小华&rdquo;,&ldquo;小李&rdquo;,&ldquo;小娟&rdquo;,&ldquo;小云&rdquo;]，下标从0开始</li>
</ul>
</li>
<li>元祖里面的内容只能读取，不能修改，列表里面的内容既可以修改，又能读取

<ul>
<li>students=(&ldquo;小明&rdquo;,&ldquo;小华&rdquo;,&ldquo;小李&rdquo;,&ldquo;小娟&rdquo;,&ldquo;小云&rdquo;)</li>
</ul>
</li>
<li>Python中集合主要有两个功能，一个功能是建立关系，另一个是消除重复元素，集合的格式是：set(元素)

<ul>
<li>交集：&amp;</li>
<li>并集：|</li>
<li>差集：-</li>
<li>消除重复元素：new=set(a)</li>
</ul>
</li>
<li>字典也叫关联数组，用大括号括起来

<ul>
<li>k={&ldquo;name&rdquo;:&ldquo;Java&rdquo;,&ldquo;IDE&rdquo;:&ldquo;Eclipse&rdquo;}</li>
<li>print k[&ldquo;IDE&rdquo;]</li>
<li>添加字典里面的项目k[&ldquo;User&rdquo;]=&ldquo;morris&rdquo;</li>
</ul>
</li>
<li>Python中的标识符第一个字符必须只能是字母或者下划线，之后的部分可以使字母，下划线或者数组</li>
<li>在Python中，如果有一些对象需要持久性存储，并且不丢失我们这个对象的类型与数据，我们需要将这些对象进行序列化，序列化之后，需要使用的时候我们再回复为原来的数据。序列化的这种过程我们称之为pickle（腌制）

<ul>
<li>import pickle</li>
<li>lista=[&ldquo;mingyue&rdquo;,&ldquo;jishi&rdquo;,&ldquo;you&rdquo;]</li>
<li>listb=pickle.dumps(lista)#序列化</li>
<li>listc=pickle.loads(listb)#将对象原样恢复</li>
<li>group1=(&ldquo;bajiu&rdquo;,&ldquo;wen&rdquo;,&ldquo;qingtian&rdquo;)</li>
<li>f1=file(&lsquo;1.pkl&rsquo;,&lsquo;wb&rsquo;)</li>
<li>pickle.dump(group1,f1,True)</li>
<li>f1.close()</li>
<li>f2=file(&lsquo;1.pkl&rsquo;,&lsquo;rb&rsquo;)</li>
<li>t=pickle.load(f2)</li>
<li>f2.close()</li>
</ul>
</li>
<li>Python的行连接符：\</li>
<li></li>
</ol>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-05-28T21:42:24+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/python/'>python</a>, <a class='category' href='/blog/categories/study/'>study</a>


</div>
	
</div>
</article>

<nav id="pagenavi">
    
        
            <a href="/posts/4" class="prev">Prev</a>
        
    
    
        <a href="/posts/6" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    suda-morris

Powered by Octopress-WenRis Group
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>