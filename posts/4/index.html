
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>WenRis Blog</title>
	<meta name="author" content="suda-morris">

	
	<meta name="description" content="WenRis Blog">
	<meta name="keywords" content="C/C++,Python,Lua">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="WenRis Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//libs.baidu.com/jquery/1.9.1/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">WenRis Blog</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/blog/categories">Categories</a></li>
	<li><a href="/aboutme">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/blog/categories">Categories</a></li>
	<li><a href="/aboutme">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.baidu.com" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:suda-morris.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/Morris1106com" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/suda-morris" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.baidu.com" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:suda-morris.github.io">
	</form>
</nav>

</header>
	
		
	

	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/07/13/ut4418-introduce/">
		
			UT4418_Introduce</a>
	</h2>
	<div class="entry-content">
		<h2>S5PV4418简介</h2>

<blockquote><p>S5PV4418处理器是三星2014年推出的4核处理器，使用Cortex-A9四核心，整体性能比Cortex-A8核心高出50%，提供6.4GB/s内存带宽，支持1080P的全高清视频输出，以及3D图形显示，支持LCD显示1080P高清电视输出等。完全是Exynos4412的升级版芯片，性能远远超过Exynos4412，并且基本兼容Exynos412</p></blockquote>

<h2>开发板配置</h2>

<ol>
<li>4G iNand(SDIN5C1-4G),1G DDR3(H5TQ4G63AFR-PBC),三星电源管理芯片&ndash;NXE2000</li>
<li>尺寸：120mm*90mm</li>
<li>TF卡支持热插拔，容量最大支持32G</li>
<li>设有开机键，长按3秒后开机</li>
<li>设有复位键，长按3秒后硬件复位，在系统启动后，可以通过软件去配置PMU来改变复位键长按时间的长短</li>
<li>通过SDA7123转换出VGA信号，VGA支持LCD同步显示，支持1080P视频输出</li>
<li>HDMI信号通过MCU直接引出，减少了转换芯片的链接，支持与LCD同步播放视频，支持的视频输出格式为480P，720P,1080P</li>
<li>以太网接口采用RTL8211E-VB-CG芯片，支持10M，100M，1000M网自适应</li>
<li>配置了USB接口的wifi模块&ndash;RTL8188</li>
<li>配置了FT-009红外接收头，支持红外遥控接收</li>
</ol>


<h2>开发环境搭建</h2>

<ol>
<li>使用虚拟机VirtualBox安装Ubuntu14.04.2LTS系统</li>
</ol>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-07-13T13:10:17+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/s5pv4418/'>s5pv4418</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/07/06/poe-introduce/">
		
			POE简介</a>
	</h2>
	<div class="entry-content">
		<blockquote><p>以太网供电（Power over Ethernet，简称PoE）也称为PoE供电，是一种可以在以太网路中透过双绞线来传输电力与资料到装置上的技术。以太网供电技术的出发点是让IP电话、WLAN接入点、网络摄像头等小型网络设备，可以直接从以太网线（4对双绞线中空闲的2对来传输）获得电力，无需单独铺设电力线，以简化系统布线，降低网络基础设施的建设成本。</p></blockquote>

<h2>使用POE的注意事项</h2>

<blockquote><p>使用POE需要留意以下三点：</p>

<ol>
<li>如上图所示，不是所有的以太网交换机都支持PoE供电功能，供电模块内置或外置，一般价格比普通交换贵一些。</li>
<li>要求终端也支持PoE受电功能。</li>
<li>通过网线供电，功率本身是有一定限制的，留意查看不同设备的使用说明和功率要求。</li>
</ol>
</blockquote>

<h2>典型的系统</h2>

<blockquote><p>一个典型的以太网供电系统。在配线柜里保留以太网交换机设备，用一个带电源供电集线器(Midspan HUB)给局域网的双绞线提供电源。在双绞线的末端，该电源用来驱动电话、无线接入点、相机和其他设备。为避免断电，可以选用一个UPS。</p></blockquote>

<h2>原理</h2>

<blockquote><p>标准的五类网线有<strong>四对双绞线</strong>,但是在10M BASE-T和100M BASE-T中只用到其中的<strong>两对</strong>。IEEE80 2.3af允许<strong>两种</strong>用法:</p>

<ol>
<li>应用空闲脚供电时,4、5脚连接为正极,7、8脚连接为负极。</li>
<li>应用数据脚供电时,将DC电源加在传输变压器的中点,不影响数据的传输。在这种方式下线对1、2和线对3、6可以为任意极性。</li>
</ol>


<p>IEEE802.3af标准不允许同时应用以上两种情况。电源提供设备PSE只能提供一种用法,但是电源应用设备PD必须能够同时适应两种情况。该标准规定供电电源通常是48V、13W的。PD设备提供48V到低电压的转换是较容易的,但同时应有1500V的绝缘安全电压。</p></blockquote>

<p><img src="http://i.imgur.com/uRd8v4m.png" alt="POE典型组网图" /></p>

<h2>参数</h2>

<blockquote><p>一个完整的POE系统包括供电端设备(PSE, Power Sourcing Equipment)和受电端设备(PD, Powered Device)两部分。PSE设备是为以太网客户端设备供电的设备,同时也是整个POE以太网供电过程的管理者。而PD设备是接受供电的PSE负载,即POE系统的客户端设备,如IP电话、网络安全摄像机、AP及掌上电脑( PDA)或移动电话充电器等许多其他以太网设备（实际上,任何功率不超过13W的设备都可以从RJ45插座获取相应的电力）。</p>

<p>POE标准供电系统的主要供电特性参数为：</p>

<ol>
<li>电压在44～57V之间,典型值为48V。</li>
<li>允许最大电流为550mA,最大启动电流为500mA。</li>
<li>典型工作电流为10～350mA,超载检测电流为350～500mA。</li>
<li>在空载条件下,最大需要电流为5mA。</li>
<li>为PD设备提供3.84～12.95W三个等级的电功率请求,最大不超过13W。（注意PD分级0和分级4没有显示出来而且不应采用。）</li>
<li>2009年10月30日 IEEE出了一个最新的802.3at标准，其中规定了POE可以提供更高的功率，超过了13W，可以达到30W,分三个等级(7W,15.4W,30W)</li>
<li>一般设备上会标明：15.4W/802.3af,30W/802.3at</li>
</ol>
</blockquote>

<h2>工作过程</h2>

<ol>
<li>检测

<ul>
<li>一开始,PSE设备在端口输出很小的电压,直到其检测到线缆终端的连接为一个支持IEEE 802.3af标准的受电端设备。检测电源输出线对之间的阻容值来判断PD是否存在</li>
</ul>
</li>
<li>PD端设备分类

<ul>
<li>当检测到受电端设备PD之后,PSE设备可能会为PD设备进行分类,并且评估此PD设备所需的功率损耗。</li>
</ul>
</li>
<li>开始供电

<ul>
<li>在一个可配置时间(一般小于15μs)的启动期内,PSE设备开始从低电压向PD设备供电,直至提供48V的直流电源。</li>
</ul>
</li>
<li>供电

<ul>
<li>为PD设备提供稳定可靠48V的直流电,满足PD设备不越过 30W的功率消耗。</li>
</ul>
</li>
<li>断电

<ul>
<li>若PD设备从网络上断开时,PSE就会快速地(一般在300～400ms之内)停止为PD设备供电,并重复检测过程以检测线缆的终端是否连接PD设备。</li>
</ul>
</li>
</ol>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-07-06T20:16:12+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/poe/'>poe</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/29/about-nginx/">
		
			初识Nginx</a>
	</h2>
	<div class="entry-content">
		<h2>Nginx简介</h2>

<blockquote><ol>
<li>Nginx是一种服务器软件，Nginx是一种高性能的HTTP和反向代理服务器，同时是一个代理邮件服务器，也就是Ngix上可以发布网站，也可以实现负载均衡，还可以作为邮件服务器实现收发邮件的功能</li>
<li>所谓负载均衡，是指当同时有N多个用户访问我们服务器的时候，为了减小服务器压力，我们需要将用户分别引入各服务器，分担服务器压力</li>
<li>优点：高并发，部署简单，内存消耗少，成本低</li>
<li>缺点：rewrite功能不够强大，模块没有Apache多</li>
</ol>
</blockquote>

<h2>其它服务器</h2>

<ol>
<li>IIS服务器只能在Windows上运行，Windows服务器性能不如Linux服务器</li>
<li>Tomcat服务器面向的是Java语言，是一种重量级的服务器</li>
<li>Apache服务器稳定，开源，跨平台，但是不支持高并发</li>
</ol>


<h2>Nginx环境的搭建</h2>

<ol>
<li><a href="http://nginx.org">进入官网下载最新版</a></li>
<li>安装gcc:<code>yum -y install gcc gcc-c++ autoconf automake</code></li>
<li>安装PCRE库文件：<code>yum -y install pcre pcre-devel</code></li>
<li>安装zlib库文件：<code>yum -y install zlib zlib-devel</code></li>
<li>解压缩Nginx压缩包，然后进入解压后文件夹，<code>./config --prefix=/software</code>,成功后执行<code>make $$ make install</code></li>
<li>启动服务器：<code>/software/nginx/sbin/nginx -c /software/nginx/conf/nginx.conf</code></li>
</ol>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-29T10:21:37+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/nginx/'>nginx</a>, <a class='category' href='/blog/categories/study/'>study</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/27/c-language-review/">
		
			C语言知识点</a>
	</h2>
	<div class="entry-content">
		<h2><code>#ifdef和#if defined的差别</code></h2>

<p>注意两者都有个define的作用，区别在于使用方式上。前者的通常用法是:</p>

<figure class='code'><figcaption><span>只能在两者中选择是否有定义</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#ifdef  XXX</span>
</span><span class='line'>
</span><span class='line'>   <span class="p">....</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>
</span><span class='line'>   <span class="p">....</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>对于后者，常用法是：</p>

<figure class='code'><figcaption><span>可以在多个中选择是否有定义</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#if defined xxx1</span>
</span><span class='line'>
</span><span class='line'>   <span class="p">....</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#elif defined xxx2</span>
</span><span class='line'>
</span><span class='line'>   <span class="p">....</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#elif defined xxx3</span>
</span><span class='line'>
</span><span class='line'>   <span class="p">....</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-27T15:17:24+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/c/'>c</a>, <a class='category' href='/blog/categories/study/'>study</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/24/php-knowledge/">
		
			PHP语法基础</a>
	</h2>
	<div class="entry-content">
		<h3>变量</h3>

<ul>
<li>变量使用<strong>$+变量名</strong>来定义与使用，比如:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='PHP'><span class='line'><span class="nv">$a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'><span class="nv">$b</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
</span><span class='line'><span class="k">echo</span> <span class="nv">$a</span><span class="o">+</span><span class="nv">$b</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>常量</h3>

<ul>
<li>使用关键字<strong>const</strong>：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='PHP'><span class='line'><span class="k">const</span> <span class="no">THE_VALUE</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span><span class='line'><span class="k">echo</span> <span class="nx">THEVALUE</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>使用<strong>define</strong>函数：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='PHP'><span class='line'><span class="nb">define</span><span class="p">(</span><span class="s1">&#39;THE_VALUE&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
</span><span class='line'><span class="k">echo</span> <span class="nx">THE_VALUE</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-24T16:00:02+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/php/'>php</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/20/board-dot-c/">
		
			Uboot第二阶段代码分析</a>
	</h2>
	<div class="entry-content">
		<figure class='code'><figcaption><span>include/asm-arm/global_data.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="k">typedef</span>  <span class="k">struct</span>   <span class="n">global_data</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">bd_t</span>        <span class="o">*</span><span class="n">bd</span><span class="p">;</span>               <span class="cm">/*与板子相关的结构*/</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">baudrate</span><span class="p">;</span>     <span class="cm">/*波特率*/</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">have_console</span><span class="p">;</span> <span class="cm">/* serial_init() was called */</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">reloc_off</span><span class="p">;</span>        <span class="cm">/* 重定位偏移*/</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">env_addr</span><span class="p">;</span>     <span class="cm">/* 存放环境变量结构的地址*/</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">env_valid</span><span class="p">;</span>        <span class="cm">/* Checksum of Environment valid? */</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">fb_base</span><span class="p">;</span>      <span class="cm">/* base address of frame buffer */</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_VFD</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">vfd_type</span><span class="p">;</span>     <span class="cm">/* display type */</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#if 0</span><span class="c"></span>
</span><span class='line'><span class="c">  unsigned long   cpu_clk;        /* CPU的时钟频率*/</span>
</span><span class='line'><span class="c">  unsigned long   bus_clk;        /*总线的时钟频率*/</span>
</span><span class='line'><span class="c">  unsigned long   ram_size;       /* RAM size */</span>
</span><span class='line'><span class="c">  unsigned long   reset_status;   /* reset status register at boot */</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="kt">void</span>        <span class="o">**</span><span class="n">jt</span><span class="p">;</span>              <span class="cm">/* jump table，保存着某些函数的入口地址，在common/Exoirt.c中进行填充 */</span>
</span><span class='line'><span class="p">}</span> <span class="kt">gd_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Global Data Flags</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="cp">#define  GD_FLG_RELOC    0x00001     </span><span class="cm">/* Code was relocated to RAM        */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define  GD_FLG_DEVINIT  0x00002     </span><span class="cm">/* Devices have been initialized    */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define  GD_FLG_SILENT   0x00004     </span><span class="cm">/* Silent mode              */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if  0</span><span class="c"></span>
</span><span class='line'><span class="c">#define DECLARE_GLOBAL_DATA_PTR     register volatile gd_t *gd asm (&quot;r8&quot;)</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="cp">#define DECLARE_GLOBAL_DATA_PTR</span>
</span><span class='line'><span class="k">extern</span> <span class="kt">gd_t</span> <span class="o">*</span><span class="n">gd</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* __ASM_GBL_DATA_H */</span><span class="cp"></span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>include/asm-arm/u-boot.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#ifndef _U_BOOT_H_</span>
</span><span class='line'><span class="cp">#define _U_BOOT_H_   1</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">bd_info</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span>           <span class="n">bi_baudrate</span><span class="p">;</span>      <span class="cm">/* 串口波特率*/</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bi_ip_addr</span><span class="p">;</span>       <span class="cm">/* IP Address */</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bi_enetaddr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span> <span class="cm">/* Ethernet adress */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">environment_s</span>    <span class="o">*</span><span class="n">bi_env</span><span class="p">;</span><span class="cm">/*环境变量地址指针*/</span>
</span><span class='line'>    <span class="n">ulong</span>          <span class="n">bi_arch_number</span><span class="p">;</span>   <span class="cm">/* unique id for this board&#39;s CPU */</span>
</span><span class='line'>    <span class="n">ulong</span>          <span class="n">bi_boot_params</span><span class="p">;</span>   <span class="cm">/* where this board expects params */</span>
</span><span class='line'>    <span class="k">struct</span>                         <span class="cm">/* RAM configuration */</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>  <span class="n">ulong</span> <span class="n">start</span><span class="p">;</span>                   <span class="cm">/*RAM的起始地址*/</span>
</span><span class='line'>  <span class="n">ulong</span> <span class="n">size</span><span class="p">;</span>                        <span class="cm">/*RAM的大小*/</span>
</span><span class='line'>    <span class="p">}</span> <span class="n">bi_dram</span><span class="p">[</span><span class="n">CONFIG_NR_DRAM_BANKS</span><span class="p">];</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_HAS_ETH1</span>
</span><span class='line'>    <span class="cm">/* second onboard ethernet port */</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">bi_enet1addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="p">}</span> <span class="kt">bd_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define bi_env_data bi_env-&gt;data</span>
</span><span class='line'><span class="cp">#define bi_env_crc  bi_env-&gt;crc</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif   </span><span class="cm">/* _U_BOOT_H_ */</span><span class="cp"></span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>include/command.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="k">struct</span> <span class="n">cmd_tbl_s</span> <span class="p">{</span>                 <span class="cm">/*command table结构体*/</span>
</span><span class='line'>  <span class="kt">char</span>        <span class="o">*</span><span class="n">name</span><span class="p">;</span>             <span class="cm">/* Command Name            */</span>
</span><span class='line'>  <span class="kt">int</span>     <span class="n">maxargs</span><span class="p">;</span>              <span class="cm">/* maximum number of arguments */</span>
</span><span class='line'>  <span class="kt">int</span>     <span class="n">repeatable</span><span class="p">;</span>               <span class="cm">/* autorepeat allowed?     */</span>
</span><span class='line'>                                  <span class="cm">/* Implementation function */</span>
</span><span class='line'>  <span class="kt">int</span>     <span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cmd_tbl_s</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">[]);</span>
</span><span class='line'>  <span class="kt">char</span>        <span class="o">*</span><span class="n">usage</span><span class="p">;</span>                <span class="cm">/* Usage message   (short) */</span>
</span><span class='line'><span class="cp">#ifdef   CFG_LONGHELP</span>
</span><span class='line'>  <span class="kt">char</span>        <span class="o">*</span><span class="n">help</span><span class="p">;</span>             <span class="cm">/* Help  message   (long)  */</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_AUTO_COMPLETE</span>
</span><span class='line'>  <span class="cm">/* do auto completion on the arguments */</span>
</span><span class='line'>  <span class="kt">int</span>     <span class="p">(</span><span class="o">*</span><span class="n">complete</span><span class="p">)(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[],</span> <span class="kt">char</span> <span class="n">last_char</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmdv</span><span class="p">[]);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>可用于U-Boot的kernel是在常规内核zImage前加了个64byte头的uImage，这个头包含了：
1. kernel的加载和运行地址
2. zImage的CRC校验码等信息</p></blockquote>

<figure class='code'><figcaption><span>include/image.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">image_header</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">uint32_t</span>    <span class="n">ih_magic</span><span class="p">;</span>         <span class="cm">/* Image Header Magic Number   */</span>
</span><span class='line'>  <span class="kt">uint32_t</span>    <span class="n">ih_hcrc</span><span class="p">;</span>          <span class="cm">/* Image Header CRC Checksum   */</span>
</span><span class='line'>  <span class="kt">uint32_t</span>    <span class="n">ih_time</span><span class="p">;</span>          <span class="cm">/* Image Creation Timestamp    */</span>
</span><span class='line'>  <span class="kt">uint32_t</span>    <span class="n">ih_size</span><span class="p">;</span>          <span class="cm">/* Image Data Size     */</span>
</span><span class='line'>  <span class="kt">uint32_t</span>    <span class="n">ih_load</span><span class="p">;</span>          <span class="cm">/* Data     Load  Address      */</span>
</span><span class='line'>  <span class="kt">uint32_t</span>    <span class="n">ih_ep</span><span class="p">;</span>                <span class="cm">/* Entry Point Address     */</span>
</span><span class='line'>  <span class="kt">uint32_t</span>    <span class="n">ih_dcrc</span><span class="p">;</span>          <span class="cm">/* Image Data CRC Checksum */</span>
</span><span class='line'>  <span class="kt">uint8_t</span>     <span class="n">ih_os</span><span class="p">;</span>                <span class="cm">/* Operating System        */</span>
</span><span class='line'>  <span class="kt">uint8_t</span>     <span class="n">ih_arch</span><span class="p">;</span>          <span class="cm">/* CPU architecture        */</span>
</span><span class='line'>  <span class="kt">uint8_t</span>     <span class="n">ih_type</span><span class="p">;</span>          <span class="cm">/* Image Type          */</span>
</span><span class='line'>  <span class="kt">uint8_t</span>     <span class="n">ih_comp</span><span class="p">;</span>          <span class="cm">/* Compression Type        */</span>
</span><span class='line'>  <span class="kt">uint8_t</span>     <span class="n">ih_name</span><span class="p">[</span><span class="n">IH_NMLEN</span><span class="p">];</span>  <span class="cm">/* Image Name      */</span>
</span><span class='line'><span class="p">}</span> <span class="kt">image_header_t</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>board.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
<span class='line-number'>457</span>
<span class='line-number'>458</span>
<span class='line-number'>459</span>
<span class='line-number'>460</span>
<span class='line-number'>461</span>
<span class='line-number'>462</span>
<span class='line-number'>463</span>
<span class='line-number'>464</span>
<span class='line-number'>465</span>
<span class='line-number'>466</span>
<span class='line-number'>467</span>
<span class='line-number'>468</span>
<span class='line-number'>469</span>
<span class='line-number'>470</span>
<span class='line-number'>471</span>
<span class='line-number'>472</span>
<span class='line-number'>473</span>
<span class='line-number'>474</span>
<span class='line-number'>475</span>
<span class='line-number'>476</span>
<span class='line-number'>477</span>
<span class='line-number'>478</span>
<span class='line-number'>479</span>
<span class='line-number'>480</span>
<span class='line-number'>481</span>
<span class='line-number'>482</span>
<span class='line-number'>483</span>
<span class='line-number'>484</span>
<span class='line-number'>485</span>
<span class='line-number'>486</span>
<span class='line-number'>487</span>
<span class='line-number'>488</span>
<span class='line-number'>489</span>
<span class='line-number'>490</span>
<span class='line-number'>491</span>
<span class='line-number'>492</span>
<span class='line-number'>493</span>
<span class='line-number'>494</span>
<span class='line-number'>495</span>
<span class='line-number'>496</span>
<span class='line-number'>497</span>
<span class='line-number'>498</span>
<span class='line-number'>499</span>
<span class='line-number'>500</span>
<span class='line-number'>501</span>
<span class='line-number'>502</span>
<span class='line-number'>503</span>
<span class='line-number'>504</span>
<span class='line-number'>505</span>
<span class='line-number'>506</span>
<span class='line-number'>507</span>
<span class='line-number'>508</span>
<span class='line-number'>509</span>
<span class='line-number'>510</span>
<span class='line-number'>511</span>
<span class='line-number'>512</span>
<span class='line-number'>513</span>
<span class='line-number'>514</span>
<span class='line-number'>515</span>
<span class='line-number'>516</span>
<span class='line-number'>517</span>
<span class='line-number'>518</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;common.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;command.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;malloc.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;devices.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;version.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;net.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;asm/io.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_BOOT_MOVINAND)</span>
</span><span class='line'><span class="cp">#include &lt;movi.h&gt;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_DRIVER_SMC91111</span>
</span><span class='line'><span class="cp">#include &quot;../drivers/smc91111.h&quot;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_DRIVER_LAN91C96</span>
</span><span class='line'><span class="cp">#include &quot;../drivers/lan91c96.h&quot;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Note: volatile register variable is *NOT* volatile in gcc 4.5.1+ */</span>
</span><span class='line'><span class="cp">#if  0</span><span class="c"></span>
</span><span class='line'><span class="c">DECLARE_GLOBAL_DATA_PTR;</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="kt">gd_t</span> <span class="o">*</span><span class="n">gd</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if (CONFIG_COMMANDS &amp; CFG_CMD_NAND)</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">nand_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_ONENAND</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">onenand_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="n">ulong</span> <span class="n">monitor_flash_len</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_HAS_DATAFLASH</span>
</span><span class='line'><span class="k">extern</span> <span class="kt">int</span>  <span class="nf">AT91F_DataflashInit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'><span class="k">extern</span> <span class="kt">void</span> <span class="nf">dataflash_print_info</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifndef CONFIG_IDENT_STRING</span>
</span><span class='line'><span class="cp">#define CONFIG_IDENT_STRING &quot;&quot;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="k">const</span> <span class="kt">char</span> <span class="n">version_string</span><span class="p">[]</span> <span class="o">=</span>
</span><span class='line'>  <span class="s">&quot;   kdm ver1.01&quot;</span> <span class="n">CONFIG_IDENT_STRING</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_DRIVER_CS8900</span>
</span><span class='line'><span class="k">extern</span> <span class="kt">void</span> <span class="nf">cs8900_get_enetaddr</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span> <span class="n">addr</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_DRIVER_RTL8019</span>
</span><span class='line'><span class="k">extern</span> <span class="kt">void</span> <span class="nf">rtl8019_get_enetaddr</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span> <span class="n">addr</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Begin and End of memory area for malloc(), and current &quot;brk&quot;</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="n">ulong</span> <span class="n">mem_malloc_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">ulong</span> <span class="n">mem_malloc_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">ulong</span> <span class="n">mem_malloc_brk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">mem_malloc_init</span> <span class="p">(</span><span class="n">ulong</span> <span class="n">dest_addr</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">mem_malloc_start</span> <span class="o">=</span> <span class="n">dest_addr</span><span class="p">;</span>                   <span class="cm">/*缓冲区起始地址*/</span>
</span><span class='line'>  <span class="n">mem_malloc_end</span> <span class="o">=</span> <span class="n">dest_addr</span> <span class="o">+</span> <span class="n">CFG_MALLOC_LEN</span><span class="p">;</span>  <span class="cm">/*缓冲区结束地址*/</span>
</span><span class='line'>  <span class="n">mem_malloc_brk</span> <span class="o">=</span> <span class="n">mem_malloc_start</span><span class="p">;</span>              <span class="cm">/*已使用块的地址，初始时应指向起始地址*/</span>
</span><span class='line'>  <span class="cm">/* memset ((void *) mem_malloc_start, 0,</span>
</span><span class='line'><span class="cm">         mem_malloc_end - mem_malloc_start); */</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="o">*</span><span class="nf">sbrk</span> <span class="p">(</span><span class="kt">ptrdiff_t</span> <span class="n">increment</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">ulong</span> <span class="n">old</span> <span class="o">=</span> <span class="n">mem_malloc_brk</span><span class="p">;</span>
</span><span class='line'>  <span class="n">ulong</span> <span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">+</span> <span class="n">increment</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">((</span><span class="n">new</span> <span class="o">&lt;</span> <span class="n">mem_malloc_start</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new</span> <span class="o">&gt;</span> <span class="n">mem_malloc_end</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">mem_malloc_brk</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">old</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/************************************************************************</span>
</span><span class='line'><span class="cm"> * Init Utilities                            *</span>
</span><span class='line'><span class="cm"> ************************************************************************</span>
</span><span class='line'><span class="cm"> * Some of this code should be moved into the core functions,</span>
</span><span class='line'><span class="cm"> * or dropped completely,</span>
</span><span class='line'><span class="cm"> * but let&#39;s get it working (again) first...</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">init_baudrate</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>  <span class="cm">/* long enough for environment variables */</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">getenv_r</span> <span class="p">(</span><span class="s">&quot;baudrate&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
</span><span class='line'>  <span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_baudrate</span> <span class="o">=</span> <span class="n">gd</span><span class="o">-&gt;</span><span class="n">baudrate</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>          <span class="o">?</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">simple_strtoul</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span class='line'>          <span class="o">:</span> <span class="n">CONFIG_BAUDRATE</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">display_banner</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">%s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version_string</span><span class="p">);</span>
</span><span class='line'>  <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;U-Boot code: %08lX -&gt; %08lX  BSS: -&gt; %08lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="n">_armboot_start</span><span class="p">,</span> <span class="n">_bss_start</span><span class="p">,</span> <span class="n">_bss_end</span><span class="p">);</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_MEMORY_UPPER_CODE </span><span class="cm">/* by scsuh */</span><span class="cp"></span>
</span><span class='line'>  <span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\b</span><span class="s">Malloc and Stack is above the U-Boot Code.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\b</span><span class="s">Malloc and Stack is below the U-Boot Code.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_MODEM_SUPPORT</span>
</span><span class='line'>  <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;Modem Support enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_USE_IRQ</span>
</span><span class='line'>  <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;IRQ Stack: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IRQ_STACK_START</span><span class="p">);</span>
</span><span class='line'>  <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;FIQ Stack: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FIQ_STACK_START</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * WARNING: this code looks &quot;cleaner&quot; than the PowerPC version, but</span>
</span><span class='line'><span class="cm"> * has the disadvantage that you either get nothing, or everything.</span>
</span><span class='line'><span class="cm"> * On PowerPC, you might see &quot;DRAM: &quot; before the system hangs - which</span>
</span><span class='line'><span class="cm"> * gives a simple yet clear indication which part of the</span>
</span><span class='line'><span class="cm"> * initialization if failing.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">display_dram_config</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef DEBUG</span>
</span><span class='line'>  <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;RAM Configuration:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_NR_DRAM_BANKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Bank #%d: %08lx &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_dram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">);</span>
</span><span class='line'>      <span class="n">print_size</span> <span class="p">(</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_dram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">ulong</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_NR_DRAM_BANKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">size</span> <span class="o">+=</span> <span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_dram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;DRAM:    &quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">print_size</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifndef CFG_NO_FLASH</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">display_flash_config</span> <span class="p">(</span><span class="n">ulong</span> <span class="n">size</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;Flash:  &quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">print_size</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CFG_NO_FLASH */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="nf">int</span> <span class="p">(</span><span class="kt">init_fnc_t</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">print_cpuinfo</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span> <span class="cm">/* test-only */</span>
</span><span class='line'>
</span><span class='line'><span class="kt">init_fnc_t</span> <span class="o">*</span><span class="n">init_sequence</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">cpu_init</span><span class="p">,</span>         <span class="cm">/* cpu的初始化，位于cpu/sec64xx/cpu.c*/</span>
</span><span class='line'>  <span class="n">board_init</span><span class="p">,</span>           <span class="cm">/* 板子初始化，位于board/samsung/mini6410/mini6410.c*/</span>
</span><span class='line'>  <span class="n">interrupt_init</span><span class="p">,</span>       <span class="cm">/* 中断初始化，位于cpu/s3c64xx/interrupts.c*/</span>
</span><span class='line'>  <span class="n">env_init</span><span class="p">,</span>         <span class="cm">/* 初始化环境变量，位于common/env_nand.c*/</span>
</span><span class='line'>  <span class="n">init_baudrate</span><span class="p">,</span>        <span class="cm">/* 初始化波特率设置，位于lib_arm/board.c*/</span>
</span><span class='line'>  <span class="n">serial_init</span><span class="p">,</span>      <span class="cm">/* 串口通讯设置，位于cpu/s3c64xx/serial.c*/</span>
</span><span class='line'>  <span class="n">console_init_f</span><span class="p">,</span>       <span class="cm">/* 第一阶段控制台设置，位于common/console.c*/</span>
</span><span class='line'>  <span class="n">display_banner</span><span class="p">,</span>       <span class="cm">/* 打印banner，位于lib_arm/board.c*/</span>
</span><span class='line'><span class="cp">#if defined(CONFIG_DISPLAY_CPUINFO)</span>
</span><span class='line'>  <span class="n">print_cpuinfo</span><span class="p">,</span>        <span class="cm">/* 打印CPU信息，位于cpu/s3c64xx/s3c6410/speed.c*/</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#if defined(CONFIG_DISPLAY_BOARDINFO)</span>
</span><span class='line'>  <span class="n">checkboard</span><span class="p">,</span>           <span class="cm">/* 打印板子信息，位于board/samsumg/mini6410/mini6410.c*/</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">dram_init</span><span class="p">,</span>            <span class="cm">/* 配置现有的RAM banks,这里只是对gd中的bi_dram结构中的两个成员赋值,也即BANK的起始地址和大小 位于board/samsumg/mini6410/mini6410.c*/</span>
</span><span class='line'>  <span class="n">display_dram_config</span><span class="p">,</span><span class="cm">/*位于lib_arm/board.c*/</span>
</span><span class='line'>  <span class="nb">NULL</span><span class="p">,</span>                <span class="cm">/*用以标识列表数组的结束 */</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">start_armboot</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>               <span class="cm">/*uboot第二阶段入口函数,完成uboot第二阶级的一系列的硬件初始化工作, 然后转入main函数*/</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">init_fnc_t</span> <span class="o">**</span><span class="n">init_fnc_ptr</span><span class="p">;</span>         <span class="cm">/*init_fnc_t 是各初始化函数的数组 */</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
</span><span class='line'><span class="cp">#ifndef CFG_NO_FLASH</span>
</span><span class='line'>  <span class="n">ulong</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_VFD) || defined(CONFIG_LCD)</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_BOOT_MOVINAND)</span>
</span><span class='line'>  <span class="n">uint</span> <span class="o">*</span><span class="n">magic</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">PHYS_SDRAM_1</span><span class="p">);</span> <span class="cm">/*指向0x5000 0000*/</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Pointer is writable since we allocated a register for it */</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_MEMORY_UPPER_CODE </span><span class="cm">/* by scsuh */</span><span class="cp"></span>
</span><span class='line'>  <span class="n">ulong</span> <span class="n">gd_base</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">gd_base</span> <span class="o">=</span> <span class="n">CFG_UBOOT_BASE</span> <span class="o">+</span> <span class="n">CFG_UBOOT_SIZE</span> <span class="o">-</span> <span class="n">CFG_MALLOC_LEN</span> <span class="o">-</span> <span class="n">CFG_STACK_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">gd_t</span><span class="p">);</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_USE_IRQ</span>
</span><span class='line'>  <span class="n">gd_base</span> <span class="o">-=</span> <span class="p">(</span><span class="n">CONFIG_STACKSIZE_IRQ</span><span class="o">+</span><span class="n">CONFIG_STACKSIZE_FIQ</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">gd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">gd_t</span><span class="o">*</span><span class="p">)</span><span class="n">gd_base</span><span class="p">;</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">gd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">gd_t</span><span class="o">*</span><span class="p">)(</span><span class="n">_armboot_start</span> <span class="o">-</span> <span class="n">CFG_MALLOC_LEN</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">gd_t</span><span class="p">));</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* compiler optimization barrier needed for GCC &gt;= 3.4 */</span>
</span><span class='line'>  <span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">:</span> <span class="o">:</span> <span class="o">:</span><span class="s">&quot;memory&quot;</span><span class="p">);</span>                   <span class="cm">/*禁止编译器优化此处代码*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">memset</span> <span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">gd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">gd_t</span><span class="p">));</span>
</span><span class='line'>  <span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">bd_t</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">gd</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">bd_t</span><span class="p">));</span>
</span><span class='line'>  <span class="n">memset</span> <span class="p">(</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">bd_t</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">monitor_flash_len</span> <span class="o">=</span> <span class="n">_bss_start</span> <span class="o">-</span> <span class="n">_armboot_start</span><span class="p">;</span>          <span class="cm">/*monitor_flash_len表示从flash中搬来的代码的长度,包络代码段，数据段*/</span>
</span><span class='line'>                                                          
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">init_fnc_ptr</span> <span class="o">=</span> <span class="n">init_sequence</span><span class="p">;</span> <span class="o">*</span><span class="n">init_fnc_ptr</span><span class="p">;</span> <span class="o">++</span><span class="n">init_fnc_ptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">init_fnc_ptr</span><span class="p">)()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">hang</span> <span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifndef CFG_NO_FLASH</span>
</span><span class='line'>  <span class="cm">/* configure available FLASH banks */</span>
</span><span class='line'>  <span class="n">size</span> <span class="o">=</span> <span class="n">flash_init</span> <span class="p">();</span>
</span><span class='line'>  <span class="n">display_flash_config</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>                            <span class="cm">/*打印flash的信息*/</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CFG_NO_FLASH */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_VFD</span>
</span><span class='line'><span class="cp">#ifndef PAGE_SIZE</span>
</span><span class='line'><span class="cp">#define PAGE_SIZE 4096                                       </span><span class="cm">/*显存大小*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * reserve memory for VFD display (always full pages)</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="cm">/* bss_end is defined in the board-specific linker script */</span>
</span><span class='line'>  <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_bss_end</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="n">size</span> <span class="o">=</span> <span class="n">vfd_setmem</span> <span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span class='line'>  <span class="n">gd</span><span class="o">-&gt;</span><span class="n">fb_base</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>                                        <span class="cm">/*设置显存基地址*/</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_VFD */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_LCD</span>
</span><span class='line'><span class="cp">#ifndef PAGE_SIZE</span>
</span><span class='line'><span class="cp">#define PAGE_SIZE 4096                                       </span><span class="cm">/*显存大小*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * reserve memory for LCD display (always full pages)</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="cm">/* bss_end is defined in the board-specific linker script */</span>
</span><span class='line'>  <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_bss_end</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="n">size</span> <span class="o">=</span> <span class="n">lcd_setmem</span> <span class="p">(</span><span class="n">addr</span><span class="p">);</span>                             <span class="cm">/*该函数位于common/lcd.c*/</span>
</span><span class='line'>  <span class="n">gd</span><span class="o">-&gt;</span><span class="n">fb_base</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>                                        <span class="cm">/*设置显存基地址*/</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_LCD */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_MEMORY_UPPER_CODE </span><span class="cm">/* by scsuh */</span><span class="cp"></span>
</span><span class='line'>  <span class="n">mem_malloc_init</span> <span class="p">(</span><span class="n">CFG_UBOOT_BASE</span> <span class="o">+</span> <span class="n">CFG_UBOOT_SIZE</span> <span class="o">-</span> <span class="n">CFG_MALLOC_LEN</span> <span class="o">-</span> <span class="n">CFG_STACK_SIZE</span><span class="p">);</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">mem_malloc_init</span> <span class="p">(</span><span class="n">_armboot_start</span> <span class="o">-</span> <span class="n">CFG_MALLOC_LEN</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_SMDK6400) || defined(CONFIG_SMDK6410) || defined(CONFIG_SMDK6430) || defined(CONFIG_SMDK2450) || defined(CONFIG_SMDK2416) || \</span>
</span><span class='line'><span class="cp">defined(CONFIG_MINI6410)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_NAND)</span>
</span><span class='line'>  <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;NAND:    &quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">nand_init</span><span class="p">();</span>      <span class="cm">/* go init the NAND */</span>
</span><span class='line'>  <span class="n">NAND_Init</span><span class="p">();</span>      <span class="cm">/*友善提供的闭源代码*/</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_ONENAND)</span>
</span><span class='line'>  <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;OneNAND: &quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">onenand_init</span><span class="p">();</span>       <span class="cm">/* go init the One-NAND */</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_BOOT_MOVINAND)</span>
</span><span class='line'>  <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;MMC:     &quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">((</span><span class="mh">0x24564236</span> <span class="o">==</span> <span class="n">magic</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x20764316</span> <span class="o">==</span> <span class="n">magic</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Boot up for burning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">movi_set_capacity</span><span class="p">();</span>
</span><span class='line'>      <span class="n">movi_set_ofs</span><span class="p">(</span><span class="n">MOVI_TOTAL_BLKCNT</span><span class="p">);</span>
</span><span class='line'>      <span class="n">movi_init</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if (CONFIG_COMMANDS &amp; CFG_CMD_NAND)</span>
</span><span class='line'>  <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;NAND:    &quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">nand_init</span><span class="p">();</span>      <span class="cm">/* go init the NAND */</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_HAS_DATAFLASH</span>
</span><span class='line'>  <span class="n">AT91F_DataflashInit</span><span class="p">();</span>
</span><span class='line'>  <span class="n">dataflash_print_info</span><span class="p">();</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>                              <span class="cm">/* initialize environment */</span>
</span><span class='line'>  <span class="n">env_relocate</span> <span class="p">();</span>          <span class="cm">/*位于common/env_common.c*/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_VFD</span>
</span><span class='line'>                              <span class="cm">/* must do this after the framebuffer is allocated */</span>
</span><span class='line'>  <span class="n">drv_vfd_init</span><span class="p">();</span>               <span class="cm">/*必须在前村初始化完成以后才能调用该初始化函数*/</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_VFD */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>                                                      <span class="cm">/* IP Address */</span>
</span><span class='line'>  <span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_ip_addr</span> <span class="o">=</span> <span class="n">getenv_IPaddr</span> <span class="p">(</span><span class="s">&quot;ipaddr&quot;</span><span class="p">);</span>        <span class="cm">/*位于net/net.c*/</span>
</span><span class='line'>
</span><span class='line'>                                                      <span class="cm">/* MAC Address */</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>      <span class="n">ulong</span> <span class="n">reg</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">i</span> <span class="o">=</span> <span class="n">getenv_r</span> <span class="p">(</span><span class="s">&quot;ethaddr&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
</span><span class='line'>      <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nl">tmp</span> <span class="p">:</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_enetaddr</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">?</span> <span class="n">simple_strtoul</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>              <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="o">?</span> <span class="n">e</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">e</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_HAS_ETH1</span>
</span><span class='line'>      <span class="n">i</span> <span class="o">=</span> <span class="n">getenv_r</span> <span class="p">(</span><span class="s">&quot;eth1addr&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
</span><span class='line'>      <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nl">tmp</span> <span class="p">:</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_enet1addr</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">?</span> <span class="n">simple_strtoul</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>              <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="o">?</span> <span class="n">e</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">e</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">devices_init</span> <span class="p">();</span>                              <span class="cm">/* get the devices list going. */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_CMC_PU2</span>
</span><span class='line'>  <span class="n">load_sernum_ethaddr</span> <span class="p">();</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_CMC_PU2 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>  <span class="n">jumptable_init</span> <span class="p">();</span>                                <span class="cm">/*初始化跳转表,对gd中的jt(函数跳转表)数组进行初始化,其中保存着一些函数的入口地址*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">console_init_r</span> <span class="p">();</span>                                <span class="cm">/* fully init console as a device */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_MISC_INIT_R)</span>
</span><span class='line'>                                                  <span class="cm">/* miscellaneous platform dependent initialisations */</span>
</span><span class='line'>  <span class="n">misc_init_r</span> <span class="p">();</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>                                                  <span class="cm">/* enable exceptions */</span>
</span><span class='line'>  <span class="n">enable_interrupts</span> <span class="p">();</span>                         <span class="cm">/*设置cpsr的I和F位以充许中断*/</span>
</span><span class='line'>
</span><span class='line'>                                                  <span class="cm">/*网卡初始化*/</span>
</span><span class='line'><span class="cp">#if defined(CONFIG_DRIVER_DM9000) &amp;&amp; defined(CONFIG_DRIVER_DM9000_NO_EEPROM)</span>
</span><span class='line'><span class="k">extern</span> <span class="kt">int</span> <span class="n">eth_set_mac</span><span class="p">(</span><span class="kt">bd_t</span> <span class="o">*</span> <span class="n">bd</span><span class="p">);</span>                  <span class="cm">/*位于drivers/dm9000x.c*/</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;ethaddr&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">eth_set_mac</span><span class="p">(</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">);</span>                           <span class="cm">/*设置DM9000的网卡地址*/</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_DRIVER_CS8900</span>
</span><span class='line'>  <span class="n">cs8900_get_enetaddr</span> <span class="p">(</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_enetaddr</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_DRIVER_SMC91111) || defined (CONFIG_DRIVER_LAN91C96)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;ethaddr&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">smc_set_mac_addr</span><span class="p">(</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_enetaddr</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_DRIVER_SMC91111 || CONFIG_DRIVER_LAN91C96 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>                                                  <span class="cm">/* Initialize from environment */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;loadaddr&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">load_addr</span> <span class="o">=</span> <span class="n">simple_strtoul</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#if (CONFIG_COMMANDS &amp; CFG_CMD_NET)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;bootfile&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">copy_filename</span> <span class="p">(</span><span class="n">BootFile</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">BootFile</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif   </span><span class="cm">/* CFG_CMD_NET */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef BOARD_LATE_INIT</span>
</span><span class='line'>  <span class="n">board_late_init</span> <span class="p">();</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#if (CONFIG_COMMANDS &amp; CFG_CMD_NET)</span>
</span><span class='line'><span class="cp">#if defined(CONFIG_NET_MULTI)</span>
</span><span class='line'>  <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;Net:     &quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">eth_initialize</span><span class="p">(</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="cm">/* main_loop() can return to retry autoboot, if so just run it again. */</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">main_loop</span> <span class="p">();</span>                             <span class="cm">/*硬件初始化完成，进入main_loop函数，该函数在common/main.c中*/</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* NOTREACHED - no way out of command loop except booting */</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">hang</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;### ERROR ### Please RESET the board ###</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(;;);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_MODEM_SUPPORT</span>
</span><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mdm_readline</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufsiz</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* called from main loop (common/main.c) */</span>
</span><span class='line'><span class="k">extern</span> <span class="kt">void</span>  <span class="nf">dbg</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">mdm_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">env_str</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">init_str</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>  <span class="k">extern</span> <span class="kt">char</span> <span class="n">console_buffer</span><span class="p">[];</span>
</span><span class='line'>  <span class="k">extern</span> <span class="kt">void</span> <span class="n">enable_putc</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>  <span class="k">extern</span> <span class="kt">int</span> <span class="n">hwflow_onoff</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">enable_putc</span><span class="p">();</span> <span class="cm">/* enable serial_putc() */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_HWFLOW</span>
</span><span class='line'>  <span class="n">init_str</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;mdm_flow_control&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">init_str</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">init_str</span><span class="p">,</span> <span class="s">&quot;rts/cts&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>      <span class="n">hwflow_onoff</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">hwflow_onoff</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">sprintf</span><span class="p">(</span><span class="n">env_str</span><span class="p">,</span> <span class="s">&quot;mdm_init%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">((</span><span class="n">init_str</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="n">env_str</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">serial_puts</span><span class="p">(</span><span class="n">init_str</span><span class="p">);</span>
</span><span class='line'>          <span class="n">serial_puts</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">mdm_readline</span><span class="p">(</span><span class="n">console_buffer</span><span class="p">,</span> <span class="n">CFG_CBSIZE</span><span class="p">);</span>
</span><span class='line'>              <span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ini%d: [%s]&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">console_buffer</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">if</span> <span class="p">((</span><span class="n">strcmp</span><span class="p">(</span><span class="n">console_buffer</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>                  <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">console_buffer</span><span class="p">,</span> <span class="s">&quot;ERROR&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                  <span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ini%d: cmd done&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>                  <span class="k">break</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span> <span class="k">else</span> <span class="cm">/* in case we are originating call ... */</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">console_buffer</span><span class="p">,</span> <span class="s">&quot;CONNECT&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                      <span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ini%d: connect&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>                      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span> <span class="cm">/* no init string - stop modem init */</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">udelay</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">udelay</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* final stage - wait for connect */</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(;</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;)</span> <span class="p">{</span> <span class="cm">/* if &#39;i&#39; &gt; 1 - wait for connection</span>
</span><span class='line'><span class="cm">               message from modem */</span>
</span><span class='line'>      <span class="n">mdm_readline</span><span class="p">(</span><span class="n">console_buffer</span><span class="p">,</span> <span class="n">CFG_CBSIZE</span><span class="p">);</span>
</span><span class='line'>      <span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ini_f: [%s]&quot;</span><span class="p">,</span> <span class="n">console_buffer</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">console_buffer</span><span class="p">,</span> <span class="s">&quot;CONNECT&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ini_f: connected&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* &#39;inline&#39; - We have to do it fast */</span>
</span><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mdm_readline</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufsiz</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">c</span> <span class="o">=</span> <span class="n">serial_getc</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/*     dbg(&quot;(%c)&quot;, c); */</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">switch</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="sc">&#39;\r&#39;</span><span class="o">:</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="sc">&#39;\n&#39;</span><span class="o">:</span>
</span><span class='line'>          <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>          <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">default</span><span class="o">:</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">n</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">bufsiz</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>              <span class="k">return</span><span class="p">;</span> <span class="cm">/* sanity check */</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'>          <span class="n">p</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">#endif   </span><span class="cm">/* CONFIG_MODEM_SUPPORT */</span><span class="cp"></span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>common/main.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="kt">void</span> <span class="nf">main_loop</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="cp">#ifndef CFG_HUSH_PARSER</span>
</span><span class='line'>  <span class="k">static</span> <span class="kt">char</span> <span class="n">lastcommand</span><span class="p">[</span><span class="n">CFG_CBSIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_BOOTDELAY) &amp;&amp; (CONFIG_BOOTDELAY &gt;= 0)</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>                                       <span class="cm">/*保存环境变量字符串*/</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">bootdelay</span><span class="p">;</span>                                    <span class="cm">/*保存uboot启动延时时间*/</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_PREBOOT</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_BOOTCOUNT_LIMIT</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bootcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bootlimit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">bcs_set</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_BOOTCOUNT_LIMIT */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_VFD) &amp;&amp; defined(VFD_TEST_LOGO)</span>
</span><span class='line'>  <span class="n">ulong</span> <span class="n">bmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="cm">/* default bitmap */</span>
</span><span class='line'>  <span class="k">extern</span> <span class="kt">int</span> <span class="n">trab_vfd</span> <span class="p">(</span><span class="n">ulong</span> <span class="n">bitmap</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_MODEM_SUPPORT</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">do_mdm_init</span><span class="p">)</span>
</span><span class='line'>      <span class="n">bmp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* alternate bitmap */</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">trab_vfd</span> <span class="p">(</span><span class="n">bmp</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif   </span><span class="cm">/* CONFIG_VFD &amp;&amp; VFD_TEST_LOGO */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>                                                  <span class="cm">/*友善之臂1wire触摸驱动*/</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="kt">void</span> <span class="n">FriendlyARM1Wire</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>      <span class="n">FriendlyARM1Wire</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_BOOTCOUNT_LIMIT</span>
</span><span class='line'>  <span class="n">bootcount</span> <span class="o">=</span> <span class="n">bootcount_load</span><span class="p">();</span>
</span><span class='line'>  <span class="n">bootcount</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>  <span class="n">bootcount_store</span> <span class="p">(</span><span class="n">bootcount</span><span class="p">);</span>
</span><span class='line'>  <span class="n">sprintf</span> <span class="p">(</span><span class="n">bcs_set</span><span class="p">,</span> <span class="s">&quot;%lu&quot;</span><span class="p">,</span> <span class="n">bootcount</span><span class="p">);</span>
</span><span class='line'>  <span class="n">setenv</span> <span class="p">(</span><span class="s">&quot;bootcount&quot;</span><span class="p">,</span> <span class="n">bcs_set</span><span class="p">);</span>
</span><span class='line'>  <span class="n">bcs</span> <span class="o">=</span> <span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;bootlimit&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">bootlimit</span> <span class="o">=</span> <span class="n">bcs</span> <span class="o">?</span> <span class="n">simple_strtoul</span> <span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_BOOTCOUNT_LIMIT */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_MODEM_SUPPORT</span>
</span><span class='line'>  <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;DEBUG: main_loop:   do_mdm_init=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">do_mdm_init</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">do_mdm_init</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;mdm_cmd&quot;</span><span class="p">));</span>
</span><span class='line'>      <span class="n">setenv</span> <span class="p">(</span><span class="s">&quot;preboot&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>  <span class="cm">/* set or delete definition */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>          <span class="n">free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>
</span><span class='line'>      <span class="n">mdm_init</span><span class="p">();</span> <span class="cm">/* wait for modem connection */</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif  </span><span class="cm">/* CONFIG_MODEM_SUPPORT */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_VERSION_VARIABLE</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">extern</span> <span class="kt">char</span> <span class="n">version_string</span><span class="p">[];</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">setenv</span> <span class="p">(</span><span class="s">&quot;ver&quot;</span><span class="p">,</span> <span class="n">version_string</span><span class="p">);</span>  <span class="cm">/* set version variable */</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_VERSION_VARIABLE */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CFG_HUSH_PARSER</span>
</span><span class='line'>  <span class="n">u_boot_hush_start</span> <span class="p">();</span>                     <span class="cm">/*定义在common/hush.c中*/</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_AUTO_COMPLETE</span>
</span><span class='line'>  <span class="n">install_auto_complete</span><span class="p">();</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_PREBOOT</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;preboot&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="cp"># ifdef CONFIG_AUTOBOOT_KEYED</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">disable_ctrlc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* disable Control C checking */</span>
</span><span class='line'><span class="cp"># endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp"># ifndef CFG_HUSH_PARSER</span>
</span><span class='line'>      <span class="n">run_command</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="cp"># else</span>
</span><span class='line'>      <span class="n">parse_string_outer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FLAG_PARSE_SEMICOLON</span> <span class="o">|</span>
</span><span class='line'>                  <span class="n">FLAG_EXIT_FROM_LOOP</span><span class="p">);</span>
</span><span class='line'><span class="cp"># endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp"># ifdef CONFIG_AUTOBOOT_KEYED</span>
</span><span class='line'>      <span class="n">disable_ctrlc</span><span class="p">(</span><span class="n">prev</span><span class="p">);</span>    <span class="cm">/* restore Control C checking */</span>
</span><span class='line'><span class="cp"># endif</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_PREBOOT */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_BOOTDELAY) &amp;&amp; (CONFIG_BOOTDELAY &gt;= 0)</span>
</span><span class='line'>  <span class="n">s</span> <span class="o">=</span> <span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;bootdelay&quot;</span><span class="p">);</span>               <span class="cm">/*获得环境变量bootdelay*/</span>
</span><span class='line'>  <span class="n">bootdelay</span> <span class="o">=</span> <span class="n">s</span> <span class="o">?</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">simple_strtol</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">:</span> <span class="n">CONFIG_BOOTDELAY</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;### main_loop entered: bootdelay=%d</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bootdelay</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">//printf(&quot;main_loop enter: the bootdelay =%d\n\n&quot;,bootdelay);</span>
</span><span class='line'><span class="cp"># ifdef CONFIG_BOOT_RETRY_TIME</span>
</span><span class='line'>  <span class="n">init_cmd_timeout</span> <span class="p">();</span>
</span><span class='line'><span class="cp"># endif  </span><span class="cm">/* CONFIG_BOOT_RETRY_TIME */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_BOOTCOUNT_LIMIT</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">bootlimit</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bootcount</span> <span class="o">&gt;</span> <span class="n">bootlimit</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Warning: Bootlimit (%u) exceeded. Using altbootcmd.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">bootlimit</span><span class="p">);</span>
</span><span class='line'>      <span class="n">s</span> <span class="o">=</span> <span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;altbootcmd&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_BOOTCOUNT_LIMIT */</span><span class="cp"></span>
</span><span class='line'>  <span class="n">s</span> <span class="o">=</span> <span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;bootcmd&quot;</span><span class="p">);</span>                         <span class="cm">/*字符串s保存bootcmd的命令*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;### main_loop: bootcmd=</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">?</span> <span class="nl">s</span> <span class="p">:</span> <span class="s">&quot;&lt;UNDEFINED&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">bootdelay</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">abortboot</span> <span class="p">(</span><span class="n">bootdelay</span><span class="p">))</span> <span class="p">{</span>  <span class="cm">/*uboot延时期间没有被打断则进入if判断*/</span>
</span><span class='line'><span class="cp"># ifdef CONFIG_AUTOBOOT_KEYED</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">disable_ctrlc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>             <span class="cm">/* disable Control C checking */</span>
</span><span class='line'><span class="cp"># endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp"># ifndef CFG_HUSH_PARSER</span>
</span><span class='line'>      <span class="n">run_command</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="cp"># else</span>
</span><span class='line'>      <span class="n">parse_string_outer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">FLAG_PARSE_SEMICOLON</span> <span class="o">|</span>
</span><span class='line'>                  <span class="n">FLAG_EXIT_FROM_LOOP</span><span class="p">);</span>
</span><span class='line'><span class="cp"># endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp"># ifdef CONFIG_AUTOBOOT_KEYED</span>
</span><span class='line'>      <span class="n">disable_ctrlc</span><span class="p">(</span><span class="n">prev</span><span class="p">);</span>                        <span class="cm">/* restore Control C checking */</span>
</span><span class='line'><span class="cp"># endif</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp"># ifdef CONFIG_MENUKEY</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">menukey</span> <span class="o">==</span> <span class="n">CONFIG_MENUKEY</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">s</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;menucmd&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="cp"># ifndef CFG_HUSH_PARSER</span>
</span><span class='line'>      <span class="n">run_command</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="cp"># else</span>
</span><span class='line'>      <span class="n">parse_string_outer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">FLAG_PARSE_SEMICOLON</span> <span class="o">|</span>
</span><span class='line'>                  <span class="n">FLAG_EXIT_FROM_LOOP</span><span class="p">);</span>
</span><span class='line'><span class="cp"># endif</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_MENUKEY */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#endif   </span><span class="cm">/* CONFIG_BOOTDELAY */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_AMIGAONEG3SE</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">extern</span> <span class="kt">void</span> <span class="n">video_banner</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>      <span class="n">video_banner</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//FriendlyARMMenu();                       /*友善之臂uboot界面*/</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * Main Loop for Monitor Command Processing</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="cp">#ifdef CFG_HUSH_PARSER</span>
</span><span class='line'>  <span class="n">parse_file_outer</span><span class="p">();</span>                           <span class="cm">/*读取用户命令并执行*/</span>
</span><span class='line'>  <span class="cm">/* This point is never reached */</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(;;);</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>                                 
</span><span class='line'><span class="cp">#ifdef CONFIG_BOOT_RETRY_TIME</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="cm">/* Saw enough of a valid command to</span>
</span><span class='line'><span class="cm">          * restart the timeout.</span>
</span><span class='line'><span class="cm">          */</span>
</span><span class='line'>          <span class="n">reset_cmd_timeout</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>      <span class="n">len</span> <span class="o">=</span> <span class="n">readline</span> <span class="p">(</span><span class="n">CFG_PROMPT</span><span class="p">);</span>          <span class="cm">/*循环读取命令的一般实现方法:从终端读入用户输入的命令字符串，然后将该字符串作为参数调用run_command函数执行该命令*/</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* assume no special flags for now */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>          <span class="n">strcpy</span> <span class="p">(</span><span class="n">lastcommand</span><span class="p">,</span> <span class="n">console_buffer</span><span class="p">);</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>          <span class="n">flag</span> <span class="o">|=</span> <span class="n">CMD_FLAG_REPEAT</span><span class="p">;</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_BOOT_RETRY_TIME</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="cm">/* -2 means timed out, retry autoboot</span>
</span><span class='line'><span class="cm">          */</span>
</span><span class='line'>          <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Timed out waiting for command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp"># ifdef CONFIG_RESET_TO_RETRY</span>
</span><span class='line'>          <span class="cm">/* Reinit board to run initialization code again */</span>
</span><span class='line'>          <span class="n">do_reset</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'><span class="cp"># else</span>
</span><span class='line'>          <span class="k">return</span><span class="p">;</span>       <span class="cm">/* retry autoboot */</span>
</span><span class='line'><span class="cp"># endif</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>          <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;&lt;INTERRUPT&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">rc</span> <span class="o">=</span> <span class="n">run_command</span> <span class="p">(</span><span class="n">lastcommand</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="cm">/* invalid command or not repeatable, forget it */</span>
</span><span class='line'>          <span class="n">lastcommand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/*CFG_HUSH_PARSER*/</span><span class="cp"></span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*解析执行用户命令*/</span>
</span><span class='line'><span class="cm">/****************************************************************************</span>
</span><span class='line'><span class="cm"> * returns:</span>
</span><span class='line'><span class="cm"> *   1  - command executed, repeatable</span>
</span><span class='line'><span class="cm"> *   0  - command executed but not repeatable, interrupted commands are</span>
</span><span class='line'><span class="cm"> *        always considered not repeatable</span>
</span><span class='line'><span class="cm"> *   -1 - not executed (unrecognized, bootd recursion or too many args)</span>
</span><span class='line'><span class="cm"> *           (If cmd is NULL or &quot;&quot; or longer than CFG_CBSIZE-1 it is</span>
</span><span class='line'><span class="cm"> *           considered unrecognized)</span>
</span><span class='line'><span class="cm"> * **************************************************************************/</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">run_command</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">cmd_tbl_t</span> <span class="o">*</span><span class="n">cmdtp</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">cmdbuf</span><span class="p">[</span><span class="n">CFG_CBSIZE</span><span class="p">];</span>            <span class="cm">/* working copy of cmd     */</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>                       <span class="cm">/* start of token in cmdbuf    */</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">sep</span><span class="p">;</span>                         <span class="cm">/* end of token (separator) in cmdbuf */</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">finaltoken</span><span class="p">[</span><span class="n">CFG_CBSIZE</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">cmdbuf</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="n">CFG_MAXARGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>      <span class="cm">/* NULL terminated */</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">inquotes</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">repeatable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>                                      <span class="cm">/*解析用户命令字符串*/</span>                 
</span><span class='line'><span class="cp">#ifdef DEBUG_PARSER</span>
</span><span class='line'>  <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;[RUN_COMMAND] cmd[%p]=</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
</span><span class='line'>  <span class="n">puts</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">?</span> <span class="nl">cmd</span> <span class="p">:</span> <span class="s">&quot;NULL&quot;</span><span class="p">);</span>           <span class="cm">/* use puts - string may be loooong */</span>
</span><span class='line'>  <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">clear_ctrlc</span><span class="p">();</span>                        <span class="cm">/* forget any previous Control C */</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span> <span class="o">||</span> <span class="o">!*</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* empty command */</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CFG_CBSIZE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;## Command too long!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">strcpy</span> <span class="p">(</span><span class="n">cmdbuf</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Process separators and check for invalid</span>
</span><span class='line'><span class="cm">  * repeatable commands</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef DEBUG_PARSER</span>
</span><span class='line'>  <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;[PROCESS_SEPARATORS] %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">      * Find separator, or string end</span>
</span><span class='line'><span class="cm">      * Allow simple escape of &#39;;&#39; by writing &quot;\;&quot;</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">inquotes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span> <span class="o">*</span><span class="n">sep</span><span class="p">;</span> <span class="n">sep</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">sep</span><span class="o">==</span><span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>              <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">sep</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;\\&#39;</span><span class="p">))</span>
</span><span class='line'>              <span class="n">inquotes</span><span class="o">=!</span><span class="n">inquotes</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inquotes</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>              <span class="p">(</span><span class="o">*</span><span class="n">sep</span> <span class="o">==</span> <span class="sc">&#39;;&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>  <span class="cm">/* separator       */</span>
</span><span class='line'>              <span class="p">(</span> <span class="n">sep</span> <span class="o">!=</span> <span class="n">str</span><span class="p">)</span> <span class="o">&amp;&amp;</span>  <span class="cm">/* past string start   */</span>
</span><span class='line'>              <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">sep</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;\\&#39;</span><span class="p">))</span> <span class="cm">/* and NOT escaped */</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">      * Limit the token to data between separators</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="n">token</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">sep</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">str</span> <span class="o">=</span> <span class="n">sep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* start of command for next pass */</span>
</span><span class='line'>          <span class="o">*</span><span class="n">sep</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">str</span> <span class="o">=</span> <span class="n">sep</span><span class="p">;</span>  <span class="cm">/* no more commands for next pass */</span>
</span><span class='line'><span class="cp">#ifdef DEBUG_PARSER</span>
</span><span class='line'>      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;token: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* find macros in this token and replace them */</span>
</span><span class='line'>      <span class="n">process_macros</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">finaltoken</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* Extract arguments */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">((</span><span class="n">argc</span> <span class="o">=</span> <span class="n">parse_line</span> <span class="p">(</span><span class="n">finaltoken</span><span class="p">,</span> <span class="n">argv</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>    <span class="cm">/* no command at all */</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>                                                      <span class="cm">/*用户命令解析完毕，解析结果尊放在argv中*/</span>                                                         
</span><span class='line'>      <span class="cm">/* Look up command in command table */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">((</span><span class="n">cmdtp</span> <span class="o">=</span> <span class="n">find_cmd</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>      <span class="cm">/*根据argv[0]去查询具体命令，返回cmdtp结构体指针*/</span>
</span><span class='line'>          <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Unknown command &#39;%s&#39; - try &#39;help&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>          <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>    <span class="cm">/* give up after bad command */</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* found - check max args */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="n">cmdtp</span><span class="o">-&gt;</span><span class="n">maxargs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Usage:</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmdtp</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">);</span>
</span><span class='line'>          <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if (CONFIG_COMMANDS &amp; CFG_CMD_BOOTD)</span>
</span><span class='line'>      <span class="cm">/* avoid &quot;bootd&quot; recursion */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">cmdtp</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">do_bootd</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="cp">#ifdef DEBUG_PARSER</span>
</span><span class='line'>          <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">finaltoken</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">CMD_FLAG_BOOTD</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;&#39;bootd&#39; recursion detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>              <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>              <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">flag</span> <span class="o">|=</span> <span class="n">CMD_FLAG_BOOTD</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="cp">#endif   </span><span class="cm">/* CFG_CMD_BOOTD */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* OK - call function to do the command */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">((</span><span class="n">cmdtp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">repeatable</span> <span class="o">&amp;=</span> <span class="n">cmdtp</span><span class="o">-&gt;</span><span class="n">repeatable</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* Did the user stop this? */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">had_ctrlc</span> <span class="p">())</span>
</span><span class='line'>          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* if stopped then not repeatable */</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="nl">rc</span> <span class="p">:</span> <span class="n">repeatable</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>在uboot中添加自定义命令，以led为例</h2>

<ol>
<li>实现自定义函数do_leds，添加U_BOOT_CMD宏定义，形成源代码文件cmd_leds.c</li>
<li>将该文件放到common目录下，并修改common/Makefile以使该c文件被编译</li>
<li>在include/cmd_confdefs.h中增加宏定义CFG_CMD_LEDS，以便使得leds命令能被用户通过include/configs/xxxx.h进行裁剪</li>
<li>修改include/configs/xxxx.h中对CONFIG_COMMANDS宏的定义，使其包含CFG_CMD_LEDS宏</li>
</ol>


<figure class='code'><figcaption><span>include/command.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#define Struct_Section  __attribute__ ((unused,section (&quot;.u_boot_cmd&quot;)))</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define U_BOOT_CMD(name,maxargs,rep,cmd,usage,help) \</span>
</span><span class='line'><span class="cp">cmd_tbl_t __u_boot_cmd_##name Struct_Section = {#name, maxargs, rep, cmd, usage}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>common/cmd_net.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">U_BOOT_CMD</span><span class="p">(</span>
</span><span class='line'>  <span class="n">ping</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="n">do_ping</span><span class="p">,</span>
</span><span class='line'>  <span class="s">&quot;ping</span><span class="se">\t</span><span class="s">- send ICMP ECHO_REQUEST to network host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s">&quot;pingAddress</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>上面代码定义了一个全局已初始化变量__u_boot_cmd_ping,类型是结构体类型cmd_tbl_t,该结构体变量的第一个字段存放的是用户将来会在uboot命令行中输入的命令名称字符串&ndash;“ping”，该结构变量第4个字段存放的是实现该命令的函数的函数名称，该变量存放在uboot.bin的二进制代码的.u_boot_cmd段</strong></p>

<figure class='code'><figcaption><span>common/cmd_bootm.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#ifndef CFG_BOOTM_LEN</span>
</span><span class='line'><span class="cp">#define CFG_BOOTM_LEN    0x800000        </span><span class="cm">/* use 8MByte as default max gunzip size */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="kt">image_header_t</span> <span class="n">header</span><span class="p">;</span>                  <span class="cm">/*这是很重要的全局变量， 会被armlinux.c 里面的do_bootm_linux()使用*/</span>
</span><span class='line'><span class="n">ulong</span> <span class="n">load_addr</span> <span class="o">=</span> <span class="n">CFG_LOAD_ADDR</span><span class="p">;</span>       <span class="cm">/* Default Load Address=0x5000_0000 */</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">do_bootm</span> <span class="p">(</span><span class="kt">cmd_tbl_t</span> <span class="o">*</span><span class="n">cmdtp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">ulong</span>    <span class="n">iflag</span><span class="p">;</span>
</span><span class='line'>  <span class="n">ulong</span>    <span class="n">addr</span><span class="p">;</span>
</span><span class='line'>  <span class="n">ulong</span>    <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">checksum</span><span class="p">;</span>
</span><span class='line'>  <span class="n">ulong</span>  <span class="o">*</span><span class="n">len_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>          <span class="cm">/* not to make warning. by scsuh */</span>
</span><span class='line'>  <span class="n">uint</span> <span class="n">unc_len</span> <span class="o">=</span> <span class="n">CFG_BOOTM_LEN</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">verify</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span>    <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">appl</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">[]);</span>
</span><span class='line'>  <span class="kt">image_header_t</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">s</span> <span class="o">=</span> <span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;verify&quot;</span><span class="p">);</span>              <span class="cm">/*读取环境变量“verify”*/</span>
</span><span class='line'>  <span class="n">verify</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">addr</span> <span class="o">=</span> <span class="n">load_addr</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">addr</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>    <span class="cm">/*addr=kernel在内存中的地址*/</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_ZIMAGE_BOOT</span>
</span><span class='line'><span class="cp">#define LINUX_ZIMAGE_MAGIC   0x016f2818</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">9</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="n">LINUX_ZIMAGE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Boot with zImage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">addr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span class='line'>      <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_os</span> <span class="o">=</span> <span class="n">IH_OS_LINUX</span><span class="p">;</span>
</span><span class='line'>      <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_ep</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span class='line'>      <span class="k">goto</span> <span class="n">after_header_check</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">//printf (&quot;## Booting image at %08lx ...\n&quot;, addr);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Copy header so we can blank CRC field for re-calculation */</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_HAS_DATAFLASH</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">addr_dataflash</span><span class="p">(</span><span class="n">addr</span><span class="p">)){</span>
</span><span class='line'>      <span class="n">read_dataflash</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">image_header_t</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">memmove</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">image_header_t</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_magic</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IH_MAGIC</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="cp">#ifdef __I386__  </span><span class="cm">/* correct image format not implemented yet - fake it */</span><span class="cp"></span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">fake_header</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="cm">/* to compensate for the addition below */</span>
</span><span class='line'>          <span class="n">addr</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">image_header_t</span><span class="p">);</span>
</span><span class='line'>          <span class="cm">/* turnof verify,</span>
</span><span class='line'><span class="cm">          * fake_header() does not fake the data crc</span>
</span><span class='line'><span class="cm">          */</span>
</span><span class='line'>          <span class="n">verify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span>
</span><span class='line'><span class="cp">#endif   </span><span class="cm">/* __I386__ */</span><span class="cp"></span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_IMAGE_BOOT</span>
</span><span class='line'>      <span class="c1">//printf(&quot;Boot with Image\n&quot;);</span>
</span><span class='line'>      <span class="n">addr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span class='line'>      <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_os</span> <span class="o">=</span> <span class="n">IH_OS_LINUX</span><span class="p">;</span>
</span><span class='line'>      <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_ep</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span class='line'>      <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_comp</span> <span class="o">=</span> <span class="n">IH_COMP_NONE</span><span class="p">;</span>
</span><span class='line'>      <span class="k">goto</span> <span class="n">after_header_check</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>      <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;Bad Magic Number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="p">;</span>
</span><span class='line'>  <span class="n">len</span>  <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">image_header_t</span><span class="p">);</span>       <span class="cm">/*header的长度0x40*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">checksum</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_hcrc</span><span class="p">);</span>
</span><span class='line'>  <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_hcrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">crc32</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">checksum</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/*crc头校验*/</span>
</span><span class='line'>      <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;Bad Header Checksum</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_HAS_DATAFLASH</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">addr_dataflash</span><span class="p">(</span><span class="n">addr</span><span class="p">)){</span>
</span><span class='line'>      <span class="n">len</span>  <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_size</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">image_header_t</span><span class="p">);</span>
</span><span class='line'>      <span class="n">read_dataflash</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">CFG_LOAD_ADDR</span><span class="p">);</span>
</span><span class='line'>      <span class="n">addr</span> <span class="o">=</span> <span class="n">CFG_LOAD_ADDR</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* for multi-file images we need the data part, too */</span>
</span><span class='line'>  <span class="n">print_image_hdr</span> <span class="p">((</span><span class="kt">image_header_t</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">image_header_t</span><span class="p">);</span>          <span class="cm">/*指向了后面的kernel部分*/</span>
</span><span class='line'>  <span class="n">len</span>  <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_size</span><span class="p">);</span>                      <span class="cm">/*kernel的实际大小就是编译后的大小*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">verify</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;   Verifying Checksum ... &quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">crc32</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_dcrc</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Bad Data CRC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">len_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(__PPC__)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_arch</span> <span class="o">!=</span> <span class="n">IH_CPU_PPC</span><span class="p">)</span>
</span><span class='line'><span class="cp">#elif defined(__ARM__)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_arch</span> <span class="o">!=</span> <span class="n">IH_CPU_ARM</span><span class="p">)</span>
</span><span class='line'><span class="cp">#elif defined(__I386__)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_arch</span> <span class="o">!=</span> <span class="n">IH_CPU_I386</span><span class="p">)</span>
</span><span class='line'><span class="cp">#elif defined(__mips__)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_arch</span> <span class="o">!=</span> <span class="n">IH_CPU_MIPS</span><span class="p">)</span>
</span><span class='line'><span class="cp">#elif defined(__nios__)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_arch</span> <span class="o">!=</span> <span class="n">IH_CPU_NIOS</span><span class="p">)</span>
</span><span class='line'><span class="cp">#elif defined(__M68K__)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_arch</span> <span class="o">!=</span> <span class="n">IH_CPU_M68K</span><span class="p">)</span>
</span><span class='line'><span class="cp">#elif defined(__microblaze__)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_arch</span> <span class="o">!=</span> <span class="n">IH_CPU_MICROBLAZE</span><span class="p">)</span>
</span><span class='line'><span class="cp">#elif defined(__nios2__)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_arch</span> <span class="o">!=</span> <span class="n">IH_CPU_NIOS2</span><span class="p">)</span>
</span><span class='line'><span class="cp">#elif defined(__blackfin__)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_arch</span> <span class="o">!=</span> <span class="n">IH_CPU_BLACKFIN</span><span class="p">)</span>
</span><span class='line'><span class="cp">#elif defined(__avr32__)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_arch</span> <span class="o">!=</span> <span class="n">IH_CPU_AVR32</span><span class="p">)</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="cp"># error Unknown CPU type</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Unsupported Architecture 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_arch</span><span class="p">);</span>
</span><span class='line'>      <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">switch</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_TYPE_STANDALONE</span><span class="p">:</span>
</span><span class='line'>      <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Standalone Application&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="cm">/* A second argument overwrites the load address */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_load</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_TYPE_KERNEL</span><span class="p">:</span>
</span><span class='line'>      <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Kernel Image&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_TYPE_MULTI</span><span class="p">:</span>
</span><span class='line'>      <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Multi-File Image&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">len</span>  <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">len_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>      <span class="cm">/* OS kernel is always the first image */</span>
</span><span class='line'>      <span class="n">data</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* kernel_len + terminator */</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">len_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>          <span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">default</span><span class="o">:</span> <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Wrong Image Type for %s command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmdtp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>      <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">6</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * We have reached the point of no return: we are going to</span>
</span><span class='line'><span class="cm">  * overwrite all exception vector code, so we cannot easily</span>
</span><span class='line'><span class="cm">  * recover from any failures any more...</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">iflag</span> <span class="o">=</span> <span class="n">disable_interrupts</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_AMIGAONEG3SE</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * We&#39;ve possible left the caches enabled during</span>
</span><span class='line'><span class="cm">  * bios emulation, so turn them off again</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="n">icache_disable</span><span class="p">();</span>
</span><span class='line'>  <span class="n">invalidate_l1_instruction_cache</span><span class="p">();</span>
</span><span class='line'>  <span class="n">flush_data_cache</span><span class="p">();</span>
</span><span class='line'>  <span class="n">dcache_disable</span><span class="p">();</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>                                      <span class="cm">/*下面开始搬运kernel到ih_load指定的地址上去*/</span>
</span><span class='line'>  <span class="k">switch</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_comp</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_COMP_NONE</span><span class="p">:</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_load</span><span class="p">)</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;   XIP %s ... &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>    <span class="cm">/*XIP:原地执行*/</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'><span class="cp">#if defined(CONFIG_HW_WATCHDOG) || defined(CONFIG_WATCHDOG)</span>
</span><span class='line'>          <span class="kt">size_t</span> <span class="n">l</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>          <span class="kt">void</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_load</span><span class="p">);</span>
</span><span class='line'>          <span class="kt">void</span> <span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;   Loading %s ... &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">while</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="kt">size_t</span> <span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="n">CHUNKSZ</span><span class="p">)</span> <span class="o">?</span> <span class="nl">CHUNKSZ</span> <span class="p">:</span> <span class="n">l</span><span class="p">;</span>
</span><span class='line'>              <span class="n">WATCHDOG_RESET</span><span class="p">();</span>
</span><span class='line'>              <span class="n">memmove</span> <span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">tail</span><span class="p">);</span>
</span><span class='line'>              <span class="n">to</span> <span class="o">+=</span> <span class="n">tail</span><span class="p">;</span>
</span><span class='line'>              <span class="n">from</span> <span class="o">+=</span> <span class="n">tail</span><span class="p">;</span>
</span><span class='line'>              <span class="n">l</span> <span class="o">-=</span> <span class="n">tail</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'><span class="cp">#else    </span><span class="cm">/* !(CONFIG_HW_WATCHDOG || CONFIG_WATCHDOG) */</span><span class="cp"></span>
</span><span class='line'>          <span class="n">memmove</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_load</span><span class="p">),</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>    <span class="cm">/*搬运代码*/</span>
</span><span class='line'><span class="cp">#endif   </span><span class="cm">/* CONFIG_HW_WATCHDOG || CONFIG_WATCHDOG */</span><span class="cp"></span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_COMP_GZIP</span><span class="p">:</span>
</span><span class='line'>      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;   Uncompressing %s ... &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">gunzip</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_load</span><span class="p">),</span> <span class="n">unc_len</span><span class="p">,</span>      <span class="cm">/*把它解压到 ih_load的位置上去*/</span>
</span><span class='line'>              <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;GUNZIP ERROR - must RESET board to recover</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">);</span>
</span><span class='line'>          <span class="n">do_reset</span> <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_BZIP2</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_COMP_BZIP2</span><span class="p">:</span>
</span><span class='line'>      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;   Uncompressing %s ... &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">      * If we&#39;ve got less than 4 MB of malloc() space,</span>
</span><span class='line'><span class="cm">      * use slower decompression algorithm which requires</span>
</span><span class='line'><span class="cm">      * at most 2300 KB of memory.</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="n">i</span> <span class="o">=</span> <span class="n">BZ2_bzBuffToBuffDecompress</span> <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_load</span><span class="p">),</span>
</span><span class='line'>                      <span class="o">&amp;</span><span class="n">unc_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">CFG_MALLOC_LEN</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">4096</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">BZ_OK</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;BUNZIP2 ERROR %d - must RESET board to recover</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>          <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">);</span>
</span><span class='line'>          <span class="n">udelay</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
</span><span class='line'>          <span class="n">do_reset</span> <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_BZIP2 */</span><span class="cp"></span>
</span><span class='line'>  <span class="k">default</span><span class="o">:</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">iflag</span><span class="p">)</span>
</span><span class='line'>          <span class="n">enable_interrupts</span><span class="p">();</span>
</span><span class='line'>      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Unimplemented compression type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_comp</span><span class="p">);</span>
</span><span class='line'>      <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">7</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>                         <span class="cm">/*搬运完毕*/</span>
</span><span class='line'>  <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">7</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">switch</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_TYPE_STANDALONE</span><span class="p">:</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">iflag</span><span class="p">)</span>
</span><span class='line'>          <span class="n">enable_interrupts</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* load (and uncompress), but don&#39;t start if &quot;autostart&quot;</span>
</span><span class='line'><span class="cm">      * is set to &quot;no&quot;</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(((</span><span class="n">s</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;autostart&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&quot;no&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>          <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span><span class='line'>          <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lX&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>          <span class="n">setenv</span><span class="p">(</span><span class="s">&quot;filesize&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">appl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">[]))</span><span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_ep</span><span class="p">);</span>
</span><span class='line'>      <span class="p">(</span><span class="o">*</span><span class="n">appl</span><span class="p">)(</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_TYPE_KERNEL</span><span class="p">:</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_TYPE_MULTI</span><span class="p">:</span>
</span><span class='line'>      <span class="cm">/* handled below */</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">default</span><span class="o">:</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">iflag</span><span class="p">)</span>
</span><span class='line'>          <span class="n">enable_interrupts</span><span class="p">();</span>
</span><span class='line'>      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Can&#39;t boot image type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_type</span><span class="p">);</span>
</span><span class='line'>      <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_ZIMAGE_BOOT) || defined(CONFIG_IMAGE_BOOT)</span>
</span><span class='line'><span class="nl">after_header_check</span><span class="p">:</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="k">switch</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_os</span><span class="p">)</span> <span class="p">{</span>               <span class="cm">/*判断何种操作系统*/</span>
</span><span class='line'>  <span class="k">default</span><span class="o">:</span>          <span class="cm">/* handled by (original) Linux case */</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_OS_LINUX</span><span class="p">:</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_SILENT_CONSOLE</span>
</span><span class='line'>      <span class="n">fixup_silent_linux</span><span class="p">();</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>      <span class="n">do_bootm_linux</span>  <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span>     <span class="cm">/*开始启动linux内核*/</span>
</span><span class='line'>               <span class="n">addr</span><span class="p">,</span> <span class="n">len_ptr</span><span class="p">,</span> <span class="n">verify</span><span class="p">);</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_OS_NETBSD</span><span class="p">:</span>
</span><span class='line'>      <span class="n">do_bootm_netbsd</span> <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span>
</span><span class='line'>               <span class="n">addr</span><span class="p">,</span> <span class="n">len_ptr</span><span class="p">,</span> <span class="n">verify</span><span class="p">);</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_LYNXKDI</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_OS_LYNXOS</span><span class="p">:</span>
</span><span class='line'>      <span class="n">do_bootm_lynxkdi</span> <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span>
</span><span class='line'>               <span class="n">addr</span><span class="p">,</span> <span class="n">len_ptr</span><span class="p">,</span> <span class="n">verify</span><span class="p">);</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_OS_RTEMS</span><span class="p">:</span>
</span><span class='line'>      <span class="n">do_bootm_rtems</span> <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span>
</span><span class='line'>               <span class="n">addr</span><span class="p">,</span> <span class="n">len_ptr</span><span class="p">,</span> <span class="n">verify</span><span class="p">);</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if (CONFIG_COMMANDS &amp; CFG_CMD_ELF)</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_OS_VXWORKS</span><span class="p">:</span>
</span><span class='line'>      <span class="n">do_bootm_vxworks</span> <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span>
</span><span class='line'>                <span class="n">addr</span><span class="p">,</span> <span class="n">len_ptr</span><span class="p">,</span> <span class="n">verify</span><span class="p">);</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_OS_QNX</span><span class="p">:</span>
</span><span class='line'>      <span class="n">do_bootm_qnxelf</span> <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span>
</span><span class='line'>                <span class="n">addr</span><span class="p">,</span> <span class="n">len_ptr</span><span class="p">,</span> <span class="n">verify</span><span class="p">);</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CFG_CMD_ELF */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#ifdef CONFIG_ARTOS</span>
</span><span class='line'>  <span class="k">case</span> <span class="nl">IH_OS_ARTOS</span><span class="p">:</span>
</span><span class='line'>      <span class="n">do_bootm_artos</span>  <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span>
</span><span class='line'>               <span class="n">addr</span><span class="p">,</span> <span class="n">len_ptr</span><span class="p">,</span> <span class="n">verify</span><span class="p">);</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">);</span>
</span><span class='line'><span class="cp">#ifdef DEBUG</span>
</span><span class='line'>  <span class="n">puts</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">## Control returned to monitor - resetting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">do_reset</span> <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>lib_arm/armlinux.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="k">extern</span> <span class="kt">image_header_t</span> <span class="n">header</span><span class="p">;</span>  <span class="cm">/* from cmd_bootm.c */</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">do_bootm_linux</span> <span class="p">(</span><span class="kt">cmd_tbl_t</span> <span class="o">*</span><span class="n">cmdtp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[],</span>
</span><span class='line'>           <span class="n">ulong</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ulong</span> <span class="o">*</span><span class="n">len_ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">verify</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">ulong</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">checksum</span><span class="p">;</span>
</span><span class='line'>  <span class="n">ulong</span> <span class="n">initrd_start</span><span class="p">,</span> <span class="n">initrd_end</span><span class="p">;</span>
</span><span class='line'>  <span class="n">ulong</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">theKernel</span><span class="p">)(</span><span class="kt">int</span> <span class="n">zero</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arch</span><span class="p">,</span> <span class="n">uint</span> <span class="n">params</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">image_header_t</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">bd_t</span> <span class="o">*</span><span class="n">bd</span> <span class="o">=</span> <span class="n">gd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_CMDLINE_TAG</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">commandline</span> <span class="o">=</span> <span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;bootargs&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">theKernel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">uint</span><span class="p">))</span><span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_ep</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * Check if there is an initrd image</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">9</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">addr</span> <span class="o">=</span> <span class="n">simple_strtoul</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;## Loading Ramdisk Image at %08lx ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* Copy header so we can blank CRC field for re-calculation */</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_HAS_DATAFLASH</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">addr_dataflash</span> <span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">read_dataflash</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">image_header_t</span><span class="p">),</span>
</span><span class='line'>                  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>          <span class="n">memcpy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">,</span>
</span><span class='line'>              <span class="k">sizeof</span> <span class="p">(</span><span class="kt">image_header_t</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_magic</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IH_MAGIC</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Bad Magic Number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>          <span class="n">do_reset</span> <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">header</span><span class="p">;</span>
</span><span class='line'>      <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">image_header_t</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">checksum</span> <span class="o">=</span> <span class="n">ntohl</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_hcrc</span><span class="p">);</span>
</span><span class='line'>      <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_hcrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">crc32</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">checksum</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Bad Header Checksum</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">11</span><span class="p">);</span>
</span><span class='line'>          <span class="n">do_reset</span> <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">print_image_hdr</span> <span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">data</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">image_header_t</span><span class="p">);</span>
</span><span class='line'>      <span class="n">len</span> <span class="o">=</span> <span class="n">ntohl</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_size</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_HAS_DATAFLASH</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">addr_dataflash</span> <span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">read_dataflash</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">CFG_LOAD_ADDR</span><span class="p">);</span>
</span><span class='line'>          <span class="n">data</span> <span class="o">=</span> <span class="n">CFG_LOAD_ADDR</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">verify</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">ulong</span> <span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;   Verifying Checksum ... &quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">csum</span> <span class="o">=</span> <span class="n">crc32</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">csum</span> <span class="o">!=</span> <span class="n">ntohl</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_dcrc</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Bad Data CRC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>              <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">);</span>
</span><span class='line'>              <span class="n">do_reset</span> <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">11</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_os</span> <span class="o">!=</span> <span class="n">IH_OS_LINUX</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>          <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_arch</span> <span class="o">!=</span> <span class="n">IH_CPU_ARM</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>          <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_type</span> <span class="o">!=</span> <span class="n">IH_TYPE_RAMDISK</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;No Linux ARM Ramdisk Image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="o">-</span><span class="mi">13</span><span class="p">);</span>
</span><span class='line'>          <span class="n">do_reset</span> <span class="p">(</span><span class="n">cmdtp</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_B2) || defined(CONFIG_EVB4510) || defined(CONFIG_ARMADILLO)</span>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">      *we need to copy the ramdisk to SRAM to let Linux boot</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="n">memmove</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_load</span><span class="p">),</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>      <span class="n">data</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_load</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_B2 || CONFIG_EVB4510 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">      * Now check if we have a multifile image</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ih_type</span> <span class="o">==</span> <span class="n">IH_TYPE_MULTI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">ulong</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">ntohl</span> <span class="p">(</span><span class="n">len_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">13</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* skip kernel length and terminator */</span>
</span><span class='line'>      <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">len_ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span><span class='line'>      <span class="cm">/* skip any additional image length fields */</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">len_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>          <span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
</span><span class='line'>      <span class="cm">/* add kernel length, and align */</span>
</span><span class='line'>      <span class="n">data</span> <span class="o">+=</span> <span class="n">ntohl</span> <span class="p">(</span><span class="n">len_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">tail</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">tail</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">len</span> <span class="o">=</span> <span class="n">ntohl</span> <span class="p">(</span><span class="n">len_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">      * no initrd image</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">14</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">len</span> <span class="o">=</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef   DEBUG</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;No initrd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">initrd_start</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>      <span class="n">initrd_end</span> <span class="o">=</span> <span class="n">initrd_start</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">initrd_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">initrd_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">SHOW_BOOT_PROGRESS</span> <span class="p">(</span><span class="mi">15</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;## Transferring control to Linux (at address %08lx) ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">theKernel</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined (CONFIG_SETUP_MEMORY_TAGS) || \</span>
</span><span class='line'><span class="cp">    defined (CONFIG_CMDLINE_TAG) || \</span>
</span><span class='line'><span class="cp">    defined (CONFIG_INITRD_TAG) || \</span>
</span><span class='line'><span class="cp">    defined (CONFIG_SERIAL_TAG) || \</span>
</span><span class='line'><span class="cp">    defined (CONFIG_REVISION_TAG) || \</span>
</span><span class='line'><span class="cp">    defined (CONFIG_LCD) || \</span>
</span><span class='line'><span class="cp">    defined (CONFIG_VFD)</span>
</span><span class='line'>  <span class="n">setup_start_tag</span> <span class="p">(</span><span class="n">bd</span><span class="p">);</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_SERIAL_TAG</span>
</span><span class='line'>  <span class="n">setup_serial_tag</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_REVISION_TAG</span>
</span><span class='line'>  <span class="n">setup_revision_tag</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_SETUP_MEMORY_TAGS</span>
</span><span class='line'>  <span class="n">setup_memory_tags</span> <span class="p">(</span><span class="n">bd</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_CMDLINE_TAG</span>
</span><span class='line'>  <span class="n">setup_commandline_tag</span> <span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="n">commandline</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_INITRD_TAG</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">initrd_start</span> <span class="o">&amp;&amp;</span> <span class="n">initrd_end</span><span class="p">)</span>
</span><span class='line'>      <span class="n">setup_initrd_tag</span> <span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="n">initrd_start</span><span class="p">,</span> <span class="n">initrd_end</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#if defined (CONFIG_VFD) || defined (CONFIG_LCD)</span>
</span><span class='line'>  <span class="n">setup_videolfb_tag</span> <span class="p">((</span><span class="kt">gd_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">gd</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">setup_end_tag</span> <span class="p">(</span><span class="n">bd</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* we assume that the kernel is in place */</span>
</span><span class='line'>  <span class="c1">//printf (&quot;\nStarting kernel ...\n\n&quot;);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_USB_DEVICE</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">extern</span> <span class="kt">void</span> <span class="n">udc_disconnect</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>      <span class="n">udc_disconnect</span> <span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">cleanup_before_linux</span> <span class="p">();</span>      <span class="cm">/*关闭中断，清空数据cache，关闭数据cache*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">theKernel</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_arch_number</span><span class="p">,</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_boot_params</span><span class="p">);</span>   <span class="cm">/*相当于执行mov r0,#0;mov r1 #2520;mov r2,#0x50000100;ldr pc,=0x50008000*/</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><ol>
<li>在将内核映像复制到RAM空间中后，就可以准备启动Linux内核了。但是在调用内核之前应该作一步准备工作，即设置Linux内核的启动参数（根文件系统在Nand Flash上的位置是其中的1个参数）。Uboot必须将正确的内核的启动参数放到内存0x50000100处，然后将存放地址（0x50000100）告知内核。内核启动后，到0x50000100处去取得参数，内核必须取得正确的根文件系统在NandFlash上的位置参数后，才能挂载根文件系统。</li>
<li>Linux2.4.x以后的内核都期望以标记列表(tagged list)的形式来传递启动参数。启动参数标记列表以标记ATAG_CORE开始，以标记ATAG_NONE结束。每个标记由标识被传递参数的tag_header结构以及随后的参数值数据结构来组成。数据结构tag和tag_header定义在Linux内核源码的include/asm/setup.h头文件中，Uboot复制了该定义，放在include/asm-arm/setup.h中</li>
<li>内核至少需要4个tag：start_tag、end_tag、memory_tags、commandline_tag才能正确启动</li>
</ol>
</blockquote>

<figure class='code'><figcaption><span>include/asm-arm/setup.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cm">/* The list ends with an ATAG_NONE node. */</span>
</span><span class='line'><span class="cp">#define ATAG_NONE    0x00000000</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">tag_header</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'>  <span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* The list must start with an ATAG_CORE node */</span>
</span><span class='line'><span class="cp">#define ATAG_CORE    0x54410001</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">tag_core</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>     <span class="cm">/* bit 0 = read-only */</span>
</span><span class='line'>  <span class="n">u32</span> <span class="n">pagesize</span><span class="p">;</span>
</span><span class='line'>  <span class="n">u32</span> <span class="n">rootdev</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">tag</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">tag_header</span> <span class="n">hdr</span><span class="p">;</span>
</span><span class='line'>  <span class="k">union</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">tag_core</span>       <span class="n">core</span><span class="p">;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">tag_mem32</span>  <span class="n">mem</span><span class="p">;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">tag_videotext</span>  <span class="n">videotext</span><span class="p">;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">tag_ramdisk</span>    <span class="n">ramdisk</span><span class="p">;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">tag_initrd</span> <span class="n">initrd</span><span class="p">;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">tag_serialnr</span>   <span class="n">serialnr</span><span class="p">;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">tag_revision</span>   <span class="n">revision</span><span class="p">;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">tag_videolfb</span>   <span class="n">videolfb</span><span class="p">;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">tag_cmdline</span>    <span class="n">cmdline</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">      * Acorn specific</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">tag_acorn</span>  <span class="n">acorn</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">      * DC21285 specific</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">tag_memclk</span> <span class="n">memclk</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>lib_arm/armlinux.c中标记列表的建立</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_start_tag</span> <span class="p">(</span><span class="kt">bd_t</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tag</span> <span class="o">*</span><span class="p">)</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_boot_params</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">ATAG_CORE</span><span class="p">;</span>
</span><span class='line'>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">tag_size</span> <span class="p">(</span><span class="n">tag_core</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">pagesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rootdev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">params</span> <span class="o">=</span> <span class="n">tag_next</span> <span class="p">(</span><span class="n">params</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_memory_tags</span> <span class="p">(</span><span class="kt">bd_t</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONFIG_NR_DRAM_BANKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">params</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">ATAG_MEM</span><span class="p">;</span>
</span><span class='line'>      <span class="n">params</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">tag_size</span> <span class="p">(</span><span class="n">tag_mem32</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">params</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_dram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
</span><span class='line'>      <span class="n">params</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bi_dram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">params</span> <span class="o">=</span> <span class="n">tag_next</span> <span class="p">(</span><span class="n">params</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_commandline_tag</span> <span class="p">(</span><span class="kt">bd_t</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">commandline</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">commandline</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* eat leading white space */</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">commandline</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* skip non-existent command lines so the kernel will still</span>
</span><span class='line'><span class="cm">  * use its default command line.</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">ATAG_CMDLINE</span><span class="p">;</span>
</span><span class='line'>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span>
</span><span class='line'>      <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tag_header</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">strcpy</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cmdline</span><span class="p">.</span><span class="n">cmdline</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">params</span> <span class="o">=</span> <span class="n">tag_next</span> <span class="p">(</span><span class="n">params</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_initrd_tag</span> <span class="p">(</span><span class="kt">bd_t</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">initrd_start</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">initrd_end</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="cm">/* an ATAG_INITRD node tells the kernel where the compressed</span>
</span><span class='line'><span class="cm">  * ramdisk can be found. ATAG_RDIMG is a better name, actually.</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">ATAG_INITRD2</span><span class="p">;</span>
</span><span class='line'>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">tag_size</span> <span class="p">(</span><span class="n">tag_initrd</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">initrd</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">initrd_start</span><span class="p">;</span>
</span><span class='line'>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">initrd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">initrd_end</span> <span class="o">-</span> <span class="n">initrd_start</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">params</span> <span class="o">=</span> <span class="n">tag_next</span> <span class="p">(</span><span class="n">params</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_end_tag</span> <span class="p">(</span><span class="kt">bd_t</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">ATAG_NONE</span><span class="p">;</span>
</span><span class='line'>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-20T15:23:31+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/kdm/'>kdm</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/u-boot/'>u-boot</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/20/nand-cp-dot-c/">
		
			nand_cp.c</a>
	</h2>
	<div class="entry-content">
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;common.h&gt;</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_S3C64XX</span>
</span><span class='line'><span class="cp">#include &lt;asm/io.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;regs.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">nandll_read_page</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">large_block</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">page_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">large_block</span><span class="p">)</span>    
</span><span class='line'>      <span class="n">page_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">NAND_ENABLE_CE</span><span class="p">();</span>               <span class="cm">/*使能芯片*/</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">NFCMD_REG</span> <span class="o">=</span> <span class="n">NAND_CMD_READ0</span><span class="p">;</span>       <span class="cm">/*读命令*/</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Write Address */</span>
</span><span class='line'>        <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                  <span class="cm">/*页内起始地址*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">large_block</span><span class="p">)</span>
</span><span class='line'>          <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>            <span class="cm">/*页地址*/</span>
</span><span class='line'>  <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>  <span class="n">NFADDR_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">large_block</span><span class="p">)</span>
</span><span class='line'>      <span class="n">NFCMD_REG</span> <span class="o">=</span> <span class="n">NAND_CMD_READSTART</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">NF_TRANSRnB</span><span class="p">();</span>                  <span class="cm">/*循环判断是否已经准备好*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">page_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">NFDATA8_REG</span><span class="p">;</span>               
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">NAND_DISABLE_CE</span><span class="p">();</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Read data from NAND.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">nandll_read_blocks</span> <span class="p">(</span><span class="n">ulong</span> <span class="n">dst_addr</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">large_block</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="n">uchar</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">dst_addr</span><span class="p">;</span>                     <span class="cm">/*这里buf就是指定的0x57e0 0000物理地址*/</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>  <span class="n">uint</span> <span class="n">page_shift</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">large_block</span><span class="p">)</span>
</span><span class='line'>      <span class="n">page_shift</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Read pages */</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mh">0x50000</span><span class="o">&gt;&gt;</span><span class="n">page_shift</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">buf</span><span class="o">+=</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">page_shift</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">nandll_read_page</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">large_block</span><span class="p">);</span>        <span class="cm">/*一次读取一个页*/</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">copy_uboot_to_ram</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">large_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>  <span class="n">vu_char</span> <span class="n">id</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>    <span class="n">NAND_ENABLE_CE</span><span class="p">();</span>               <span class="cm">/*使能芯片*/</span>
</span><span class='line'>    <span class="n">NFCMD_REG</span> <span class="o">=</span> <span class="n">NAND_CMD_READID</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NFADDR_REG</span> <span class="o">=</span>  <span class="mh">0x00</span><span class="p">;</span>              
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* wait for a while */</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
</span><span class='line'>  <span class="n">id</span> <span class="o">=</span> <span class="n">NFDATA8_REG</span><span class="p">;</span>
</span><span class='line'>  <span class="n">id</span> <span class="o">=</span> <span class="n">NFDATA8_REG</span><span class="p">;</span>               <span class="cm">/*取第二次的返回值*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mh">0x80</span><span class="p">)</span>                    <span class="c1">//判断读取的id是否大于0x80</span>
</span><span class='line'>      <span class="n">large_block</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* read NAND Block.</span>
</span><span class='line'><span class="cm">  * 128KB -&gt;240KB because of U-Boot size increase. by scsuh</span>
</span><span class='line'><span class="cm">  * So, read 0x3c000 bytes not 0x20000(128KB).</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">nandll_read_blocks</span><span class="p">(</span><span class="n">CFG_PHY_UBOOT_BASE</span><span class="p">,</span> <span class="mh">0x50000</span><span class="p">,</span> <span class="n">large_block</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-20T15:17:22+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/kdm/'>kdm</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/u-boot/'>u-boot</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/19/cpu-init-dot-s/">
		
			cpu_init.S</a>
	</h2>
	<div class="entry-content">
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;config.h&gt;                      </span><span class="cm">/*里面包含mini6410.h*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#include &lt;s3c6410.h&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">mem_ctrl_asm_init</span>
</span><span class='line'><span class="nl">mem_ctrl_asm_init</span><span class="p">:</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_MEM_SYS_CFG</span>          <span class="err">@</span><span class="n">Memory</span> <span class="n">sussystem</span> <span class="n">address</span> <span class="mh">0x7e00f120</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xd</span>                     <span class="err">@</span> <span class="n">Xm0CSn2</span> <span class="o">=</span> <span class="n">NFCON</span> <span class="n">CS0</span><span class="p">,</span> <span class="n">Xm0CSn3</span> <span class="o">=</span> <span class="n">NFCON</span> <span class="n">CS1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_DMC1_BASE</span>            <span class="err">@</span><span class="n">DMC1</span> <span class="n">base</span> <span class="n">address</span> <span class="mh">0x7e001000</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 1. 使dramc进入&quot;config&quot;状态 */</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x04</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_MEMC_CMD</span><span class="p">]</span> 
</span><span class='line'>
</span><span class='line'><span class="cm">/* 2. 设置timing parameter*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_REFRESH_PRD</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_REFRESH_PRD</span><span class="p">]</span>      <span class="cm">/*刷新周期7.8us */</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_CAS_LATENCY</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_CAS_LATENCY</span><span class="p">]</span>      <span class="cm">/*CAS Latency:指的是内存存取数据所需的延迟时间，简单的说，就是内存接到CPU的指令后的反应速度。一般的参数值是2和3*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_DQSS</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_DQSS</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_MRD</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_MRD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_RAS</span>                      <span class="cm">/*RAS=45ns*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_RAS</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_RC</span>                       <span class="cm">/*RC=68ns*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_RC</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_RCD</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_schedule_RCD</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_RCD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_RFC</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_schedule_RFC</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_RFC</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_RP</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_schedule_RP</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_RP</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_RRD</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_RRD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_WR</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_WR</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_WTR</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_WTR</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_XP</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_XP</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_XSR</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_XSR</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_t_ESR</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_T_ESR</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 3.设置chip configuration*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC1_MEM_CFG</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_MEMORY_CFG</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC1_MEM_CFG2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_MEMORY_CFG2</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC1_CHIP0_CFG</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_CHIP_0_CFG</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_DDR_32_CFG</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_USER_CONFIG</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 4. 初始化sdram */</span>
</span><span class='line'>  <span class="err">@</span><span class="n">DMC0</span> <span class="n">DDR</span> <span class="n">Chip</span> <span class="mi">0</span> <span class="n">configuration</span> <span class="n">direct</span> <span class="n">command</span> <span class="n">reg</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_NOP0</span>                                   <span class="cm">/* NOP*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">Precharge</span> <span class="n">All</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_PA0</span>                                    <span class="cm">/*precharge*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">Auto</span> <span class="n">Refresh</span>    <span class="mi">2</span> <span class="n">time</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_AR0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>                   <span class="cm">/*auto refresh*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">MRS</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_mDDR_EMR0</span>                              <span class="cm">/*EMRS*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">Mode</span> <span class="n">Reg</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_mDDR_MR0</span>                               <span class="cm">/*MRS*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_SMDK6410_X5A</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC1_CHIP1_CFG</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_CHIP_1_CFG</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">DMC0</span> <span class="n">DDR</span> <span class="n">Chip</span> <span class="mi">0</span> <span class="n">configuration</span> <span class="n">direct</span> <span class="n">command</span> <span class="n">reg</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_NOP1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">Precharge</span> <span class="n">All</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_PA1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">Auto</span> <span class="n">Refresh</span>    <span class="mi">2</span> <span class="n">time</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_AR1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">MRS</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_mDDR_EMR1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="n">Mode</span> <span class="n">Reg</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">DMC_mDDR_MR1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_DIRECT_CMD</span><span class="p">]</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* 5. 使dramc进入&quot;ready&quot;状态  */</span>
</span><span class='line'>  <span class="err">@</span><span class="n">Enable</span> <span class="n">DMC1</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_MEMC_CMD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="nl">check_dmc1_ready</span><span class="p">:</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">INDEX_DMC_MEMC_STATUS</span><span class="p">]</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r2</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x3</span>
</span><span class='line'>  <span class="n">and</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">cmp</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">check_dmc1_ready</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>                             <span class="cm">/*内存控制器初始化完毕，返回*/</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Below code is for ARM926EJS and ARM1026EJS */</span>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">cleanDCache</span>
</span><span class='line'><span class="nl">cleanDCache</span><span class="p">:</span>
</span><span class='line'>  <span class="n">mrc</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">c7</span><span class="p">,</span> <span class="n">c10</span><span class="p">,</span> <span class="mi">3</span>   <span class="cm">/* test/clean D-Cache */</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">cleanDCache</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">cleanFlushDCache</span>
</span><span class='line'><span class="nl">cleanFlushDCache</span><span class="p">:</span>
</span><span class='line'>  <span class="n">mrc</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">c7</span><span class="p">,</span> <span class="n">c14</span><span class="p">,</span> <span class="mi">3</span>   <span class="cm">/* test/cleanflush D-Cache */</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">cleanFlushDCache</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">cleanFlushCache</span>
</span><span class='line'><span class="nl">cleanFlushCache</span><span class="p">:</span>
</span><span class='line'>  <span class="n">mrc</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">c7</span><span class="p">,</span> <span class="n">c14</span><span class="p">,</span> <span class="mi">3</span>   <span class="cm">/* test/cleanflush D-Cache */</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">cleanFlushCache</span>
</span><span class='line'>  <span class="n">mcr</span>  <span class="n">p15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c7</span><span class="p">,</span> <span class="n">c5</span><span class="p">,</span> <span class="mi">0</span>    <span class="cm">/* flush I-Cache */</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">ltorg</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-19T17:28:03+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/kdm/'>kdm</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/u-boot/'>u-boot</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/18/lowlevel-init-dot-s/">
		
			lowlevel_init.S</a>
	</h2>
	<div class="entry-content">
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;config.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;version.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;s3c6410.h&gt;</span>
</span><span class='line'><span class="cp">#include &quot;mini6410_val.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">_TEXT_BASE</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="n">TEXT_BASE</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">lowlevel_init</span>
</span><span class='line'><span class="nl">lowlevel_init</span><span class="p">:</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r12</span><span class="p">,</span> <span class="n">lr</span>                        <span class="cm">/*bl指令会把下一条指令的地址赋给lr，在这里保存lr是为了最后能够成功地函数返回*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* LED on only #8 */</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_GPIO_BASE</span>        <span class="cm">/*Regs.h中的宏定义，就是s3c6410.h中的宏定义*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x55540000</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPNCON_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPN15~GPN9均是输出(01),GPN0~GPN8均是输入(00)*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x55555555</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPNPUD_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPN0~GPN15均是下拉使能*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0xf000</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPNDAT_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPN15~GPN12输出高电平，GPN10~11输出低电平*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_GPIO_BASE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x1</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPECON_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPE0设置为输出，GPE1~GPE15设置为输入*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPEDAT_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPE0输出低电平,LCD_BL_EN=0*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_GPIO_BASE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x2A5AAAAA</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPPCON_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPP15设置为输入，GPP11~GPP10设置为输出，其余设置为片内外设功能*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPPDAT_OFFSET</span><span class="p">]</span>  <span class="cm">/*GPP11和GPP10输出低电平*/</span>
</span><span class='line'>  
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x55555555</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">MEM1DRVCON_OFFSET</span><span class="p">]</span>  <span class="cm">/*由于ddr芯片的工作电压在1.8V，所以驱动电流设置为7mA*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Disable Watchdog */</span>              <span class="cm">/*关闭片内看门狗*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x7e000000</span>        <span class="err">@</span><span class="mh">0x7e004000</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x4000</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span> <span class="n">External</span> <span class="n">interrupt</span> <span class="n">pending</span> <span class="n">clear</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="p">(</span><span class="n">ELFIN_GPIO_BASE</span><span class="o">+</span><span class="n">EINTPEND_OFFSET</span><span class="p">)</span>  <span class="cm">/*EINTPEND*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>                     <span class="cm">/*读一次外部中断就能清楚外部中断信号*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_VIC0_BASE_ADDR</span>   <span class="err">@</span><span class="mh">0x71200000</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_VIC1_BASE_ADDR</span>   <span class="err">@</span><span class="mh">0x71300000</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span> <span class="n">Disable</span> <span class="n">all</span> <span class="n">interrupts</span> <span class="p">(</span><span class="n">VIC0</span> <span class="n">and</span> <span class="n">VIC1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">mvn</span>  <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>                     <span class="cm">/*0取反为全1*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">oINTMSK</span><span class="p">]</span>                <span class="cm">/*禁用所有中断*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="n">oINTMSK</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span> <span class="n">Set</span> <span class="n">all</span> <span class="n">interrupts</span> <span class="n">as</span> <span class="n">IRQ</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">oINTMOD</span><span class="p">]</span>                <span class="cm">/*将所有中断设置为IRQ中断*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="n">oINTMOD</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span> <span class="n">Pending</span> <span class="n">Interrupt</span> <span class="n">Clear</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>                     <span class="cm">/*清除所有当前激活的中断服务程序的地址*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">oVECTADDR</span><span class="p">]</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r3</span><span class="p">,</span> <span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="n">oVECTADDR</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* init system clock */</span>
</span><span class='line'>  <span class="n">bl</span> <span class="n">system_clock_init</span>              <span class="cm">/*初始化系统时钟*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* for UART */</span>
</span><span class='line'>  <span class="n">bl</span> <span class="n">uart_asm_init</span>                  <span class="cm">/*初始化串口*/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_NAND)</span>
</span><span class='line'>  <span class="cm">/* simple init for NAND */</span>
</span><span class='line'>  <span class="n">bl</span> <span class="n">nand_asm_init</span>                  <span class="cm">/*nand flash初始化*/</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">bl</span>   <span class="n">mem_ctrl_asm_init</span>                <span class="cm">/*内存控制器初始化,函数位于/CPU/s3c6410/CPU_init.S*/</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="p">(</span><span class="n">ELFIN_CLOCK_POWER_BASE</span><span class="o">+</span><span class="n">RST_STAT_OFFSET</span><span class="p">)</span>      <span class="cm">/*7e00_f904-&gt;RST_STAT*/</span>
</span><span class='line'>    <span class="n">ldr</span>     <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">bic</span>     <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xfffffff7</span>
</span><span class='line'>    <span class="n">cmp</span>     <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x8</span>                    <span class="cm">/*bit[3]=1,表明从SLEEP状态中唤醒*/</span>
</span><span class='line'>    <span class="n">beq</span>     <span class="n">wakeup_reset</span>
</span><span class='line'>
</span><span class='line'><span class="mi">1</span><span class="o">:</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_UART_BASE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x4b4b4b4b</span>                    <span class="cm">/*通过串口发送字母“K”*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UTXH_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">lr</span><span class="p">,</span> <span class="n">r12</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>                         <span class="cm">/*lowlevel_init结束，返回*/</span>
</span><span class='line'>
</span><span class='line'><span class="nl">wakeup_reset</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="p">(</span><span class="n">ELFIN_CLOCK_POWER_BASE</span><span class="o">+</span><span class="n">WAKEUP_STAT_OFFSET</span><span class="p">)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>                     <span class="cm">/*Clear wakeup status register*/</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*LED test*/</span>
</span><span class='line'>    <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_GPIO_BASE</span>
</span><span class='line'>    <span class="n">ldr</span>     <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x3000</span>
</span><span class='line'>    <span class="n">str</span>     <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPNDAT_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/*Load return address and jump to kernel*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="p">(</span><span class="n">ELFIN_CLOCK_POWER_BASE</span><span class="o">+</span><span class="n">INF_REG0_OFFSET</span><span class="p">)</span>       <span class="cm">/*0x4c00_0a00-&gt;INFORM0*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">]</span>                                         <span class="cm">/* r1 = physical address of s3c6400_cpu_resume function*/</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">r1</span>                                             <span class="cm">/*Jump to kernel (sleep-s3c6400.S)*/</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * system_clock_init: Initialize core clock and bus clock.</span>
</span><span class='line'><span class="cm"> * void system_clock_init(void)</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nl">system_clock_init</span><span class="p">:</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_CLOCK_POWER_BASE</span> <span class="err">@</span><span class="mh">0x7e00f000</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef   CONFIG_SYNC_MODE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r2</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x40</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>              
</span><span class='line'>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x80</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>          <span class="cm">/*bit[6],bit[7]都置1，设置成同步模式*/</span>
</span><span class='line'>
</span><span class='line'><span class="nl">check_syncack</span><span class="p">:</span>                             <span class="cm">/*等待时钟完成同步*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="mh">0xf00</span>
</span><span class='line'>  <span class="n">and</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>                           <span class="cm">/*只查看bit[8]~bit[11]，这几位是SYNC mode相应位，只读,只有在AYNC模式才能读1*/</span>
</span><span class='line'>  <span class="n">cmp</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xf00</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">check_syncack</span>
</span><span class='line'><span class="cp">#else                                        </span><span class="cm">/* 否则配置成异步时钟模式 */</span><span class="cp"></span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>  <span class="n">nop</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xC0</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x40</span>                      <span class="cm">/*bit[6]置1，bit[7]清0*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>          
</span><span class='line'>
</span><span class='line'><span class="nl">wait_for_async</span><span class="p">:</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">and</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xf00</span>
</span><span class='line'>  <span class="n">cmp</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="n">wait_for_async</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x40</span>                      <span class="cm">/*bit[6]清0*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xff00</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xff</span>                      <span class="cm">/*设置各PLL的LOCK_TIME,使用最大值*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">APLL_LOCK_OFFSET</span><span class="p">]</span>           <span class="cm">/*APLL_LOCK，供cpu使用*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">MPLL_LOCK_OFFSET</span><span class="p">]</span>           <span class="cm">/*MPLL_LOCK，供AHB(存储/中断/lcd等控制器)/APB(看门狗，定时器，SD等)总线上的设备使用*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">EPLL_LOCK_OFFSET</span><span class="p">]</span>           <span class="cm">/*EPLL_LOCK，供UART,IIS,IIC使用*/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_CLKSRC_CLKUART)</span>
</span><span class='line'>  <span class="n">ldr</span>      <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CLK_DIV2_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x70000</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x30000</span>                   <span class="cm">/*CLK_DIV2的bit[16]~bit[19]即UART_RATIO,设置为3,CLKUART(66.5Mhz)=CLKUART_input(532/2=266Mhz)/(UART_RATIO(3)+1)*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CLK_DIV2_OFFSET</span><span class="p">]</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>      <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CLK_DIV0_OFFSET</span><span class="p">]</span>        <span class="cm">/*Set Clock Divider*/</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x30000</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xff00</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xff</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="n">CLK_DIV_VAL</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CLK_DIV0_OFFSET</span><span class="p">]</span>            <span class="cm">/*设置时钟的分频系数*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">APLL_VAL</span>                       <span class="cm">/*设置APLL_MDIV=266,APLL_PDIV=3,APLL_SDIV=1*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">APLL_CON_OFFSET</span><span class="p">]</span>            <span class="cm">/*FOUT = MDIV X FIN / (PDIV X 2^SDIV) = 266*12/(3*2^1) = 532MHz*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="n">MPLL_VAL</span>                       <span class="cm">/*设置MPLL_MDIV=266,MPLL_PDIV=3,MPLL_SDIV=1*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">MPLL_CON_OFFSET</span><span class="p">]</span>            <span class="cm">/*FOUT = MDIV X FIN / (PDIV X 2^SDIV) = 266*12/(3*2^1) = 532MHz*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x80200102</span>                        <span class="cm">/*设置EPLL_MDIV=32,EPLL_PDIV=1,EPLL_SDIV=2*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">EPLL_CON0_OFFSET</span><span class="p">]</span>           <span class="cm">/*FOUT = (MDIV+KDIV/2^16) X FIN / (PDIV X 2^SDIV) = (32+0)*12/(1*2^2) = 96MHz*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x0</span>                           <span class="cm">/*设置EPLL_KDIV=0*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">EPLL_CON1_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CLK_SRC_OFFSET</span><span class="p">]</span>         <span class="cm">/*读取CLK_SRC寄存器的值*/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_CLKSRC_CLKUART)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x2007</span>                                    
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r2</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x7</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>                           <span class="cm">/*APLL,MPLL,EPLL的时钟源选择各自的Fout；UART的时钟源选择DOUT_MPLL*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">CLK_SRC_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x10000</span>                     <span class="cm">/*等待所有时钟稳定，至少200us*/</span>
</span><span class='line'><span class="mi">1</span><span class="o">:</span> <span class="n">subs</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mi">1</span>                     <span class="cm">/*非0则跳转*/</span>
</span><span class='line'>  <span class="n">bne</span>  <span class="mi">1</span><span class="n">b</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_SYNC_MODE                      </span><span class="cm">/* Synchronization for VIC port */</span><span class="cp"></span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x20</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">bic</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x20</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">OTHERS_OFFSET</span><span class="p">]</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>                             <span class="cm">/*系统时钟初始化完成，返回*/</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * uart_asm_init: Initialize UART in asm mode, 115200bps fixed.</span>
</span><span class='line'><span class="cm"> * void uart_asm_init(void)</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nl">uart_asm_init</span><span class="p">:</span>
</span><span class='line'>  <span class="cm">/*配置GPIO的功能为串口UART*/</span>
</span><span class='line'>  <span class="cm">/*UART0_RXD=GPA0,UART0_TXD=GPA1,UART1_RXD=GPA4,UART1_TXD=GPA5*/</span>
</span><span class='line'>  <span class="cm">/*UART2_RXD=GPB0,UART2_TXD=GPB1,UART3_RXD=GPB2,UART3_TXD=GPB3*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_GPIO_BASE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x22222222</span>
</span><span class='line'>  <span class="n">str</span>      <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPACON_OFFSET</span><span class="p">]</span>      <span class="cm">/*配置UART0和UART1使用的GPIO引脚,UART0和UART1具有流控功能(GPA0~GPA7)*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x2222</span>
</span><span class='line'>  <span class="n">str</span>      <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">GPBCON_OFFSET</span><span class="p">]</span>      <span class="cm">/*配置UART2和UART3使用的GPIO引脚,UART2和UART3不具有流控功能(GPB0~GPB3)*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_UART_CONSOLE_BASE</span>        <span class="cm">/*ELFIN_UART_CONSOLE_BASE=0x7F005000,即UART0*/</span>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UFCON_OFFSET</span><span class="p">]</span>               <span class="cm">/*禁止使用FIFO*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UMCON_OFFSET</span><span class="p">]</span>               <span class="cm">/*禁止流控，调制解调功能*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x3</span>                         <span class="cm">/*配置UART0：数据位:8, 无校验, 停止位: 1, 8n1*/</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">ULCON_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*设置波特率 */</span>
</span><span class='line'><span class="cm">/*DIV_VAL = (EXT_UCLK1 / (bps x 16 ) ) - 1 = (66500000/(115200x16))-1 = 35.08*/</span>
</span><span class='line'><span class="cm">/*DIV_VAL = 35.08 = UBRDIVn + (num of 1’s in UDIVSLOTn)/16*/</span>
</span><span class='line'><span class="cp">#if defined(CONFIG_CLKSRC_CLKUART)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0xe45</span>                         <span class="cm">/* UARTCLK_SRC=11 =&gt; EXT_UCLK1,EXT_UCLK1由MPLL或者EPLL分频得到,这里是66.5MHz。串口数据接收发送采用轮训或者中断的方式*/</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x245</span>                         <span class="cm">/* UARTCLK_SRC=x0 =&gt; PCLK */</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UCON_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_UART_50)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x1A</span>
</span><span class='line'><span class="cp">#elif defined(CONFIG_UART_66)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x23</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x1A</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UBRDIV_OFFSET</span><span class="p">]</span>          <span class="cm">/*UBRDIV0=35*/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_UART_50)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x3</span>
</span><span class='line'><span class="cp">#elif defined(CONFIG_UART_66)</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x0080</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x3</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UDIVSLOT_OFFSET</span><span class="p">]</span>            <span class="cm">/*UDIVSLOT0中有1个‘1’*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="o">=</span><span class="mh">0x4f4f4f4f</span>
</span><span class='line'>  <span class="n">str</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">UTXH_OFFSET</span><span class="p">]</span>                <span class="cm">/*UART0串口发送字母‘O’*/</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>                             <span class="cm">/*串口配置结束，返回*/</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Nand Interface Init for SMDK6410 </span>
</span><span class='line'><span class="cm"> * /</span>
</span><span class='line'><span class="cm">nand_asm_init:                               /*初始化NandFlash控制器*/</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r0</span><span class="p">,</span> <span class="o">=</span><span class="n">ELFIN_NAND_BASE</span>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">NFCONF_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x70</span>                      <span class="cm">/*TWRPH1=7*/</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x7700</span>                        <span class="cm">/*TWRPH0=7,TACLS=7*/</span>
</span><span class='line'>  <span class="n">str</span>     <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">NFCONF_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ldr</span>  <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">NFCONT_OFFSET</span><span class="p">]</span>
</span><span class='line'>  <span class="n">orr</span>  <span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x03</span>                      <span class="cm">/*使能NandFlash控制器*/</span>
</span><span class='line'>  <span class="n">str</span>     <span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="n">NFCONT_OFFSET</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mov</span>  <span class="n">pc</span><span class="p">,</span> <span class="n">lr</span>                             <span class="cm">/*NandFlash控制器初始化完毕，返回*/</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_ENABLE_MMU</span>
</span><span class='line'>                                          <span class="cm">/*为Uboot服务的MMU页表在这里创建*/</span>
</span><span class='line'>                                          <span class="cm">/* form a first-level section entry */</span>
</span><span class='line'><span class="cm">/*定义一个可以生成描述符的宏*/</span>
</span><span class='line'><span class="cm">/*描述符的最低两位00为无效，01为二级页表方式（由高地址12位的一级页表(TTB的高18位指定的虚拟基地址)位置取出对应二级页表(coarse page table)的基地址，由中间地址8位的二级页表取出对应4KB页表（small page）的基地址，最后由低12为地址的页表取出最终的内存值），10为一级页表方式（如果bit18为0，则为section，bit18为1，则为supersection），11保留。*/</span>
</span><span class='line'><span class="p">.</span><span class="n">macro</span> <span class="n">FL_SECTION_ENTRY</span> <span class="n">base</span><span class="p">,</span><span class="n">ap</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">b</span>     
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="p">(</span><span class="err">\</span><span class="n">base</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="err">\</span><span class="n">ap</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> \
</span><span class='line'>        <span class="p">(</span><span class="err">\</span><span class="n">d</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="err">\</span><span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="err">\</span><span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="n">endm</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*按照section方式映射，每个section必须是1M，占20位地址，这里共256M物理内存，映射到整个4G地址空间，所以共有4096（0x1000）个描述符。虚拟地址的高12位（4096）作为描述符位置，低20位作为section里面的地址*/</span>
</span><span class='line'><span class="p">.</span><span class="n">section</span> <span class="p">.</span><span class="n">mmudata</span><span class="p">,</span> <span class="s">&quot;a&quot;</span>                        <span class="cm">/*指名该段的名称是.mmudata,在u-boot.lds中会为该段分配具体的空间，.a表示这是一个需要鉴权的段*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">align</span> <span class="mi">14</span>                             <span class="cm">/*对齐到0x4000*/</span>
</span><span class='line'>  <span class="c1">// the following alignment creates the mmu table at address 0x4000.</span>
</span><span class='line'>  <span class="p">.</span><span class="n">globl</span> <span class="n">mmu_table</span>                       <span class="cm">/*mmu页表地址需要在start.S中告诉CPU以启动MMU，因此需要声明为全局变量*/</span>
</span><span class='line'><span class="nl">mmu_table</span><span class="p">:</span>
</span><span class='line'>  <span class="p">.</span><span class="n">set</span> <span class="n">__base</span><span class="p">,</span><span class="mi">0</span>
</span><span class='line'>  <span class="c1">// 1:1 mapping for debugging</span>
</span><span class='line'>  <span class="p">.</span><span class="n">rept</span> <span class="mh">0xA00</span>                               <span class="cm">/*共2048个描述符*/</span>
</span><span class='line'>  <span class="n">FL_SECTION_ENTRY</span> <span class="n">__base</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>           <span class="cm">/*ap为3表示读允许,d为0表示这些描述符都属于domain0，domain用来做权限控制,c和b为0表示共享，互斥读写*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">set</span> <span class="n">__base</span><span class="p">,</span><span class="n">__base</span><span class="o">+</span><span class="mi">1</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// access is not allowed.</span>
</span><span class='line'>  <span class="p">.</span><span class="n">rept</span> <span class="mh">0xC00</span> <span class="o">-</span> <span class="mh">0xA00</span>                        <span class="cm">/*共512个描述符*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="mh">0x00000000</span>                      <span class="cm">/*ap为0表示不允许访问*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 128MB for SDRAM 0xC0000000 -&gt; 0x50000000</span>
</span><span class='line'>  <span class="p">.</span><span class="n">set</span> <span class="n">__base</span><span class="p">,</span> <span class="mh">0x500</span>
</span><span class='line'>  <span class="p">.</span><span class="n">rept</span> <span class="mh">0xC80</span> <span class="o">-</span> <span class="mh">0xC00</span>                        <span class="cm">/*共128个描述符*/</span>
</span><span class='line'>  <span class="n">FL_SECTION_ENTRY</span> <span class="n">__base</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>           <span class="cm">/*ap为3表示读允许,d为0表示这些描述符都属于domain0，domain用来做权限控制,c和b为1表示内存输入输出都为回写模式*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">set</span> <span class="n">__base</span><span class="p">,</span><span class="n">__base</span><span class="o">+</span><span class="mi">1</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// access is not allowed.</span>
</span><span class='line'>  <span class="p">.</span><span class="n">rept</span> <span class="mh">0x1000</span> <span class="o">-</span> <span class="mh">0xc80</span>                       <span class="cm">/*共896个描述符*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">word</span> <span class="mh">0x00000000</span>                      <span class="cm">/*ap为0表示不允许访问*/</span>
</span><span class='line'>  <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-18T15:38:36+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/kdm/'>kdm</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/u-boot/'>u-boot</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/06/17/mini6410-dot-h/">
		
			Mini6410.h</a>
	</h2>
	<div class="entry-content">
		<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#define CONFIG_S3C6410     1       </span><span class="cm">/* in a SAMSUNG S3C6410 SoC */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CONFIG_S3C64XX       1       </span><span class="cm">/* in a SAMSUNG S3C64XX Family  */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CONFIG_MINI6410      1       </span><span class="cm">/* in a FriendlyARM MINI6410 Board */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CFG_UBOOT_SIZE       (2*1024*1024)   </span><span class="cm">/*定义Uboot大小为2M字节*/</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_ENABLE_MMU    </span><span class="cm">/*在Uboot中开启MMU,目的为了开启DCache来提高运行速度*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define MEMORY_BASE_ADDRESS  0x50000000  </span><span class="cm">/*DDR起始地址*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_PHY_UBOOT_BASE   MEMORY_BASE_ADDRESS + 0x7e00000 </span><span class="cm">/*Uboot的物理地址0x57e00000*/</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_ENABLE_MMU</span>
</span><span class='line'><span class="cp">#define CFG_UBOOT_BASE       0xc7e00000</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="cp">#define CFG_UBOOT_BASE       0x57e00000</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CFG_ENV_OFFSET       0x00040000      </span><span class="cm">/*Uboot中环境变量偏移地址*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_ENV_SIZE     0x20000         </span><span class="cm">/* Total Size of Environment Sector */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/***********************************************Size of malloc() pool********************************/</span>
</span><span class='line'><span class="cp">#define CFG_MALLOC_LEN       (CFG_ENV_SIZE + 1024*1024)</span>
</span><span class='line'><span class="cp">#define CFG_GBL_DATA_SIZE    128 </span><span class="cm">/* size in bytes reserved for initial data */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CFG_STACK_SIZE       512*1024</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/****************************************NANDFlash宏定义*********************************************/</span>
</span><span class='line'><span class="cp">#define CFG_MAX_NAND_DEVICE     1</span>
</span><span class='line'><span class="cp">#define CFG_NAND_BASE           (0x70200010)</span>
</span><span class='line'><span class="cp">#define NAND_MAX_CHIPS          1</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define NAND_DISABLE_CE()    (NFCONT_REG |= (1 &lt;&lt; 1))</span>
</span><span class='line'><span class="cp">#define NAND_ENABLE_CE() (NFCONT_REG &amp;= ~(1 &lt;&lt; 1))</span>
</span><span class='line'><span class="cp">#define NF_TRANSRnB()        do { while(!(NFSTAT_REG &amp; (1 &lt;&lt; 0))); } while(0)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CFG_NAND_SKIP_BAD_DOT_I  1  </span><span class="cm">/* &quot;.i&quot; read skips bad blocks   */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define  CFG_NAND_WP     1</span>
</span><span class='line'><span class="cp">#define CFG_NAND_YAFFS_WRITE 1  </span><span class="cm">/* support yaffs write */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(FRIENDLYARM_BOOT_MEDIA_NAND) </span><span class="cm">/*启动介质是NandFlash*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CONFIG_BOOT_NAND</span>
</span><span class='line'><span class="cp">#elif defined(FRIENDLYARM_BOOT_MEDIA_SD) </span><span class="cm">/*启动介质是SD Card*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CONFIG_BOOT_MOVINAND</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="cp">#error Boot media not defined</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define  CONFIG_NAND</span>
</span><span class='line'><span class="cp">#define CONFIG_MOVINAND</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_MEMORY_UPPER_CODE         </span><span class="cm">/*用户内存位于代码之上*/</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#undef CONFIG_USE_IRQ                        </span><span class="cm">/* Uboot中不使用IRQ/FIQ*/</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/******************************************系统时钟宏定义*******************************************/</span>
</span><span class='line'><span class="cp">#define CONFIG_CLK_532_133_66                </span><span class="cm">/*FIN=12MHz,Fout=532MHz*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define APLL_MDIV    266</span>
</span><span class='line'><span class="cp">#define APLL_PDIV    3</span>
</span><span class='line'><span class="cp">#define APLL_SDIV    1</span>
</span><span class='line'><span class="cp">#define CONFIG_SYNC_MODE</span>
</span><span class='line'><span class="cp">#define set_pll(mdiv, pdiv, sdiv)    (1&lt;&lt;31 | mdiv&lt;&lt;16 | pdiv&lt;&lt;8 | sdiv)</span>
</span><span class='line'><span class="cp">#define APLL_VAL set_pll(APLL_MDIV, APLL_PDIV, APLL_SDIV)</span>
</span><span class='line'><span class="cp">#define Startup_APLL (CONFIG_SYS_CLK_FREQ/(APLL_PDIV&lt;&lt;APLL_SDIV)*APLL_MDIV)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define MPLL_MDIV    266                     </span><span class="cm">/* fixed MPLL 533MHz */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define MPLL_PDIV    3</span>
</span><span class='line'><span class="cp">#define MPLL_SDIV    1</span>
</span><span class='line'><span class="cp">#define MPLL_VAL set_pll(MPLL_MDIV, MPLL_PDIV, MPLL_SDIV)</span>
</span><span class='line'><span class="cp">#define Startup_MPLL ((CONFIG_SYS_CLK_FREQ)/(MPLL_PDIV&lt;&lt;MPLL_SDIV)*MPLL_MDIV)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define Startup_APLLdiv      0</span>
</span><span class='line'><span class="cp">#define Startup_HCLKx2div    1</span>
</span><span class='line'><span class="cp">#define  Startup_PCLKdiv     3</span>
</span><span class='line'><span class="cp">#define Startup_HCLKdiv      1</span>
</span><span class='line'><span class="cp">#define Startup_MPLLdiv      1</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CLK_DIV_VAL  ((Startup_PCLKdiv&lt;&lt;12)|(Startup_HCLKx2div&lt;&lt;9)|(Startup_HCLKdiv&lt;&lt;8)|(Startup_MPLLdiv&lt;&lt;4)|Startup_APLLdiv)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if defined(CONFIG_SYNC_MODE)</span>
</span><span class='line'><span class="cp">#define Startup_HCLK (Startup_APLL/(Startup_HCLKx2div+1)/(Startup_HCLKdiv+1))</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="cp">#define Startup_HCLK (Startup_MPLL/(Startup_HCLKx2div+1)/(Startup_HCLKdiv+1))</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_CLKSRC_CLKUART</span>
</span><span class='line'><span class="cp">#define CONFIG_UART_66                       </span><span class="cm">/*CLKUART=66.5MHz*/</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/*****************************************DDR控制器宏定义*******************************************/</span>
</span><span class='line'><span class="cp">#if defined(FRIENDLYARM_BOOT_RAM256)</span>
</span><span class='line'><span class="cp">#define DMC1_MEM_CFG     ((1&lt;&lt;30) | (2&lt;&lt;15) | (3&lt;&lt;3) | (2&lt;&lt;0))   </span><span class="cm">/*column address(10):A0~A9;row address(14):A0~A13;Burst Length =4*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DMC1_CHIP0_CFG       0x150F0                                 </span><span class="cm">/*Bank-Row-Column organization */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define PHYS_SDRAM_1_SIZE    0x10000000 </span><span class="cm">/* 256 MB */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#elif defined(FRIENDLYARM_BOOT_RAM128)</span>
</span><span class='line'><span class="cp">#define DMC1_MEM_CFG     ((1&lt;&lt;30) | (2&lt;&lt;15) | (2&lt;&lt;3)| (2&lt;&lt;0))</span>
</span><span class='line'><span class="cp">#define DMC1_CHIP0_CFG       0x150F8</span>
</span><span class='line'><span class="cp">#define PHYS_SDRAM_1_SIZE    0x8000000 </span><span class="cm">/* 128 MB */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="cp">#error RAM size must be defined</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define DMC1_MEM_CFG2        0xB41       </span><span class="cm">/*Memory with=32,Mobile DDR SDRAM,Read delay 1 cycle*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DMC_DDR_32_CFG       0x0         </span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* DDR Parameters */</span>
</span><span class='line'><span class="cp">#define DDR_tREFRESH     7800        </span><span class="cm">/* ns */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tRAS     45      </span><span class="cm">/* ns (min: 45ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tRC      68      </span><span class="cm">/* ns (min: 67.5ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tRCD     23      </span><span class="cm">/* ns (min: 22.5ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tRFC     80      </span><span class="cm">/* ns (min: 80ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tRP      23      </span><span class="cm">/* ns (min: 22.5ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tRRD     15      </span><span class="cm">/* ns (min: 15ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tWR      15      </span><span class="cm">/* ns (min: 15ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_tXSR     120     </span><span class="cm">/* ns (min: 120ns)*/</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define DDR_CASL     3       </span><span class="cm">/* CAS Latency 3 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define DMC_DDR_BA_EMRS  2</span>
</span><span class='line'><span class="cp">#define DMC_DDR_MEM_CASLAT   3</span>
</span><span class='line'><span class="cp">#define DMC_DDR_CAS_LATENCY  (DDR_CASL&lt;&lt;1)                     </span><span class="c1">//6   Set Cas Latency to 3</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_DQSS       1                           </span><span class="c1">// Min 0.75 ~ 1.25</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_MRD        2                           </span><span class="c1">//Min 2 tck</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_RAS        (((Startup_HCLK / 1000 * DDR_tRAS) - 1) / 1000000 + 1)  </span><span class="c1">//7, Min 45ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_RC     (((Startup_HCLK / 1000 * DDR_tRC) - 1) / 1000000 + 1)   </span><span class="c1">//10, Min 67.5ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_RCD        (((Startup_HCLK / 1000 * DDR_tRCD) - 1) / 1000000 + 1)  </span><span class="c1">//4,5(TRM), Min 22.5ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_schedule_RCD ((DMC_DDR_t_RCD - 3) &lt;&lt; 3)</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_RFC        (((Startup_HCLK / 1000 * DDR_tRFC) - 1) / 1000000 + 1)  </span><span class="c1">//11,18(TRM) Min 80ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_schedule_RFC ((DMC_DDR_t_RFC - 3) &lt;&lt; 5)</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_RP     (((Startup_HCLK / 1000 * DDR_tRP) - 1) / 1000000 + 1)   </span><span class="c1">//4, 5(TRM) Min 22.5ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_schedule_RP  ((DMC_DDR_t_RP - 3) &lt;&lt; 3)</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_RRD        (((Startup_HCLK / 1000 * DDR_tRRD) - 1) / 1000000 + 1)  </span><span class="c1">//3, Min 15ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_WR     (((Startup_HCLK / 1000 * DDR_tWR) - 1) / 1000000 + 1)   </span><span class="c1">//Min 15ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_WTR        2</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_XP     2                           </span><span class="c1">//1tck + tIS(1.5ns)</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_XSR        (((Startup_HCLK / 1000 * DDR_tXSR) - 1) / 1000000 + 1)  </span><span class="c1">//17, Min 120ns</span>
</span><span class='line'><span class="cp">#define DMC_DDR_t_ESR        DMC_DDR_t_XSR</span>
</span><span class='line'><span class="cp">#define DMC_DDR_REFRESH_PRD  (((Startup_HCLK / 1000 * DDR_tREFRESH) - 1) / 1000000)  </span><span class="c1">// TRM 2656</span>
</span><span class='line'><span class="cp">#define DMC_DDR_USER_CONFIG  1                           </span><span class="c1">// 2b01 : mDDR</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_NR_DRAM_BANKS 1      </span><span class="cm">/* we have 2 bank of DRAM */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define PHYS_SDRAM_1     MEMORY_BASE_ADDRESS </span><span class="cm">/* SDRAM Bank #1 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cm">/***************************************************************************************************************/</span>
</span><span class='line'><span class="cp">#define CONFIG_DISPLAY_CPUINFO</span>
</span><span class='line'><span class="cp">#define CONFIG_DISPLAY_BOARDINFO</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/************************************************DM9000*********************************************************/</span>
</span><span class='line'><span class="cp">#define CONFIG_DRIVER_DM9000 1</span>
</span><span class='line'><span class="cp">#define CONFIG_DRIVER_DM9000_NO_EEPROM   1</span>
</span><span class='line'><span class="cp">#define CONFIG_DM9000_USE_16BIT 1</span>
</span><span class='line'><span class="cp">#define CONFIG_DM9000_BASE   0x18000300</span>
</span><span class='line'><span class="cp">#define DM9000_IO CONFIG_DM9000_BASE</span>
</span><span class='line'><span class="cp">#define DM9000_DATA (CONFIG_DM9000_BASE+4)</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/***************************************************************************************************************/</span>
</span><span class='line'><span class="cp">#define CONFIG_INCLUDE_TEST</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_ZIMAGE_BOOT</span>
</span><span class='line'><span class="cp">#define CONFIG_IMAGE_BOOT</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define BOARD_LATE_INIT</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_SETUP_MEMORY_TAGS</span>
</span><span class='line'><span class="cp">#define CONFIG_CMDLINE_TAG</span>
</span><span class='line'><span class="cp">#define CONFIG_INITRD_TAG</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/******************************************************Shell*******************************************************/</span>
</span><span class='line'><span class="cp">#define CONFIG_SERIAL1          1            </span><span class="cm">/* we use SERIAL 1 on SMDK6410 */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_HUSH_PARSER                      </span><span class="cm">/* use &quot;hush&quot; command parser  */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CFG_HUSH_PARSER</span>
</span><span class='line'><span class="cp">#define CFG_PROMPT_HUSH_PS2  &quot;&gt; &quot;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*******************************************************Command definition*****************************************/</span>
</span><span class='line'><span class="cp">#define CONFIG_COMMANDS \</span>
</span><span class='line'><span class="cp">                        (CONFIG_CMD_DFL | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_CACHE   | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_USB     | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_REGINFO | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_LOADS   | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_LOADB   | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_ENV     | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_NAND    | \</span>
</span><span class='line'><span class="cp">                     CFG_CMD_PING    | \</span>
</span><span class='line'><span class="cp">                        CFG_CMD_MOVINAND) \</span>
</span><span class='line'><span class="cp">                        &amp; ~(CFG_CMD_AUTOSCRIPT  | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_BOOTD   | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_IMI     | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_RUN     | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_CONSOLE | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_DOCG3P3 | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_EEPROM   | \</span>
</span><span class='line'><span class="cp">                                CFG_CMD_I2C     | \</span>
</span><span class='line'><span class="cp">                                0)</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*********************************************************************************************************************/</span>
</span><span class='line'><span class="cp">#include &lt;cmd_confdefs.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_BOOTDELAY 0</span>
</span><span class='line'><span class="cp">#define CONFIG_BOOTARGS      &quot;root=/dev/mtdblock2 rootfstype=yaffs2 init=/linuxrc console=ttySAC0,115200&quot;</span>
</span><span class='line'><span class="cp">#define CONFIG_ETHADDR       08:90:90:90:90:90</span>
</span><span class='line'><span class="cp">#define CONFIG_NETMASK          255.255.255.0</span>
</span><span class='line'><span class="cp">#define CONFIG_IPADDR        192.168.1.230</span>
</span><span class='line'><span class="cp">#define CONFIG_SERVERIP      192.168.1.88</span>
</span><span class='line'><span class="cp">#define CONFIG_GATEWAYIP 192.168.1.1</span>
</span><span class='line'><span class="cp">#define CONFIG_DEVICENUM    0</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CONFIG_ZERO_BOOTDELAY_CHECK</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/************************************************************************************************************************/</span>
</span><span class='line'><span class="cp">#define CFG_LONGHELP             </span><span class="cm">/* undef to save memory     */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_PROMPT       &quot;iggsensor # &quot;    </span><span class="cm">/* Monitor Command Prompt   */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_CBSIZE       256     </span><span class="cm">/* Console I/O Buffer Size  */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_PBSIZE       384     </span><span class="cm">/* Print Buffer Size */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_MAXARGS      16      </span><span class="cm">/* max number of command args   */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define CFG_BARGSIZE     CFG_CBSIZE  </span><span class="cm">/* Boot Argument Buffer Size    */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*************************************************************************************************************************/</span>
</span><span class='line'><span class="cp">#define MACH_TYPE        2520</span>
</span><span class='line'><span class="cp">#define UBOOT_MAGIC      (0x43090000 | MACH_TYPE)</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-06-17T11:49:49+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/kdm/'>kdm</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/u-boot/'>u-boot</a>


</div>
	
</div>
</article>

<nav id="pagenavi">
    
        
            <a href="/posts/3" class="prev">Prev</a>
        
    
    
        <a href="/posts/5" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    suda-morris

Powered by Octopress-WenRis Group
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>